#! @SHELL@
#
# $Id: mkimapdcert.in,v 1.4 2001/08/26 15:49:50 mrsam Exp $
#
# Copyright 2000 Double Precision, Inc.  See COPYING for
# distribution information.
#
# This is a short script to quickly generate a self-signed X.509 key for
# IMAP over SSL.  Normally this script would get called by an automatic
# package installation routine.

test -x @OPENSSL@ || exit 0

prefix="@prefix@"

if test -f @datadir@/imapd.pem
then
	echo "@datadir@/imapd.pem already exists."
	exit 1
fi

cp /dev/null @datadir@/imapd.pem
chmod 600 @datadir@/imapd.pem
chown @mailuser@ @datadir@/imapd.pem

cleanup() {
	rm -f @datadir@/imapd.pem
	rm -f @datadir@/imapd.rand
	exit 1
}

cd @datadir@
dd if=@RANDOMV@ of=@datadir@/imapd.rand count=1 2>/dev/null
@OPENSSL@ req -new -x509 -days 365 -nodes \
	-config @sysconfdir@/imapd.cnf -out @datadir@/imapd.pem -keyout @datadir@/imapd.pem || cleanup
@OPENSSL@ gendh -rand @datadir@/imapd.rand 512 >>@datadir@/imapd.pem || cleanup
@OPENSSL@ x509 -subject -dates -fingerprint -noout -in @datadir@/imapd.pem || cleanup
rm -f @datadir@/imapd.rand
