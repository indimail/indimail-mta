dnl Process this file with autoconf to produce a configure script.
dnl $Id: configure.in,v 1.12 2004/07/24 03:36:53 mrsam Exp $

dnl Copyright 2000-2004 Double Precision, Inc.  See COPYING for
dnl distribution information.

AC_INIT(soxwrap.h)

AM_INIT_AUTOMAKE(soxwrap,0.50,0)
AM_CONFIG_HEADER(soxwrap_config.h)

dnl Checks for programs.
AC_PROG_AWK
AC_PROG_INSTALL
AC_PROG_RANLIB
AC_PROG_LN_S
AC_PROG_CC

dnl Check for options

AC_CACHE_CHECK([for the Courier Socks library],
		    ac_courier_socks,

AC_COMPILE_IFELSE(
	AC_LANG_SOURCE([
#include <socks.h>

#ifndef courier_socks_h
#error Not a Courier socks header file
#endif
],[ int x=0; ]), [ac_courier_socks=yes],[ac_courier_socks=no])

)

AC_ARG_WITH(socks,
[--without-socks                    - Do not use the Courier Socks library
--with-socks                       - Use Courier Socks library],
[
	if test "$withval" = "yes"
	then
		if test "$ac_courier_socks" = "no"
		then
			AC_MSG_ERROR([Courier Socks header files not found])
		fi
	else
		ac_courier_socks=no
	fi
])

dnl Checks for libraries.

saveLIBS="$LIBS"
NETLIBS=""
USENSL=no

AC_CHECK_LIB(socket,socket,result=yes,result=no)
if test $result = yes; then
        NETLIBS="-lsocket"
else
        AC_CHECK_LIB(socket,socket,result=yes,result=no,-lnsl)
        if test $result = yes; then
                NETLIBS = "-lsocket -lnsl"
                USENSL=yes
        else
                AC_CHECK_LIB(socket,connect,result=yes,result=no)
                if test $result = yes; then
                        NETLIBS="-lsocket"
                else
                        AC_CHECK_LIB(socket,connect,result=yes,result=no,-lnsl)
                        if test $result = yes; then
                                NETLIBS="-lsocket -lnsl"
                                USENSL=yes
                        fi
                fi
        fi
fi

if test $USENSL != yes; then
	LIBS="$LIBS $NETLIBS"
	AC_TRY_LINK_FUNC(inet_addr, [ : ],
	[
	        AC_CHECK_LIB(nsl,inet_addr,result=yes,result=no)
	        if test $result = yes; then
	                NETLIBS="$NETLIBS -lnsl"
	        fi
	])
fi

LIBS="$saveLIBS"

if test "$ac_courier_socks" = "yes"
then
	SOCKLIBS="-lsocks"
	DOSOCKS=1
else
	SOCKLIBS=$NETLIBS
	DOSOCKS=0
fi

AC_DEFINE_UNQUOTED(HAVE_SOCKS, $DOSOCKS, [ Whether to use the Courier Socks library ])

AC_CHECK_HEADERS([arpa/inet.h fcntl.h netdb.h netinet/in.h stdlib.h string.h sys/socket.h sys/select.h sys/poll.h pthread.h sys/stat.h fcntl.h sys/select.h sys/poll.h])
AC_HEADER_TIME
AC_SUBST(SOCKLIBS)


echo $SOCKLIBS >soxlibs.dep
CPPFLAGS="-I.. -I$srcdir/.. $CPPFLAGS"
dnl Checks for typedefs, structures, and compiler characteristics.
AC_OUTPUT(Makefile)
