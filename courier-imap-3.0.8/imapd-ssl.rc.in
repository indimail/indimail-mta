#! @SHELL@
# $Id: imapd-ssl.rc.in,v 1.18 2004/04/18 15:54:38 mrsam Exp $
#
# Copyright 1998 - 2002 Double Precision, Inc.
# See COPYING for distribution information.


prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libexecdir=@libexecdir@

if test ! -f @sysconfdir@/imapd
then
	echo "@sysconfdir@/imapd does not exist, forgot make install-configure?"
	exit 1
fi

if test ! -f @sysconfdir@/imapd-ssl
then
	echo "@sysconfdir@/imapd-ssl does not exist, forgot make install-configure?"
	exit 1
fi

TLS_CACHEFILE=""
. @sysconfdir@/imapd
. @sysconfdir@/imapd-ssl

case $1 in
start)
	LIBAUTHMODULES=""
	for f in `echo $AUTHMODULES`
	do
		LIBAUTHMODULES="$LIBAUTHMODULES @libexecdir@/authlib/$f"
	done

	if test -x ${libexecdir}/authlib/authdaemond
	then
		@SETENV@ - DEBUG_LOGIN="$DEBUG_LOGIN" ${libexecdir}/authlib/authdaemond start
	fi

	if test "$TLS_CACHEFILE" != ""
	then
		rm -f $TLS_CACHEFILE
	fi

	@ULIMIT@ $IMAP_ULIMITD
	@SETENV@ - @SHELL@ -c " set -a ;
		prefix=@prefix@ ;
		exec_prefix=@exec_prefix@ ;
		bindir=@bindir@ ;
		libexecdir=@libexecdir@ ;
		. @sysconfdir@/imapd ; \
		. @sysconfdir@/imapd-ssl ; \
		IMAP_TLS=1; export IMAP_TLS; \
		@libexecdir@/couriertcpd -address=$SSLADDRESS \
			-stderrlogger=@sbindir@/courierlogger \
			-stderrloggername=imapd-ssl \
			-maxprocs=$MAXDAEMONS -maxperip=$MAXPERIP \
			-pid=$SSLPIDFILE $TCPDOPTS \
			$SSLPORT $COURIERTLS -server -tcpd \
				@sbindir@/imaplogin $LIBAUTHMODULES \
				@bindir@/imapd ${MAILDIRPATH}"
	;;
stop)
	@libexecdir@/couriertcpd -pid=$SSLPIDFILE -stop
	if test -x ${libexecdir}/authlib/authdaemond
	then
		${libexecdir}/authlib/authdaemond stop
	fi
	;;
esac
exit 0
