indimaildir=@indimaildir@
qmaildir=@qmaildir@
mysqlbindir=@mysqlbindir@
moduledir=@moduledir@
auth_inc=@auth_inc@
auth_libs=@auth_libs@
libdir=@libdir@
logdir=@logdir@
basepath=@basepath@
mysql_prefix=@mysql_prefix@
mysql_incdir=@mysql_incdir@
mysql_libdir=@mysql_libdir@
defaultdomain=@defaultdomain@
acl_libdirstem := $(shell basename @libdir@ 2>/dev/null|| echo "lib")
release := $(shell head -1 changelog.in | awk '{print $2}' | cut -d'-' -f2 | cut -c-1)
version=@version@
prefix=@prefix@
#
clamav_version=0.98
libdkim_version=1.4
libsrs2_version=1.0.18
courier_version=4.13
bogofilter_version=1.2.3
fetchmail_version=6.3.26
nssd_version=1.1
#
pam_multi_version=1.1
altermime_version=0.3.10
ripmime_version=1.4.0.9
flash_version=0.9.4
mpack_version=1.6
logalert_version=0.3
fortune_version=1.1

all: rules indimail.prerm indimail.preinst indimail.postrm indimail.postinst \
obs_deb_prep gen_control _service \
indimail-xUbuntu_14.04.dsc indimail-xUbuntu_13.10.dsc indimail-xUbuntu_13.04.dsc \
indimail-xUbuntu_12.10.dsc indimail-xUbuntu_12.04.dsc indimail-xUbuntu_11.10.dsc \
indimail-xUbuntu_11.04.dsc indimail-xUbuntu_10.10.dsc indimail-xUbuntu_10.04.dsc \
indimail-Debian_7.0.dsc indimail-Debian_6.0.dsc \
indimail-devel.install indimail-devel.postinst \
indimail-devel.postrm indimail-mini.prerm indimail-mini.preinst \
indimail-mini.postrm indimail-mini.postinst debian.tar.gz dummy.tar.gz

install: all
install-strip: install
distclean: clean

clean:
	/bin/rm -f rules indimail.prerm indimail.preinst indimail.postrm \
	indimail.postinst obs_deb_prep _service indimail-devel.install \
	indimail-devel.postinst indimail-devel.postrm \
	indimail-mini.prerm indimail-mini.preinst indimail-mini.postrm \
	indimail-mini.postinst debian.tar.gz dummy.tar.gz *.dsc

noinst_SCRIPTS = indimail.prerm indimail.preinst indimail.postrm \
				 indimail.postinst rules obs_deb_prep gen_control \
				 indimail-devel.install \
				 indimail-devel.postinst indimail-devel.postrm \
				 indimail-mini.prerm indimail-mini.preinst \
				 indimail-mini.postrm indimail-mini.postinst
MOSTLYCLEANFILES= indimail.prerm indimail.preinst indimail.postrm \
				  indimail.postinst rules obs_deb_prep gen_control \
				  indimail-devel.install \
				  indimail-devel.postinst indimail-devel.postrm \
				  indimail-mini.prerm indimail-mini.preinst \
				  indimail-mini.postrm indimail-mini.postinst \
				  changelog debian.tar.gz dummy.tar.gz

edit = sed \
	-e 's,@indimaildir\@,$(indimaildir),g' \
	-e 's,@qmaildir\@,$(qmaildir),g' \
	-e 's,@mysqlbindir\@,$(mysqlbindir),g' \
	-e 's,@moduledir\@,$(moduledir),g' \
	-e 's,@auth_inc\@,$(auth_inc),g' \
	-e 's,@auth_libs\@,$(auth_libs),g' \
	-e 's,@acl_libdirstem\@,$(acl_libdirstem),g' \
	-e 's,@libdir\@,$(libdir),g' \
	-e 's,@logdir\@,$(logdir),g' \
	-e 's,@basepath\@,$(basepath),g' \
	-e 's,@mysql_prefix\@,$(mysql_prefix),g' \
	-e 's,@mysql_incdir\@,$(mysql_incdir),g' \
	-e 's,@mysql_libdir\@,$(mysql_libdir),g' \
	-e 's,@defaultdomain\@,$(defaultdomain),g' \
	-e 's,@version\@,$(version),g' \
	-e 's,@DESTDIR\@,$(DESTDIR),g' \
	-e 's,@HOST\@,$(host),g' \
	-e 's,@DATE\@,$(DATE),g' \
	-e 's,@clamav_version\@,$(clamav_version),g' \
	-e 's,@libdkim_version\@,$(libdkim_version),g' \
	-e 's,@libsrs2_version\@,$(libsrs2_version),g' \
	-e 's,@courier_version\@,$(courier_version),g' \
	-e 's,@bogofilter_version\@,$(bogofilter_version),g' \
	-e 's,@fetchmail_version\@,$(fetchmail_version),g' \
	-e 's,@nssd_version\@,$(nssd_version),g' \
	-e 's,@pam_multi_version\@,$(pam_multi_version),g' \
	-e 's,@altermime_version\@,$(altermime_version),g' \
	-e 's,@ripmime_version\@,$(ripmime_version),g' \
	-e 's,@flash_version\@,$(flash_version),g' \
	-e 's,@mpack_version\@,$(mpack_version),g' \
	-e 's,@logalert_version\@,$(logalert_version),g' \
	-e 's,@fortune_version\@,$(fortune_version),g' \
	-e 's,@prefix\@,$(prefix),g'

rules: rules.in obs.mk
	$(edit) $@.in > $@; chmod +x $@;
_service: _service.in obs.mk
	$(edit) $@.in > $@;
indimail.prerm: indimail.prerm.in
	$(edit) $@.in > $@;
indimail.preinst: indimail.preinst.in
	$(edit) $@.in > $@;
indimail.postrm: indimail.postrm.in
	$(edit) $@.in > $@;
indimail.postinst: indimail.postinst.in
	$(edit) $@.in > $@;

indimail-devel.postinst: indimail-devel.postinst.in
	$(edit) $@.in > $@;
indimail-devel.postrm: indimail-devel.postrm.in
	$(edit) $@.in > $@;
indimail-devel.install: indimail-devel.install.in
	$(edit) $@.in > $@;

indimail-mini.prerm: indimail-mini.prerm.in
	$(edit) $@.in > $@;
indimail-mini.preinst: indimail-mini.preinst.in
	$(edit) $@.in > $@;
indimail-mini.postrm: indimail-mini.postrm.in
	$(edit) $@.in > $@;
indimail-mini.postinst: indimail-mini.postinst.in
	$(edit) $@.in > $@;

indimail.cron.d: indimail.cron.d.in
	$(edit) $@.in > $@

obs_deb_prep: obs_deb_prep.in obs.mk
	$(edit) $@.in > $@;

changelog: changelog.in obs.mk
	$(edit) $@.in > $@;

indimail-Debian_5.0.dsc: indimail-Debian_5.0.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@;
indimail-Debian_6.0.dsc: indimail-Debian_6.0.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-Debian_7.0.dsc: indimail-Debian_7.0.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_14.04.dsc: indimail-xUbuntu_14.04.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_13.10.dsc: indimail-xUbuntu_13.10.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_13.04.dsc: indimail-xUbuntu_13.04.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_12.10.dsc: indimail-xUbuntu_12.10.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_12.04.dsc: indimail-xUbuntu_12.04.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_11.10.dsc: indimail-xUbuntu_11.10.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_11.04.dsc: indimail-xUbuntu_11.04.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_10.10.dsc: indimail-xUbuntu_10.10.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp
indimail-xUbuntu_10.04.dsc: indimail-xUbuntu_10.04.dsc.in obs.mk changelog.in
	$(edit) $@.in > $@.tmp; \
	sed -e 's,@release@,$(release),g' $@.tmp > $@; /bin/rm -f $@.tmp

dummy.tar.gz: README
	tar cf - README |gzip > $@
debian.tar.gz: copyright indimail.preinst indimail.postinst indimail.prerm \
indimail.postrm rules changelog compat indimail-devel.install \
obs_deb_prep indimail-devel.postinst indimail-devel.postrm \
indimail-mini.prerm indimail-mini.preinst indimail-mini.postrm \
indimail-mini.postinst indimail-mini.install gen_control obs.mk \
control control.Debian.6.0 control.Debian.7.0 control.Ubuntu.10.04 \
control.Ubuntu.10.10 control.Ubuntu.11.04 control.Ubuntu.11.10 \
control.Ubuntu.12.04 control.Ubuntu.12.10 control.Ubuntu.13.04 \
control.Ubuntu.13.10 control.Ubuntu.14.04 indimail.cron.d
	tar cf - copyright indimail.preinst indimail.postinst indimail.prerm \
		indimail.postrm rules changelog compat obs_deb_prep \
		indimail-devel.install indimail-devel.postinst gen_control \
		indimail-devel.postrm indimail-mini.prerm indimail-mini.preinst \
		indimail-mini.postrm indimail-mini.postinst indimail-mini.install \
		control control.Debian.6.0 control.Debian.7.0 control.Ubuntu.10.04 \
		control.Ubuntu.10.10 control.Ubuntu.11.04 control.Ubuntu.11.10 \
		control.Ubuntu.12.04 control.Ubuntu.12.10 control.Ubuntu.13.04 \
		control.Ubuntu.13.10 control.Ubuntu.14.04 indimail.cron.d |gzip > $@
