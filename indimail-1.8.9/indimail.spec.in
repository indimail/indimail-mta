#
#
# $Id: indimail.spec.in,v 2.280 2014-05-14 15:01:25+05:30 Cprogrammer Exp mbhangui $
%undefine _missing_build_ids_terminate_build
%define _unpackaged_files_terminate_build 1

%define is_mandrake %(test -e /etc/mandrake-release && echo 1 || echo 0)
%define is_suse %(test -e /etc/SuSE-release && echo 1 || echo 0)
%define is_fedora %(test -e /etc/fedora-release && echo 1 || echo 0)

%define dist redhat
%define disttag rh

%if %{is_mandrake} != 0
%define dist mandrake
%define disttag mdk
%endif
%if %{is_suse} != 0
%define dist suse
%define disttag suse
%endif
%if %{is_fedora} != 0
%define dist fedora
%define disttag rhfc
%endif

%if 0%{?opensuse_bs}
# define to 1 if building on openSUSE build service
%define build_on_obs       1
%define fast_mode          1
%else
%define build_on_obs       0
%define fast_mode          1
%endif

%define _prefix            @indimaildir@
%define default_domain     @defaultdomain@
%define courier_version    4.13
%define bogofilter_version 1.2.3
%define pam_multi_version  1.1
%define ucspi_version      0.88
%define qmail_version      1.03
%define fetchmail_version  6.3.26
%define nosignatures       1
%define clamav_version     0.98
%define fortune_version    1.1
%define nssd_version       1.1
%define flash_version      0.9.4
%define eps_version        1.2
%define cdb_version        1.0
%define libdkim_version    1.4
%define libsrs2_version    1.0.18
%define mysql_version      6.0.9-alpha
%define noperms            1
%define see_base           For a description of IndiMail visit http://www.indimail.org
%define i_m_on_mac         0
%if %i_m_on_mac == 1
%define nonssd             1
%define fast_mode          1
%define noclamav           1
%else
%define nonssd             0
%define noclamav           1
%endif
%define noproxy            0
%define nocourierimap      0
%define nolibdkim          0
%define nolibsrs2          0
%define nofetchmail        0
%define nobogofilter       0
%define nodksignatures     0

%define _verbose           0
%define qcount             5
%define qbase              %{_prefix}/queue
%define mbase              @basepath@
%define logdir             @logdir@
%define servicedir         /service
%define pam_confdir        /etc/pam.d
%define dkimkeyfn          default
%if %i_m_on_mac == 0
%define module_dir         /%{_lib}/security
%else
%define module_dir         /usr/%{_lib}/pam
%endif

%if %build_on_obs == 1
%define packager Manvendra Bhangui <manvendra@indimail.org>
%endif

%if %build_on_obs == 1
# change mysqlPrefix to /usr for openSUSE buildservice
%define mysqlPrefix        /usr
%else
%define mysqlPrefix        @mysql_prefix@
%endif

Summary: A Flexible Messaging Platform with Multi-Host/Multi-Protocol support
Name: indimail
Version: @version@
%if %build_on_obs == 1
Release: 1.<B_CNT>
%else
Release: 1.B_CCNT
%endif
%if %build_on_obs == 1
License: GPL-3.0+
%else
License: GPLv3
%endif
%if %{undefined suse_version} && %{undefined sles_version}
Group: System Environment/Base
%else
Group: Productivity/Networking/Email/Servers
%endif
Source0:  http://downloads.sourceforge.net/%{name}/%{name}-%{version}.tar.gz
Source1:  http://cr.yp.to/software/qmail-%{qmail_version}.tar.gz
Source2:  http://cr.yp.to/ucspi-tcp/ucspi-tcp-%{ucspi_version}.tar.gz
%if %nocourierimap == 0
Source3:  http://downloads.sourceforge.net/%{name}/courier-imap-%{courier_version}.tar.bz2
%endif
Source4:  http://downloads.sourceforge.net/%{name}/flash-0.9.4.tar.gz
Source5:  http://downloads.sourceforge.net/%{name}/altermime-0.3.10.tar.gz
Source6:  http://downloads.sourceforge.net/%{name}/ripmime-1.4.0.9.tar.gz
Source7:  http://downloads.sourceforge.net/%{name}/mpack-1.6.tar.gz
Source8:  http://downloads.sourceforge.net/%{name}/fortune-%{fortune_version}.tar.gz
%if %nonssd == 0
Source9:  http://downloads.sourceforge.net/%{name}/nssd-%{nssd_version}.tar.gz
%endif
%if %nobogofilter == 0
Source10: http://downloads.sourceforge.net/bogofilter/bogofilter-%{bogofilter_version}.tar.bz2
%endif
%if %nofetchmail == 0
Source11: http://downloads.sourceforge.net/fetchmail/fetchmail-%{fetchmail_version}.tar.xz 
%endif
%if %noclamav == 0
Source12: http://downloads.sourceforge.net/clamav/clamav-%{clamav_version}.tar.gz
%endif
Source13: http://downloads.sourceforge.net/%{name}/pam-multi-%{pam_multi_version}.tar.gz
Source14: http://downloads.sourceforge.net/%{name}/logalert-0.3.tar.gz
Source15: http://downloads.sourceforge.net/%{name}/%{name}-%{version}-rpmlintrc
%if %noperms == 0
%if 0%{?suse_version} >= 1120
Source16:%{name}-permissions.easy
Source17:%{name}-permissions.secure
Source18:%{name}-permissions.paranoid
%endif
%endif
%if %nolibdkim == 0
Source19:  http://downloads.sourceforge.net/%{name}/libdkim-%{libdkim_version}.tar.gz
%endif
%if %nolibsrs2 == 0
Source20:  http://downloads.sourceforge.net/%{name}/libsrs2-%{libsrs2_version}.tar.gz
%endif

Patch1:  http://downloads.sourceforge.net/%{name}/Patches/qmail-%{qmail_version}.patch.gz
Patch2:  http://downloads.sourceforge.net/%{name}/Patches/ucspi-tcp-%{ucspi_version}.patch.gz

%if %nocourierimap == 0
%if %i_m_on_mac == 1
Patch3:  http://downloads.sourceforge.net/%{name}/Patches/courier-imap-%{courier_version}-1.2.patch.gz
%else
Patch3:  http://downloads.sourceforge.net/%{name}/Patches/courier-imap-%{courier_version}.patch.gz
%endif
%endif

# Comment out below for openSUSE buildservice
%if %build_on_obs == 0
%if %nobogofilter == 0
Patch10: http://downloads.sourceforge.net/%{name}/Patches/bogofilter-%{bogofilter_version}.patch.gz
%endif
%if %nofetchmail == 0
Patch11: http://downloads.sourceforge.net/%{name}/Patches/fetchmail-%{fetchmail_version}.patch.gz
%endif
%endif

%if %noclamav == 0
Patch12: http://downloads.sourceforge.net/%{name}/Patches/clamav-%{clamav_version}.patch.gz
%endif

%if %i_m_on_mac == 1
Patch13: http://downloads.sourceforge.net/%{name}/Patches/courier-imap-%{courier_version}-1.2.mac_supplement.patch.gz
%endif

NoSource: 0
NoSource: 2
%if %nocourierimap == 0
NoSource: 3
%endif
NoSource: 4
NoSource: 5
NoSource: 6
NoSource: 7
NoSource: 8
%if %nonssd == 0
NoSource: 9
%endif
%if %nobogofilter == 0
NoSource: 10
%endif
%if %nofetchmail == 0
NoSource: 11
%endif
%if %noclamav == 0
NoSource: 12
%endif
NoSource: 13
NoSource: 14
NoSource: 19
NoSource: 20

URL: http://www.indimail.org
#AutoReqProv: No
Conflicts: %{name}-mini
Provides: %{name}-shared
BuildRequires: openssl-devel rpm gcc gcc-c++ make bison binutils coreutils grep
BuildRequires: glibc glibc-devel openssl procps readline-devel
BuildRequires: sed ncurses-devel gettext-devel
BuildRequires: python-devel flex findutils
BuildRequires: readline gzip autoconf pkgconfig
BuildRequires: libidn-devel
BuildRequires: groff xz

%if %{defined fedora_version}
BuildRequires: redhat-lsb-core
%endif
%if %{defined centos_version} || %{defined rhel_version}
BuildRequires: redhat-lsb
%endif
%if %{defined suse_version}
%if 0%{?suse_version} > 1110 || 0%{?suse_version} == 1310 || 0%{?suse_version} == 1230 || 0%{?suse_version} == 1220 || 0%{?suse_version} == 1210 || 0%{?suse_version} == 1140
BuildRequires: lsb-release
%endif
%endif

%if %{undefined rhel_version}
BuildRequires: gdbm-devel sharutils
%else
%if 0%{?rhel_version} != 600
BuildRequires: gdbm-devel sharutils
%endif
%endif
%if 0%{?suse_version}
BuildRequires: openldap2-devel
%else
BuildRequires: openldap-devel
%endif
%if %build_on_obs == 1
BuildRequires: mysql-devel
%endif
%if %{undefined centos_version} && %{undefined rhel_version}
BuildRequires: chrpath
%endif
%if 0%{?suse_version} == 1220 || 0%{?suse_version} == 1210 || 0%{?suse_version} == 1140 || 0%{?suse_version} == 1100 || 0%{?suse_version} == 1030 || 0%{?suse_version} == 1020
BuildRequires: chrpath
%endif
%if %noperms == 0
%if 0%{?suse_version} >= 1120
PreReq: permissions
%endif
%endif
%if 0%{?suse_version}
BuildRequires: db-devel
BuildRequires: -post-build-checks  
#!BuildIgnore: post-build-checks  
%else
%if 0%{?mandriva_version} == 201100
BuildRequires: db5.1-devel
%else
%if 0%{?mandriva_version} == 201010
BuildRequires: db4.7-devel
%else
%if 0%{?fedora_version} > 17
BuildRequires: libdb-devel
%else
BuildRequires: db4-devel
%endif
%endif
%endif
%endif
BuildRequires: pam-devel
Requires: pam

# rpm -qf /bin/ls
# rpm -qp --queryformat '%{arch}\n' some-file.rpm
# rpm --showrc for all macros
# rpm -qlp some-file.rpm
%if %i_m_on_mac == 0
Requires: /usr/sbin/useradd /usr/sbin/groupadd
Requires: /sbin/chkconfig /usr/sbin/userdel /usr/sbin/groupdel procps /usr/bin/awk
%endif
Requires: coreutils grep /bin/sh glibc openssl mysql-server
%if %{defined centos_version} || %{defined rhel_version}
Requires: policycoreutils-python
%endif
BuildRoot: %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXXX)
#
# IndiMail is choosy and runs on reliable OS only
#
Excludeos: windows 

%description
IndiMail is a messaging platform built using following packages

qmail,
serialmail,
qmailanalog,
dotforward,
fastforward,
mess822,
daemontools,
ucspi-tcp,
Courier IMAP/POP3,
Bogofilter - A Bayesian Spam Filter,
Clam AntiVirus - GPL anti-virus toolkit for UNIX,
Fetchmail,
other useful utilities (mpack, unpack, altermime, ripmime, fortune, flash).

IndiMail also provides Management of Virtual domains. Lot of the
integration has been done by modifying some of the core components.
You can read the feature list to get an idea of the changes and new
features that have been added over the original packages.

The package combines qmail with other packages like courier-imap for
IMAP/POP3, bogofilter for SPAM control, fetchmail for hosts with 
intermittent connectivity. IndiMail provides ability for a single domain
to have users across multiple hosts (even across different geographical
locations) and tools to manage virtual domains ?

%{see_base}

%package devel
Summary: IndiMail - Development header files and libraries
Group: Development/Libraries/Other

%description devel
This package contains the development header files and libraries
necessary to develop IndiMail client applications.

%{see_base}

%package shared
Summary: IndiMail - Shared libraries
Group: Development/Libraries/Other

%description shared
This package contains the shared libraries (*.so*) which certain
languages and applications need to dynamically load and use IndiMail.

%{see_base}

%package mini
Summary: IndiMail - Mini Client Installation
Group: Productivity/Networking/Email/Clients
Conflicts: %{name}

%description mini
This package contains sendmail, qmail-inject and qmail-qmqpc - Bare minimum
programs to have a mini-indimail installation.

A mini-indimail installation doesn't have a mail queue. It gives each new message to a
central server using QMQP.

%{see_base}

%prep
echo "---------------- INFORMATION ------------------------"
echo target        %_target
echo target_alias  %_target_alias
echo target_cpu    %_target_cpu
echo target_os     %_target_os
echo target_vendor %_target_vendor
echo Building %{name}-%{version}-%{release} Build %{_build} OS %{_os} Dist %dist disttag %disttag libs %{_lib} %{_libdir}
echo "------------------------------------------------------"

for i in %{name}-%{version} altermime-0.3.10 ripmime-1.4.0.9 flash-0.9.4 \
mpack-1.6 fortune-%{fortune_version} pam-multi-%{pam_multi_version} \
qmail-%{qmail_version} ucspi-tcp-%{ucspi_version} nssd-%{nssd_version} \
bogofilter-%{bogofilter_version} fetchmail-%{fetchmail_version} \
courier-imap-%{courier_version} clamav-%{clamav_version} \
libdkim-%{libdkim_version} libsrs2-%{libsrs2_version} logalert-0.3
do
	(
	if [ -d $i ] ; then
		%{__rm} -rf $i
	fi
	if [ " $i" = " fetchmail-%{fetchmail_version}" -a %nofetchmail -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " bogofilter-%{bogofilter_version}" -a %nobogofilter -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " courier-imap-%{courier_version}" -a %nocourierimap -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " libdkim-%{libdkim_version}" -a %nolibdkim -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " libsrs2-%{libsrs2_version}" -a %nolibsrs2 -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " clamav-%{clamav_version}" -a %noclamav -ne 0 ] ; then
		continue
	fi
	if [ -f ../SOURCES/$i.tar.bz2 ] ; then
		%{__bzip2} -d -c ../SOURCES/$i.tar.bz2 | tar xf -
	elif [ -f ../SOURCES/$i.tar.xz ] ; then
		xz -d -c ../SOURCES/$i.tar.xz |tar xf -
	elif [ -f ../SOURCES/$i.tar.gz ] ; then
		gunzip -c ../SOURCES/$i.tar.gz | tar xf -
	else
		echo "No Source Archive for $i"
		exit 1
	fi
	if [ -d $i ] ; then
%if %build_on_obs == 1
		#
		# Apply IndiMail Patch
		#
		if [ " $i" = " %{name}-%{version}" ] ; then
			if [ -f ../SOURCES/%{name}-%{version}.patch ] ; then
				patch -p0 < ../SOURCES/%{name}-%{version}.patch
				continue
			elif [ -f ../SOURCES/%{name}-%{version}.patch.gz ] ; then
				gunzip -c ../SOURCES/%{name}-%{version}.patch.gz | patch -p0
				continue
			fi
		fi
		#
		# Apply patch picked up from indimail.sourceforge.net
		#
		if [ " $i" = " courier-imap-%{courier_version}" ] ; then
			continue
		fi
		if [ " $i" = " qmail-%{qmail_version}" ] ; then
			continue
		fi
		if [ " $i" = " ucspi-tcp-%{ucspi_version}" ] ; then
			continue
		fi
%endif
		if [ -f %{name}-%{version}/patches/$i.patch ] ; then
			# Copy for the SRPM
			%{__cp} %{name}-%{version}/patches/$i.patch ../SOURCES
		elif [ -f %{name}-%{version}/patches/$i.patch.gz ] ; then
			%{__cp} %{name}-%{version}/patches/$i.patch.gz ../SOURCES
		fi
	fi
	)
done

%patch1  -p0
%patch2  -p0

%if %nocourierimap == 0
%patch3  -p0
%if %i_m_on_mac == 1
%patch13  -p0
%endif
%endif

# Comment out below for openSUSE buildservice
%if %build_on_obs == 0
%if %nobogofilter == 0
%patch10 -p0
%endif
%if %nofetchmail == 0
%patch11 -p0
%endif
%endif

%if %noclamav == 0
%patch12 -p0
%endif

%build
ID=$(id -u)
if [ %{_verbose} -eq 0 ] ; then
	DEVICE=/dev/null
else
	DEVICE=/dev/tty
fi
echo "Will send output to $DEVICE"
#### Stupid Mandriva ######################
%if 0%{?mandriva_version} > 2009
%ifarch x86_64
%define _libdir %{_prefix}/lib64
%define _lib lib64
%else
%define _libdir %{_prefix}/lib
%define _lib lib
%endif
%endif
#### LIBDKIM ######################
if [ -d libdkim-%{libdkim_version} ] ; then
cd libdkim-%{libdkim_version}

if [ %{fast_mode} -eq 0 ] ; then
if [ %{build_on_obs} -eq 0 ] ; then
	echo "reconfiguring..."
	autoreconf -fi
else
	echo "reconfiguring..."
%if %{undefined centos_version} && %{undefined rhel_version} && %{undefined sles_version}
%if 0%{?fedora_version} > 10 || 0%{?suse_version} || 0%{?mandriva_version} > 2009
	autoreconf -fi
%endif
%endif
fi
fi

%configure --prefix=%{_prefix} --mandir=%{_prefix}/man > $DEVICE
cd ..
fi
#### LIBSRS2 ######################
if [ -d libsrs2-%{libsrs2_version} ] ; then
cd libsrs2-%{libsrs2_version}

if [ %{fast_mode} -eq 0 ] ; then
if [ %{build_on_obs} -eq 0 ] ; then
	echo "reconfiguring..."
	autoreconf -fi
else
	echo "reconfiguring..."
%if %{undefined centos_version} && %{undefined rhel_version} && %{undefined sles_version}
%if 0%{?fedora_version} > 10 || 0%{?suse_version} || 0%{?mandriva_version} > 2009
	autoreconf -fi
%endif
%endif
fi
fi

# for mandrake use --x-libraries
#./configure --prefix=%{_prefix} --libdir=%{_libdir} --libexecdir=%{_prefix}/libexec \
#	--x-libraries=%{_libdir} --mandir=%{_prefix}/man > $DEVICE
#
%configure --prefix=%{_prefix} --mandir=%{_prefix}/man > $DEVICE
cd ..
fi

#### IndiMail ######################
cd %{name}-%{version}

if [ %{fast_mode} -eq 0 ] ; then
if [ %{build_on_obs} -eq 0 ] ; then
	echo "reconfiguring..."
	autoreconf -fi
else
echo "reconfiguring..."
%if %{undefined centos_version} && %{undefined rhel_version} && %{undefined sles_version}
%if 0%{?fedora_version} > 10 || 0%{?suse_version} || 0%{?mandriva_version} > 2009
	autoreconf -fi
%endif
%endif
fi
fi

%configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
	--enable-mysqlbindir=%{mysqlPrefix}/bin --enable-mysqlprefix=%{mysqlPrefix} \
	--mandir=%{_prefix}/man --sysconfdir=%{_prefix}/etc --enable-qmaildir=%{_prefix} \
	--enable-basepath=@basepath@ --enable-logdir=@logdir@ \
	--enable-tcprules-prog=%{_prefix}/bin/tcprules --enable-tcpserver-file=%{_prefix}/etc/tcp.smtp \
	--enable-moduledir=%module_dir \
	`%{__cat} config/indimail.opts` > $DEVICE

#### nssd ######################
%if %nonssd == 0
if [ -d ../nssd-%{nssd_version} ] ; then
	cd ../nssd-%{nssd_version}

if [ %{fast_mode} -eq 0 ] ; then
if [ %{build_on_obs} -eq 0 ] ; then
	echo "reconfiguring..."
	autoreconf -fi
else
	echo "reconfiguring..."
%if %{undefined centos_version} && %{undefined rhel_version} && %{undefined sles_version}
%if 0%{?fedora_version} > 10 || 0%{?suse_version} || 0%{?mandriva_version} > 2009
	autoreconf -fi
%endif
%endif
fi
fi

	%configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
	--mandir=%{_prefix}/man --libdir=/usr/%{_lib} \
	--enable-mysqlprefix=%{mysqlPrefix} --enable-mysqllibdir=%{mysqlPrefix}/%{_lib}/mysql \
	`%{__cat} ../%{name}-%{version}/config/nssd.opts` > $DEVICE
fi
%endif
#sed -i 's|^hardcode_libdir_flag_spec=.*|hardcode_libdir_flag_spec=""|g' libtool
#sed -i 's|^runpath_var=LD_RUN_PATH|runpath_var=DIE_RPATH_DIE|g' libtool

#### courier-imap ######################
%if %nocourierimap == 0
if [ -d ../courier-imap-%{courier_version} ] ; then
	cd ../courier-imap-%{courier_version}
	%{__mkdir_p} m4
	%configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --bindir=%{_prefix}/bin \
	--mandir=%{_prefix}/man --sysconfdir=%{_prefix}/etc \
	`%{__cat} ../%{name}-%{version}/config/courier-imap.opts` > $DEVICE
fi
%endif

#### bogofilter ######################
%if %nobogofilter == 0
if [ -d ../bogofilter-%{bogofilter_version} ] ; then
	cd ../bogofilter-%{bogofilter_version}
	if [ %{build_on_obs} -eq 0 ] ; then
	autoreconf -fi
	%configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
	--mandir=%{_prefix}/man `%{__cat} ../%{name}-%{version}/config/bogofilter.opts` > $DEVICE
	else
	# change to ./configure for openSUSE buildservice
	./configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
	--mandir=%{_prefix}/man `%{__cat} ../%{name}-%{version}/config/bogofilter.opts` > $DEVICE
%if 0%{?sles_version} == 10
        sed 's{extern int yylineno;{int yylineno = 1;{' < src/lexer.c > src/lexer.c.tmp
        mv src/lexer.c.tmp src/lexer.c
%endif
	fi
fi
%endif

#### clamav ######################
%if %noclamav == 0
if [ -d ../clamav-%{clamav_version} ] ; then
	cd ../clamav-%{clamav_version}
	if [ %{build_on_obs} -eq 0 ] ; then
	%configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
	--with-dbdir=%{_prefix}/share/clamd --mandir=%{_prefix}/man \
	`%{__cat} ../%{name}-%{version}/config/clamav.opts` > $DEVICE
	else
	# change to ./configure for openSUSE buildservice
	./configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
	--with-dbdir=%{_prefix}/share/clamd --mandir=%{_prefix}/man \
	`%{__cat} ../%{name}-%{version}/config/clamav.opts` > $DEVICE
	fi
fi
%endif

#### fetchmail ######################
%if %nofetchmail == 0
if [ -d ../fetchmail-%{fetchmail_version} ] ; then
	cd ../fetchmail-%{fetchmail_version}
	if [ %{build_on_obs} -eq 0 ] ; then
		echo "reconfiguring..."
		if [ %{fast_mode} -eq 0 ] ; then
			autoreconf -fi
		fi
	%configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
		--enable-indimaildir=%{_prefix} --mandir=%{_prefix}/man \
		`%{__cat} ../%{name}-%{version}/config/fetchmail.opts` > $DEVICE
	else
		echo "reconfiguring..."
%if %{undefined centos_version} && %{undefined rhel_version} && %{undefined sles_version}
%if 0%{?fedora_version} || 0%{?suse_version}
		if [ %{fast_mode} -eq 0 ] ; then
			autoreconf -fi
		fi
%else
		if [ %{fast_mode} -eq 0 ] ; then
			%{__autoheader}
			%{__autoconf}
		fi
%endif
%endif
	./configure --prefix=%{_prefix} --libexecdir=%{_prefix}/libexec --sysconfdir=%{_prefix}/etc \
		--enable-indimaildir=%{_prefix} --mandir=%{_prefix}/man \
		`%{__cat} ../%{name}-%{version}/config/fetchmail.opts` > $DEVICE
	fi
fi
%endif
cd ..
#### ucspi-tcp ######################
if [ -d ucspi-tcp-%{ucspi_version} ] ; then
	%{__sed} 's{HOME{%{_prefix}{' ucspi-tcp-%{ucspi_version}/conf-home.in > ucspi-tcp-%{ucspi_version}/conf-home
fi
if [ $ID -eq 0 ] ; then
	if [ $nscd_up -ge 1 ] ; then
		if [ -x %{_sysconfdir}/init.d/nscd ] ; then
			%{_sysconfdir}/init.d/nscd start
		fi
	fi
fi

%install
[ "$RPM_BUILD_ROOT" != "/" ] && %{__rm} -fr $RPM_BUILD_ROOT
ID=$(id -u)
%{__mkdir_p} $RPM_BUILD_ROOT%{_prefix}
for i in libdkim-%{libdkim_version} libsrs2-%{libsrs2_version} %{name}-%{version} \
ucspi-tcp-%{ucspi_version} nssd-%{nssd_version} bogofilter-%{bogofilter_version} \
fetchmail-%{fetchmail_version} courier-imap-%{courier_version} \
clamav-%{clamav_version}
do
	if [ " $i" = " fetchmail-%{fetchmail_version}" -a %nofetchmail -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " bogofilter-%{bogofilter_version}" -a %nobogofilter -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " courier-imap-%{courier_version}" -a %nocourierimap -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " libdkim-%{libdkim_version}" -a %nolibdkim -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " libsrs2-%{libsrs2_version}" -a %nolibsrs2 -ne 0 ] ; then
		continue
	fi
	if [ " $i" = " clamav-%{clamav_version}" -a %noclamav -ne 0 ] ; then
		continue
	fi
	if [ -d $i ] ; then
		cd $i
		if [ %{_verbose} -eq 0 ] ; then
			%{__make} -s DESTDIR=%{buildroot}
			%{__make} -s DESTDIR=%{buildroot} install-strip
		else
			%{__make} DESTDIR=%{buildroot}
			%{__make} DESTDIR=%{buildroot} install-strip
		fi
		# courier-imap installations misses out on this
		if [ %nocourierimap -eq 0 -a " $i" = " courier-imap-%{courier_version}" ] ; then
			%{__mkdir_p} %{buildroot}%{_prefix}/man/man1
			cp tcpd/couriertls.1 %{buildroot}%{_prefix}/man/man1/couriertls.1
		fi
		cd ..
	fi
done
for i in eps cdb flash indimail
do
	%{__rm} -f %{buildroot}%{_libdir}/lib"$i".la
done
%{__rm} -f %{buildroot}%{_prefix}/modules/iauth.la

if [ %noclamav -eq 0 ] ; then
	for i in clamav clamunrar clamunrar_iface
	do
		%{__rm} -f %{buildroot}%{_libdir}/lib"$i".la
	done
fi
if [ %nonssd -eq 0 ] ; then
	%{__rm} -f %{buildroot}/usr/%{_lib}/libnss_nssd.la
fi
if [ %nolibdkim -eq 0 ] ; then
	%{__rm} -f %{buildroot}%{_libdir}/libdkim.la
	if [ -x /usr/bin/chrpath ] ; then
    	/usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/dkim
	fi
fi
if [ %nolibsrs2 -eq 0 ] ; then
	%{__rm} -f %{buildroot}%{_libdir}/libsrs2.la
	if [ -x /usr/bin/chrpath ] ; then
    	/usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/srsfilter
    	/usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/srs
	fi
fi

%{__mkdir_p} %{buildroot}%{_prefix}/domains
%{__mkdir_p} %{buildroot}%{_prefix}/etc
%{__mkdir_p} %{buildroot}%{_prefix}/include
%{__cp} %{name}-%{version}/inc_deps %{buildroot}%{_prefix}/etc
%{__cp} %{name}-%{version}/lib_deps %{buildroot}%{_prefix}/etc
%{__cp} %{name}-%{version}/indimail.h %{buildroot}%{_prefix}/include
%{__cp} %{name}-%{version}/typesx.h %{buildroot}%{_prefix}/include

if [ %noclamav -eq 0 ] ; then
	if [ -f %{buildroot}%{_prefix}/etc/clamd.conf ] ; then
		%{__rm} -f %{buildroot}%{_prefix}/etc/clamd.conf
	fi
	if [ -f %{buildroot}%{_prefix}/etc/freshclam ] ; then
		%{__rm} -f %{buildroot}%{_prefix}/etc/freshclam.conf
	fi
	if [ -d %{buildroot}%{_prefix}/var ] ; then
		/bin/rmdir %{buildroot}%{_prefix}/var
	fi
fi

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%{__mkdir_p} %{buildroot}%{_sysconfdir}/permissions.d/
install -m 644 %{S:16} %{buildroot}%{_sysconfdir}/permissions.d/%{name}-permissions
install -m 644 %{S:17} %{buildroot}%{_sysconfdir}/permissions.d/%{name}-permissions.secure
%endif
%endif

if [ -x /usr/bin/chrpath ] ; then
	/usr/bin/chrpath -d %{buildroot}%{_libdir}/*.so
	for i in dbinfo flash hostcntrl indiversion printdir \
		proxyimap proxypop3 resetquota sigtool vacation vaddaliasdomain vadddomain vadduser \
		vadduserl valias vatrn vbulletin vcalias vcfilter vdeldomain vdeluser vdominfo \
		vgroup vhostid vipmap vlimit vmoduser vmoveuser vpasswd vpriv sslerator \
		vproxy vrenamedomain vrenameuser vsetuserquota vsmtp vuserinfo tcpserver ismaildup
	do
		if [ -f %{buildroot}%{_prefix}/bin/$i ] ; then
    		/usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/$i
		fi
	done
	if [ %noclamav -eq 0 ] ; then
		for i in clambc clamconf clamscan freshclam
		do
			if [ -f %{buildroot}%{_prefix}/bin/$i ] ; then
    			/usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/$i
			fi
		done
	fi

	/usr/bin/chrpath -d %{buildroot}%{_prefix}/libexec/authlib/authindi
	/usr/bin/chrpath -d %{buildroot}%{_prefix}/libexec/authlib/authpgsql
	/usr/bin/chrpath -d %{buildroot}%{_prefix}/libexec/sq_vacation
	/usr/bin/chrpath -d %{buildroot}%{_prefix}/libexec/qmailmrtg7
	/usr/bin/chrpath -d %{buildroot}%{_prefix}/modules/iauth.so

	for i in adminclient chowkidar cindimail clearopensmtp copyemail execmysql \
	hostsync indisrvr inlookup inquerytest install_tables ipchange mail_report \
	mgmtpass postdel systpass testmra updatefile updaterules vchkpass vdelivermail \
	vdeloldusers vfilter vfstab vmoddomain vreorg vsetpass nssd vserverinfo check_getpw \
	vtable
	do
		if [ -f %{buildroot}%{_prefix}/sbin/$i ] ; then
    		/usr/bin/chrpath -d %{buildroot}%{_prefix}/sbin/$i
		fi
	done
	if [ %noclamav -eq 0 ] ; then
    	/usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/clamd
	fi
fi
# Compress the man pages
find %{buildroot}%{_prefix}/man -type f -exec gzip -q {} \;
if [ -f %{buildroot}%{_prefix}/man/man7/authlib.7.gz ] ; then
	for i in authshadow.7 authpwd.7 authpam.7 authcustom.7
	do
		%{__rm} -f %{buildroot}%{_prefix}/man/man7/$i
		ln -sf %{_prefix}/man/man7/authlib.7.gz %{buildroot}%{_prefix}/man/man7/$i.gz
	done
fi
# pam-multi
%{__rm} -f %{buildroot}%{module_dir}/pam-multi.la
%{__rm} -f %{buildroot}%{module_dir}/pam-multi.a
if [ -x /usr/bin/chrpath ] ; then
	/usr/bin/chrpath -d %{buildroot}%{module_dir}/pam-multi.so
	/usr/bin/chrpath -d %{buildroot}%{_prefix}/sbin/pam-checkpwd
fi


if [ -x /bin/touch ] ; then
	TOUCH=/bin/touch
elif [ -x /usr/bin/touch ] ; then
	TOUCH=/usr/bin/touch
else
	TOUCH=/bin/touch
fi
# Create these files so that %ghost does not complain
for i in indimail.cnf tcp.imap tcp.imap.cdb tcp.pop3 tcp.pop3.cdb \
tcp.smtp tcp.smtp.cdb tcp.qmtp tcp.qmtp.cdb tcp.qmqp tcp.qmqp.cdb \
tcp.poppass tcp.poppass.cdb services.log
do
	if [ ! -f %{buildroot}%{_prefix}/etc/$i ] ; then
		$TOUCH %{buildroot}%{_prefix}/etc/$i
	fi
done
%if %nonssd == 0
	$TOUCH %{buildroot}%{_prefix}/etc/nssd.conf
%endif
(
for i in `%{__cat} %{buildroot}%{_prefix}/etc/controlfiles`
do
	echo "%ghost %config(noreplace,missingok)               %{_prefix}/control/$i"
	$TOUCH %{buildroot}%{_prefix}/control/$i
done
) > config_files.list
if [ %nobogofilter -eq 0 ] ; then
	$TOUCH %{buildroot}%{_prefix}/etc/bogofilter.cf
fi
if [ %nofetchmail -eq 0 ] ; then
	$TOUCH %{buildroot}%{_prefix}/etc/fetchmailrc
fi
if [ %noclamav -eq 0 ] ; then # clamav >= 0.97.5, without clamav-db
	if [ ! -d %{buildroot}%{_prefix}/share/clamd ] ; then
		%{__mkdir_p} %{buildroot}%{_prefix}/share/clamd
	else # with built-in clamav signatures
		$TOUCH %{buildroot}%{_prefix}/share/clamd/clamav
		$TOUCH %{buildroot}%{_prefix}/share/clamd/mirrors.dat
	fi
else
	if [ -f /usr/bin/freshclam ] ; then
		if [ ! -d %{buildroot}%{_prefix}/share/clamd ] ; then
			%{__mkdir_p} %{buildroot}%{_prefix}/share/clamd
		fi
	fi
fi

%files -f config_files.list
%defattr(-, root, root,-)
#
# Directories
#
%dir %attr(555,root,qmail)        %{_prefix}
%dir %attr(555,root,qmail)        %{_prefix}/boot
%dir %attr(555,root,qmail)        %{_prefix}/doc
%dir %attr(2555,alias,qmail)      %{_prefix}/alias
%dir %attr(750,qscand,qscand)     %{_prefix}/qscanq
%dir %attr(750,qscand,qscand)     %{_prefix}/qscanq/root
%dir %attr(750,qscand,qscand)     %{_prefix}/qscanq/root/scanq
%dir %attr(555,root,root)         %{_prefix}/lib
%dir %attr(555,root,root)         %{_prefix}/libexec
%dir %attr(555,root,root)         %{_prefix}/libexec/authlib
%dir %attr(755,indimail,indimail) %{_prefix}/control
%dir %attr(775,indimail,indimail) %{_prefix}/control/inquery
%dir %attr(755,indimail,indimail) %{_prefix}/control/domainkeys
%dir %attr(2755,indimail,qmail)   %{_prefix}/autoturn
%dir %attr(555,root,root)         %{_prefix}/modules
%dir %attr(555,root,qmail)        %{_prefix}/man
%dir %attr(555,root,qmail)        %{_prefix}/man/man1
%dir %attr(555,root,qmail)        %{_prefix}/man/cat1
%dir %attr(555,root,qmail)        %{_prefix}/man/man5
%dir %attr(555,root,qmail)        %{_prefix}/man/cat5
%dir %attr(555,root,qmail)        %{_prefix}/man/man7
%dir %attr(555,root,qmail)        %{_prefix}/man/cat7
%dir %attr(555,root,qmail)        %{_prefix}/man/man8
%dir %attr(555,root,qmail)        %{_prefix}/man/cat8
%dir %attr(555,root,root)         %{_prefix}/include
%dir %attr(555,root,root)         %{_libdir}

%if %nofetchmail == 0
%if %i_m_on_mac == 0
%dir %attr(755,root,root)         %{_prefix}/share/locale
%endif
%dir %attr(755,root,root)         %{_prefix}/lib*/python*
%dir %attr(755,root,root)         %{_prefix}/lib*/python*/site-packages
%endif

%dir %attr(775,root,indimail)     %{_prefix}/domains
%dir %attr(555,root,root)         %{_prefix}/share

%if %noclamav == 0
%dir %attr(755,root,root)         %{_libdir}/pkgconfig
%dir %attr(775,qscand,qscand)     %{_prefix}/share/clamd
%endif

%dir %attr(755,root,root)         %{_prefix}/share/fortunes
%dir %attr(555,root,qmail)        %{_prefix}/users
%dir %attr(555,root,qmail)        %{_prefix}/plugins
%dir %attr(775,root,indimail)     %{_prefix}/etc
%dir %attr(755,root,root)         %{_prefix}/etc/yum.repos.d
%dir %attr(555,root,indimail)     %{_prefix}/sbin
%dir %attr(555,root,qmail)        %{_prefix}/bin
#
# If the configuration file should not be replaced when the RPM is
# upgraded, mark it as follows:
# %config(noreplace) filename
#
# Configuration files must be marked as such in packages.
# As a rule of thumb, use %config(noreplace) instead of plain %config unless your best,
# educated guess is that doing so will break things. In other words, think hard before
# overwriting local changes in configuration files on package upgrades.
# An example case when /not/ to use noreplace is when a package's configuration file
# changes so that the new package revision wouldn't work with the config file
# from the previous package revision. Whenever plain %config is used,
# add a brief comment to the specfile explaining why.

%attr(444,root,root) %config(noreplace)           %{_prefix}/etc/system.flashlogin
%attr(444,root,root) %config(noreplace)           %{_prefix}/etc/system.rc
%attr(444,root,root) %config(noreplace)           %{_prefix}/etc/system.menu
%attr(444,root,root) %config(noreplace)           %{_prefix}/etc/system.module
%attr(444,root,root) %config(noreplace)           %{_prefix}/etc/osh.table
# Allow new control files to get added with new packages
# unlikely for this file to have local changes
%attr(444,root,root)                              %{_prefix}/etc/controlfiles
# For configuration files that may be found missing during uninstall have
# $config(missingok)
#
# For files that should be included in the list of files so that they
# are uninstalled when the package is removed but may not exist until
# they are created during post-install should be marked as follows:
# %ghost filename
%if %nobogofilter == 0
%ghost %config(noreplace,missingok)               %{_prefix}/etc/bogofilter.cf
%endif
%if %nofetchmail == 0
%ghost %config(noreplace,missingok)               %{_prefix}/etc/fetchmailrc
%endif

%ghost %config(noreplace,missingok)               %{_prefix}/etc/indimail.cnf
%if %nonssd == 0
%ghost %config(noreplace,missingok)               %{_prefix}/etc/nssd.conf
%endif
%ghost %config(noreplace,missingok)               %{_prefix}/etc/tcp.imap
%ghost %config(noreplace,missingok)               %{_prefix}/etc/tcp.pop3
%ghost %config(noreplace,missingok)               %{_prefix}/etc/tcp.smtp
%ghost %config(noreplace,missingok)               %{_prefix}/etc/tcp.qmtp
%ghost %config(noreplace,missingok)               %{_prefix}/etc/tcp.qmqp
%ghost %config(noreplace,missingok)               %{_prefix}/etc/tcp.poppass
#
# These files will get removed during uninstallation
#
%ghost %attr(0644,indimail,indimail)              %{_prefix}/etc/tcp.smtp.cdb
%ghost %attr(0644,indimail,indimail)              %{_prefix}/etc/tcp.qmtp.cdb
%ghost %attr(0644,indimail,indimail)              %{_prefix}/etc/tcp.qmqp.cdb
%ghost %attr(0644,indimail,indimail)              %{_prefix}/etc/tcp.imap.cdb
%ghost %attr(0644,indimail,indimail)              %{_prefix}/etc/tcp.pop3.cdb
%ghost %attr(0644,indimail,indimail)              %{_prefix}/etc/tcp.poppass.cdb
%ghost %attr(0644,root,root)                      %{_prefix}/etc/services.log

%attr(444,root,root)                              %{_prefix}/etc/cronlist
%attr(444,root,root)                              %{_prefix}/etc/indimail.te
%attr(444,root,root)                              %{_prefix}/etc/indimail.mrtg.cfg
%attr(444,root,root)                              %{_prefix}/etc/qmailprog.list
%attr(444,root,root)                              %{_prefix}/etc/headerlist
%attr(444,root,root)                              %{_prefix}/etc/indimail.settings
%attr(444,root,root)                              %{_prefix}/etc/perm_list
%attr(444,root,root)                              %{_prefix}/etc/yum.repos.d/*.repo
# logalert
%attr(444,root,root)                              %{_prefix}/etc/logalert_perm_list

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%attr(644,root,root)                              %{_sysconfdir}/permissions.d/%{name}-permissions
%attr(644,root,root)                              %{_sysconfdir}/permissions.d/%{name}-permissions.secure
%endif
%endif

%if %nobogofilter == 0
%attr(644,root,root)                              %{_prefix}/etc/bogofilter.cf.example
%attr(0644,indimail,indimail) %config(noreplace)  %{_prefix}/etc/wordlist.db
%endif

%if %nocourierimap == 0
%attr(600,root,root)                              %{_prefix}/etc/pop3d-ssl.dist
%attr(600,root,root)                              %{_prefix}/etc/imapd-ssl.dist
%attr(600,root,root)                              %{_prefix}/etc/pop3d.cnf
%attr(600,root,root)                              %{_prefix}/etc/imapd.cnf
%attr(600,root,root)                              %{_prefix}/etc/pop3d.dist
%attr(600,root,root)                              %{_prefix}/etc/imapd.dist
%attr(644,root,root)                              %{_prefix}/etc/quotawarnmsg.example
%endif

#
# Binaries
#
%attr(6511,qscand,qmail)                %{_prefix}/bin/qhpsi
%attr(6511,qmailq,qmail)                %{_prefix}/bin/qmail-queue
%attr(4555,root,root)                   %{_prefix}/bin/vrenameuser
%attr(4555,root,root)                   %{_prefix}/bin/vmoveuser
%attr(4555,root,root)                   %{_prefix}/bin/vuserinfo
%attr(4555,root,root)                   %{_prefix}/bin/vrenamedomain
%attr(4555,root,root)                   %{_prefix}/bin/vmoduser
%attr(4555,root,root)                   %{_prefix}/bin/vcfilter
%attr(4555,root,root)                   %{_prefix}/bin/vsetuserquota
%attr(4555,root,root)                   %{_prefix}/bin/vaddaliasdomain
%attr(4511,qscand,qscand)               %{_prefix}/bin/qscanq
%attr(4555,root,root)                   %{_prefix}/bin/vadduser
%attr(4555,root,root)                   %{_prefix}/bin/printdir
%attr(4555,root,root)                   %{_prefix}/bin/vdeluser
%attr(4555,root,root)                   %{_prefix}/bin/vbulletin
%attr(4555,root,root)                   %{_prefix}/bin/vdominfo
%attr(4555,root,root)                   %{_prefix}/bin/vadddomain
%attr(4555,root,root)                   %{_prefix}/bin/vdeldomain
%attr(2511,root,qscand)                 %{_prefix}/bin/run-cleanq
%attr(4555,root,root)                   %{_prefix}/sbin/systpass

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vdeluser
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vadduser
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vaddaliasdomain
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vrenamedomain
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vsetuserquota
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vmoveuser
%verify (not user group mode) %attr(6511, qscand, qmail)   %{_prefix}/bin/qhpsi
%verify (not user group mode) %attr(2511, root, qscand)    %{_prefix}/bin/run-cleanq
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vuserinfo
%verify (not user group mode) %attr(6511, qmailq, qmail)   %{_prefix}/bin/qmail-queue
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vdeldomain
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vadddomain
%if %nobogofilter == 0
%verify (not user group mode) %attr(6511, root, indimail)  %{_prefix}/bin/bogofilter
%endif
%verify (not user group mode) %attr(4555, qscand, qscand)  %{_prefix}/bin/qscanq
%verify (not user group mode) %attr(4511, root, root)      %{_prefix}/bin/vdominfo
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vrenameuser
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/printdir
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vmoduser
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vcfilter
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/bin/vbulletin
%verify (not user group mode) %attr(4555, root, qmail)     %{_prefix}/libexec/sq_vacation
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/libexec/authlib/authshadow
%verify (not user group mode) %attr(4555, root, root)      %{_prefix}/sbin/systpass
%verify (not user group mode) %attr(2555, alias, qmail)    %{_prefix}/alias
%verify (not user group mode) %attr(2755, indimail, qmail) %{_prefix}/autoturn
%endif
%endif

%attr(555,root,qmail)                   %{_prefix}/bin/logmonitor
%attr(555,root,qmail)                   %{_prefix}/bin/hostcntrl
%attr(555,root,qmail)                   %{_prefix}/bin/bogofilter-qfe
%attr(555,root,qmail)                   %{_prefix}/bin/vpasswd
%attr(555,root,qmail)                   %{_prefix}/bin/displaytop
%attr(555,root,qmail)                   %{_prefix}/bin/resetquota
%attr(555,root,qmail)                   %{_prefix}/bin/vcalias
%attr(555,root,qmail)                   %{_prefix}/bin/vhostid
%attr(555,root,qmail)                   %{_prefix}/bin/vatrn
%attr(555,root,qmail)                   %{_prefix}/bin/indiversion
%attr(555,root,qmail)                   %{_prefix}/bin/vlimit
%attr(555,root,qmail)                   %{_prefix}/bin/crypt
%attr(555,root,qmail)                   %{_prefix}/bin/vpriv
%attr(555,root,qmail)                   %{_prefix}/bin/vipmap
%attr(555,root,qmail)                   %{_prefix}/bin/vsmtp
%attr(555,root,qmail)                   %{_prefix}/bin/vgroup
%attr(555,root,qmail)                   %{_prefix}/bin/vadduserl
%attr(555,root,qmail)                   %{_prefix}/bin/vcaliasrev
%attr(555,root,qmail)                   %{_prefix}/bin/hashtable
%attr(555,root,qmail)                   %{_prefix}/bin/vacation
%attr(555,root,qmail)                   %{_prefix}/bin/proxyimap
%attr(555,root,qmail)                   %{_prefix}/bin/proxypop3
%attr(555,root,qmail)                   %{_prefix}/bin/crc
%attr(555,root,qmail)                   %{_prefix}/bin/echo
%attr(555,root,qmail)                   %{_prefix}/bin/versioninfo
%attr(555,root,qmail)                   %{_prefix}/bin/mailzipper
%attr(555,root,qmail)                   %{_prefix}/sbin/vserverinfo
%attr(555,root,qmail)                   %{_prefix}/sbin/adminclient
%attr(555,root,qmail)                   %{_prefix}/sbin/chowkidar
%attr(555,root,qmail)                   %{_prefix}/sbin/cindimail
%attr(555,root,qmail)                   %{_prefix}/sbin/clearopensmtp
%attr(555,root,qmail)                   %{_prefix}/sbin/config_settings
%attr(555,root,qmail)                   %{_prefix}/sbin/controlsync
%attr(555,root,qmail)                   %{_prefix}/sbin/copyemail
%attr(555,root,qmail)                   %{_prefix}/sbin/cputime
%attr(555,root,qmail)                   %{_prefix}/sbin/execmysql
%attr(555,root,qmail)                   %{_prefix}/sbin/hostsync
%attr(555,root,qmail)                   %{_prefix}/sbin/indisrvr
%attr(555,root,qmail)                   %{_prefix}/sbin/initsvc
%attr(555,root,qmail)                   %{_prefix}/sbin/inlookup
%attr(555,root,qmail)                   %{_prefix}/sbin/inquerytest
%attr(555,root,qmail)                   %{_prefix}/sbin/install_tables
%attr(555,root,qmail)                   %{_prefix}/sbin/vtable
%attr(555,root,qmail)                   %{_prefix}/sbin/ipchange
%attr(555,root,qmail)                   %{_prefix}/sbin/mail_report
%attr(555,root,qmail)                   %{_prefix}/sbin/mgmtpass
%attr(555,root,qmail)                   %{_prefix}/sbin/myslave
%attr(555,root,qmail)                   %{_prefix}/sbin/svctool
%attr(555,root,qmail)                   %{_prefix}/sbin/get-cert
%attr(555,root,qmail)                   %{_prefix}/sbin/create_services
%attr(555,root,qmail)                   %{_prefix}/sbin/tls-cert-check
%attr(555,root,qmail)                   %{_prefix}/sbin/testmra
%attr(555,root,qmail)                   %{_prefix}/sbin/updatefile
%attr(555,root,qmail)                   %{_prefix}/sbin/updaterules
%attr(555,root,qmail)                   %{_prefix}/sbin/vchkpass
%attr(555,root,qmail)                   %{_prefix}/sbin/vsetpass
%attr(555,root,qmail)                   %{_prefix}/sbin/vdelivermail
%attr(555,root,qmail)                   %{_prefix}/sbin/vdeloldusers
%attr(555,root,qmail)                   %{_prefix}/sbin/vfilter
%attr(555,root,qmail)                   %{_prefix}/sbin/vfstab
%attr(555,root,qmail)                   %{_prefix}/sbin/vmoddomain
%attr(555,root,qmail)                   %{_prefix}/sbin/vreorg
%attr(555,root,qmail)                   %{_prefix}/sbin/osh
%attr(555,root,qmail)                   %{_prefix}/sbin/postdel

%attr(555,root,qmail)                   %{_prefix}/bin/qmail-popbull
%attr(555,root,qmail)                   %{_prefix}/bin/cleanq
%attr(555,root,qmail)                   %{_prefix}/bin/zsuccesses
%attr(555,root,qmail)                   %{_prefix}/bin/ofmipd
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-queue-print
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-lagcheck
%attr(555,root,qmail)                   %{_prefix}/bin/mbox2maildir.pl
%attr(555,root,qmail)                   %{_prefix}/bin/deferrals
%attr(555,root,qmail)                   %{_prefix}/bin/maildirwatch
%attr(555,root,qmail)                   %{_prefix}/bin/bouncesaying
%attr(511,root,qmail)                   %{_prefix}/bin/relaytest
%attr(555,root,qmail)                   %{_prefix}/bin/checkaddr
%attr(555,root,qmail)                   %{_prefix}/bin/rsmtprecipients
%attr(555,root,qmail)                   %{_prefix}/bin/autoresponder
%attr(555,root,qmail)                   %{_prefix}/bin/idedit
%attr(555,root,qmail)                   %{_prefix}/bin/svstat
%attr(555,root,qmail)                   %{_prefix}/bin/ddist
%attr(555,root,qmail)                   %{_prefix}/bin/smtp-matchup
%attr(500,root,qmail)                   %{_prefix}/bin/qmail-newu
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-pw2u
%attr(555,root,qmail)                   %{_prefix}/bin/qfilelog
%attr(555,root,qmail)                   %{_prefix}/bin/checkdomain
%attr(555,root,qmail)                   %{_prefix}/bin/svok
%attr(555,root,qmail)                   %{_prefix}/bin/maildirqmtp
%attr(555,root,qmail)                   %{_prefix}/bin/qmailctl
%attr(500,root,qmail)                   %{_prefix}/bin/qmail-lspawn
%attr(555,root,qmail)                   %{_prefix}/bin/dnstxt
%attr(555,root,qmail)                   %{_prefix}/bin/dnsmxip
%attr(555,root,qmail)                   %{_prefix}/bin/dnsfq
%attr(555,root,qmail)                   %{_prefix}/bin/dnsptr
%attr(555,root,qmail)                   %{_prefix}/bin/dnsip
%attr(555,root,qmail)                   %{_prefix}/bin/dnscname
%attr(555,root,qmail)                   %{_prefix}/bin/printmaillist
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-todo
%attr(555,root,qmail)                   %{_prefix}/bin/tai64nunix
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-tcpto
%attr(555,root,qmail)                   %{_prefix}/bin/newinclude
%attr(555,root,qmail)                   %{_prefix}/bin/recordio
%attr(555,root,qmail)                   %{_prefix}/bin/logselect
%attr(555,root,qmail)                   %{_prefix}/bin/teepipe
%attr(555,root,qmail)                   %{_prefix}/bin/ipmeprint
%attr(555,root,qmail)                   %{_prefix}/bin/uacl
%attr(555,root,qmail)                   %{_prefix}/bin/envdir
%attr(555,root,qmail)                   %{_prefix}/bin/zrecipients
%attr(555,root,qmail)                   %{_prefix}/bin/xsender
%attr(555,root,qmail)                   %{_prefix}/bin/rxdelay
%attr(555,root,qmail)                   %{_prefix}/bin/cdbmake
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-remote
%attr(555,root,qmail)                   %{_prefix}/bin/pinq
%attr(555,root,qmail)                   %{_prefix}/bin/mlmatchup
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-send
%attr(555,root,qmail)                   %{_prefix}/bin/sendmail
%attr(555,root,qmail)                   %{_prefix}/bin/rmail
%attr(555,root,qmail)                   %{_prefix}/bin/dbinfo
%attr(555,root,qmail)                   %{_prefix}/bin/sslerator
%attr(555,root,qmail)                   %{_prefix}/bin/ifaddr
%attr(555,root,qmail)                   %{_prefix}/bin/svscan
%attr(555,root,qmail)                   %{_prefix}/bin/matchup
%attr(555,root,qmail)                   %{_prefix}/bin/zspam
%attr(555,root,qmail)                   %{_prefix}/bin/recipients
%attr(555,root,qmail)                   %{_prefix}/bin/update_tmprsadh
%attr(555,root,qmail)                   %{_prefix}/bin/softlimit
%attr(555,root,qmail)                   %{_prefix}/bin/setforward
%attr(555,root,qmail)                   %{_prefix}/bin/cdbdump
%attr(555,root,qmail)                   %{_prefix}/bin/iftocc
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-qmqpc
%attr(555,root,qmail)                   %{_prefix}/bin/serialqmtp
%attr(555,root,qmail)                   %{_prefix}/bin/altermime
%attr(555,root,qmail)                   %{_prefix}/bin/rsmtprdomains
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-getpw
%attr(555,root,qmail)                   %{_prefix}/bin/balance_outgoing
%attr(555,root,qmail)                   %{_prefix}/bin/rsmtpfailures
%attr(555,root,qmail)                   %{_prefix}/bin/fghack
%attr(555,root,qmail)                   %{_prefix}/bin/cdbmake-sv
%attr(555,root,qmail)                   %{_prefix}/bin/svscanboot
%attr(555,root,qmail)                   %{_prefix}/bin/successes
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-sigterm
%attr(555,root,qmail)                   %{_prefix}/bin/spipe
%attr(555,root,qmail)                   %{_prefix}/bin/delcr
%attr(555,root,qmail)                   %{_prefix}/bin/svc
%attr(555,root,qmail)                   %{_prefix}/bin/setmaillist
%attr(555,root,qmail)                   %{_prefix}/bin/zrxdelay
%attr(555,root,qmail)                   %{_prefix}/bin/maildirdeliver
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-showctl
%attr(555,root,qmail)                   %{_prefix}/bin/envmigrate
%attr(555,root,qmail)                   %{_prefix}/bin/rspamrdomain
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-sighup
%attr(555,root,qmail)                   %{_prefix}/bin/multilog-matchup
%attr(511,root,qmail)                   %{_prefix}/bin/splogger
%attr(555,root,qmail)                   %{_prefix}/bin/mbox2maildir
%attr(555,root,qmail)                   %{_prefix}/bin/printforward
%attr(555,root,qmail)                   %{_prefix}/bin/zddist
%attr(555,root,qmail)                   %{_prefix}/bin/elq
%attr(500,root,qmail)                   %{_prefix}/bin/qmail-newmrh
%attr(555,root,qmail)                   %{_prefix}/bin/supervise
%attr(555,root,qmail)                   %{_prefix}/bin/preline
%attr(555,root,qmail)                   %{_prefix}/bin/cdbget
%attr(555,root,qmail)                   %{_prefix}/bin/cdbgetm
%attr(555,root,qmail)                   %{_prefix}/bin/atrn
%attr(555,root,qmail)                   %{_prefix}/bin/cdbstats
%attr(555,root,qmail)                   %{_prefix}/bin/zsenders
%attr(500,root,qmail)                   %{_prefix}/bin/instcheck
%attr(555,root,qmail)                   %{_prefix}/bin/suids
%attr(555,root,qmail)                   %{_prefix}/bin/maildirserial
%attr(500,root,qmail)                   %{_prefix}/bin/qmail-start
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-popup
%attr(555,root,qmail)                   %{_prefix}/bin/ofmipname
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-local
%attr(555,root,qmail)                   %{_prefix}/bin/serialsmtp
%attr(555,root,qmail)                   %{_prefix}/bin/predate
%attr(555,root,qmail)                   %{_prefix}/bin/condredirect
%attr(555,root,qmail)                   %{_prefix}/bin/fastforward
%attr(555,root,qmail)                   %{_prefix}/bin/rspamsdomain
%attr(555,root,qmail)                   %{_prefix}/bin/newaliases
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-rm
%attr(555,root,qmail)                   %{_prefix}/bin/zsmtp
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-pop3d
%attr(555,root,qmail)                   %{_prefix}/bin/zoverall
%attr(555,root,qmail)                   %{_prefix}/bin/randstr
%attr(555,root,qmail)                   %{_prefix}/bin/xqp
%attr(555,root,qmail)                   %{_prefix}/bin/dot-forward
%attr(555,root,qmail)                   %{_prefix}/bin/datemail
%attr(555,root,qmail)                   %{_prefix}/bin/base64
%attr(555,root,qmail)                   %{_prefix}/bin/swaks
%attr(555,root,qmail)                   %{_prefix}/bin/rhosts
%attr(555,root,qmail)                   %{_prefix}/bin/replier
%attr(500,root,qmail)                   %{_prefix}/bin/qmail-cdb
%attr(500,root,qmail)                   %{_prefix}/bin/qmail-sql
%attr(555,root,qmail)                   %{_prefix}/bin/cdbtest
%attr(555,root,qmail)                   %{_prefix}/bin/tai64n
%attr(555,root,qmail)                   %{_prefix}/bin/qmaildirmake
%attr(555,root,qmail)                   %{_prefix}/bin/maildir2mbox
%attr(555,root,qmail)                   %{_prefix}/bin/columnt
%attr(555,root,qmail)                   %{_prefix}/bin/zrhosts
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-smtpd
%attr(555,root,qmail)                   %{_prefix}/bin/qarf
%attr(555,root,qmail)                   %{_prefix}/bin/qaes
%attr(555,root,qmail)                   %{_prefix}/bin/qnotify
%attr(555,root,qmail)                   %{_prefix}/bin/rrt
%attr(555,root,qmail)                   %{_prefix}/bin/greydaemon
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-greyd
%attr(555,root,qmail)                   %{_prefix}/bin/drate
%attr(555,root,qmail)                   %{_prefix}/bin/cidr
%attr(555,root,qmail)                   %{_prefix}/bin/spawn-filter
%attr(555,root,qmail)                   %{_prefix}/bin/tcp-env
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-lint
%attr(555,root,qmail)                   %{_prefix}/bin/rrforward
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-dk
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-dkim
%attr(555,root,qmail)                   %{_prefix}/bin/dktest
%attr(555,root,qmail)                   %{_prefix}/bin/dk-filter
%attr(555,root,qmail)                   %{_prefix}/bin/dknewkey
%attr(555,root,qmail)                   %{_prefix}/bin/mailsubj
%attr(555,root,qmail)                   %{_prefix}/bin/condtomaildir
%attr(555,root,qmail)                   %{_prefix}/bin/crcdiff
%attr(555,root,qmail)                   %{_prefix}/bin/multirotate
%attr(555,root,qmail)                   %{_prefix}/bin/testzero
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-cat
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-poppass
%attr(555,root,qmail)                   %{_prefix}/bin/failures
%attr(555,root,qmail)                   %{_prefix}/bin/rsmtp
%attr(555,root,qmail)                   %{_prefix}/bin/qail
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-tcpok
%attr(555,root,qmail)                   %{_prefix}/bin/qpq
%attr(555,root,qmail)                   %{_prefix}/bin/replier-config
%attr(555,root,qmail)                   %{_prefix}/bin/etrn
%attr(555,root,qmail)                   %{_prefix}/bin/forward
%attr(555,root,qmail)                   %{_prefix}/bin/new-inject
%attr(555,root,qmail)                   %{_prefix}/bin/filterto
%attr(555,root,qmail)                   %{_prefix}/bin/ripmime
%attr(555,root,qmail)                   %{_prefix}/bin/stripmime.pl
%attr(555,root,qmail)                   %{_prefix}/bin/fixcrio
%attr(555,root,qmail)                   %{_prefix}/bin/qscanq-stdin
%attr(555,root,qmail)                   %{_prefix}/bin/rsmtpsenders
%attr(555,root,qmail)                   %{_prefix}/bin/queue-fix
%attr(555,root,qmail)                   %{_prefix}/bin/readproctitle
%attr(555,root,qmail)                   %{_prefix}/bin/zdeferrals
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-scanner-queue.pl
%attr(555,root,qmail)                   %{_prefix}/bin/rspamstat
%attr(555,root,qmail)                   %{_prefix}/bin/iftoccfrom
%attr(555,root,qmail)                   %{_prefix}/bin/zsuids
%attr(555,root,qmail)                   %{_prefix}/bin/setlock
%attr(555,root,qmail)                   %{_prefix}/bin/qreceipt
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-qmqpd
%attr(555,root,qmail)                   %{_prefix}/bin/multitail
%attr(555,root,qmail)                   %{_prefix}/bin/except
%attr(555,root,qmail)                   %{_prefix}/bin/maildirsmtp
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-clean
%attr(511,root,qmail)                   %{_prefix}/bin/qmail-rspawn
%attr(555,root,qmail)                   %{_prefix}/bin/pgrphack
%attr(555,root,qmail)                   %{_prefix}/bin/xrecipient
%attr(555,root,qmail)                   %{_prefix}/bin/argv0
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-qmtpd
%attr(555,root,qmail)                   %{_prefix}/bin/addcr
%attr(555,root,qmail)                   %{_prefix}/bin/qsmhook
%attr(555,root,qmail)                   %{_prefix}/bin/rspamhist
%attr(500,root,qmail)                   %{_prefix}/bin/recipient-cdb
%attr(555,root,qmail)                   %{_prefix}/bin/rsmtpsdomains
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-inject
%attr(555,root,qmail)                   %{_prefix}/bin/serialcmd
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-qread
%attr(555,root,qmail)                   %{_prefix}/bin/zfailures
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-nullqueue
%attr(500,root,qmail)                   %{_prefix}/bin/qmail-daemon
%attr(555,root,qmail)                   %{_prefix}/bin/zsendmail
%attr(555,root,qmail)                   %{_prefix}/bin/multipipe
%attr(555,root,qmail)                   %{_prefix}/bin/cdbmake-12
%attr(555,root,qmail)                   %{_prefix}/bin/multilog
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-multi
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-qfilter
%attr(555,root,qmail)                   %{_prefix}/bin/srsfilter
%attr(555,root,qmail)                   %{_prefix}/bin/surblfilter
%attr(555,root,qmail)                   %{_prefix}/bin/surblqueue
%attr(555,root,qmail)                   %{_prefix}/bin/qmail-sigalrm
%attr(555,root,qmail)                   %{_prefix}/bin/rpmattr
%attr(555,root,qmail)                   %{_prefix}/bin/senders
%attr(555,root,qmail)                   %{_prefix}/bin/setuidgid
%attr(555,root,qmail)                   %{_prefix}/bin/spfquery
%attr(555,root,qmail)                   %{_prefix}/bin/tai64nlocal
%attr(555,root,qmail)                   %{_prefix}/bin/envuidgid
%attr(555,root,qmail)                   %{_prefix}/bin/maildircmd

%attr(555,root,qmail)                   %{_prefix}/bin/822headerfilter
%attr(555,root,qmail)                   %{_prefix}/bin/822print
%attr(555,root,qmail)                   %{_prefix}/bin/822date
%attr(555,root,qmail)                   %{_prefix}/bin/822headerok
%attr(555,root,qmail)                   %{_prefix}/bin/822addr
%attr(555,root,qmail)                   %{_prefix}/bin/822fields
%attr(555,root,qmail)                   %{_prefix}/bin/822bodyfilter
%attr(555,root,qmail)                   %{_prefix}/bin/822header
%attr(555,root,qmail)                   %{_prefix}/bin/822field
%attr(555,root,qmail)                   %{_prefix}/bin/822body
%attr(555,root,qmail)                   %{_prefix}/bin/822received

%attr(555,root,qmail)                   %{_prefix}/sbin/hostname
%attr(555,root,qmail)                   %{_prefix}/sbin/config-fast
%attr(555,root,qmail)                   %{_prefix}/sbin/qmailconfig
%attr(555,root,qmail)                   %{_prefix}/sbin/batv
%attr(555,root,qmail)                   %{_prefix}/sbin/plugtest
%attr(555,root,qmail)                   %{_prefix}/sbin/sys-checkpwd
%attr(555,root,qmail)                   %{_prefix}/sbin/ldap-checkpwd

%if %nonssd == 0
%attr(555,root,qmail)                   %{_prefix}/sbin/nssd
%attr(555,root,qmail)                   %{_prefix}/sbin/check_getpw
%endif

%attr(555,root,qmail)                   %{_prefix}/bin/mpack
%attr(555,root,qmail)                   %{_prefix}/bin/munpack
%attr(555,root,qmail)                   %{_prefix}/bin/fortune
%attr(555,root,qmail)                   %{_prefix}/sbin/rot
%attr(555,root,qmail)                   %{_prefix}/sbin/strfile
%attr(555,root,qmail)                   %{_prefix}/sbin/unstr

%attr(555,root,qmail)                   %{_prefix}/bin/ismaildup
%attr(555,root,qmail)                   %{_prefix}/bin/flash
%attr(555,root,qmail)                   %{_prefix}/bin/ripole
%attr(555,root,qmail)                   %{_prefix}/bin/valias
%attr(555,root,qmail)                   %{_prefix}/bin/vproxy
%attr(555,root,qmail)                   %{_prefix}/libexec/vadddomain
%attr(555,root,qmail)                   %{_prefix}/libexec/vaddaliasdomain
%attr(555,root,qmail)                   %{_prefix}/libexec/vrenamedomain
%attr(555,root,qmail)                   %{_prefix}/libexec/vdeldomain
%attr(555,root,qmail)                   %{_prefix}/libexec/vadduser
%attr(555,root,qmail)                   %{_prefix}/libexec/overquota.sh
%attr(555,root,qmail)                   %{_prefix}/libexec/qmailmrtg7
%attr(4555,root,qmail)                  %{_prefix}/libexec/sq_vacation

%if %nocourierimap == 0
# courier imap
%attr(555,root,root)                    %{_prefix}/bin/maildirmake
%attr(555,root,root)                    %{_prefix}/bin/maildirkw
%attr(555,root,root)                    %{_prefix}/bin/deliverquota
%attr(555,root,root)                    %{_prefix}/bin/couriertls
%attr(555,root,root)                    %{_prefix}/bin/maildiracl
%attr(555,root,root)                    %{_prefix}/bin/imapd
%attr(555,root,root)                    %{_prefix}/bin/pop3d
%attr(555,root,root)                    %{_prefix}/sbin/imaplogin
%attr(555,root,root)                    %{_prefix}/sbin/pop3login
%attr(555,root,root)                    %{_prefix}/sbin/sharedindexinstall
%attr(555,root,root)                    %{_prefix}/sbin/sharedindexsplit
#
                                        %{_prefix}/sbin/mkimapdcert
                                        %{_prefix}/sbin/mkpop3dcert
#
%if %i_m_on_mac == 0
%attr(4555,root,root)                   %{_prefix}/libexec/authlib/authshadow
%endif
%endif
# ucspi-tcp
%attr(555,root,root)                    %{_prefix}/bin/mconnect-io
%attr(555,root,root)                    %{_prefix}/bin/rblsmtpd
%attr(555,root,root)                    %{_prefix}/bin/tcprulescheck
%attr(555,root,root)                    %{_prefix}/bin/tcpcat
%attr(555,root,root)                    %{_prefix}/bin/date@
%attr(555,root,root)                    %{_prefix}/bin/who@
%attr(555,root,root)                    %{_prefix}/bin/tcpclient
%attr(555,root,root)                    %{_prefix}/bin/tcpserver
%attr(555,root,root)                    %{_prefix}/bin/mconnect
%attr(555,root,root)                    %{_prefix}/bin/finger@
%attr(555,root,root)                    %{_prefix}/bin/http@
%attr(555,root,root)                    %{_prefix}/bin/tcprules
# bogofilter
%if %nobogofilter == 0
%attr(6511,root,indimail)               %{_prefix}/bin/bogofilter
%attr(555,root,root)                    %{_prefix}/bin/bogolexer
%attr(555,root,root)                    %{_prefix}/bin/bogotune
%attr(555,root,root)                    %{_prefix}/bin/bogoutil
%attr(555,root,root)                    %{_prefix}/bin/bogoupgrade
%attr(555,root,root)                    %{_prefix}/sbin/bf_compact
%attr(555,root,root)                    %{_prefix}/sbin/bf_copy
%attr(555,root,root)                    %{_prefix}/sbin/bf_tar
%endif

%if %nolibdkim == 0
%attr(555,root,root)                    %{_prefix}/bin/dkim
%endif

%if %nolibsrs2 == 0
%attr(555,root,root)                    %{_prefix}/bin/srs
%endif

# clamav
%if %noclamav == 0
%attr(555,root,root)                    %{_prefix}/bin/sigtool
%attr(555,root,root)                    %{_prefix}/bin/clamav-config
%attr(555,root,root)                    %{_prefix}/bin/clamscan
%attr(555,root,root)                    %{_prefix}/bin/clamdscan
%attr(555,root,root)                    %{_prefix}/bin/clambc
%attr(555,root,root)                    %{_prefix}/bin/clamdtop
%attr(555,root,root)                    %{_prefix}/bin/freshclam
%attr(555,root,root)                    %{_prefix}/sbin/clamd
%attr(555,root,root)                    %{_prefix}/bin/clamconf
%endif
# logalert
%attr(555,root,root)                    %{_prefix}/bin/logalert
%attr(0511,root,root)                   %{_prefix}/bin/logclient
%attr(0511,root,root)                   %{_prefix}/bin/incrmesg
%attr(0511,root,root)                   %{_prefix}/bin/showbytes
%attr(0511,root,root)                   %{_prefix}/sbin/rpclog
%attr(0511,root,root)                   %{_prefix}/sbin/logsrv

# fetchmail
%if %nofetchmail == 0
%attr(555,root,root)                    %{_prefix}/bin/fetchmailconf
%attr(555,root,root)                    %{_prefix}/bin/fetchmail
%attr(555,root,root)                    %{_prefix}/sbin/fetchmail.cron
%attr(555,root,root)                    %{_prefix}/sbin/fetchmail.down
%attr(555,root,root)                    %{_prefix}/sbin/fetchmail.up
%attr(555,root,root)                    %{_prefix}/sbin/fixwvdialconf
%attr(555,root,root)                    %{_prefix}/sbin/ip-down.local
%attr(555,root,root)                    %{_prefix}/sbin/ip-up.local
%attr(555,root,root)                    %{_prefix}/sbin/ppp-off
%attr(555,root,root)                    %{_prefix}/sbin/slemsPrivate
%attr(555,root,root)                    %{_prefix}/sbin/writefifo
%endif

# pam-multi
%attr(555,root,root)                    %{_prefix}/sbin/pam-checkpwd
%attr(644,root,root) %config(noreplace) %{pam_confdir}/pam-multi
%attr(644,root,root) %config(noreplace) %{pam_confdir}/pop3
%attr(644,root,root) %config(noreplace) %{pam_confdir}/imap

%attr(555,root,qmail)                   %{_prefix}/boot/binm2
%attr(555,root,qmail)                   %{_prefix}/boot/proc+df
%attr(555,root,qmail)                   %{_prefix}/boot/binm1+df
%attr(555,root,qmail)                   %{_prefix}/boot/binm3+df
%attr(555,root,qmail)                   %{_prefix}/boot/home+df
%attr(555,root,qmail)                   %{_prefix}/boot/binm3
%attr(555,root,qmail)                   %{_prefix}/boot/binm1
%attr(555,root,qmail)                   %{_prefix}/boot/proc
%attr(555,root,qmail)                   %{_prefix}/boot/home
%attr(555,root,qmail)                   %{_prefix}/boot/binm2+df
%attr(444,root,qmail)                   %{_prefix}/boot/upstart
%attr(444,root,qmail)                   %{_prefix}/boot/systemd
%if %i_m_on_mac == 1
%attr(444,root,qmail)                   %{_prefix}/boot/StartupParameters.plist
%attr(444,root,qmail)                   %{_prefix}/boot/indimail.plist
%endif

%if %nocourierimap == 0
%attr(555,root,root)                    %{_prefix}/libexec/pop3d-ssl.rc
%attr(555,root,root)                    %{_prefix}/libexec/makedatprog
%attr(555,root,root)                    %{_prefix}/libexec/imapd-ssl.rc
%attr(555,root,root)                    %{_prefix}/libexec/couriertcpd
%attr(555,root,root)                    %{_prefix}/libexec/imapd.rc
%attr(555,root,root)                    %{_prefix}/libexec/pop3d.rc
%attr(555,root,root)                    %{_prefix}/share/mkimapdcert
%attr(555,root,root)                    %{_prefix}/share/mkpop3dcert
%endif
%attr(555,root,root)                    %{_prefix}/libexec/authlib/authindi
%attr(555,root,root)                    %{_prefix}/libexec/authlib/authpgsql
%attr(555,root,root)                    %{_prefix}/libexec/authlib/authgeneric

%attr(555,root,qmail)                   %{_prefix}/plugins/generic.so
%attr(555,root,qmail)                   %{_prefix}/plugins/smtpd-plugin.so
%attr(555,root,qmail)                   %{_prefix}/plugins/smtpd-plugin0.so

%attr(555,root,root)                    %{_prefix}/modules/background
%attr(555,root,root)                    %{_prefix}/modules/alarms
%attr(555,root,root)                    %{_prefix}/modules/countdown
%attr(555,root,root)                    %{_prefix}/modules/iauth.so

%attr(644,root,root)                    %{_prefix}/share/fortunes/definitions
%attr(644,root,root)                    %{_prefix}/share/fortunes/linux.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/food
%attr(644,root,root)                    %{_prefix}/share/fortunes/medicine
%attr(644,root,root)                    %{_prefix}/share/fortunes/magic
%attr(644,root,root)                    %{_prefix}/share/fortunes/ethnic
%attr(644,root,root)                    %{_prefix}/share/fortunes/art.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/computers.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/songs-poems.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/kids
%attr(644,root,root)                    %{_prefix}/share/fortunes/goedel
%attr(644,root,root)                    %{_prefix}/share/fortunes/paradoxum
%attr(644,root,root)                    %{_prefix}/share/fortunes/computers
%attr(644,root,root)                    %{_prefix}/share/fortunes/goedel.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/news
%attr(644,root,root)                    %{_prefix}/share/fortunes/pets
%attr(644,root,root)                    %{_prefix}/share/fortunes/law.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/zippy
%attr(644,root,root)                    %{_prefix}/share/fortunes/miscellaneous
%attr(644,root,root)                    %{_prefix}/share/fortunes/ascii-art.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/perl
%attr(644,root,root)                    %{_prefix}/share/fortunes/kids.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/love.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/work.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/humorists
%attr(644,root,root)                    %{_prefix}/share/fortunes/definitions.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/drugs
%attr(644,root,root)                    %{_prefix}/share/fortunes/education.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/politics.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/science.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/love
%attr(644,root,root)                    %{_prefix}/share/fortunes/men-women
%attr(644,root,root)                    %{_prefix}/share/fortunes/ascii-art
%attr(644,root,root)                    %{_prefix}/share/fortunes/humorists.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/platitudes.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/debian
%attr(644,root,root)                    %{_prefix}/share/fortunes/sports.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/riddles
%attr(644,root,root)                    %{_prefix}/share/fortunes/law
%attr(644,root,root)                    %{_prefix}/share/fortunes/knghtbrd.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/sports
%attr(644,root,root)                    %{_prefix}/share/fortunes/perl.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/tao.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/linuxcookie
%attr(644,root,root)                    %{_prefix}/share/fortunes/linuxcookie.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/riddles.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/medicine.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/fortunes
%attr(644,root,root)                    %{_prefix}/share/fortunes/cookie
%attr(644,root,root)                    %{_prefix}/share/fortunes/cookie.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/art
%attr(644,root,root)                    %{_prefix}/share/fortunes/politics
%attr(644,root,root)                    %{_prefix}/share/fortunes/songs-poems
%attr(644,root,root)                    %{_prefix}/share/fortunes/startrek.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/men-women.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/kernelnewbies
%attr(644,root,root)                    %{_prefix}/share/fortunes/fortunes.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/magic.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/science
%attr(644,root,root)                    %{_prefix}/share/fortunes/platitudes
%attr(644,root,root)                    %{_prefix}/share/fortunes/kernelnewbies.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/literature.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/translate-me
%attr(644,root,root)                    %{_prefix}/share/fortunes/startrek
%attr(644,root,root)                    %{_prefix}/share/fortunes/drugs.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/zippy.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/linux
%attr(644,root,root)                    %{_prefix}/share/fortunes/work
%attr(644,root,root)                    %{_prefix}/share/fortunes/literature
%attr(644,root,root)                    %{_prefix}/share/fortunes/knghtbrd
%attr(644,root,root)                    %{_prefix}/share/fortunes/news.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/paradoxum.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/bofh-excuses.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/translate-me.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/miscellaneous.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/rj.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/debian.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/tao
%attr(644,root,root)                    %{_prefix}/share/fortunes/food.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/ethnic.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/people.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/people
%attr(644,root,root)                    %{_prefix}/share/fortunes/wisdom.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/rj
%attr(644,root,root)                    %{_prefix}/share/fortunes/wisdom
%attr(644,root,root)                    %{_prefix}/share/fortunes/pets.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/bofh-excuses
%attr(644,root,root)                    %{_prefix}/share/fortunes/education
%attr(644,root,root)                    %{_prefix}/share/fortunes/age
%attr(644,root,root)                    %{_prefix}/share/fortunes/age.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/chanakya
%attr(644,root,root)                    %{_prefix}/share/fortunes/chanakya.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/joel-on-software
%attr(644,root,root)                    %{_prefix}/share/fortunes/joel-on-software.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/osp
%attr(644,root,root)                    %{_prefix}/share/fortunes/osp.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/paul-graham
%attr(644,root,root)                    %{_prefix}/share/fortunes/paul-graham.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/thirukkural
%attr(644,root,root)                    %{_prefix}/share/fortunes/thirukkural.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/vedas-1
%attr(644,root,root)                    %{_prefix}/share/fortunes/vedas-1.dat
%attr(644,root,root)                    %{_prefix}/share/fortunes/vedas-2
%attr(644,root,root)                    %{_prefix}/share/fortunes/vedas-2.dat

%if %noclamav == 0
%if %nosignatures == 0
%ghost                   %config(noreplace) %{_prefix}/share/clamd/clamav*
%ghost                   %config(noreplace) %{_prefix}/share/clamd/mirrors.dat
%attr(664,qscand,qscand) %config(noreplace) %{_prefix}/share/clamd/main.cvd
%attr(664,qscand,qscand) %config(noreplace) %{_prefix}/share/clamd/daily.cvd
%endif
%attr(644,root,root)                        %{_prefix}/etc/clamd.conf.sample
%attr(644,root,root)                        %{_prefix}/etc/freshclam.conf.sample
%attr(644,root,root)                        %{_libdir}/pkgconfig/libclamav.pc
%endif

%if %nofetchmail == 0
%if %i_m_on_mac == 0
%attr(644,root,root)                    %{_prefix}/share/locale/*/LC_MESSAGES/*.mo
%endif
%attr(644,root,root)                    %{_prefix}/lib*/python*/site-packages/fetchmailconf.pyo
%attr(555,root,root)                    %{_prefix}/lib*/python*/site-packages/fetchmailconf.py
%attr(644,root,root)                    %{_prefix}/lib*/python*/site-packages/fetchmailconf.pyc
%endif

%docdir %{_prefix}/doc
%docdir %{_prefix}/man
%attr(444,root,qmail)                   %{_prefix}/man/man[1,4,5,8]/*
%attr(444,root,qmail)                   %{_prefix}/man/cat[1,4,5,8]/*
%attr(444,root,qmail)                   %{_prefix}/man/cat7/forgeries.0.gz
%attr(444,root,qmail)                   %{_prefix}/man/cat7/qmail-limits.0.gz
%attr(444,root,qmail)                   %{_prefix}/man/cat7/qmail.0.gz
%attr(444,root,qmail)                   %{_prefix}/man/man7/IndiMail.7.gz
%attr(444,root,qmail)                   %{_prefix}/man/man7/forgeries.7.gz
%attr(444,root,qmail)                   %{_prefix}/man/man7/indimail.7.gz
%attr(444,root,qmail)                   %{_prefix}/man/man7/qmail-limits.7.gz
%attr(444,root,qmail)                   %{_prefix}/man/man7/qmail.7.gz
%attr(444,root,qmail)                   %{_prefix}/man/man7/authlib.7.gz
                                        %{_prefix}/man/man7/authcustom.7.gz
                                        %{_prefix}/man/man7/authpam.7.gz
                                        %{_prefix}/man/man7/authpwd.7.gz
                                        %{_prefix}/man/man7/authshadow.7.gz

%attr(444,root,qmail)                   %{_prefix}/doc/HOWTO.sharedmaildir
%attr(444,root,qmail)                   %{_prefix}/doc/README.auth
%attr(444,root,qmail)                   %{_prefix}/doc/README.clamav
%attr(444,root,qmail)                   %{_prefix}/doc/README.cdb
%attr(444,root,qmail)                   %{_prefix}/doc/README.filters
%attr(444,root,qmail)                   %{_prefix}/doc/README.greylist
%attr(444,root,qmail)                   %{_prefix}/doc/README.indimail
%attr(444,root,qmail)                   %{_prefix}/doc/README.logselect
%attr(444,root,qmail)                   %{_prefix}/doc/README.moreipme
%attr(444,root,qmail)                   %{_prefix}/doc/README.newline
%attr(444,root,qmail)                   %{_prefix}/doc/README.qhpsi
%attr(444,root,qmail)                   %{_prefix}/doc/README.qregex
%attr(444,root,qmail)                   %{_prefix}/doc/README.queue-fix
%attr(444,root,qmail)                   %{_prefix}/doc/README.qmail
%attr(444,root,qmail)                   %{_prefix}/doc/README.recipients
%attr(444,root,qmail)                   %{_prefix}/doc/README.remote-auth
%attr(444,root,qmail)                   %{_prefix}/doc/README.spamcontrol
%attr(444,root,qmail)                   %{_prefix}/doc/README.srs
%attr(444,root,qmail)                   %{_prefix}/doc/README.starttls
%attr(444,root,qmail)                   %{_prefix}/doc/README.status
%attr(444,root,qmail)                   %{_prefix}/doc/README.surbl
%attr(444,root,qmail)                   %{_prefix}/doc/README.tls
%attr(444,root,qmail)                   %{_prefix}/doc/README.wildmat
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.maildir
%attr(444,root,qmail)                   %{_prefix}/doc/TEST.receive
%attr(444,root,qmail)                   %{_prefix}/doc/README-CLUSTER
%attr(444,root,qmail)                   %{_prefix}/doc/Quick-INSTALL
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.indimail
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL-RPM
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL-MINI
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL-MYSQL
%attr(444,root,qmail)                   %{_prefix}/doc/RELEASE-Notes
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.alias
%attr(444,root,qmail)                   %{_prefix}/doc/ChangeLog
%attr(444,root,qmail)                   %{_prefix}/doc/UPGRADE
%attr(444,root,qmail)                   %{_prefix}/doc/percenthack.shtml
%attr(444,root,qmail)                   %{_prefix}/doc/README.vlimits
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.local2alias
%attr(444,root,qmail)                   %{_prefix}/doc/CREDITS
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.mbox
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.local2local
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.ids
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.qmail
%attr(444,root,qmail)                   %{_prefix}/doc/HOWTO.bogofilter
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.nullclient
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.rem2local
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.relaybad
%attr(444,root,qmail)                   %{_prefix}/doc/SENDMAIL
%attr(444,root,qmail)                   %{_prefix}/doc/37rules.pdf
%attr(444,root,qmail)                   %{_prefix}/doc/indimail_arch.png
%attr(444,root,qmail)                   %{_prefix}/doc/indimail_queue.png
%attr(444,root,qmail)                   %{_prefix}/doc/COPYING
%attr(444,root,qmail)                   %{_prefix}/doc/FAQ.pdf
%attr(444,root,qmail)                   %{_prefix}/doc/FROMISP
%attr(444,root,qmail)                   %{_prefix}/doc/README.mpack
%attr(444,root,qmail)                   %{_prefix}/doc/REMOVE.binmail
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.local2ext
%attr(444,root,qmail)                   %{_prefix}/doc/README
%attr(444,root,qmail)                   %{_prefix}/doc/REMOVE.sendmail
%attr(444,root,qmail)                   %{_prefix}/doc/AUTOTURN
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.vsm
%attr(444,root,qmail)                   %{_prefix}/doc/QMAILFAQ
%attr(444,root,qmail)                   %{_prefix}/doc/INTERNALS
%attr(444,root,qmail)                   %{_prefix}/doc/INSTALL.ctl
%attr(444,root,qmail)                   %{_prefix}/doc/TEST.deliver
%attr(444,root,qmail)                   %{_prefix}/doc/EXTTODO
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.local2virt
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.relaygood
%attr(444,root,qmail)                   %{_prefix}/doc/PIC.local2rem
%attr(444,root,qmail)                   %{_prefix}/doc/TOISP

# Shared libraries (omit for architectures that don't support them)

# pam-multi
%attr(755,root,root)                    /%{module_dir}/pam-multi.so

%if %noclamav == 0
%if %i_m_on_mac == 1
%{_libdir}/libclam*.dylib
%else
%{_libdir}/libclam*.so*
%endif
%endif

%if %nolibdkim == 0
%if %i_m_on_mac == 1
%{_libdir}/libdkim.dylib
%{_libdir}/libdkim-%{libdkim_version}.0.dylib
%else
%{_libdir}/libdkim.so
%{_libdir}/libdkim-%{libdkim_version}.so.0
%{_libdir}/libdkim-%{libdkim_version}.so.0.0.0
%endif
%endif

%if %nolibsrs2 == 0
%if %i_m_on_mac == 1
%{_libdir}/libsrs2.dylib
%{_libdir}/libsrs2-%{libsrs2_version}.0.dylib
%else
%{_libdir}/libsrs2.so
%{_libdir}/libsrs2-%{libsrs2_version}.so.0
%{_libdir}/libsrs2-%{libsrs2_version}.so.0.0.0
%endif
%endif

%if %i_m_on_mac == 1
%{_libdir}/libeps.dylib
%{_libdir}/libeps-%{eps_version}.0.dylib
%{_libdir}/libcdb.dylib
%{_libdir}/libcdb-%{cdb_version}.0.dylib
%{_libdir}/libflash.dylib
%{_libdir}/libflash-%{flash_version}.0.dylib
%{_libdir}/libindimail.dylib
%{_libdir}/libindimail-%{version}.0.dylib
%else
%{_libdir}/libeps.so
%{_libdir}/libeps-%{eps_version}.so.0
%{_libdir}/libeps-%{eps_version}.so.0.0.0
%{_libdir}/libcdb.so
%{_libdir}/libcdb-%{cdb_version}.so.0
%{_libdir}/libcdb-%{cdb_version}.so.0.0.0
%{_libdir}/libflash.so
%{_libdir}/libflash-%{flash_version}.so.0
%{_libdir}/libflash-%{flash_version}.so.0.0.0
%{_libdir}/libindimail.so
%{_libdir}/libindimail-%{version}.so.0
%{_libdir}/libindimail-%{version}.so.0.0.0
%endif

%if %nonssd == 0
                                        /usr/%{_lib}/libnss_nssd.so
                                        /usr/%{_lib}/libnss_nssd.so.2
%attr(755,root,root)                    /usr/%{_lib}/libnss_nssd.so.2.0.0
%endif

%files devel
%defattr(-, root, root, 0755)
%dir %attr(555,root,root)              %{_prefix}/include
%dir %attr(555,root,root)              %{_libdir}
%dir %attr(555,root,qmail)             %{_prefix}/man/man3
%doc %attr(444,root,qmail)             %{_prefix}/man/man3/*

%attr(644,root,qmail)                   %{_prefix}/etc/inc_deps
%attr(644,root,qmail)                   %{_prefix}/etc/lib_deps

%attr(644,root,qmail)                   %{_prefix}/include/eps_unroll.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_buffer.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_email.h
%attr(644,root,qmail)                   %{_prefix}/include/rfc2822.h
%attr(444,root,qmail)                   %{_prefix}/include/indimail.h
%attr(444,root,qmail)                   %{_prefix}/include/typesx.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_mime.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_boundary.h
%attr(444,root,qmail)                   %{_prefix}/include/indimail_config.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_roll.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_line.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_int_buffer.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_base64.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_misc.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_address.h
%attr(644,root,qmail)                   %{_prefix}/include/eps.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_interface.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_int_stream.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_header.h
%attr(644,root,qmail)                   %{_prefix}/include/eps_content.h
%attr(644,root,qmail)                   %{_prefix}/include/cdb.h
%attr(644,root,qmail)                   %{_prefix}/include/cdbmake.h
%attr(644,root,qmail)                   %{_prefix}/include/uint32.h

%if %noclamav == 0
%attr(644,root,qmail)                   %{_prefix}/include/clamav.h
%endif

%if %nolibdkim == 0
%attr(644,root,qmail)                   %{_prefix}/include/dkim.h
%attr(644,root,qmail)                   %{_prefix}/include/macros.h
%attr(644,root,qmail)                   %{_libdir}/libdkim.a
%endif

%if %nolibsrs2 == 0
%attr(644,root,qmail)                   %{_prefix}/include/srs2.h
%attr(644,root,qmail)                   %{_libdir}/libsrs2.a
%endif

%{_libdir}/libeps.a
%{_libdir}/libcdb.a
%{_libdir}/libflash.a
%{_libdir}/libindimail.a

%files shared
%defattr(-, root, root, 0755)
# Shared libraries (omit for architectures that don't support them)
%if %noclamav == 0
%if %i_m_on_mac == 1
%{_libdir}/libclam*.dylib
%else
%{_libdir}/libclam*.so*
%endif
%endif

%if %nolibdkim == 0
%if %i_m_on_mac == 1
%{_libdir}/libdkim.dylib
%{_libdir}/libdkim-%{libdkim_version}.0.dylib
%else
%{_libdir}/libdkim.so
%{_libdir}/libdkim-%{libdkim_version}.so.0
%{_libdir}/libdkim-%{libdkim_version}.so.0.0.0
%endif
%endif

%if %nolibsrs2 == 0
%if %i_m_on_mac == 1
%{_libdir}/libsrs2.dylib
%{_libdir}/libsrs2-%{libsrs2_version}.0.dylib
%else
%{_libdir}/libsrs2.so
%{_libdir}/libsrs2-%{libsrs2_version}.so.0
%{_libdir}/libsrs2-%{libsrs2_version}.so.0.0.0
%endif
%endif

%if %i_m_on_mac == 0
%{_libdir}/libeps.so
%{_libdir}/libeps-%{eps_version}.so.0
%{_libdir}/libeps-%{eps_version}.so.0.0.0
%{_libdir}/libcdb.so
%{_libdir}/libcdb-%{cdb_version}.so.0
%{_libdir}/libcdb-%{cdb_version}.so.0.0.0
%{_libdir}/libflash.so
%{_libdir}/libflash-%{flash_version}.so.0
%{_libdir}/libflash-%{flash_version}.so.0.0.0
%{_libdir}/libindimail.so
%{_libdir}/libindimail-%{version}.so.0
%{_libdir}/libindimail-%{version}.so.0.0.0
%else
%{_libdir}/libeps.dylib
%{_libdir}/libeps-%{eps_version}.0.dylib
%{_libdir}/libcdb.dylib
%{_libdir}/libcdb-%{cdb_version}.0.dylib
%{_libdir}/libflash.dylib
%{_libdir}/libflash-%{flash_version}.0.dylib
%{_libdir}/libindimail.dylib
%{_libdir}/libindimail-%{version}.0.dylib
%endif

%files mini
%defattr(-, root, root, 0555)
#
# Directories
#
%dir %attr(555,root,qmail)        %{_prefix}
%dir %attr(755,indimail,indimail) %{_prefix}/control
%dir %attr(555,root,qmail)        %{_prefix}/man
%dir %attr(555,root,qmail)        %{_prefix}/man/man1
%dir %attr(555,root,qmail)        %{_prefix}/man/cat1
%dir %attr(555,root,qmail)        %{_prefix}/man/man8
%dir %attr(555,root,qmail)        %{_prefix}/man/cat8
#
%attr(555,root,qmail)             %{_prefix}/bin/sendmail
%attr(555,root,qmail)             %{_prefix}/bin/qmail-inject
%attr(555,root,qmail)             %{_prefix}/bin/qmail-qmqpc
%attr(555,root,qmail)             %{_prefix}/bin/forward
%attr(555,root,qmail)             %{_prefix}/bin/predate
%attr(555,root,qmail)             %{_prefix}/bin/datemail
%attr(555,root,qmail)             %{_prefix}/bin/mailsubj
%attr(555,root,qmail)             %{_prefix}/bin/qmail-showctl
%attr(555,root,root)              %{_prefix}/bin/maildirmake
%attr(555,root,qmail)             %{_prefix}/bin/qmaildirmake
%attr(555,root,qmail)             %{_prefix}/bin/maildir2mbox
%attr(555,root,qmail)             %{_prefix}/bin/maildirwatch
%attr(555,root,qmail)             %{_prefix}/bin/qail
%attr(555,root,qmail)             %{_prefix}/bin/elq
%attr(555,root,qmail)             %{_prefix}/bin/pinq
#
%attr(444,root,qmail)             %{_prefix}/man/man1/forward.1.gz
%attr(444,root,qmail)             %{_prefix}/man/cat1/forward.0.gz
%attr(444,root,qmail)             %{_prefix}/man/man1/predate.1.gz
%attr(444,root,qmail)             %{_prefix}/man/man1/datemail.1.gz
%attr(444,root,qmail)             %{_prefix}/man/man1/mailsubj.1.gz
%attr(444,root,qmail)             %{_prefix}/man/cat1/mailsubj.0.gz
%attr(444,root,qmail)             %{_prefix}/man/man1/maildirmake.1.gz
%attr(444,root,qmail)             %{_prefix}/man/man1/qmaildirmake.1.gz
%attr(444,root,qmail)             %{_prefix}/man/cat1/qmaildirmake.0.gz
%attr(444,root,qmail)             %{_prefix}/man/man1/maildir2mbox.1.gz
%attr(444,root,qmail)             %{_prefix}/man/cat1/maildir2mbox.0.gz
%attr(444,root,qmail)             %{_prefix}/man/man1/maildirwatch.1.gz
%attr(444,root,qmail)             %{_prefix}/man/cat1/maildirwatch.0.gz
#
%attr(444,root,qmail)             %{_prefix}/man/man8/qmail-showctl.8.gz
%attr(444,root,qmail)             %{_prefix}/man/cat8/qmail-showctl.0.gz
%attr(444,root,qmail)             %{_prefix}/man/man8/qmail-inject.8.gz
%attr(444,root,qmail)             %{_prefix}/man/man8/sendmail.8.gz
%attr(444,root,qmail)             %{_prefix}/man/cat8/qmail-inject.0.gz
%attr(444,root,qmail)             %{_prefix}/man/man8/qmail-qmqpc.8.gz
%attr(444,root,qmail)             %{_prefix}/man/cat8/qmail-qmqpc.0.gz

# a copy of /var/qmail/control/me, /var/qmail/control/defaultdomain,
# and /var/qmail/control/plusdomain from your central server, so that qmail-inject uses appropriate host names in outgoing mail; and
# this host's name in /var/qmail/control/idhost, so that qmail-inject generates Message-ID without any risk of collision

%clean
%{__rm} -rf %{buildroot}

#            install   erase   upgrade  reinstall
# % pretrans      0        -         0
# % pre           1        -         2         2
# % post          1        -         2         2
# % preun         -        0         1         -
# % postun        -        0         1         -
# % posttrans     0        -         0
# The scriptlets in %pre and %post are respectively run before and after a package is installed.
# The scriptlets %preun and %postun are run before and after a package is uninstalled.
# The scriptlets %pretrans and %posttrans are run at start and end of a transaction.
# On upgrade, the scripts are run in the following order:
#
#   1. %pretrans of new package
#   2. %pre of new package
#   3. (package install)
#   4. %post of new package
#   5. %preun of old package
#   6. (removal of old package)
#   7. %postun of old package
#   8. %posttrans of new package 

### SCRIPTLET ###############################################################################
%verifyscript
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi
%{_prefix}/sbin/svctool --check-install --servicedir=%{servicedir} \
	--qbase=%{qbase} --qcount=%{qcount} --qstart=1

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%verify_permissions -e %{_prefix}/bin/vdeluser
%verify_permissions -e %{_prefix}/bin/vadduser
%verify_permissions -e %{_prefix}/bin/vaddaliasdomain
%verify_permissions -e %{_prefix}/bin/vrenamedomain
%verify_permissions -e %{_prefix}/bin/vsetuserquota
%verify_permissions -e %{_prefix}/bin/vmoveuser
%verify_permissions -e %{_prefix}/bin/qhpsi
%verify_permissions -e %{_prefix}/bin/run-cleanq
%verify_permissions -e %{_prefix}/bin/vuserinfo
%verify_permissions -e %{_prefix}/bin/qmail-queue
%verify_permissions -e %{_prefix}/bin/vdeldomain
%verify_permissions -e %{_prefix}/bin/vadddomain
%if %nobogofilter == 0
%verify_permissions -e %{_prefix}/bin/bogofilter
%endif
%verify_permissions -e %{_prefix}/bin/qscanq
%verify_permissions -e %{_prefix}/bin/vdominfo
%verify_permissions -e %{_prefix}/bin/vrenameuser
%verify_permissions -e %{_prefix}/bin/printdir
%verify_permissions -e %{_prefix}/bin/vmoduser
%verify_permissions -e %{_prefix}/bin/vcfilter
%verify_permissions -e %{_prefix}/bin/vbulletin
%verify_permissions -e %{_prefix}/libexec/sq_vacation
%verify_permissions -e %{_prefix}/libexec/authlib/authshadow
%verify_permissions -e %{_prefix}/sbin/systpass
%verify_permissions -e %{_prefix}/alias
%verify_permissions -e %{_prefix}/autoturn
%endif
%endif

### SCRIPTLET ###############################################################################
%pretrans
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi
if [ -d %{_prefix} -a -d /service ] ; then
	if [ -f %{_prefix}/sbin/initsvc ] ; then
		%{_prefix}/sbin/initsvc -status
	fi

	if test -f %{_sysconfdir}/init/svscan.conf
	then
		echo "Giving IndiMail exactly 5 seconds to exit nicely"
		/sbin/initctl emit qmailstop > /dev/null 2>&1
	elif test -f %{_sysconfdir}/event.d/svscan
	then
		echo "Giving IndiMail exactly 5 seconds to exit nicely"
		/sbin/initctl emit qmailstop > /dev/null 2>&1
	elif test -f %{_sysconfdir}/systemd/system/multi-user.target.wants/indimail.service
	then
		echo "Giving IndiMail exactly 5 seconds to exit nicely"
		/bin/systemctl stop indimail.service > /dev/null 2>&1
	elif test -x %{_prefix}/sbin/initsvc
	then
		echo "Giving IndiMail exactly 5 seconds to exit nicely"
		%{_prefix}/sbin/initsvc -off
	fi
	sleep 5
fi

### SCRIPTLET ###############################################################################
%pre 
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi
# we are doing upgrade
if [ $argv1 -eq 2 ] ; then
	exit 0
fi
(
echo "Checking for mandatory user/group mysql.."
case "%host" in
	*-*-darwin*)
	/usr/bin/dscl . -list /Groups/mysql > /dev/null || (echo "group mysql does not exist. Aborting..." && false)
	if [ $? -ne 0 ] ; then
		exit 1
	fi
	/usr/bin/dscl . -list /Users/mysql > /dev/null || (echo "user mysql does not exist. Aborting..." && false)
	if [ $? -ne 0 ] ; then
		exit 1
	fi
	;;
	*)
	/usr/bin/getent group  mysql > /dev/null || (echo "group mysql does not exist. Aborting..." && false)
	if [ $? -ne 0 ] ; then
		exit 1
	fi
	/usr/bin/getent passwd mysql > /dev/null || (echo "user  mysql does not exist. Aborting..." && false)
	if [ $? -ne 0 ] ; then
		exit 1
	fi
esac
%if %i_m_on_mac == 1
echo "Adding IndiMail users/groups"
/usr/bin/dscl . -create /Groups/indimail PrimaryGroupID 555
/usr/bin/dscl . -create /Groups/nofiles PrimaryGroupID 556
/usr/bin/dscl . -create /Groups/qmail   PrimaryGroupID 557
/usr/bin/dscl . -create /Groups/qscand  PrimaryGroupID 558

/usr/bin/dscl . -create /Users/indimail UniqueID 555
/usr/bin/dscl . -create /Users/indimail home @indimaildir@
/usr/bin/dscl . -create /Users/indimail PrimaryGroupID 555
/usr/bin/dscl . -create /Users/indimail UserShell /bin/bash
/usr/bin/dscl . -create /Users/indimail RealName indimail

/usr/bin/dscl . -create /Users/alias    UniqueID 556
/usr/bin/dscl . -create /Users/alias    home @indimaildir@/alias
/usr/bin/dscl . -create /Users/alias    PrimaryGroupID 556
/usr/bin/dscl . -create /Users/alias    UserShell /bin/bash
/usr/bin/dscl . -create /Users/alias    RealName alias
id=557
for i in qmaild qmaill qmailp
do
	/usr/bin/dscl . -create /Users/$i   UniqueID $id
	/usr/bin/dscl . -create /Users/$i   home @indimaildir@
	/usr/bin/dscl . -create /Users/$i   PrimaryGroupID 556
	/usr/bin/dscl . -create /Users/$i   UserShell /bin/bash
	/usr/bin/dscl . -create /Users/$i   RealName qmaild
	id=`expr $id + 1`
done
id=560
for i in qmailq qmailr qmails
do
	/usr/bin/dscl . -create /Users/$i   UniqueID $id
	/usr/bin/dscl . -create /Users/$i   home @indimaildir@
	/usr/bin/dscl . -create /Users/$i   PrimaryGroupID 557
	/usr/bin/dscl . -create /Users/$i   UserShell /bin/bash
	/usr/bin/dscl . -create /Users/$i   RealName qmailq
	id=`expr $id + 1`
done
/usr/bin/dscl . -create /Users/qscand UniqueID 563
/usr/bin/dscl . -create /Users/qscand home @indimaildir@/qscanq
/usr/bin/dscl . -create /Users/qscand PrimaryGroupID 558
/usr/bin/dscl . -create /Users/qscand UserShell /bin/false
/usr/bin/dscl . -create /Users/qscand RealName qscand
/usr/bin/dscl . -append /Groups/qmail GroupMembership qscand
%else
#
# Create a users and groups. Do not report any problems if they already
# exists.
#
nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
if [ $nscd_up -ge 1 ] ; then
	if [ -x %{_sysconfdir}/init.d/nscd ] ; then
		%{_sysconfdir}/init.d/nscd stop
	fi
fi
echo "Adding IndiMail users/groups"
/usr/bin/getent group indimail  > /dev/null || /usr/sbin/groupadd -r -g 555 indimail || true
if [ $? = 4 ] ; then
	/usr/sbin/groupadd indimail
fi
/usr/bin/getent group nofiles   > /dev/null || /usr/sbin/groupadd nofiles  || true
/usr/bin/getent group qmail     > /dev/null || /usr/sbin/groupadd qmail    || true
/usr/bin/getent group qscand    > /dev/null || /usr/sbin/groupadd qscand   || true

for i in indimail alias qmaild qmaill qmailp qmailq qmailr qmails qscand
do
	%{__rm} -f /var/spool/mail/$i
done

/usr/bin/getent passwd indimail > /dev/null || /usr/sbin/useradd -r -g indimail -u 555 -d %{_prefix} indimail || true
if [ $? = 4 ] ; then
	/usr/sbin/useradd -r -g indimail -d %{_prefix} indimail
fi
/usr/bin/getent passwd alias    > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{_prefix}/alias  -s /sbin/nologin  alias || true
/usr/bin/getent passwd qmaild   > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{_prefix}        -s /sbin/nologin qmaild || true
/usr/bin/getent passwd qmaill   > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{_prefix}        -s /sbin/nologin qmaill || true
/usr/bin/getent passwd qmailp   > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{_prefix}        -s /sbin/nologin qmailp || true
/usr/bin/getent passwd qmailq   > /dev/null || /usr/sbin/useradd -M -g qmail    -d %{_prefix}        -s /sbin/nologin qmailq || true
/usr/bin/getent passwd qmailr   > /dev/null || /usr/sbin/useradd -M -g qmail    -d %{_prefix}        -s /sbin/nologin qmailr || true
/usr/bin/getent passwd qmails   > /dev/null || /usr/sbin/useradd -M -g qmail    -d %{_prefix}        -s /sbin/nologin qmails || true
/usr/bin/getent passwd qscand   > /dev/null || /usr/sbin/useradd -M -g qscand   -d %{_prefix}/qscanq -G qmail,qscand -s /sbin/nologin qscand || true
if [ $nscd_up -ge 1 ] ; then
	if [ -x %{_sysconfdir}/init.d/nscd ] ; then
		%{_sysconfdir}/init.d/nscd start
	fi
fi
%endif
) > /tmp/indimail-install.log 2>&1

### SCRIPTLET ###############################################################################
%post
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi
if [ -x /bin/touch ] ; then
	TOUCH=/bin/touch
elif [ -x /usr/bin/touch ] ; then
	TOUCH=/usr/bin/touch
else
	TOUCH=/bin/touch
fi

if [ $argv1 -eq 2 ] ; then # upgrade
	if [ -f %{_prefix}/boot/rpm.init ] ; then
%if %i_m_on_mac == 0
		/sbin/ldconfig
%endif
		echo "Running Custom Upgrade Script for post"
		/bin/sh %{_prefix}/boot/rpm.init upgrade
	fi
	echo "doing post upgrade activities"
	(
	# selinux
	%{_prefix}/sbin/svctool --config=selinux
	) >> /tmp/indimail-install.log 2>&1
	exit 0
fi

%if %i_m_on_mac == 0
# Recreate ld.so links and cache
if [ -d %{_sysconfdir}/ld.so.conf.d ] ; then
	(
		echo %{_libdir}
		if [ -f %{mysqlPrefix}/%{_lib}/mysql/libmysqlclient.so ] ; then
			echo %{mysqlPrefix}/%{_lib}/mysql 
		elif [ -f %{mysqlPrefix}/%{_lib}/libmysqlclient.so ] ; then
			echo %{mysqlPrefix}/%{_lib}
		fi
	) > %{_sysconfdir}/ld.so.conf.d/indimail-%{_arch}.conf
fi
/sbin/ldconfig
%endif

echo "doing post installation activities"
(
# MySQL
echo "Creating %{logdir}"
if [ ! -d %{logdir} ] ; then
	%{__mkdir_p} %{logdir}
fi
%{__chown} -R qmaill:nofiles %{logdir}

if [ -d /service ] ; then
	echo "UFO found in /service. Moving it to /service.org"
	%{__mv} -f %{servicedir} %{servicedir}.org
fi
if [ -f %{mysqlPrefix}/bin/mysql_config ] ; then
	echo "Creating Database/Service for MySQL"
	# MySQL Config Creation
	%{_prefix}/sbin/svctool --config=mysql   --mysqlPrefix=%{mysqlPrefix} --model=medium --no-of-cpu=2
	# MySQL Database Creation
	%{_prefix}/sbin/svctool --config=mysqldb --mysqlPrefix=%{mysqlPrefix} \
    	--databasedir=%{_prefix}/mysqldb --base_path=%{mbase}
	# MySQL Supervise creation
	%{_prefix}/sbin/svctool --mysql=3306 --servicedir=%{servicedir} --mysqlPrefix=%{mysqlPrefix} \
		--databasedir=%{_prefix}/mysqldb --config=%{_prefix}/etc/indimail.cnf --default-domain=%{default_domain} \
		--model=small --no-of-cpu=2
	$TOUCH %{servicedir}/mysql.3306/down
else
	echo "WARNING!!! Did not find mysql_config in %{mysqlPrefix}. Skipping MySQL configuration" 1>&2
fi

if [ %nodksignatures -eq 0 ] ; then
	if [ -x %{_prefix}/bin/dknewkey ] ; then
		ver_opt="both"
		sign_opt="both"
		%{_prefix}/bin/dknewkey %{_prefix}/control/domainkeys/default 1024
	else
		ver_opt="none"
		sign_opt="none"
	fi
else
	ver_opt="none"
	sign_opt="none"
fi

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%if 0%{?set_permissions:1} > 0
	if [ ! -f /tmp/no_permissions ] ; then
    	%set_permissions %{name}
	fi
%else
	if [ ! -f /tmp/no_permissions ] ; then
    	%run_permissions
	fi
%endif
%endif
%endif

# SMTP
%ifarch x86_64
%define fetchmail_mem 144857600
%define smtp_soft_mem 104857600
%define qmtp_soft_mem 104857600
%define qmqp_soft_mem 104857600
%define imap_pop3_mem 524288000
%define imapspop3_mem 524288000
%define poppass_mem   104857600
%else
%define fetchmail_mem 72428800
%define smtp_soft_mem 52428800
%define qmtp_soft_mem 52428800
%define qmqp_soft_mem 52428800
%define imap_pop3_mem 52428800
%define imapspop3_mem 52428800
%define poppass_mem   52428800
%endif

for port in 465 25 587
do
	if [ $port -eq 465 ] ; then
		if [ %nobogofilter -eq 1 ] ; then
			spamfilter=0
		else
			spamfilter=1
		fi
		extra_opt="--skipsend --ssl"
		extra_opt="$extra_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
	elif [ $port -eq 587 ] ; then
		# local authenticated users
		# why bother with spamfilter
		# if you do, then you have a serious
		# problem with your organization, not 
		# with IndiMail
		spamfilter=0
		extra_opt="--skipsend --authsmtp --antispoof"
	else
		if [ %nobogofilter -eq 1 ] ; then
			spamfilter=0
		else
			spamfilter=1
		fi
		extra_opt="--remote-authsmtp=plain --localfilter --remotefilter"
		extra_opt="$extra_opt --deliverylimit-count=-1 --deliverylimit-size=-1"
		extra_opt="$extra_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
	fi
	if [ %noclamav -eq 0 ] ; then
		echo "Checking if clamav is installed"
		clamav_os=0
		clamdPrefix=%{_prefix}
		qhpsi="%{_prefix}/bin/clamdscan %s --fdpass --quiet --no-summary"
		mysysconfdir=%{_prefix}/etc
	else
		if [ -f /usr/sbin/clamd -a -f /usr/bin/clamdscan ] ; then
			clamav_os=1
			clamdPrefix="/usr"
			qhpsi="/usr/bin/clamdscan %s --fdpass --quiet --no-summary"
			mysysconfdir=%{_sysconfdir}
		else
			clamav_os=0
		fi
	fi
	if [ $spamfilter -eq 1 ] ; then
		if [ %noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			%{_prefix}/sbin/svctool --smtp=$port --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=%{smtp_soft_mem} --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter \
				--spamfilter="%{_prefix}/bin/bogofilter -p -d %{_prefix}/etc" \
				--logfilter=/tmp/spamfifo --rejectspam=0 --spamexitcode=0 \
				--qhpsi="$qhpsi" \
				--dmasquerade \
				--dkverify=$ver_opt \
				--dksign=$sign_opt --private_key=%{_prefix}/control/domainkeys/%/%dkimkeyfn \
				$extra_opt
		else
			%{_prefix}/sbin/svctool --smtp=$port --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=%{smtp_soft_mem} --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--spamfilter="%{_prefix}/bin/bogofilter -p -d %{_prefix}/etc" \
				--logfilter=/tmp/spamfifo --rejectspam=0 --spamexitcode=0 \
				--dmasquerade \
				--dkverify=both \
				--dksign=both --private_key=%{_prefix}/control/domainkeys/%/%dkimkeyfn \
				$extra_opt
		fi
	else
		if [ %noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			%{_prefix}/sbin/svctool --smtp=$port --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=%{smtp_soft_mem} --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter \
				--qhpsi="$qhpsi" \
				--dmasquerade \
				--dkverify=both \
				--dksign=both --private_key=%{_prefix}/control/domainkeys/%/%dkimkeyfn \
				$extra_opt
		else
			%{_prefix}/sbin/svctool --smtp=$port --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=%{smtp_soft_mem} --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--dmasquerade \
				--dkverify=both \
				--dksign=both --private_key=%{_prefix}/control/domainkeys/%/%dkimkeyfn \
				$extra_opt
		fi
	fi
	echo "1" > %{servicedir}/qmail-smtpd.$port/variables/DISABLE_PLUGIN
done
if [ %noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
	%{_prefix}/sbin/svctool --queueParam=defaultqueue \
		--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
		--min-free=52428800 --fsync --syncdir \
		--qhpsi="$qhpsi" \
		--dkverify="none" --dksign=$sign_opt \
		--private_key=%{_prefix}/control/domainkeys/%/%dkimkeyfn \
		$extra_opt
else
	%{_prefix}/sbin/svctool --queueParam=defaultqueue \
		--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
		--min-free=52428800 --fsync --syncdir --virus-filter \
		--dkverify="none" --dksign=$sign_opt \
		--private_key=%{_prefix}/control/domainkeys/%/%dkimkeyfn \
		$extra_opt
fi
%{_prefix}/sbin/svctool --smtp=366 --odmr --servicedir=%{servicedir} \
	--query-cache --password-cache --memory=%{smtp_soft_mem}
echo "1" > %{servicedir}/qmail-smtpd.366/variables/DISABLE_PLUGIN
# Greylist daemon
%{_prefix}/sbin/svctool --greylist=1999 --servicedir=%{servicedir} --min-resend-min=2 \
    --resend-win-hr=24 --timeout-days=30 --context-file=greylist.context \
    --hash-size=65536 --save-interval=5 --whitelist=greylist.white --use-greydaemon
# qmail-qmtpd service
%{_prefix}/sbin/svctool --qmtp=209 --servicedir=%{servicedir} --qbase=%{qbase} \
	--qcount=%{qcount} --qstart=1 --cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 \
	--fsync --syncdir --memory=%{qmtp_soft_mem} --min-free=52428800
# qmail-qmqpd service
%{_prefix}/sbin/svctool --qmqp=628 --servicedir=%{servicedir} --qbase=%{qbase} \
	--qcount=%{qcount} --qstart=1 --cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 \
	--fsync --syncdir --memory=%{qmqp_soft_mem} --min-free=52428800
$TOUCH %{servicedir}/qmail-qmqpd.628/down

if [ %nofetchmail -eq 0 ] ; then
# fetchmail
	if [ %nobogofilter -eq 0 ] ; then
		if [ %noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			%{_prefix}/sbin/svctool --fetchmail --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--cntrldir=control --default-domain=%{default_domain} \
				--qhpsi="$qhpsi" \
				--spamfilter="%{_prefix}/bin/bogofilter -p -d %{_prefix}/etc" \
				--logfilter=/tmp/spamfifo --rejectspam=0 --spamexitcode=0 \
				--memory=%{fetchmail_mem} --fsync --syncdir \
				--dkverify=$ver_opt
		else
			%{_prefix}/sbin/svctool --fetchmail --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--cntrldir=control --default-domain=%{default_domain} \
				--spamfilter="%{_prefix}/bin/bogofilter -p -d %{_prefix}/etc" \
				--logfilter=/tmp/spamfifo --rejectspam=0 --spamexitcode=0 \
				--memory=%{fetchmail_mem} --fsync --syncdir \
				--dkverify=$ver_opt
		fi
	else
		if [ %noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			%{_prefix}/sbin/svctool --fetchmail --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--cntrldir=control --default-domain=%{default_domain} \
				--qhpsi="$qhpsi" \
				--memory=%{fetchmail_mem} --fsync --syncdir \
				--dkverify=$ver_opt
		else
			%{_prefix}/sbin/svctool --fetchmail --servicedir=%{servicedir} \
				--qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
				--cntrldir=control --default-domain=%{default_domain} \
				--memory=%{fetchmail_mem} --fsync --syncdir \
				--dkverify=$ver_opt
		fi
	fi
	#
	# user has to create fetchmailrc before which fetchmail cannot be started
	#
	$TOUCH %{servicedir}/fetchmail/down
fi

if [ %nocourierimap -eq 0 ] ; then
# IMAP/POP3
%{_prefix}/sbin/svctool --imap=143 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imap_pop3_mem} \
	--starttls
%{_prefix}/sbin/svctool --imap=993 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imapspop3_mem} \
	--ssl
%{_prefix}/sbin/svctool --pop3=110 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imap_pop3_mem} \
	--starttls
%{_prefix}/sbin/svctool --pop3=995 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imapspop3_mem} \
	--ssl
fi
if [ %noproxy -eq 0 ] ; then
%{_prefix}/sbin/svctool --imap=4143 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imap_pop3_mem} \
	--proxy=143 --starttls --tlsprog=%{_prefix}/bin/sslerator
%{_prefix}/sbin/svctool --imap=9143 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imapspop3_mem} \
	--proxy=143 --ssl
%{_prefix}/sbin/svctool --pop3=4110 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imap_pop3_mem} \
	--proxy=110 --starttls --tlsprog=%{_prefix}/bin/sslerator
%{_prefix}/sbin/svctool --pop3=9110 --servicedir=%{servicedir} --localip=0 --maxdaemons=40 \
	--maxperip=25 --query-cache --default-domain=%{default_domain} --memory=%{imapspop3_mem} \
	--proxy=110 --ssl
fi

# IndiMail Daemons
%{_prefix}/sbin/svctool --indisrvr=4000 --servicedir=%{servicedir} \
	--localip=0 --maxdaemons=40 --maxperip=25 --avguserquota=2097152 \
    --certfile=%{_prefix}/control/servercert.pem --ssl \
	--hardquota=52428800 --base_path=%{mbase}
%{_prefix}/sbin/svctool --inlookup=infifo --servicedir=%{servicedir} --cntrldir=control \
	--threads=5 --query-cache --password-cache
if [ %nonssd -eq 0 ] ; then
	%{_prefix}/sbin/svctool --pwdlookup=/tmp/nssd.sock --threads=5 --timeout=-1 \
		--mysqlhost=localhost --mysqluser=indimail \
		--mysqlpass=ssh-1.5- --mysqlsocket=/tmp/mysql.sock --servicedir=%{servicedir}
fi
%{_prefix}/sbin/svctool --poppass=106 --localip=0 --maxdaemons=40 --maxperip=25 \
	--memory=%{poppass_mem} \
    --certfile=%{_prefix}/control/servercert.pem --ssl \
	--setpassword=%{_prefix}/sbin/vsetpass --servicedir=%{servicedir}

# virus/spam filtering
%{_prefix}/sbin/svctool --qscanq --servicedir=%{servicedir} --scanint=200
if [ %noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
	%{_prefix}/sbin/svctool --config=clamd
	# create clamd, freshclam service
	%{_prefix}/sbin/svctool --clamd --servicedir=%{servicedir} --clamdPrefix=$clamdPrefix \
		--sysconfdir=$mysysconfdir
fi

%{_prefix}/sbin/svctool --config=qmail --postmaster=%{_prefix}/alias/Maildir/ \
	--default-domain=%{default_domain} --mysqlhost=localhost --mysqluser=indimail \
	--mysqlpass=ssh-1.5- --mysqlsocket=/tmp/mysql.sock

%{__cat} <<EOF > %{_prefix}/control/signatures
# Windows executables seen in active virii
TVqQAAMAA:
TVpQAAIAA
# Additional windows executable signatures not yet seen in virii
TVpAALQAc
TVpyAXkAX
TVrmAU4AA
TVrhARwAk
TVoFAQUAA
TVoAAAQAA
TVoIARMAA
TVouARsAA
TVrQAT8AA
# .ZIPfile signature seen in SoBig.E and mydoom:
#UEsDBBQAA:SoBig.e Virus
#UEsDBAoAAA:mydoom Virus
# .GIF file found in a previous Microsoft virus making the rounds.
R0lGODlhaAA7APcAAP///+rp6puSp6GZrDUjUUc6Zn53mFJMdbGvvVtXh2xre8bF1x8cU4yLprOy:Virus in .gif files
# http://www.gossamer-threads.com/lists/qmail/users/114447
UEsDBAoAAQAAAEBHYzCf4kJRDDAAAAAwAAAKAAAAc3ZtaXhlLmV4ZcuI1rOkjfn48VwCkMYHRTfM
EOF
%{__chown} qscand:qscand %{_prefix}/control/signatures

if [ %nobogofilter -eq 0 ] ; then
	%{_prefix}/sbin/svctool --config=bogofilter
fi

# rebuild cdb
for i in smtp qmtp qmqp imap pop3 poppass
do
	for j in `/bin/ls %{_prefix}/etc/tcp*.$i 2>/dev/null`
	do
		echo "Creating CDB $j.cdb"
   		%{_prefix}/bin/tcprules $j.cdb $j.tmp < $j && /bin/chmod 664 $j.cdb \
			&& chown indimail:indimail $j.cdb
	done
done

# Misc/Configuration
%{_prefix}/sbin/svctool --svscanlog --servicedir=%{servicedir}

# selinux
%{_prefix}/sbin/svctool --config=selinux

#
# Install IndiMail to be started on system boot
# The add-boot command installs svscan to be started by init, upstart or launchctl
#
echo "adding indimail startup"
%{_prefix}/sbin/svctool --config=add-boot

) >> /tmp/indimail-install.log 2>&1

if [ -f %{_prefix}/boot/rpm.init ] ; then
	echo "Running Custom Installation Script for post"
	/bin/sh %{_prefix}/boot/rpm.init post
fi

if [ -f %{_sysconfdir}/init/svscan.conf -o -f %{_sysconfdir}/event.d/svscan ] ; then
	echo "1. Issue /sbin/initctl emit qmailstart to start services"
	count=1
elif [ -f %{_sysconfdir}/systemd/system/multi-user.target.wants/indimail.service ] ; then
	echo "1. Issue /bin/systemctl start indimail.service to start services"
	count=1
else
%if %i_m_on_mac == 0
	echo "1. Issue %{_prefix}/sbin/initsvc -on"
	echo "2. Issue /sbin/init q to start services"
	count=2
%else
	echo "1. Issue /bin/launchctl load /System/Library/LaunchDaemons/indimail.plist"
	count=1
%endif
fi
count=`expr $count + 1`
echo "$count. Change your default domain in %{_prefix}/control/defaultdomain"
count=`expr $count + 1`
echo "$count. You can optionally run the following command to verify installation"
echo "   sudo rpm -V indimail"
%if %noclamav == 0
count=`expr $count + 1`
echo "$count. You need to ensure that clamav signatures download have completed so that"
echo "   you can start sending emails. Look at %{logdir}/freshclam/current"
%endif
if [ ! -f %{_prefix}/control/servercert.pem ] ; then
count=`expr $count + 1`
%if %nocourierimap == 0
echo "$count. You need to create CERTS for STARTTLS / SSL enabled IMAP/POP3."
%else
echo "$count. You need to create CERTS for STARTTLS."
%endif
echo "   Run the following command to create the Certificate"
echo "   %{_prefix}/sbin/svctool --postmaster=postmaster@indimail.org --config=cert"
fi

echo
echo "Look at /tmp/indimail-install.log for the installation log"

### SCRIPTLET ###############################################################################
%preun
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi

if test -f %{_sysconfdir}/init/svscan.conf
then
	/sbin/initctl emit qmailstop > /dev/null 2>&1
	echo "Giving IndiMail exactly 5 seconds to exit nicely"
	sleep 5
	if [ $argv1 -ne 1 ] ; then # not an upgrade
		%{__rm} -f %{_sysconfdir}/init/svscan.conf
	fi
elif test -f %{_sysconfdir}/event.d/svscan
then
	/sbin/initctl emit qmailstop > /dev/null 2>&1
	echo "Giving IndiMail exactly 5 seconds to exit nicely"
	sleep 5
	if [ $argv1 -ne 1 ] ; then # not an upgrade
		%{__rm} -f %{_sysconfdir}/event.d/svscan
	fi
elif test -f %{_sysconfdir}/systemd/system/multi-user.target.wants/indimail.service
then
	/bin/systemctl stop indimail.service > /dev/null 2>&1
	echo "Giving IndiMail exactly 5 seconds to exit nicely"
	sleep 5
elif test -x %{_prefix}/sbin/initsvc
then
	%{_prefix}/sbin/initsvc -off
	echo "Giving IndiMail exactly 5 seconds to exit nicely"
	sleep 5
fi

if [ -f %{_prefix}/boot/rpm.init ] ; then
	echo "Running Custom Un-Installation Script for preun"
	/bin/sh %{_prefix}/boot/rpm.init preun "$argv1"
fi

# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
	exit 0
fi

# Remove IndiMail being started on system boot
echo "removing indimail startup"
%{_prefix}/sbin/svctool --config=rm-boot

### SCRIPTLET ###############################################################################
%postun
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
%if %i_m_on_mac == 0
	echo "recreating ld.so cache"
	/sbin/ldconfig
%endif
	exit 0
fi

# remove users / groups
nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
if [ $nscd_up -ge 1 ] ; then
	if [ -x %{_sysconfdir}/init.d/nscd ] ; then
		%{_sysconfdir}/init.d/nscd stop
	fi
fi
%if %i_m_on_mac == 0
for i in alias qmaild qmaill qmailp qmailq qmailr qmails qscand indimail
do
	echo "removing user $i"
	/usr/bin/getent passwd $i > /dev/null && /usr/sbin/userdel $i >/dev/null || true
done
for i in nofiles qmail qscand indimail
do
	echo "removing group $i"
	/usr/bin/getent group $i > /dev/null && /usr/sbin/groupdel $i  >/dev/null || true
done
if [ $nscd_up -ge 1 ] ; then
	if [ -x %{_sysconfdir}/init.d/nscd ] ; then
		%{_sysconfdir}/init.d/nscd start
	fi
fi
%else
	for i in indimail qmail nofiles qscand; do
		echo "removing group $i"
		dscl . -delete /Groups/$i
	done
	for i in indimail alias qmaild qmaill qmailp qmailq qmailr qmails qscand; do
		echo "removing user $i"
		dscl . -delete /Users/$i
	done
%endif

if [ ! %{_prefix} = "/usr" ] ; then
	echo "removing binaries, libraries, queues, man pages"
	for i in %{_prefix}/bin %{_prefix}/sbin %{_prefix}/lib %{_prefix}/queue \
		%{_prefix}/man/man1 %{_prefix}/man/cat1 %{_prefix}/man/man5 %{_prefix}/man/cat5 \
		%{_prefix}/man/man7 %{_prefix}/man/cat7 %{_prefix}/man/man8 %{_prefix}/man/cat8
	do
		%{__rm} -rf $i || true
	done
	/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/man 2>/dev/null
	for i in `/bin/ls %{_prefix}/share 2>/dev/null`
	do
		if [ " $i" = " clamd" ] ; then # leave the signatures
			continue;
		fi
		%{__rm} -rf %{_prefix}/share/$i || true
	done
	/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/share 2>/dev/null
fi

echo "removing configuration"
for i in indimail.cnf backup.conf cronlist indimail.te headerlist \
		imapd.cnf imapd.dist imapd-ssl.dist inc_deps indimail.mrtg.cfg \
		indimail.settings lib_deps osh.table perm_list pop3d.cnf \
		pop3d.dist pop3d-ssl.dist qmailprog.list quotawarnmsg.example \
		services.log system.flashlogin system.menu system.module system.rc
do
	%{__rm} -f %{_prefix}/etc/$i
done

if [ %nofetchmail -eq 0 ] ; then
	%{__rm} -f %{_prefix}/etc/fetchmailrc
fi
if [ %nobogofilter -eq 0 ] ; then
	%{__rm} -f %{_prefix}/etc/bogofilter.cf
fi
%if %nonssd == 0
	%{__rm} -f %{_prefix}/etc/nssd.conf
%endif

for i in smtp qmtp qmqp imap pop3 poppass
do
	for j in `/bin/ls %{_prefix}/etc/tcp*.$i 2>/dev/null`
	do
			%{__rm} -f $j.cdb
	done
done
/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/etc 2>/dev/null
for i in assign cdb
do
		%{__rm} -f %{_prefix}/users/$i
done
/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/users 2>/dev/null

if [ -f %{_prefix}/etc/controlfiles ] ; then
	for i in `%{__cat} %{_prefix}/etc/controlfiles`
	do
		%{__rm} -f %{_prefix}/control/$i
	done
else
	for i in databytes defaultdelivery defaultdomain localiphost locals \
		me nodnscheck plusdomain queue_base smtpgreeting signatures \
		chkrcptdomains defaulthost envnoathost filterargs greylist.white \
		hostip timeoutremote timeoutsmtpd
	do
		%{__rm} -f %{_prefix}/control/$i
	done
fi
%{__rm} -f %{_prefix}/control/controlfiles
%{__rm} -f %{_prefix}/control/domainkeys/%{dkimkeyfn}.pub %{_prefix}/control/domainkeys/%dkimkeyfn
/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/control/domainkeys 2>/dev/null
/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/control 2>/dev/null

for i in postmaster mailer-daemon root ham spam register-ham register-spam
do
	%{__rm} -f %{_prefix}/alias/.qmail-"$i"
done
/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/alias 2>/dev/null
%{__rm} -f %{_prefix}/share/imapd.pem
%{__rm} -f %{_prefix}/share/pop3d.pem

echo "removing startup services"
for i in clamd fetchmail freshclam indisrvr.4000 inlookup.infifo mysql.3306 \
pwdlookup qmail-imapd.143 qmail-imapd-ssl.993 qmail-pop3d.110 qmail-pop3d-ssl.995 \
qmail-send.25 qmail-smtpd.25 qmail-smtpd.366 qmail-spamlog qscanq qmail-imapd.4143 \
qmail-pop3d.4110 qmail-smtpd.465 qmail-smtpd.587 qmail-qmtpd.209 qmail-qmqpd.628 \
qmail-poppass.106 greylist.1999 .svscan
do
	if [ -d %{servicedir}/$i ] ; then
		%{__rm} -rf %{servicedir}/$i || true
	fi
done
if [ %noproxy -eq 0 ] ; then
for i in proxy-imapd.4143 proxy-imapd-ssl.9143 proxy-pop3d.4110 proxy-pop3d-ssl.9110
do
	if [ -d %{servicedir}/$i ] ; then
		%{__rm} -rf %{servicedir}/$i || true
	fi
done
fi

#selinux
%{__rm} -f %{_prefix}/etc/indimail.te %{_prefix}/etc/indimail.mod %{_prefix}/etc/indimail.pp

echo "removing logs"
%{__rm} -f %{_prefix}/mysqldb/logs/logisam.log
%{__rm} -f %{_prefix}/mysqldb/logs/logquery
%{__rm} -f %{_prefix}/mysqldb/logs/logslow
count=`/bin/ls %{servicedir} 2>/dev/null| /usr/bin/wc -l`
if [ $count -eq 0 ] ; then
	%{__rm} -rf %{servicedir} || true
fi
if [ -h %{logdir} ] ; then
	log_dir=`/bin/ls -ld %{logdir} | /usr/bin/awk '{print $10}'`
else
	log_dir=%{logdir}
fi
[ "$log_dir" != "/" ] && %{__rm} -fr $log_dir
%if %i_m_on_mac == 0
echo "recreating ld.so cache"
/sbin/ldconfig
%endif

if [ -f %{_prefix}/boot/rpm.init ] ; then
	echo "Running Custom Un-Installation Script for postun"
	/bin/sh %{_prefix}/boot/rpm.init postun
fi

### SCRIPTLET ###############################################################################
%posttrans
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi
#echo "Running postrans script for %{version}-%{release} : arg=$1"
if [ -f %{_prefix}/boot/rpm.init ] ; then
	echo "Running Custom Installation Script for posttrans"
	/bin/sh %{_prefix}/boot/rpm.init posttrans
fi
echo ""

### SCRIPTLET ###############################################################################
%pre shared

### SCRIPTLET ###############################################################################
%post shared
%if %i_m_on_mac == 0
/sbin/ldconfig
%endif

### SCRIPTLET ###############################################################################
%postun shared
argv1=$1
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
	exit 0
fi
# Shared libraries (omit for architectures that don't support them)
echo "removing shared libraries"
%if %noclamav == 0
%{__rm} -f %{_libdir}/libclam*.so*
%endif

%if %nolibdkim == 0
%if %i_m_on_mac == 1
%{__rm} -f %{_libdir}/libdkim*.dylib
%{__rm} -f %{_libdir}/libdkim-%{libdkim_version}.0.dylib
%else
%{__rm} -f %{_libdir}/libdkim.so
%{__rm} -f %{_libdir}/libdkim-%{libdkim_version}.so.0
%{__rm} -f %{_libdir}/libdkim-%{libdkim_version}.so.0.0.0
%endif
%endif

%if %nolibsrs2 == 0
%if %i_m_on_mac == 1
%{__rm} -f %{_libdir}/libsrs2*.dylib
%{__rm} -f %{_libdir}/libsrs2-%{libsrs2_version}.0.dylib
%else
%{__rm} -f %{_libdir}/libsrs2.so
%{__rm} -f %{_libdir}/libsrs2-%{libsrs2_version}.so.0
%{__rm} -f %{_libdir}/libsrs2-%{libsrs2_version}.so.0.0.0
%endif
%endif

%if %i_m_on_mac == 1
%{__rm} -f %{_libdir}/libeps.dylib
%{__rm} -f %{_libdir}/libeps-%{eps_version}.0.dylib
%{__rm} -f %{_libdir}/libcdb.dylib
%{__rm} -f %{_libdir}/libcdb-%{cdb_version}.0.dylib
%{__rm} -f %{_libdir}/libflash.dylib
%{__rm} -f %{_libdir}/libflash-%{flash_version}.0.dylib
%{__rm} -f %{_libdir}/libindimail.dylib
%{__rm} -f %{_libdir}/libindimail-%{version}.0.dylib
%else
%{__rm} -f %{_libdir}/libeps.so
%{__rm} -f %{_libdir}/libeps-%{eps_version}.so.0
%{__rm} -f %{_libdir}/libeps-%{eps_version}.so.0.0.0
%{__rm} -f %{_libdir}/libcdb.so
%{__rm} -f %{_libdir}/libcdb-%{cdb_version}.so.0
%{__rm} -f %{_libdir}/libcdb-%{cdb_version}.so.0.0.0
%{__rm} -f %{_libdir}/libflash.so
%{__rm} -f %{_libdir}/libflash-%{flash_version}.so.0
%{__rm} -f %{_libdir}/libflash-%{flash_version}.so.0.0.0
%{__rm} -f %{_libdir}/libindimail.so
%{__rm} -f %{_libdir}/libindimail-%{version}.so.0
%{__rm} -f %{_libdir}/libindimail-%{version}.so.0.0.0
/sbin/ldconfig
%endif

%postun devel
argv1=$1
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
	exit 0
fi
echo "removing man pages, include files"
for i in %{_prefix}/include %{_prefix}/man/man3
do
	%{__rm} -rf $i || true
done
/bin/rmdir --ignore-fail-on-non-empty %{_prefix}/man 2>/dev/null
echo "removing static libraries"
%{__rm} -f %{_libdir}/libeps.a
%{__rm} -f %{_libdir}/libcdb.a
%{__rm} -f %{_libdir}/libflash.a
%{__rm} -f %{_libdir}/libindimail.a
%if %nolibdkim == 0
%{__rm} -f %{_libdir}/libdkim.a
%endif
%if %nolibsrs2 == 0
%{__rm} -f %{_libdir}/libsrs2.a
%endif

%post mini
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
	echo "You are not root" 1>&2
	exit 1
fi
# we are doing upgrade
if [ $argv1 -eq 2 ] ; then
	exit 0
fi
%if %i_m_on_mac == 1
echo "Adding IndiMail users/groups"
/usr/bin/dscl . -create /Groups/indimail PrimaryGroupID 555
/usr/bin/dscl . -create /Groups/nofiles PrimaryGroupID 556
/usr/bin/dscl . -create /Groups/qmail   PrimaryGroupID 557

/usr/bin/dscl . -create /Users/indimail UniqueID 555
/usr/bin/dscl . -create /Users/indimail home @indimaildir@
/usr/bin/dscl . -create /Users/indimail PrimaryGroupID 555
/usr/bin/dscl . -create /Users/indimail UserShell /bin/bash
/usr/bin/dscl . -create /Users/indimail RealName indimail
%else
#
# Create user/groups indimail. Do not report any problems if it already
# exists.
#
nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
if [ $nscd_up -ge 1 ] ; then
	if [ -x %{_sysconfdir}/init.d/nscd ] ; then
		%{_sysconfdir}/init.d/nscd stop
	fi
fi
echo "Adding IndiMail users/groups"
/usr/bin/getent group indimail  > /dev/null || /usr/sbin/groupadd -r -g 555 indimail || true
if [ $? = 4 ] ; then
	/usr/sbin/groupadd indimail
fi
/usr/bin/getent group nofiles   > /dev/null || /usr/sbin/groupadd nofiles  || true
/usr/bin/getent group qmail     > /dev/null || /usr/sbin/groupadd qmail    || true

%{__rm} -f /var/spool/mail/indimail

/usr/bin/getent passwd indimail > /dev/null || /usr/sbin/useradd -r -g indimail -u 555 -d %{_prefix} indimail || true
if [ $? = 4 ] ; then
	/usr/sbin/useradd -r -g indimail -d %{_prefix} indimail
fi
if [ $nscd_up -ge 1 ] ; then
	if [ -x %{_sysconfdir}/init.d/nscd ] ; then
		%{_sysconfdir}/init.d/nscd start
	fi
fi
%endif

if [ -f %{_prefix}/bin/qmail-qmqpc ] ; then
	%{__rm} -f %{_prefix}/bin/qmail-queue
fi
cd %{_prefix}/bin
/bin/ln -sf qmail-qmqpc qmail-queue
if [ -f %{_sysconfdir}/init.d/sendmail ] ; then
	%{_sysconfdir}/init.d/sendmail stop
	if [ -f /sbin/chkconfig ] ; then
		/sbin/chkconfig --del sendmail
	fi
fi
if [ -x /usr/sbin/alternatives ] ; then
	/usr/sbin/alternatives --install \
		/usr/sbin/sendmail mta %{_prefix}/bin/sendmail 120 \
		--slave /usr/share/man/man8/sendmail.8.gz mta-sendmailman \
			%{_prefix}/man/man8/sendmail.8.gz \
		--slave /usr/lib/sendmail mta-sendmail %{_prefix}/bin/sendmail \
		--slave /usr/bin/rmail mta-rmail %{_prefix}/bin/rmail
	/usr/sbin/alternatives --set mta %{_prefix}/bin/sendmail
else
	for i in /usr/lib/sendmail /usr/sbin/sendmail; do
		if [ -f $i -a ! -L $i ]; then
			echo "! $i is a file, should be a link"
			%{__mv} $i $i.old
			/bin/ln -s %{_prefix}/bin/sendmail $i
		elif [ -L $i ];then
			%{__mv} $i $i.old
			/bin/ln -s %{_prefix}/bin/sendmail $i
		elif [ ! -f $i ];then
			echo "! $i is missing"
			/bin/ln -s %{_prefix}/bin/sendmail $i
		fi
	done
fi
if [ ! -f %{_prefix}/control/idhost ] ; then
	uname -n > %{_prefix}/control/idhost
fi

%postun mini
argv1=$1
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
	exit 0
fi
if [ -x /usr/sbin/alternatives ] ; then
	/usr/sbin/alternatives --remove mta %{_prefix}/bin/sendmail
	/usr/sbin/alternatives --auto mta
else
	if [ -f %{_sysconfdir}/init.d/sendmail ] ; then
		if [ -f /sbin/chkconfig ] ; then
			/sbin/chkconfig --add sendmail
			echo "to start sendmail, issue"
			echo "%{_sysconfdir}/init.d/sendmail start"
		fi
	fi
	for i in /usr/lib/sendmail /usr/sbin/sendmail; do
		if [ -f $i.old -o -L $i.old ]; then
			echo "restoring sendmail"
			%{__rm} -f $i
			%{__mv} $i.old $i
		fi
	done
fi

# fix changelog for openSUSE buildservice
%changelog
