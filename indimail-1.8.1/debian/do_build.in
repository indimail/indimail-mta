#!/bin/sh
version=@version@
libdkim_version=1.3
pam_multi_version=1.1
altermime_version=0.3.10
ripmime_version=1.4.0.9
flash_version=0.9.4
mpack_version=1.6
logalert_version=0.3
fortune_version=1.1
nssd_version=1.1
courier_version=4.9.1
bogofilter_version=1.2.2
fetchmail_version=6.3.19
clamav_version=0.97

for i in libdkim-"$libdkim_version" bogofilter-"$bogofilter_version" \
	altermime-"$altermime_version" ripmime-"$ripmime_version" flash-"$flash_version" \
	fortune-"$fortune_version" logalert-"$logalert_version" mpack-"$mpack_version" \
	pam-multi-"$pam_multi_version" qmail-1.03 ucspi-tcp-0.88 \
	courier-imap-"$courier_version" fetchmail-"$fetchmail_version" nssd-"$nssd_version" clamav-"$clamav_version"
do
	if [ "$i" = "ucspi-tcp-0.88" ] ; then
		j=ucspi-tcp_0.88
	elif [ "$i" = "pam-multi-"$pam_multi_version"" ] ; then
		j=pam-multi_"$pam_multi_version"
	elif [ "$i" = "courier-imap-"$courier_version"" ] ; then
		j=courier-imap_"$courier_version"
	else
		j=`echo $i | sed s{-{_{g`
	fi
	if [ -f $i.tar.bz2 ] ; then
		echo "Extracting $i.tar.bz2"
		bzip2 -d -c $i.tar.bz2|tar xf -
		mv $i.tar.bz2 $j.orig.tar.bz2
	elif [ -f $i.tar.gz ] ; then
		echo "Extracting $i.tar.gz"
		gunzip -c $i.tar.gz|tar xf -
		mv $i.tar.gz $j.orig.tar.gz
	elif [ -f $j.orig.tar.gz -o -f $j.orig.tar.bz2 ] ; then
		continue
	else
		echo "Missing archive for $i" >&2
		exit 1
	fi
	if [ -f indimail-"$version"/patches/$i.patch.gz ] ; then
		echo "Patching $i"
		gunzip -c indimail-"$version"/patches/$i.patch.gz | patch -p0
	elif [ -f indimail-"$version"/patches/$i.patch ] ; then
		echo "Patching $i"
		patch -p0 < indimail-"$version"/patches/$i.patch
	fi
done
exit 0
