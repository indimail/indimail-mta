<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN">
<HTML
><HEAD
><link rel='stylesheet' type='text/css' href='manpage.css'>
  <!-- $Id: imapd.sgml,v 1.2 2002/10/13 20:42:00 mrsam Exp $ -->
  <!-- Copyright 1998 - 2001 Double Precision, Inc.  See COPYING for -->
  <!-- distribution information. -->
<meta name="MSSmartTagsPreventParsing" content="TRUE">
<link rel="icon" href="icon.gif" type="image/gif" />
<TITLE
>imapd</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.7"></HEAD
><BODY
CLASS="REFENTRY"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><H1
><A
NAME="IMAPD"
></A
>imapd</H1
><DIV
CLASS="REFNAMEDIV"
><A
NAME="AEN10"
></A
><H2
>Name</H2
>imapd&nbsp;--&nbsp;Courier-IMAP server</DIV
><DIV
CLASS="REFSYNOPSISDIV"
><A
NAME="AEN13"
></A
><H2
>Synopsis</H2
><P
><B
CLASS="COMMAND"
>@libexecdir@/couriertcpd</B
> {couriertcpd options} {@prefix@/sbin/imaplogin} [<VAR
CLASS="REPLACEABLE"
>modules</VAR
>...] {@prefix@/bin/imapd} {./Maildir}</P
><P
><B
CLASS="COMMAND"
>@prefix@/bin/imapd</B
> {./Maildir}</P
></DIV
><DIV
CLASS="REFSECT1"
><A
NAME="AEN25"
></A
><H2
>DESCRIPTION</H2
><P
><B
CLASS="COMMAND"
>imapd</B
> is the <TT
CLASS="APPLICATION"
>Courier-IMAP</TT
>
server that provides IMAP access to
Maildir mailboxes.
Normally you don't have to worry about it, as <B
CLASS="COMMAND"
>imapd</B
>
runs automatically after receiving a network connection, accompanied by
the appropriate userid and password.</P
><P
><B
CLASS="COMMAND"
>couriertcpd</B
> opens network ports that receive incoming
IMAP connections.
After an incoming network connections is established,
<B
CLASS="COMMAND"
>couriertcpd</B
>
runs the command specified by its first argument, which is
<B
CLASS="COMMAND"
>imaplogin</B
> passing the remaining arguments to
<B
CLASS="COMMAND"
>imaplogin</B
>.
<B
CLASS="COMMAND"
>imaplogin</B
> reads the IMAP login userid and password,
then runs the modules specified by its remaining options, which
are Courier authentication modules described in the
<A
HREF="authlib.html"
TARGET="_top"
><SPAN
CLASS="CITEREFENTRY"
><SPAN
CLASS="REFENTRYTITLE"
>authlib</SPAN
>(7)</SPAN
></A
>
manual page.</P
><P
>The last daisy-chained command is
<B
CLASS="COMMAND"
>imapd</B
>, which is the actual IMAP server,
which is started from the logged-in account's home directory.
The sole argument to <B
CLASS="COMMAND"
>imapd</B
> is the pathname
to the default IMAP mailbox, which is usually
<TT
CLASS="FILENAME"
>./Maildir</TT
>.
Some authentication modules are capable of specifying a different
filename, by setting the <VAR
CLASS="ENVAR"
>MAILDIR</VAR
> environment variable.</P
><P
><B
CLASS="COMMAND"
>imapd</B
> may also be invoked from the shell prompt, in which
case it issues a <TT
CLASS="LITERAL"
>PREAUTH</TT
> response, then changes the
current directory to either its
argument, or the contents of the <VAR
CLASS="ENVAR"
>MAILDIR</VAR
> environment
variable, then attempts to talk IMAP on standard input and output.</P
><P
><B
CLASS="COMMAND"
>imapd</B
> implements IMAP4REV1, as defined by
<A
HREF="http://www.rfc-editor.org/rfc/rfc2060.txt"
TARGET="_top"
>RFC 2060</A
>.</P
></DIV
><DIV
CLASS="REFSECT1"
><A
NAME="AEN53"
></A
><H2
>FILES AND ENVIRONMENT VARIABLES</H2
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
><VAR
CLASS="ENVAR"
>AUTH*</VAR
></DT
><DD
><P
><B
CLASS="COMMAND"
>imapd</B
> examines several environment variables whose
names start with AUTH - these environment variables are set by
<B
CLASS="COMMAND"
>imaplogin</B
> and the authentication modules.
Their absence tells
<B
CLASS="COMMAND"
>imapd</B
> that it's running from the command line.</P
></DD
><DT
><VAR
CLASS="ENVAR"
>MAILDIR</VAR
></DT
><DD
><P
><VAR
CLASS="ENVAR"
>MAILDIR</VAR
> - if defined,
<B
CLASS="COMMAND"
>imapd</B
> changes its directory to the
one specified by this environment variable.
Otherwise <B
CLASS="COMMAND"
>imapd</B
> changes
its directory to the one specified on the command line.</P
></DD
><DT
><TT
CLASS="FILENAME"
>`<B
CLASS="COMMAND"
>pwd</B
>`/.</TT
></DT
><DD
><P
>The current directory is assumed to be the main INBOX
Maildir.</P
></DD
><DT
><TT
CLASS="FILENAME"
>`<B
CLASS="COMMAND"
>pwd</B
>`/.<VAR
CLASS="REPLACEABLE"
>folder</VAR
></TT
></DT
><DD
><P
>Maildir folders, each one containing their own
tmp, new, cur, etc...</P
></DD
></DL
></DIV
><P
>Other environment variables are initialized from the
<TT
CLASS="FILENAME"
>@sysconfdir@/imapd</TT
> and
<TT
CLASS="FILENAME"
>@sysconfdir@/imapd-ssl</TT
> configuration files.
These files are loaded into the environment by the system startup script
that runs <B
CLASS="COMMAND"
>couriertcpd</B
>.</P
><DIV
CLASS="REFSECT2"
><A
NAME="AEN89"
></A
><H3
>Realtime concurrent folder status updates</H3
><P
>Setting the <TT
CLASS="LITERAL"
>IMAP_ENHANCEDIDLE</TT
> to
<TT
CLASS="LITERAL"
>1</TT
> in
<TT
CLASS="FILENAME"
>@sysconfdir@/imapd</TT
> enables realtime concurrent folder
status updates.
When relatime folder status updates are enabled all IMAP mail clients
that have the same folder open will be
immediately notified of any changes to the folder's contents.</P
><P
>The Courier-IMAP server always allows more than one mail client to have the
same folder opened.
However, when two or more clients have the same folder opened, the mail
clients may not necessarily know when another client added or removed
messages from the folder.
The base IMAP protocol specification requires IMAP mail clients to explicitly
check for any changes to the folder's contents.
No provisions exists to notify the mail client immediately when the folder's
contents are modified by another mail client.</P
><P
>The <TT
CLASS="LITERAL"
>IDLE</TT
> extension to the base IMAP protocol provides
a delivery mechanism for notifying mail clients of changes to the mail
folder's contents.  Although at this time it's not known to which extent
the <TT
CLASS="LITERAL"
>IDLE</TT
> extension is supported by IMAP mail clients,
the Courier-IMAP server fully implements the <TT
CLASS="LITERAL"
>IDLE</TT
>
extension provided that the following requirements are met:</P
><P
></P
><DIV
CLASS="VARIABLELIST"
><DL
><DT
><TT
CLASS="APPLICATION"
>FAM</TT
></DT
><DD
><P
>The
<A
HREF="http://oss.sgi.com/projects/fam/"
TARGET="_top"
>File Alteration Monitor</A
> package, FAM, must be properly installed and
configured prior to installing Courier-IMAP.</P
><P
><TT
CLASS="APPLICATION"
>FAM</TT
> is an application library that
provides an interface to the operating system's kernel
that applications can use to be notified when specific files
or directories are changed, and Courier-IMAP leverages this API to implement
realtime concurrent folder status updates.
According to the most recently available documentation,
<TT
CLASS="APPLICATION"
>FAM</TT
>
builds and runs on Linux and IRIX.
<TT
CLASS="APPLICATION"
>FAM</TT
>
should also build on other platform, but without a supported kernel monitor
FAM will fall back to a polling mode.
At press time,
<TT
CLASS="APPLICATION"
>FAM</TT
>'s
web site reports that
<TT
CLASS="APPLICATION"
>FAM</TT
>
succesfully builds (in polling mode) on FreeBSD and Solaris.</P
><P
><TT
CLASS="APPLICATION"
>FAM</TT
>
also works with NFS filesystems.
On NFS clients <B
CLASS="COMMAND"
>fam</B
> transparently forwards file monitoring
requests to a peer <B
CLASS="COMMAND"
>fam</B
> process on the NFS server.</P
><P
>Installation and configuration of <TT
CLASS="APPLICATION"
>FAM</TT
> is beyond
the scope of this document.  This documentation presumes that FAM is
succesfully installed.  Use the resources and tools on
<A
HREF="http://oss.sgi.com/projects/fam/"
TARGET="_top"
>FAM's web site</A
>
for assistance with setting up FAM.
Systems that use GNOME or KDE desktops already have
<TT
CLASS="APPLICATION"
>FAM</TT
>
installed, as
<TT
CLASS="APPLICATION"
>FAM</TT
>
is used by the current versions of both desktops.</P
></DD
><DT
><TT
CLASS="LITERAL"
>IDLE</TT
> IMAP capability</DT
><DD
><P
><TT
CLASS="LITERAL"
>IDLE</TT
>
must be listed in the
<VAR
CLASS="ENVAR"
>IMAP_CAPABILITY</VAR
>
setting in the <TT
CLASS="FILENAME"
>@sysconfdir@/imapd</TT
>
configuration file.
This is the default setting in new Courier-IMAP 1.6.0/Courier 0.40 installs.
The default setting in previous versions of the server does not include
the <TT
CLASS="LITERAL"
>IDLE</TT
> capability.
When upgrading from the previous version the <TT
CLASS="LITERAL"
>IDLE</TT
>
capability must be manually added.</P
></DD
><DT
><VAR
CLASS="ENVAR"
>IMAP_USELOCKS</VAR
></DT
><DD
><P
>This setting in <TT
CLASS="FILENAME"
>@sysconfdir@/imapd</TT
>
must be enabled.
This setting uses dot-lock files to synchronize updates to folder indexes
between multiple IMAP clients that have the same folder opened.</P
><P
>This setting is safe to use with NFS, as it does not use actual file locking
calls, and does not require the services of the problematic NFS lock
daemon.</P
></DD
><DT
>An IMAP mail client that fully supports the
<TT
CLASS="LITERAL"
>IDLE</TT
>
protocol extension.</DT
><DD
><P
>Of course, an IMAP client that supports the <TT
CLASS="LITERAL"
>IDLE</TT
>
protocol extension is required.
At press time the status and extent of <TT
CLASS="LITERAL"
>IDLE</TT
> support
in most IMAP mail clients is not known.</P
></DD
><DT
><VAR
CLASS="ENVAR"
>IMAP_ENHANCEDIDLE</VAR
></DT
><DD
><P
>This setting in <TT
CLASS="FILENAME"
>@sysconfdir@/imapd</TT
>
actually enables concurrent realtime folder status updates using the
<TT
CLASS="LITERAL"
>IDLE</TT
> extension.
Note that it is possible to enable the <TT
CLASS="LITERAL"
>IDLE</TT
> extension
even if <TT
CLASS="APPLICATION"
>FAM</TT
> is not available, or without
enabling either the <VAR
CLASS="ENVAR"
>IMAP_USELOCKS</VAR
> and/or
<VAR
CLASS="ENVAR"
>IMAP_ENHANCEDIDLE</VAR
> settings.
The resulting consequences are described are as follows:</P
><P
></P
><OL
TYPE="1"
><LI
><P
>Without <VAR
CLASS="ENVAR"
>IMAP_USERLOCKS</VAR
> there exists a small possibility
that multiple mail clients will receive a slightly inconsistent folder index
if both clients try to update the contents of the folder at the same time.
Usually, the worst case result is that some clients will eventually end up
downloading the same message twice from the server, and caching it incorrectly
in the local cache (if the IMAP client caches message contents).
Clearing the local message cache will quickly eliminate any residual
confusion that results from this situation.</P
></LI
><LI
><P
>Without <TT
CLASS="APPLICATION"
>FAM</TT
>, and
<VAR
CLASS="ENVAR"
>IMAP_ENHANCEDIDLE</VAR
> set, the Courier-IMAP server will
manually check for changes to the folder's contents every 60 seconds,
in IDLE mode (instead of in real time).</P
></LI
></OL
></DD
></DL
></DIV
></DIV
><DIV
CLASS="REFSECT2"
><A
NAME="AEN165"
></A
><H3
>Verifying realtime concurrent folder status updates</H3
><P
>Use the following procedure to verify that realtime concurrent folder status
updates are properly working.
It is helpful to be familiar with the IMAP protocol.
If that's not the case, just be extra careful in entering the IMAP protocol
commands.
The following instructions describe the procedure for connecting to the
IMAP server, and manually issuing IMAP protocol commands, as if they
originate from an IMAP client.
The following instructions use "<TT
CLASS="LITERAL"
>C:</TT
>" to indicate IMAP
client commands that must be entered, and "<TT
CLASS="LITERAL"
>S:</TT
>" to
indicate the expected replies from the server.</P
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="100%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
>NOTE:</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>The actual replies from the server may differ slightly, due to the actual
server configuration, and other minor factors.
The following examples have long lines wrapped for readability.

Slight observed differences from the expected replies are normal, but they
should still be substantively the same.</P
></TD
></TR
></TABLE
></DIV
><P
></P
><OL
TYPE="1"
><LI
><P
>Prepare a test account with a couple of messages.
Open two or three terminal windows.
In each window, connect to the IMAP server, and enter IDLE mode:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>S:* OK Courier-IMAP ready. Copyright 1998-2002 Double Precision, Inc.
  See COPYING for distribution information.
C:a login <VAR
CLASS="REPLACEABLE"
>userid</VAR
> <VAR
CLASS="REPLACEABLE"
>password</VAR
>
S:a OK LOGIN Ok.
C:a SELECT INBOX
S:* FLAGS (\Draft \Answered \Flagged \Deleted \Seen \Recent)
  * OK [PERMANENTFLAGS (\Draft \Answered \Flagged \Deleted \Seen)]
    Limited
  * 2 EXISTS
  * 0 RECENT
  * OK [UIDVALIDITY 939609418] Ok
  a OK [READ-WRITE] Ok
C:a IDLE
S:+ entering ENHANCED idle mode</PRE
></TD
></TR
></TABLE
><DIV
CLASS="NOTE"
><P
></P
><TABLE
CLASS="NOTE"
WIDTH="90%"
BORDER="0"
><TR
><TD
WIDTH="25"
ALIGN="CENTER"
VALIGN="TOP"
>NOTE:</TD
><TD
ALIGN="LEFT"
VALIGN="TOP"
><P
>The default Courier-IMAP server configuration permits a maximum of four
connections from the same IP address.
It may be necessary to adjust this setting in
<TT
CLASS="FILENAME"
>@sysconfdir@/imapd</TT
>
for the duration of this test.</P
></TD
></TR
></TABLE
></DIV
></LI
><LI
><P
>The last message from the server must be "entering ENHANCED idle mode".
Otherwise, it means that some of the necessary prerequisites have not been
met.
Verify that <TT
CLASS="APPLICATION"
>FAM</TT
> was set up prior to installing
Courier-IMAP (use <SPAN
CLASS="CITEREFENTRY"
><SPAN
CLASS="REFENTRYTITLE"
>ldd</SPAN
>(1)</SPAN
>
to verify that the <B
CLASS="COMMAND"
>imapd</B
> executable is linked with
the <TT
CLASS="FILENAME"
>libfam</TT
> library), and verify the settings in the
<TT
CLASS="FILENAME"
>@sysconfdir@/imapd</TT
>.</P
></LI
><LI
><P
>Open another terminal window, connect to the server, and modify the flags
of one of the messages:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>S:* OK Courier-IMAP ready. Copyright 1998-2002 Double Precision, Inc.
  See COPYING for distribution information.
C:a login <VAR
CLASS="REPLACEABLE"
>userid</VAR
> <VAR
CLASS="REPLACEABLE"
>password</VAR
>
S:a OK LOGIN Ok.
C:a SELECT INBOX
S:* FLAGS (\Draft \Answered \Flagged \Deleted \Seen \Recent)
  * OK [PERMANENTFLAGS (\Draft \Answered \Flagged \Deleted \Seen)]
    Limited
  * 2 EXISTS
  * 0 RECENT
  * OK [UIDVALIDITY 939609418] Ok
  a OK [READ-WRITE] Ok
C:STORE 1 +FLAGS (\Deleted)
* 1 FETCH (FLAGS (\Deleted))
a OK STORE completed.</PRE
></TD
></TR
></TABLE
></LI
><LI
><P
>The last command sets the <TT
CLASS="LITERAL"
>\Deleted</TT
> flag on the first
message in the folder.
Immediately after entering the last command,
"<TT
CLASS="LITERAL"
>* 1 FETCH (FLAGS (\Deleted))</TT
>" should also appear
in all other terminal windows.
On systems where <TT
CLASS="APPLICATION"
>FAM</TT
> uses the fall-back polling
mode this response may appear after a brief delay of a few seconds.
The delay should never exceed 15-20 seconds.</P
></LI
><LI
><P
>Verify that all terminal windows reliably receive folder status updates in
real time by alternatively entering the commands
"<TT
CLASS="LITERAL"
>a STORE 1 -FLAGS (\Deleted)</TT
>"
and
"<TT
CLASS="LITERAL"
>a STORE 1 +FLAGS (\Deleted)</TT
>",
to toggle the deleted flag on the first message.
Observe that the message is received by all terminal windows quickly,
and reliably.</P
></LI
><LI
><P
>With the <TT
CLASS="LITERAL"
>\Deleted</TT
> flag set on the first message,
enter the <B
CLASS="COMMAND"
>EXPUNGE</B
> command, which removes the deleted
message from the folder:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>C:a EXPUNGE
S:* 1 EXPUNGE
  * 2 EXISTS
  * 0 RECENT
S:a OK EXPUNGE completed</PRE
></TD
></TR
></TABLE
><P
>The lines that begin with the "*" character should also appear in all other
terminal windows (depending on the initial folder state one of the terminal
windows may have a different <TT
CLASS="LITERAL"
>RECENT</TT
> message, which is
fine).</P
></LI
><LI
><P
>Use a mail client to create and send a test message to the test account.
As soon as the mail server delivers the message, the following
messages should appear in every terminal window:</P
><TABLE
BORDER="0"
BGCOLOR="#E0E0E0"
WIDTH="90%"
><TR
><TD
><PRE
CLASS="PROGRAMLISTING"
>* 3 EXISTS
* 0 RECENT
* 3 FETCH (FLAGS ())</PRE
></TD
></TR
></TABLE
><P
>The numbers in these messages may be different, depending upon the
initial contents of the test mail folder.
One of the terminal windows should have a different <TT
CLASS="LITERAL"
>RECENT</TT
>
count,
and one of the terminal windows should include a
<TT
CLASS="LITERAL"
>\Recent</TT
> flag in the untagged
<TT
CLASS="LITERAL"
>FLAGS</TT
> message.
These difference are acceptable; the important thing is to make sure that
all terminal windows have the same <TT
CLASS="LITERAL"
>EXISTS</TT
> message.</P
></LI
></OL
></DIV
></DIV
><DIV
CLASS="REFSECT1"
><A
NAME="AEN219"
></A
><H2
>SEE ALSO</H2
><P
><A
HREF="authlib.html"
TARGET="_top"
><SPAN
CLASS="CITEREFENTRY"
><SPAN
CLASS="REFENTRYTITLE"
>authlib</SPAN
>(7)</SPAN
></A
>,
 
<A
HREF="userdb.html"
TARGET="_top"
><SPAN
CLASS="CITEREFENTRY"
><SPAN
CLASS="REFENTRYTITLE"
>userdb</SPAN
>(8)</SPAN
></A
></P
></DIV
></BODY
></HTML
>