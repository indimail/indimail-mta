#!/bin/sh
# postrm script for indimail
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postrm> `remove'
#        * <postrm> `purge'
#        * <old-postrm> `upgrade' <new-version>
#        * <new-postrm> `failed-upgrade' <old-version>
#        * <new-postrm> `abort-install'
#        * <new-postrm> `abort-install' <old-version>
#        * <new-postrm> `abort-upgrade' <old-version>
#        * <disappearer's-postrm> `disappear' <overwriter>
#          <overwriter-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


prefix=@prefix@
mandir=@mandir@
indimaildir=@indimaildir@
shareddir=@shareddir@
sysconfdir=@sysconfdir@
servicedir=/service
logdir=@logdir@
rm=/bin/rm
rmdir=/bin/rmdir
####################################
noproxy=0
nocourierimap=0
noclamav=1
nofetchmail=0
nobogofilter=0
nonssd=0
default_domain=@defaultdomain@

ID=`id -u`
if [ $ID -ne 0 ] ; then
	echo "You are not root" >&2
	exit 1
fi

case "$1" in
    purge|remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

# we are doing upgrade or removal
if [ " $1" = " upgrade" ] ; then
	echo "recreating ld.so cache"
	/sbin/ldconfig
	exit 0
fi

case "$1" in
    failed-upgrade|abort-install|abort-upgrade|disappear)
	exit 0
    ;;
esac
#
# Debian silliness
#
(
if [ " $1" = " purge" ] ; then
	nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd stop
		fi
	fi

	for i in alias qmaild qmaill qmailp qmailq qmailr qmails qscand indimail
	do
		echo "removing user $i"
		/usr/bin/getent passwd $i > /dev/null && /usr/sbin/userdel $i >/dev/null || true
	done
	for i in nofiles qmail qscand indimail
	do
		echo "removing group $i"
		/usr/bin/getent group $i > /dev/null && /usr/sbin/groupdel $i  >/dev/null || true
	done
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd start
		fi
	fi

	echo "removing database and configuration"
	for i in mysqldb domains alias
	do
		${rm} -rf ${indimaildir}/$i || true
	done
	${rm} -f ${indimaildir}/bin || true
	${rm} -f ${indimaildir}/sbin || true
	${rm} -f ${indimaildir}/users || true
	${rm} -f ${indimaildir}/control || true
	${rm} -rf ${sysconfdir} || true
	if [ -f /etc/mysql/indimail.cnf ] ; then
		${rm} -f /etc/mysql/indimail.cnf
	fi
	if [ -d ${sysconfdir}/control/domainkeys ] ; then
		${rmdir} --ignore-fail-on-non-empty ${sysconfdir}/control/domainkeys || true
	fi
	if [ -d ${sysconfdir}/control ] ; then
		${rmdir} --ignore-fail-on-non-empty ${sysconfdir}/control || true
	fi
	for i in .qmail-nonspam .qmail-register-nonspam .qmail-register-spam .qmail-spam .qmail-default
	do
		${rm} -f ${indimaildir}/domains/${default_domain}/$i
	done
	if [ -d ${indimaildir}/domains/${default_domain} ] ; then
		${rmdir} --ignore-fail-on-non-empty ${indimaildir}/domains/${default_domain} || true
	fi
	echo "removing aliases postmaster, mailer-daemon, root"
	for i in postmaster mailer-daemon root
	do
		${rm} -f ${indimaildir}/alias/.qmail-"$i"
	done
	if [ -d ${indimaildir}/alias ] ; then
		${rmdir} --ignore-fail-on-non-empty ${indimaildir}/alias || true
	fi
	${rm} -f ${sysconfdir}/imapd.pem ${sysconfdir}/pop3d.pem
	${rm} -f ${sysconfdir}/imapd.cnf.* ${sysconfdir}/pop3d.cnf.*

	echo "removing binaries, libraries, queues"
	if [ ${prefix} = "/var/indimail" -o ${prefix} = "/var/qmail" ] ; then
		for i in ${prefix}/bin ${prefix}/sbin ${prefix}/lib ${indimaildir}/queue \
			${mandir}/man1 ${mandir}/cat1 ${mandir}/man5 ${mandir}/cat5 \
			${mandir}/man7 ${mandir}/cat7 ${mandir}/man8 ${mandir}/cat8
		do
			${rm} -rf $i || true
		done
		for i in `/bin/ls ${sharedir} 2>/dev/null`
		do
			${rm} -rf ${shareddir}/$i || true
		done
	else
		for i in bin sbin control users
		do
			${rm} -f ${indimaildir}/$i || true
		done
		# queue
		${rm} -rf ${indimaildir}/queue || true
		# modules
		${rm} -rf ${prefix}/lib/indimail || true
		# shareddir
		if [ ! " ${shareddir}" = " /usr/share" ] ; then
			for i in `/bin/ls ${shareddir} 2>/dev/null`
			do
				${rm} -rf ${shareddir}/$i || true
			done
		fi
		# libexecdir
		if [ ! " ${libexecdir}" = " /usr/libexec" ] ; then
			${rm} -rf ${libexecdir} || true
		fi
	fi
	echo "removing man pages"
	${rmdir} --ignore-fail-on-non-empty ${mandir} || true
	if [ -d ${shareddir} ] ; then
	echo "removing architecture-independent shared directory"
	${rmdir} --ignore-fail-on-non-empty ${shareddir} || true
	fi

	if [ $nobogofilter -eq 0 ] ; then
		${rm} -f ${sysconfdir}/bogofilter.cf ${sysconfdir}/bogofilter.cf.example
	fi

	if [ $noclamav -eq 0 ] ; then
		${rm} -f ${sysconfdir}/clamd.conf ${sysconfdir}/freshclam.conf
		${rm} -f ${sysconfdir}/clamd.conf.disabled ${sysconfdir}/freshclam.conf.disabled
		${rm} -f ${sysconfdir}/clamd.conf.sample ${sysconfdir}/freshclam.conf.sample
	fi
	if [ $nonssd -eq 0 ] ; then
		${rm} -f ${sysconfdir}/nssd.conf
	fi
	if [ $nofetchmail -eq 0 ] ; then
		${rm} -f ${sysconfdir}/fetchmailrc
	fi

	echo "removing tcp configuration"
	for i in imap pop3 smtp qmtp qmqp poppass
	do
		${rm} -f ${sysconfdir}/tcp.$i.cdb ${sysconfdir}/tcp.$i
	done
	${rm} -f ${sysconfdir}/control/controlfiles
	for i in indimail.cnf stat.override backup.conf cronlist headerlist \
		imapd.cnf imapd.dist imapd-ssl.dist inc_deps indimail.mrtg.cfg \
		procmailrc indimail.settings lib_deps osh.table perm_list pop3d.cnf \
		pop3d.dist pop3d-ssl.dist qmailprog.list quotawarnmsg.example \
		services.log system.flashlogin system.menu system.module system.rc
	do
		${rm} -f ${sysconfdir}/$i
	done
	if [ -d ${indimaildir}/domains ] ; then
	${rmdir} --ignore-fail-on-non-empty ${indimaildir}/domains || true
	fi
	if [ -d ${indimaildir}/users ] ; then
	${rmdir} --ignore-fail-on-non-empty ${indimaildir}/users || true
	fi
	if [ -d ${indimaildir} ] ; then
	${rmdir} --ignore-fail-on-non-empty ${indimaildir} || true
	fi

	echo "removing startup services"
	for i in clamd fetchmail freshclam indisrvr.4000 inlookup.infifo mysql.3306 \
	pwdlookup qmail-imapd.143 qmail-imapd-ssl.993 qmail-pop3d.110 qmail-pop3d-ssl.995 \
	qmail-send.25 qmail-smtpd.25 qmail-smtpd.366 qmail-spamlog qscanq qmail-imapd.4143 \
	qmail-pop3d.4110 qmail-smtpd.465 qmail-smtpd.587 qmail-qmtpd.209 qmail-qmqpd.628 \
	qmail-poppass.106 greylist.1999 udplogger.3000 .svscan
	do
		if [ -d ${servicedir}/$i ] ; then
			${rm} -rf ${servicedir}/$i >/dev/null 2>&1 || true
		fi
	done
	if [ $noproxy -eq 0 ] ; then
		for i in proxy-imapd.4143 proxy-imapd-ssl.9143 proxy-pop3d.4110 proxy-pop3d-ssl.9110
		do
			if [ -d ${servicedir}/$i ] ; then
				${rm} -rf ${servicedir}/$i >/dev/null 2>&1 || true
			fi
		done
	fi

	echo "removing logs"
	${rm} -f ${indimaildir}/mysqldb/logs/logisam.log
	${rm} -f ${indimaildir}/mysqldb/logs/logquery
	${rm} -f ${indimaildir}/mysqldb/logs/logslow
	count=`/bin/ls ${servicedir} 2>/dev/null| /usr/bin/wc -l`
	if [ $count -eq 0 ] ; then # ignore disabled services
		${rm} -rf ${servicedir} || true
	fi
	if [ -h ${logdir} ] ; then
		log_dir=`/bin/ls -ld ${logdir} | /usr/bin/awk '{print $10}'`
	else
		log_dir=${logdir}
	fi
	[ "$log_dir" != "/" ] && ${rm} -fr $log_dir
else
	echo "recreating ld.so cache"
	/sbin/ldconfig
	if [ -f ${shareddir}/boot/rpm.init ] ; then
		echo "Running Custom Un-Installation Script for postun"
		/bin/sh ${shareddir}/boot/rpm.init postun
	fi
fi
) >> /tmp/indimail-uninstall.log
exit 0
