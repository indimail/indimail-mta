File README-CLUSTER, Version @version@
DATE: @DATE@

    You can either have a normal non-clustered domain or a clustered domain. A clustered domain
    is a domain extended across multiple hosts. To achieve high performance needed for high
    volume servers, IndiMail uses MySQL to store some of the information in MySQL tables. All
    indimail program depend on one or more control file to figure out how to extract this
    information stored in MySQL tables. These control files are host.cntrl, host.master,
    host.mysql. Take a look at http://groups.google.com/group/indimail/web/quick-install

    IndiMail supports a cluster of servers for a domain. A cluster is a set of servers
    having the same domain. In other words, a clustered domain is a domain which has been
    extended across more than one server.
    (Refer to the diagram at https://sourceforge.net/project/screenshots.php?group_id=230686)

    There are five types of servers
    1) clusterinfo  - This is the host which has a MySQL database for storing the location
       of each user. Location information is hostid and ip address.
       If this host is going to serve as a pure MySQL database server only, you need not
       install IndiMail on this server.
    2) Mailstores - A mailstore is a host which has disk space to host user's mailboxes.
       Each mailstore can have its own set of users. You can call each host a 'node'.
       IndiMail allows you to extend a domain across multiple mailstores. Each mailstore
       needs its own MySQL database to store information for its own set of users. You may
       install a MySQL database on each of the mailstore.
       You need to install IndiMail on each mailstore.
    3) Relay Server - A relay server acts as an SMTP gateway between the user and the
       mailstore or between the user and the internet. A relay server can also carry
       out tasks like virus/spam filtering, maintain your security policy, access lists.
       You need to install IndiMail on each relay server.
    4) IMAP/POP3 Gateway - These servers run IndiMail's IMAP/POP3 Proxies
       You need to install IndiMail on each IMAP/POP3 proxy server.
    5) Webmail - This servers run a webmail software (like squirellmail, roundcube, etc).
       In case your webmail software connects to localhost on the IMAP/POP3 port, you will
       need to install IndiMail for having the IMAP/POP3 proxy.

    The control files used to figure out the MySQL server storing IndiMail configuration/information
    depends on whether you are running a clustered or a non-clustered domain. Read below to
    know more about this.

    Non-Clustered Domain
    --------------------
    In this case IndiMail just requires how to connect to a single MySQL database. You can
    create a control file host.mysql which has the IP address or hostname for the MySQL
    database. If this file is missing, IndiMail program will use 'localhost' my default.

    # echo localhost > @indimaildir@/control/host.mysql (MySQL host to which all programs will
                                                         connect)
    NOTE: you can also use host:user:password:socket or host:user:password:port format
    for host.mysql (for IndiMail 1.6.9 and above)

    # echo "localhost:indimail:ssh-1.5-:/tmp/mysql.sock" > host.mysql

    Clustered Domain
    ----------------

    Each mailstore requires a MySQL database to store user information. When a domain is
    extended across multiple mailstores, you require an additional MySQL database called
    the clusterinfo. The clusterinfo is used to store information about all the MySQL
    databases for each of the mailstores. When you extend a domain, each mailstore needs
    to have the control files host.cntrl and host.master. These control files has  the IP
    address or hostname of the clusterinfo MySQL database. The clusterinfo database also
    stores each user's mailstore. This is required to ensure that each mail reaches the
    correct user on the correct mailstore.

    Adding the first Mailstore in a cluster
    =======================================

    There are three files required on all hosts serving mailboxes (mailstores) for 
    clustered domain - host.cntrl,host.master & mcdinfo

    echo hostcntrl_host > @indimaildir@/control/host.mysql   (MySQL host to which all programs will
                                                             connect)
      or
    echo "hostcntrl_host:user:password:mysql socket/port" > @indimaildir@/control/host.mysql

    When you have a clustered domain, IndiMail supports the use of Master-Slave architecture in
    MySQL.

    echo hostcntrl_master > @indimaildir@/control/host.master (for a clustered domain, the master host)
    echo hostcntrl_slave  > @indimaildir@/control/host.cntrl  (for a clustered domain, the slave host)

    where hostcntrl_master is the IP address of MySQL Master having the host control information.
    where hostcntrl_slaver is the IP address of MySQL Slave  having the host control information.

    NOTE: you can also use host:user:password:socket or host:user:password:port format
    for host.mysql, host.cntrl, host.master (for IndiMail 1.6.9 and above)

    In case you don't desire a master-slave architecture, hostcntrl_master and hostcntrl_slave
    can be the same

    You also need to have a file called mcdinfo having information for all hosts which will host
    the domain indimail.org

    e.g. run the following command to create a clustered domain with just two mail clusters on
    hosts 192.168.2.115 and 192.168.2.116. The cluster information for all users will be
    maintained on the MySQL host at 192.168.2.110. Updating the file on any host updates the file
    on all hosts. You can use any text editor to edit this file.


    (
    echo "domain   indimail.org                     1"
    echo "server   192.168.2.110" # MySQL Server for Cluster Information
    echo "mdahost  192.168.2.115" # Mail Store
    echo "port     3306"
    echo "database indimail"
    echo "user     indimail"
    echo "pass     ssh-1.5-"
    echo
    echo "domain   indimail.org                     1"
    echo "server   192.168.2.110" # MySQL Server for Cluster Information
    echo "mdahost  192.168.2.116" # Mail Store
    echo "port     3306"
    echo "database indimail"
    echo "user     indimail"
    echo "pass     ssh-1.5-"
    echo
    ) > @indimaildir@/control/mcdinfo
    
    The above can also be achieved by executing the following commands
    % @indimaildir@/bin/dbinfo -i -S 192.168.2.110 -D indimail -U indimail -P ssh-1.5- \
        -p 3306 -d indimail.org -m 192.168.2.115
    % @indimaildir@/bin/dbinfo -i -S 192.168.2.110 -D indimail -U indimail -P ssh-1.5- \
        -p 3306 -d indimail.org -m 192.168.2.116

    -- NOTE ----------------------------------------------------------------------------
    The above example has one MySQL server for both the mailstores for storing the user
    information. For better performance you may want to have each mailstore have its own
    MySQL server on the mailstore itself. In that case you can execute the following
    commands
    % @indimaildir@/bin/dbinfo -i -S 192.168.2.115 -D indimail -U indimail -P ssh-1.5- \
        -p 3306 -d indimail.org -m 192.168.2.115
    % @indimaildir@/bin/dbinfo -i -S 192.168.2.116 -D indimail -U indimail -P ssh-1.5- \
        -p 3306 -d indimail.org -m 192.168.2.116
    ------------------------------------------------------------------------------------

    You can use the command @indimaildir@/bin/dbinfo -s to show this information.

    The cluster information is maintained in the MySQL table dbinfo
    Every host has to be assigned a unique identifier called hostid
    Each hostid is associated with the IP address of the mail store host    
    You can use the command vhostid to add, insert, delete or update this
    information. The hostid can be stored in the conrol file @indimaildir@/control/hostid.
    In case this control file is not there, IndiMail will use the gethostid(2) system
    call to get the hostid. The dbinfo table can also be modified directly. The immediate
    next call to 'dbinfo -s' will create the file mcdinfo. One can also use 'dbinfo -i'
    to add entries to dbinfo table. In a cluster you need to update mcdinfo only on one
    host. The entries to mcdinfo on all hosts part of the cluster automatically get updated.

    When you add a user to a host in the cluster, the user gets added to a 
    MySQL table hostcntrl. This table maintains the username, domain and the
    hostid on which the user's mailbox lies.

    The SMTP, IMAP/POP3 processes all look into the tables hostcntrl and host_table to
    figure out the host which has the user's mailbox. You can specify the -m or -h
    argument to vadduser to create users on specific hosts.

    Adding a New Mailstore to a Cluster
    ===================================
    1) use vadddomain on the new node to add domain
    2) Create the files host.cntrl, host.master in @indimaildir@/control
    3) Use dbinfo -i to add entry for the new node

    Adding a New Relay Server/Proxy IMAP/Proxy POP3 Server to a cluster
    ===================================================================
    1) Create the files host.cntrl, host.master in @indimaildir@/control
    2) run dbinfo -s
    3) On host which will have SMTP/qmail-send, have the environment variable
       ROUTES=dynamic for qmail-send. i.e

       # echo dynamic > /service/qmail-send.25/variables/ROUTES
       % svc -d /service/qmail-send.25; svc -u /service/qmail-send.25


NOTE: This document is WIP and will undergo frequent changes till i get satisfied. Help
in simplifying this will be highly apprecated. You can email me at mbhangui@gmail.com, if
you find this confusing or need any help/clarification.
