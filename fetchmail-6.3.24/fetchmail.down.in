#!/bin/sh
#
# $Log: fetchmail.down.in,v $
# Revision 1.5  2008-06-20 20:49:48+05:30  Cprogrammer
# moved slemsPrivate to sbin
#
# Revision 1.4  2005-06-26 12:56:28+05:30  Cprogrammer
# exit for non-dialup setups
# bug fix for servicedir
#
# Revision 1.3  2005-02-18 23:55:04+05:30  Cprogrammer
# added comments
#
# Revision 1.2  2004-05-12 23:03:39+05:30  Cprogrammer
# added comments
#
# Revision 1.1  2003-12-13 16:10:43+05:30  Cprogrammer
# Initial revision
#
#
trap "" 1
if [ ! -f /tmp/.dialup ] ; then
	exit 0
fi

if [ -f /sbin/ifconfig ] ; then
	IFCONFIG=/sbin/ifconfig
elif [ -f /usr/sbin/ifconfig ] ; then
	IFCONFIG=/usr/sbin/ifconfig
elif [ -f /usr/bin/ifconfig ] ; then
	IFCONFIG=/usr/bin/ifconfig
fi
$IFCONFIG ppp0 >/dev/null 2>&1
if [ $? -ne 0 ] ; then
	exit 1
fi
if [ -d /service1 ] ; then
	SERVICEDIR=/service1
elif [ -d /service2 ] ; then
	SERVICEDIR=/service2
else
	SERVICEDIR=/service
fi
#
# send out all outgoing mails
#
@prefix@/sbin/slemsPrivate @prefix@/bin/qmail-tcpok > /dev/null
@prefix@/sbin/slemsPrivate @prefix@/bin/svc -a $SERVICEDIR/qmail-send*
sleep 3
#
# Die when there are no mails in queue
# keep on sleeping for 10 seconds if there are mails in queue
# die if even after 10 tries, mails are still in queue
#
check=0
while true
do
  	count=`@prefix@/sbin/slemsPrivate @prefix@/bin/qmail-qstat | grep Total | grep -v remote | grep -v todo | grep -v local | awk '{print $5}'`
	check=`expr $check + 1`
	if [ " $count" = " 0" ] ; then
		@prefix@/sbin/slemsPrivate @prefix@/sbin/ppp-off
		exit 0
	fi
	sleep 10
	if [ " $check" = " 10" ] ; then
		@prefix@/sbin/slemsPrivate @prefix@/sbin/ppp-off
		exit 1
	fi
done
