#!/bin/sh
#
#
qcount=5
tcpserver_plugin=1
add_boot=0
check_install=9
servicedir=/service
indimaildir=@indimaildir@
prefix=@prefix@
sysconfdir=@sysconfdir@
controldir=@controldir@
libexecdir=@libexecdir@

#
# End USER Configuration OPTIONS
#

# $Id: create_services.in,v 2.63 2017-03-27 08:49:19+05:30 Cprogrammer Exp mbhangui $

usage()
{
	echo "create_service [--servicedir=path] --qbase=path --mbase=path --mysqlPrefix=path [--destdir=path] [--shared-objects] [--chk-install]

	servicedir     - path of Supervise service directory
	qbase          - path for createing IndiMail's queue collection
	mbase          - path where user's home maildir will be created
	mysqlPrefix    - Prefix for MySQL installation
	destdir        - Staging directory for creating service
	shared-objects - Enable loading of shared objects in tcpserver for SMTP
	add-boot       - Enable indimail/indimail-mta in system startup
	chk-install    - Check indimail/indimail-mta installation
	echo
	echo Press ENTER or Cntrl C to quit"
	read key
	exit 1
}

if test $# -eq 0; then
    usage 1
fi

noproxy=0
nocourierimap=0
nofetchmail=0
nobogofilter=0
noindimail=0
noclamav=1
nonssd=0
nodksignatures=0
dkimkeyfn=default
ID=`id -u`
while test $# -gt 0; do
    case "$1" in
    -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
    *) optarg= ;;
    esac

    case "$1" in
    --servicedir=*)
	servicedir=$optarg
	;;

    --qcount=*)
	qcount=$optarg
	;;

    --qbase=*)
	qbase=$optarg
	;;

    --mbase=*)
	mail_path=$optarg
	;;

    --mysqlPrefix=*)
	mysql_base=$optarg
	;;

    --no-courier-imap)
	nocourierimap=1
	;;

    --no-proxy)
	noproxy=1
	;;

    --no-bogofilter)
	nobogofilter=1
	;;

    --no-nssd)
	nonssd=1
	;;

    --no-fetchmail)
	nofetchmail=1
	;;

    --no-clamav)
	noclamav=1
	;;

    --chk-install)
	check_install=1
	;;

	--shared-objects)
	tcpserver_plugin=1
	;;

	--add-boot)
	add_boot=1
	;;

    --destdir=*)
	extra_opt="--destdir=$optarg"
	dir_prefix=$optarg
	;;

    *)
	echo "invalid option [$1]"
	read key
	usage 1
	;;
    esac

    shift
done

if [ ! -x $dir_prefix$prefix/bin/vadddomain -a ! -x $prefix/bin/vadddomain ] ; then
	noindimail=1
fi
if [ $noindimail -eq 0 ] ; then
	if [ " $qbase" = " " -o " $mail_path" = " " -o " $mysql_base" = " " ] ; then
    	usage 1
	fi
else
	if [ " $qbase" = " " ] ; then
    	usage 1
	fi
fi
if [ $ID -eq 0 -a $noindimail -eq 0 -a -z "$dir_prefix" ] ; then
	if [ -d /etc/ld.so.conf.d ] ; then
		(
			echo @mysql_libdir@
			echo @libdir@
		) > /etc/ld.so.conf.d/indimail-`arch`.conf
		/sbin/ldconfig
	fi
fi

if [ -x $dir_prefix$prefix/sbin/svctool ] ; then
	svctool=$dir_prefix$prefix/sbin/svctool
else
	svctool=/usr/sbin/svctool
fi
# some setup
mkdir -p $dir_prefix$prefix/bin
mkdir -p $dir_prefix$prefix/sbin
mkdir -p $dir_prefix$indimaildir
mkdir -p $dir_prefix$controldir
mkdir -p $dir_prefix$sysconfdir/users
mkdir -p $dir_prefix$sysconfdir/control
mkdir -p $dir_prefix$libexecdir
if [ ! -x $dir_prefix$libexecdir/config-fast -a -x $libexecdir/config-fast ] ; then
	/bin/cp $libexecdir/config-fast $dir_prefix$libexecdir
fi
if [ ! -x $dir_prefix$libexecdir/ipmeprint -a -x $libexecdir/ipmeprint ] ; then
	/bin/cp $libexecdir/ipmeprint $dir_prefix$libexecdir
fi
if [ ! -x $dir_prefix$prefix/bin/queue-fix -a -x $prefix/bin/queue-fix ] ; then
	/bin/cp $prefix/bin/queue-fix $dir_prefix$prefix/bin/queue-fix
fi
if [ ! -f $dir_prefix$sysconfdir/users/assign ] ; then
	echo "." > $dir_prefix$sysconfdir/users/assign
fi
if [ ! -x $dir_prefix$prefix/bin/tcprules -a -x $prefix/bin/tcprules ] ; then
	/bin/cp $prefix/bin/tcprules $dir_prefix$prefix/bin/tcprules
fi
######################

if [ ! -x $dir_prefix$prefix/bin/fetchmail -a ! -x $dir_prefix$prefix/bin/fetchmail ] ; then
	nofetchmail=1
fi
if [ ! -x $dir_prefix$prefix/bin/bogofilter -a ! -x $dir_prefix$prefix/bin/bogofilter ] ; then
	nobogofilter=1
fi
if [ ! -x $dir_prefix$prefix/sbin/nssd -a ! -x $dir_prefix$prefix/sbin/nssd ] ; then
	nonssd=1
fi
if [ ! -x $dir_prefix$prefix/bin/imapd -a ! -x $dir_prefix$prefix/bin/imapd ] ; then
	nocourierimap=1
fi
if [ ! -x $dir_prefix$libexecdir/imapmodules/authindi -a ! -x $libexecdir/imapmodues/authindi ] ; then
	noproxy=1
fi
echo "Creating @logdir@"
if [ ! -d $dir_prefix"@logdir@" ] ; then
	mkdir -p $dir_prefix"@logdir@"
fi
if [ -x /bin/chown ] ; then
	chown=/bin/chown
elif [ -x /usr/sbin/chown ] ; then
	chown=/usr/sbin/chown
elif [ -x /usr/bin/chown ] ; then
	chown=/usr/bin/chown
else
	chown=/bin/chown
fi
if [ $ID -eq 0 ] ; then
	$chown -R qmaill:nofiles @logdir@
fi
#
# create users
#
if [ $noindimail -eq 0 ] ; then
	echo "Creating indimail Users"
else
	echo "Creating indimail-mta Users"
fi
$svctool --config=users $extra_opt

#
# MySQL
#
if [ $noindimail -eq 0 ] ; then
$svctool --config=mysql   --mysqlPrefix=$mysql_base $extra_opt
$svctool --config=mysqldb --mysqlPrefix=$mysql_base \
    --databasedir=$indimaildir/mysqldb --base_path=$mail_path $extra_opt
$svctool --mysql=3306 --servicedir=$servicedir \
    --mysqlPrefix=$mysql_base --databasedir=$prefix/mysqldb \
	--config=$sysconfdir/etc/indimail.cnf --default-domain=indimail.org $extra_opt
fi
#
# create qmail config
$svctool --config=qmail --postmaster=postmaster@indimail.org \
	--default-domain=indimail.org $extra_opt

a_arch=`arch`
if [ " $$a_arch" = " x86_64" ] ; then
	fetchmail_mem=144857600
	smtp_soft_mem=104857600
	qmtp_soft_mem=104857600
	qmqp_soft_mem=104857600
	imap_pop3_mem=524288000
	imapspop3_mem=524288000
	poppass_mem=104857600
else
	fetchmail_mem=72428800
	smtp_soft_mem=52428800
	qmtp_soft_mem=52428800
	qmqp_soft_mem=52428800
	imap_pop3_mem=52428800
	imapspop3_mem=52428800
	poppass_mem=52428800
fi
#
# SMTP
#
if [ $nodksignatures -eq 0 ] ; then
	if [ -x $dir_prefix$prefix/bin/dknewkey ] ; then
		ver_opt="both"
		sign_opt="both"
		$dir_prefix$prefix/bin/dknewkey $dir_prefix"$controldir"/domainkeys/$dkimkeyfn 1024
	else
		ver_opt="none"
		sign_opt="none"
	fi
else
	ver_opt="none"
	sign_opt="none"
fi
orig_bogofilter=$nobogofilter

if [ $noclamav -eq 0 ] ; then
	echo "Checking if clamav is installed"
	clamav_os=0
	clamdPrefix=$dir_prefix
	qhpsi="$dir_prefix/bin/clamdscan %s --fdpass --quiet --no-summary"
	mysysconfdir=$dir_prefix/etc
else
	if [ -f /usr/sbin/clamd -a -f /usr/bin/clamdscan ] ; then
		clamav_os=1
		clamdPrefix="/usr"
		qhpsi="/usr/bin/clamdscan %s --fdpass --quiet --no-summary"
		mysysconfdir=/etc
	else
		clamav_os=0
	fi
fi
for port in 465 25 587
do
	if [ $port -eq 465 ] ; then
		e_opt="--skipsend --ssl"
		e_opt="$e_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
	elif [ $port -eq 587 ] ; then
		nobogofilter=1
		e_opt="--skipsend --authsmtp --antispoof"
	else
		e_opt="--remote-authsmtp=plain --localfilter --remotefilter"
		e_opt="$e_opt --deliverylimit-count=-1 --deliverylimit-size=-1"
		e_opt="$e_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
	fi
	if [ $tcpserver_plugin -eq 1 ] ; then
		e_opt="$e_opt --shared-objects=1"
	fi
	if [ $nobogofilter -eq 0 ] ; then
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			$svctool --smtp=$port --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--qhpsi="$qhpsi" \
				--spamfilter="$prefix/bin/bogofilter -p -d $sysconfdir/etc" \
				--logfilter=/tmp/logfifo --rejectspam=0 --spamexitcode=0 \
				--dmasquerade --infifo=infifo \
				--dkverify=$ver_opt \
				--dksign=$sign_opt --private_key=$controldir/domainkeys/%/$dkimkeyfn \
				$e_opt $extra_opt
		else
			$svctool --smtp=$port --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--spamfilter="$prefix/bin/bogofilter -p -d $sysconfdir/etc" \
				--logfilter=/tmp/logfifo --rejectspam=0 --spamexitcode=0 \
				--dmasquerade --infifo=infifo \
				--dkverify=$ver_opt \
				--dksign=$sign_opt --private_key=$controldir/domainkeys/%/$dkimkeyfn \
				$e_opt $extra_opt
		fi
	else
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			$svctool --smtp=$port --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--qhpsi="$qhpsi" \
				--dmasquerade --infifo=infifo \
				--dkverify=$ver_opt \
				--dksign=$sign_opt --private_key=$controldir/domainkeys/%/$dkimkeyfn \
				$e_opt $extra_opt
		else
			$svctool --smtp=$port --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem --chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--dmasquerade --infifo=infifo \
				--dkverify=$ver_opt \
				--dksign=$sign_opt --private_key=$controldir/domainkeys/%/$dkimkeyfn \
				$e_opt $extra_opt
		fi
	fi
	echo "1" > $dir_prefix$servicedir/qmail-smtpd.$port/variables/DISABLE_PLUGIN
	nobogofilter=$orig_bogofilter
done

if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
	$svctool --queueParam=defaultqueue \
		--qbase=$qbase --qcount=$qcount --qstart=1 \
		--min-free=52428800 --fsync --syncdir --virus-filter \
		--qhpsi="$qhpsi" \
		--dkverify="none" --dksign=$sign_opt \
		--private_key=$controldir/domainkeys/%/$dkimkeyfn \
		$e_opt $extra_opt
else
	$svctool --queueParam=defaultqueue \
		--qbase=$qbase --qcount=$qcount --qstart=1 \
		--min-free=52428800 --fsync --syncdir --virus-filter \
		--dkverify="none" --dksign=$sign_opt \
		--private_key=$controldir/domainkeys/%/$dkimkeyfn \
		$e_opt $extra_opt
fi

$svctool --smtp=366 --odmr --servicedir=$servicedir \
	--infifo="" --query-cache --password-cache --memory=$smtp_soft_mem $extra_opt
if [ -d $dir_prefix$servicedir/qmail-smtpd.366/variables ] ; then
	echo "1" > $dir_prefix$servicedir/qmail-smtpd.366/variables/DISABLE_PLUGIN
fi
#
# Greylist
#
$svctool --greylist=1999 --servicedir=$servicedir --min-resend-min=2 \
    --resend-win-hr=24 --timeout-days=30 --context-file=greylist.context \
	--hash-size=65536 --save-interval=5 --whitelist=greylist.white --use-greydaemon $extra_opt
#
# qmtpd service
#
$svctool --qmtp=209 --servicedir=$servicedir \
	--qbase=$qbase --qcount=$qcount --qstart=1 \
	--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 \
	--fsync --syncdir --memory=$qmtp_soft_mem --min-free=52428800 $extra_opt
#
# qmqpd service
#
$svctool --qmqp=628 --servicedir=$servicedir \
	--qbase=$qbase --qcount=$qcount --qstart=1 \
	--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 \
	--fsync --syncdir --memory=$qmqp_soft_mem --min-free=52428800 $extra_opt

#
# fetchmail
#
if [ $nofetchmail -eq 0 ] ; then
	if [ $nobogofilter -eq 0 ] ; then
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			$svctool --fetchmail --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--cntrldir=control --default-domain=indimail.org \
				--qhpsi="$qhpsi" \
				--spamfilter="$prefix/bin/bogofilter -p -d $sysconfdir/etc" \
				--logfilter=/tmp/logfifo --rejectspam=0 --spamexitcode=0 \
				--memory=$fetchmail_mem --fsync --syncdir --dkverify=$ver_opt $extra_opt
		else
			$svctool --fetchmail --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--cntrldir=control --default-domain=indimail.org \
				--spamfilter="$prefix/bin/bogofilter -p -d $sysconfdir/etc" \
				--logfilter=/tmp/logfifo --rejectspam=0 --spamexitcode=0 \
				--memory=$fetchmail_mem --fsync --syncdir --dkverify=$ver_opt $extra_opt
		fi
	else
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			$svctool --fetchmail --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--cntrldir=control --default-domain=indimail.org \
				--qhpsi="$qhpsi" \
				--memory=$fetchmail_mem --fsync --syncdir --dkverify=$ver_opt $extra_opt
		else
			$svctool --fetchmail --servicedir=$servicedir \
				--qbase=$qbase --qcount=$qcount --qstart=1 \
				--cntrldir=control --default-domain=indimail.org \
				--memory=$fetchmail_mem --fsync --syncdir --dkverify=$ver_opt $extra_opt
		fi
	fi
	touch $dir_prefix$servicedir/fetchmail/down
fi

#
# IMAP/POP3
#
if [ $nocourierimap -eq 0 ] ; then
	$svctool --imap=143 --servicedir=$servicedir \
		--starttls --localip=0 --maxdaemons=40 --maxperip=25 --infifo=infifo \
		--query-cache --default-domain=indimail.org --memory=$imap_pop3_mem $extra_opt
	$svctool --imap=993 --servicedir=$servicedir --localip=0 \
		--maxdaemons=40 --maxperip=25 --infifo=infifo \
		--query-cache --default-domain=indimail.org --memory=$imapspop3_mem --ssl $extra_opt
	$svctool --pop3=110 --servicedir=$servicedir --localip=0 \
		--starttls --maxdaemons=40 --maxperip=25 --infifo=infifo \
		--query-cache --default-domain=indimail.org --memory=$imap_pop3_mem $extra_opt
	$svctool --pop3=995 --servicedir=$servicedir --localip=0 \
		--maxdaemons=40 --maxperip=25 --infifo=infifo \
		--query-cache --default-domain=indimail.org --memory=$imapspop3_mem --ssl $extra_opt
fi
if [ $noproxy -eq 0 ] ; then
	$svctool --imap=4143 --servicedir=$servicedir --localip=0 --infifo=infifo \
		--maxdaemons=40 --maxperip=25 --query-cache --default-domain=indimail.org \
		--memory=$imap_pop3_mem --proxy=143 --starttls --tlsprog=$prefix/bin/sslerator \
		$extra_opt
	$svctool --imap=9143 --servicedir=$servicedir --localip=0 --infifo=infifo \
		--maxdaemons=40 --maxperip=25 --query-cache --default-domain=indimail.org \
		--memory=$imapspop3_mem --proxy=143 --ssl $extra_opt
	$svctool --pop3=4110 --servicedir=$servicedir --localip=0 --infifo=infifo \
		--maxdaemons=40 --maxperip=25 --query-cache --default-domain=indimail.org \
		--memory=$imap_pop3_mem --proxy=110 --starttls --tlsprog=$prefix/bin/sslerator \
		$extra_opt
	$svctool --pop3=9110 --servicedir=$servicedir --localip=0 --infifo=infifo \
		--maxdaemons=40 --maxperip=25 --query-cache --default-domain=indimail.org \
		--memory=$imapspop3_mem --proxy=110 --ssl $extra_opt
fi

#
# IndiMail Daemons
#
if [ $noindimail -eq 0 ] ; then
	$svctool --indisrvr=4000 --servicedir=$servicedir \
		--localip=0 --maxdaemons=40 --maxperip=25 --avguserquota=2097152 \
		--certfile=$controldir/servercert.pem --ssl \
		--hardquota=52428800 --base_path=$mail_path $extra_opt
	$svctool --inlookup=infifo --servicedir=$servicedir --cntrldir=control --threads=5 \
		--query-cache --password-cache $extra_opt
	
	if [ $nonssd -eq 0 ] ; then
		$svctool --pwdlookup=/tmp/nssd.sock --threads=5 --timeout=-1 \
			--mysqlhost=localhost --mysqluser=indimail \
			--mysqlpass=ssh-1.5- --mysqlsocket=/tmp/mysql.sock --servicedir=$servicedir $extra_opt
	fi
#
# poppassd protocol
#
	$svctool --poppass=106 --localip=0 --maxdaemons=40 --maxperip=25 \
		--memory=$poppass_mem \
		--certfile=$controldir/servercert.pem --ssl \
		--setpassword=$prefix/sbin/vsetpass --servicedir=$servicedir $extra_opt
fi
#
# virus clamav/spam filter
#
if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
	$svctool --qscanq --servicedir=$servicedir --clamdPrefix=$prefix \
		--scanint=200 $extra_opt
	$svctool --config=clamd $extra_opt
fi
if [ $nobogofilter -eq 0 ] ; then
	$svctool --config=bogofilter $extra_opt
fi
#
# Misc/Configuration
#

# create certs
$svctool --postmaster=postmaster@indimail.org --config=cert --common_name=indimail.org $extra_opt
# create svscan logging in indimail log directory
$svctool --svscanlog --servicedir=$servicedir $extra_opt
if [ $add_boot -eq 1 ] ; then
	if [ $noindimail -eq 0 ] ; then
		$dir_prefix$prefix/sbin/initsvc -status
	fi
	# Install IndiMail to be started on system boot
	echo "adding indimail startup"
	$svctool --config=add-boot $extra_opt
fi
if [ $check_install -eq 1 ] ; then
	$svctool --check-install --servicedir=$servicedir \
		--qbase=$qbase --qcount=$qcount --qstart=1 $extra_opt
fi
