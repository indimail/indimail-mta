#!/bin/sh
# postinst script for indimail
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package

prefix=@prefix@
indimaildir=@indimaildir@
mandir=@mandir@
shareddir=@shareddir@
qcount=5
qbase=${indimaildir}/queue
mbase=@basepath@
logdir=@logdir@
mysqlPrefix=@mysql_prefix@
servicedir=/service
sysconfdir=@sysconfdir@
rm=/bin/rm
mv=/bin/mv
####################################
noproxy=0
nonssd=0
nocourierimap=0
noclamav=1
nofetchmail=0
nobogofilter=0
nodksignature=0
tcpserver_plugin=1
default_domain=@defaultdomain@
dkimkeyfn=default
mysqlSocket=/var/run/mysqld/mysqld.sock

setperm()
{
	local user="$1"; shift
	local group="$1"; shift
	local mode="$1"; shift
	local file="$1"; shift
	/usr/sbin/dpkg-statoverride --list "$file" >/dev/null && return 0
	/usr/sbin/dpkg-statoverride --update --add "$user" "$group" "$mode" "$file"
}

fixperms()
{
#%attr(0555,root,qmail) @prefix@/bin/rsmtp
	if [ $# -eq 3 ] ; then # directory
		lin=$2
		file=$3
		if [ ! -d $file ] ; then
			return 0
		fi
	elif [ $# = 2 ] ; then # file
		lin=$1
		file=$2
		if [ ! -f $file ] ; then
			return 0
		fi
	fi
	perm=`echo $lin|cut -d\( -f2 | cut -d, -f1`
	perm_f1=`echo $perm | cut -c1`
	own=`echo $lin|cut -d\( -f2 | cut -d, -f2`
	grp=`echo $lin|cut -d\( -f2 | cut -d, -f3|cut -d\) -f1`
	if [ -f $file ] ; then
		if [ $perm_f1 -eq 0 ] ; then # 4755, 0644
			/bin/chown $own:$grp $file
			/bin/chmod $perm $file
		else
			echo $file
			if [ -f /usr/sbin/dpkg-statoverride ] ; then
				setperm $own $grp $perm $file
			else
				/bin/chown $own:$grp $file
				/bin/chmod $perm $file
			fi
		fi
	fi
}

ID=`id -u`
if [ $ID -ne 0 ] ; then
	echo "You are not root" >&2
	exit 1
fi

case "$1" in
    configure)
		if [ " $2" = " " ] ; then
		echo "installing indimail @version@"
		else
		echo "upgrading to indimail $2"
		fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
	exit 0
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

#
# We need to do this for debian. SIGH!!
#
if [ -f ${sysconfdir}/perm_list ] ; then
	echo "Fixing Permissions (debian stupidity)"
(
/bin/grep -v "^#" ${sysconfdir}/perm_list | while read line
do
	if [ " $line" = " " ] ; then
		continue
	fi
	fixperms $line
done
) > ${sysconfdir}/stat.override
fi

if [ -f /tmp/indimail.upgrade ] ; then # upgrade
	if [ -f ${shareddir}/boot/rpm.init ] ; then
		echo "Running Custom Upgrade Script"
		/bin/sh ${shareddir}/boot/rpm.init upgrade
	fi
	${rm} -f /tmp/indimail.upgrade
	exit 0
fi
${rm} -f /tmp/indimail.install /tmp/indimail.upgrade
# Recreate ld.so links and cache
echo "recreating ld.so cache"
if [ -d /etc/ld.so.conf.d ] ; then
	(
		echo @mysql_libdir@
		if [ -d @prefix@/lib64 ] ; then
			echo @prefix@/lib64
		else
			echo @prefix@/lib
		fi
	) > /etc/ld.so.conf.d/indimail-`uname -m`.conf
fi
/sbin/ldconfig

if [ -f /usr/sbin/clamd -a -f /usr/bin/clamdscan ] ; then
	clamav_os=1
else
	clamav_os=0
fi
echo "Doing post installation activities for the following"
echo ""
echo " 1. Configure ${logdir} for multilog"
echo " 2. Configure ${servicedir}. Move existing services to ${servicedir}.org"
echo " 3. Configure svscanlog service"
echo " 4. Configure standard catch-all accounts, default qmail configuration"
echo " 5. Configure ${sysconfdir}/indimail.cnf for MySQL service"
echo " 6. Configure MySQL DB in ${indimaildir}/mysqldb/data"
echo " 7. Configure DKIM, Domainkeys signature"
echo " 8. Configure QHPSI for inline virus scanning"
echo " 9. Configure SMTP services on port in 465 25 587"
echo "10. Configure default queue configuration for sendmail, qmail-inject"
echo "11. Configure ODMR service"
echo "12. Configure greylisting service"
echo "13. Configure QMTP service"
echo "14. Configure QMQP service"
echo "15. Configure udplogger service"
echo "16. Configure fetchmail service"
echo "17. Configure IMAP/POP3/poppass services"
echo "18. Configure indisrvr service"
echo "19. Configure nssd service"
echo "20. Configure inlookup service"
echo "21. Configure qscanq/clamd/freshclam service"
echo "22. Configure ${sysconfdir}/control/signatures"
echo "23. Configure SPAM filter configuration"
echo "24. Configure tcprules database for SMTP, IMAP, POP3, popass"
echo "25. Configure indimail startup"
echo "26. Configure default cron entries"
if [ -x /etc/init.d/apparmor ] ; then
if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
echo "27. Creating apparmor profile"
fi
fi
echo ""

if [ -x /bin/touch ] ; then
	TOUCH=/bin/touch
elif [ -x /usr/bin/touch ] ; then
	TOUCH=/usr/bin/touch
else
	TOUCH=/bin/touch
fi
(
echo "Creating ${logdir}"
if [ ! -d ${logdir} ] ; then
	/bin/mkdir ${logdir}
fi
/bin/chown -R qmaill:nofiles ${logdir}

if [ -d /service ] ; then
	echo "UFO found in /service. Moving it to /service.org" 1>&2
	${mv} -f $servicedir "$servicedir".org
fi

# create svscanlog service
${prefix}/sbin/svctool --svscanlog --servicedir=$servicedir

echo "Creating default qmail configuraton and catch-all alias (${indimaildir}/alias/Maildir) for all system users"
${prefix}/sbin/svctool --config=qmail --postmaster=${indimaildir}/alias/Maildir/ \
	--default-domain=${default_domain} \
	--mysqlhost=localhost --mysqluser=indimail --mysqlpass=ssh-1.5- --mysqlsocket=${mysqlSocket}

echo "Creating Database/Service for MySQL"
# MySQL Config Creation
if [ -x ${mysqlPrefix}/libexec/mysqld -o -x ${mysqlPrefix}/sbin/mysqld ] ; then
	${prefix}/sbin/svctool --config=mysql --mysqlPrefix=${mysqlPrefix} --mysqlsocket=${mysqlSocket}
	# MySQL Database Creation
	${prefix}/sbin/svctool --config=mysqldb --mysqlPrefix=${mysqlPrefix} \
    	--databasedir=${indimaildir}/mysqldb --base_path=${mbase} --mysqlsocket=${mysqlSocket}
	# MySQL Supervise creation
	${prefix}/sbin/svctool --mysql=3306 --servicedir=${servicedir} --mysqlPrefix=${mysqlPrefix} \
		--databasedir=${indimaildir}/mysqldb --config=${sysconfdir}/indimail.cnf --default-domain=${default_domain}
	count=`ps -e|grep mysqld|wc -l`
	if [ $count -gt 0 ] ; then
		echo "Disabling mysqld service"
		$TOUCH ${servicedir}/mysql.3306/down
	fi
else
	echo "WARNING!!! Did not find mysqld in ${mysqlPrefix}/{libexec,sbin}. Skipping MySQL configuration" 1>&2
fi

# MySQL apparmor
if [ -x /etc/init.d/apparmor ] ; then
	if [ -f ${sysconfdir}/apparmor.d/local/usr.sbin.mysqld -a -d /etc/apparmor.d/local ] ; then
		cp ${sysconfdir}/apparmor.d/local/usr.sbin.mysqld /etc/apparmor.d/local
	fi
	if [ -f /etc/apparmor.d/local/usr.sbin.mysqld ] ; then
		echo "Reloading apparmor profiles..."
		/usr/sbin/service apparmor reload || true
	else
		echo "Shutting down apparmor..."
		/usr/sbin/service apparmor stop || true
		/usr/sbin/service apparmor teardown || true
	fi
fi

if [ $nodksignature -eq 0 ] ; then
	if [ -x ${prefix}/bin/dknewkey ] ; then
		ver_opt="both"
		sign_opt="both"
		if [ " $key_bit" = " " ] ; then
			key_bit=1024
		fi
		${prefix}/bin/dknewkey ${sysconfdir}/control/domainkeys/$dkimkeyfn $key_bit
	else
		ver_opt="none"
		sign_opt="none"
	fi
else
	ver_opt="none"
	sign_opt="none"
fi
a_arch=`uname -m`
if [ " $a_arch" = " x86_64" ] ; then
	fetchmail_mem=144857600
	smtp_soft_mem=104857600
	qmtp_soft_mem=104857600
	qmqp_soft_mem=104857600
	imap_pop3_mem=209715200
	poppass_mem=52428800
else
	fetchmail_mem=72428800
	smtp_soft_mem=52428800
	qmtp_soft_mem=52428800
	qmqp_soft_mem=52428800
	imap_pop3_mem=10485760
	poppass_mem=10485760
fi
echo "Checking if clamav is installed"
if [ $noclamav -eq 0 ] ; then
	clamav_os=0
	clamdPrefix=${prefix}
	qhpsi="${prefix}/bin/clamdscan %s --fdpass --quiet --no-summary"
	mysysconfdir=${sysconfdir}
else
	if [ -f /usr/sbin/clamd -a -f /usr/bin/clamdscan ] ; then
		clamav_os=1
		clamdPrefix="/usr"
		qhpsi="/usr/bin/clamdscan %s --fdpass --quiet --no-summary"
		if [ -d /etc/clamav ] ; then
			mysysconfdir=/etc/clamav
		else
			mysysconfdir=${sysconfdir}
		fi
	else
		clamav_os=0
	fi
fi
# SMTP
for port in 465 25 587
do
	if [ $port -eq 465 ] ; then
		spamfilter=1
		extra_opt="--skipsend --ssl"
		extra_opt="$extra_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
	elif [ $port -eq 587 ] ; then
		# local authenticated users
		# why bother with spamfilter
		# if you do, then you have a serious
		# problem with your organization, not 
		# with IndiMail
		spamfilter=0
		extra_opt="--skipsend --authsmtp --antispoof"
	else
		spamfilter=1
		extra_opt="--remote-authsmtp=plain --localfilter --remotefilter"
		extra_opt="$extra_opt --deliverylimit-count=-1 --deliverylimit-size=-1"
		extra_opt="$extra_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
	fi
	if [ $tcpserver_plugin -eq 1 ] ; then
		extra_opt="$extra_opt --shared-objects=1"
	fi
	if [ $spamfilter -eq 1 ] ; then
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			${prefix}/sbin/svctool --smtp=$port --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem \
				--chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter \
				--qhpsi="$qhpsi" \
				--spamfilter="${prefix}/bin/bogofilter -p -d ${sysconfdir}" \
				--logfilter=/tmp/logfifo --rejectspam=0 --spamexitcode=0 \
				--dmasquerade \
				--dkverify=$ver_opt \
				--dksign=$sign_opt --private_key=${sysconfdir}/control/domainkeys/%/$dkimkeyfn \
				$extra_opt
		else
			${prefix}/sbin/svctool --smtp=$port --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem \
				--chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--spamfilter="${prefix}/bin/bogofilter -p -d ${sysconfdir}" \
				--logfilter=/tmp/logfifo --rejectspam=0 --spamexitcode=0 \
				--dmasquerade \
				--dkverify=both \
				--dksign=both --private_key=${sysconfdir}/control/domainkeys/%/$dkimkeyfn \
				$extra_opt
		fi
	else
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			${prefix}/sbin/svctool --smtp=$port --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem \
				--chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter \
				--qhpsi="$qhpsi" \
				--dmasquerade \
				--dkverify=both \
				--dksign=both --private_key=${sysconfdir}/control/domainkeys/%/$dkimkeyfn \
				$extra_opt
		else
			${prefix}/sbin/svctool --smtp=$port --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--query-cache --dnscheck --password-cache \
				--cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
				--starttls --fsync --syncdir --memory=$smtp_soft_mem \
				--chkrecipient --chkrelay --masquerade \
				--min-free=52428800 --content-filter --virus-filter \
				--dmasquerade \
				--dkverify=both \
				--dksign=both --private_key=${sysconfdir}/control/domainkeys/%/$dkimkeyfn \
				$extra_opt
		fi
	fi
	echo "1" > ${servicedir}/qmail-smtpd.$port/variables/DISABLE_PLUGIN
done
#
# qmail-inject, sendmail default configuration
#
if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
	${prefix}/sbin/svctool --queueParam=defaultqueue \
		--qbase=${qbase} --qcount=${qcount} --qstart=1 \
		--min-free=52428800 --fsync --syncdir \
		--qhpsi="$qhpsi" \
		--dkverify="none" --dksign=$sign_opt \
		--private_key=${sysconfdir}/control/domainkeys/%/$dkimkeyfn \
		$extra_opt
else
	${prefix}/sbin/svctool --queueParam=defaultqueue \
		--qbase=${qbase} --qcount=${qcount} --qstart=1 \
		--min-free=52428800 --fsync --syncdir --virus-filter \
		--dkverify="none" --dksign=$sign_opt \
		--private_key=${sysconfdir}/control/domainkeys/%/$dkimkeyfn \
		$extra_opt
fi
#
# ODMR Service
#
${prefix}/sbin/svctool --smtp=366 --odmr --servicedir=$servicedir \
	--query-cache --password-cache
echo "1" > ${servicedir}/qmail-smtpd.366/variables/DISABLE_PLUGIN

# Greylist daemon
${prefix}/sbin/svctool --greylist=1999 --servicedir=$servicedir --min-resend-min=2 \
    --resend-win-hr=24 --timeout-days=30 --context-file=greylist.context \
    --hash-size=65536 --save-interval=5 --whitelist=greylist.white

# qmail-qmtpd service
${prefix}/sbin/svctool --qmtp=209 --servicedir=$servicedir --qbase=${qbase} \
	--qcount=${qcount} --qstart=1 --cntrldir=control --localip=0 \
	--maxdaemons=75 --maxperip=25 \
	--fsync --syncdir --memory=$qmtp_soft_mem --min-free=52428800

# qmail-qmqpd service
${prefix}/sbin/svctool --qmqp=628 --servicedir=$servicedir --qbase=${qbase} \
	--qcount=${qcount} --qstart=1 --cntrldir=control --localip=0 \
	--maxdaemons=75 --maxperip=25 \
	--fsync --syncdir --memory=$qmqp_soft_mem --min-free=52428800
/bin/touch $servicedir/qmail-qmqpd.628/down

if [ $nofetchmail -eq 0 ] ; then
# fetchmail
	if [ $nobogofilter -eq 0 ] ; then
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			${prefix}/sbin/svctool --fetchmail --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--cntrldir=control --default-domain=${default_domain} \
				--qhpsi="$qhpsi" \
				--spamfilter="${prefix}/bin/bogofilter -p -d ${sysconfdir}" --spamexitcode=0 \
				--memory=$fetchmail_mem --fsync --syncdir \
				--dkverify=$ver_opt
		else
			${prefix}/sbin/svctool --fetchmail --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--cntrldir=control --default-domain=${default_domain} \
				--spamfilter="${prefix}/bin/bogofilter -p -d ${sysconfdir}" --spamexitcode=0 \
				--memory=$fetchmail_mem --fsync --syncdir \
				--dkverify=$ver_opt
		fi
	else
		if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
			${prefix}/sbin/svctool --fetchmail --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--cntrldir=control --default-domain=${default_domain} \
				--qhpsi="$qhpsi" \
				--memory=$fetchmail_mem --fsync --syncdir \
				--dkverify=$ver_opt
		else
			${prefix}/sbin/svctool --fetchmail --servicedir=$servicedir \
				--qbase=${qbase} --qcount=${qcount} --qstart=1 \
				--cntrldir=control --default-domain=${default_domain} \
				--memory=$fetchmail_mem --fsync --syncdir \
				--dkverify=$ver_opt
		fi
	fi
	#
	# user has to create fetchmailrc before which fetchmail cannot be started
	#
	/bin/touch $servicedir/fetchmail/down
fi

if [ $nocourierimap -eq 0 ] ; then
# IMAP/POP3
${prefix}/sbin/svctool --imap=143 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--starttls --default-domain=${default_domain} --memory=$imap_pop3_mem
${prefix}/sbin/svctool --imap=993 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--default-domain=${default_domain} --memory=$imap_pop3_mem --ssl
${prefix}/sbin/svctool --pop3=110 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--starttls --default-domain=${default_domain} --memory=$imap_pop3_mem
${prefix}/sbin/svctool --pop3=995 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--default-domain=${default_domain} --memory=$imap_pop3_mem --ssl
fi
if [ $noproxy -eq 0 ] ; then
${prefix}/sbin/svctool --imap=4143 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--default-domain=${default_domain} --memory=$imap_pop3_mem --proxy=143 \
	--starttls
${prefix}/sbin/svctool --imap=9143 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--default-domain=${default_domain} --memory=$imap_pop3_mem --proxy=143 --ssl
${prefix}/sbin/svctool --pop3=4110 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--default-domain=${default_domain} --memory=$imap_pop3_mem --proxy=110 \
	--starttls
${prefix}/sbin/svctool --pop3=9110 --servicedir=$servicedir --localip=0 \
	--maxdaemons=40 --maxperip=25 \
	--default-domain=${default_domain} --memory=$imap_pop3_mem --proxy=110 --ssl
fi

# IndiMail Daemons
${prefix}/sbin/svctool --indisrvr=4000 --servicedir=$servicedir \
	--localip=0 --maxdaemons=40 --maxperip=25 --avguserquota=2097152 \
    --certfile=${sysconfdir}/certs/servercert.pem --ssl \
	--hardquota=52428800 --base_path=${mbase}
${prefix}/sbin/svctool --inlookup=infifo --servicedir=$servicedir \
	--cntrldir=control --threads=5 --password-cache
if [ $nonssd -eq 0 ] ; then
${prefix}/sbin/svctool --pwdlookup=/tmp/nssd.sock --threads=5 --timeout=-1 \
	--mysqlhost=localhost --mysqluser=indimail \
	--mysqlpass=ssh-1.5- --mysqlsocket=${mysqlSocket} --servicedir=$servicedir
fi
${prefix}/sbin/svctool --poppass=106 --localip=0 --maxdaemons=40 --maxperip=25 \
	--memory=$poppass_mem \
    --certfile=${sysconfdir}/certs/servercert.pem --ssl \
	--setpassword=${prefix}/sbin/vsetpass --servicedir=$servicedir

# virus/spam filtering
${prefix}/sbin/svctool --qscanq --servicedir=${servicedir} --scanint=200
if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
	# create clamd.conf, freshclam.conf
	${prefix}/sbin/svctool --config=clamd
	# create clamd, freshclam service
	${prefix}/sbin/svctool --clamd --servicedir=${servicedir} --clamdPrefix=$clamdPrefix \
		--sysconfdir=$mysysconfdir
	if [ $clamav_os -eq 1 ] ; then
		echo "Checking if clamd/freshclam is running"
		count=`ps -e|grep clamd|wc -l`
		if [ $count -gt 0 ] ; then
			echo "Disabling clamd service"
			$TOUCH ${servicedir}/clamd/down
		fi
		count=`ps -e|grep freshclam|wc -l`
		if [ $count -gt 0 ] ; then
			echo "Disabling freshclam service"
			$TOUCH ${servicedir}/freshclam/down
		fi
	fi
fi
if [ -x /etc/init.d/apparmor ] ; then
if [ $noclamav -eq 0 -o $clamav_os -eq 1 ] ; then
	if [ -f ${sysconfdir}/apparmor.d/local/usr.sbin.clamd -a -d /etc/apparmor.d/local ] ; then
		cp ${sysconfdir}/apparmor.d/local/usr.sbin.clamd /etc/apparmor.d/local
	fi
	if [ -f ${sysconfdir}/apparmor.d/local/usr.bin.freshclam -a -d /etc/apparmor.d/local ] ; then
		cp ${sysconfdir}/apparmor.d/local/usr.bin.freshclam /etc/apparmor.d/local
	fi
	if [ -f /etc/apparmor.d/local/usr.sbin.clamd -o -f /etc/apparmor.d/local/usr.bin.freshclam ] ; then
		echo "Reloading apparmor profiles..."
		/usr/sbin/service apparmor reload || true
	else
		echo "Shutting down apparmor..."
		/usr/sbin/service apparmor stop || true
		/usr/sbin/service apparmor teardown || true
	fi
fi
fi

# udplogger service
${prefix}/sbin/svctool --udplogger=3000 --localip=0 --timeout=10 --servicedir=${servicedir}

/bin/cat <<EOFUU > ${sysconfdir}/control/signatures
# Windows executables seen in active virii
TVqQAAMAA
TVpQAAIAA
# Additional windows executable signatures not yet seen in virii
TVpAALQAc
TVpyAXkAX
TVrmAU4AA
TVrhARwAk
TVoFAQUAA
TVoAAAQAA
TVoIARMAA
TVouARsAA
TVrQAT8AA
# .ZIPfile signature seen in SoBig.E and mydoom:
#UEsDBBQAA
#UEsDBAoAAA
# .GIF file found in a previous Microsoft virus making the rounds.
R0lGODlhaAA7APcAAP///+rp6puSp6GZrDUjUUc6Zn53mFJMdbGvvVtXh2xre8bF1x8cU4yLprOy
EOFUU
/bin/chown qscand:qscand ${sysconfdir}/control/signatures

#
# bogofilter configuration
#
if [ $nobogofilter -eq 0 ] ; then
	${prefix}/sbin/svctool --config=bogofilter
	${rm} -f ${sysconfdir}/bogofilter.cf.example
fi
# rebuild cdb
for i in smtp qmtp qmqp imap pop3 poppass
do
	for j in `/bin/ls ${sysconfdir}/tcp.$i 2>/dev/null`
	do
		echo "Creating CDB $j.cdb"
   		${prefix}/bin/tcprules $j.cdb $j.tmp < $j && /bin/chmod 664 $j.cdb \
			&& chown indimail:indimail $j.cdb
	done
done

echo "compressing man pages"
find ${mandir} -type f -exec gzip -q {} \;
if [ -f ${mandir}/man7/authlib.7.gz ] ; then
	for i in authshadow.7 authpwd.7 authpam.7 authcustom.7
	do
		${rm} -f ${mandir}/man7/$i
		ln -sf ${mandir}/man7/authlib.7.gz ${mandir}/man7/$i.gz
	done
fi

if [ -f ${shareddir}/boot/rpm.init ] ; then
	echo "Running Custom Installation Script"
	/bin/sh ${shareddir}/boot/rpm.init post
fi
#
# Install IndiMail to be started on system boot
# The add-boot command installs svscan to be started by init, systemd, upstart or launchctl
#
echo "adding indimail startup"
if [ /usr/lib/sm.bin/sendmail ] ; then
	if [ -x /usr/sbin/update-alternatives ] ; then
	/usr/sbin/update-alternatives --remove-all sendmail-mta || true
	/usr/sbin/update-alternatives --remove-all sendmail-msp || true
	elif [ -x /usr/bin/update-alternatives ] ; then
	/usr/bin/update-alternatives --remove-all sendmail-mta || true
	/usr/bin/update-alternatives --remove-all sendmail-msp || true
	fi
fi
SERVICE_LIST="sendmail exim4 mysql"
export SERVICE_LIST
${prefix}/sbin/svctool --config=add-boot
if [ -x /bin/systemctl ] ; then
	/bin/systemctl enable indimail.service
fi

echo "Checking Installed Permissions"
if [ -f ${prefix}/bin/instcheck ] ; then
	${prefix}/bin/instcheck > /dev/null 2>&1
fi
#
# create /tmp/skip-install_tables so that svctool does not run sbin/install_tables
#
) >> /tmp/indimail-install.log 2>&1

if [ -f /etc/init/svscan.conf -o -f /etc/event.d/svscan ] ; then
	echo "1. Issue /sbin/initctl emit qmailstart to start services"
	count=1
elif [ -f /etc/systemd/system/multi-user.target.wants/indimail.service ] ; then
	echo "1. Issue /bin/systemctl start indimail.service to start services"
	count=1
else
	echo "1. Issue ${prefix}/sbin/initsvc -on"
	echo "2. Issue /sbin/init q to start services"
	count=2
fi
echo "   You can also use the 'service' command to start indimail"
echo "   sudo service indimail start"
count=`expr $count + 1`
echo "$count. If you want to use IndiMail to manage MySQL startup, remove"
echo "   ${servicedir}/mysql.3306/down"
count=`expr $count + 1`
echo "$count. Change your default domain in ${sysconfdir}/control/defaultdomain"
count=`expr $count + 1`
echo "$count. You can optionally run the following command to verify installation"
echo "   sudo ${prefix}/sbin/svctool --check-install --servicedir=${servicedir} \\"
echo "       --qbase=${qbase} --qcount=${qcount} --qstart=1"
if [ $noclamav -eq 0 ] ; then
count=`expr $count + 1`
echo "$count. You need to ensure that clamav signatures download have completed so that"
echo "   you can start sending emails. Look at ${logdir}/freshclam/current"
fi
if [ ! -f ${sysconfdir}/certs/servercert.pem ] ; then
count=`expr $count + 1`
echo "$count. You also need to create CERTS for SSL/TLS. run the following"
echo "   command to create cert"
echo "   ${prefix}/sbin/svctool --config-cert --postmaster=postmaster@yourdomain --common_name=yourdomain"
fi
echo
echo "Check /tmp/indimail-install.log for the detailed installation log!!!"

exit 0
