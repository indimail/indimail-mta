diff -Naur Bogofilter-1.2.0/bogofilter.cf.example bogofilter-1.2.0/bogofilter.cf.example
--- Bogofilter-1.2.0/bogofilter.cf.example	2009-02-22 02:02:51.000000000 +0530
+++ bogofilter-1.2.0/bogofilter.cf.example	2009-03-29 10:42:09.000000000 +0530
@@ -18,7 +18,7 @@
 #	directory for wordlists
 #
 #bogofilter_dir=~/.bogofilter
-##bogofilter_dir=/var/spool/bogofilter
+##bogofilter_dir=/var/indimail/etc
 
 #### name/location of user config file
 #
@@ -137,6 +137,7 @@
 #	    l - logging tag (from '-l' option)
 #
 #	    o - spam_cutoff, ex. cutoff=%o
+#	    O - ham_cutoff,  ex. ham_cutoff=%O
 #
 #	    p - spamicity value
 #	    d - if ham or unsure, the spamicity
diff -Naur Bogofilter-1.2.0/configure.ac bogofilter-1.2.0/configure.ac
--- Bogofilter-1.2.0/configure.ac	2009-02-22 02:11:43.000000000 +0530
+++ bogofilter-1.2.0/configure.ac	2009-03-29 10:43:25.000000000 +0530
@@ -267,6 +267,14 @@
 AM_CONDITIONAL(ENABLE_STATIC, test x$enable_static = xyes)
 AC_SUBST(EXE_EXT)
 
+###	use option --enable-indimail to compile in the INDIMAIL support
+AC_ARG_ENABLE(indimail,
+	[  --enable-indimail            compile in INDIMAIL protocol support],
+	[with_INDIMAIL=$enableval],
+	[with_INDIMAIL=no])
+test "$with_INDIMAIL" = "yes" && AC_DEFINE(INDIMAIL,1,Define if you want INDIMAIL support compiled in)
+AM_CONDITIONAL(INDIMAIL, test "$with_INDIMAIL" = yes)
+
 dnl Allow the user to specify a header name to use to indicate whether a given
 dnl message is SPAM or not.
 AC_ARG_ENABLE(spam-header-name, 
diff -Naur Bogofilter-1.2.0/config.in bogofilter-1.2.0/config.in
--- Bogofilter-1.2.0/config.in	2009-02-22 02:12:01.000000000 +0530
+++ bogofilter-1.2.0/config.in	2009-03-29 11:02:43.000000000 +0530
@@ -261,6 +261,9 @@
 /* Define as const if the declaration of iconv() needs const. */
 #undef ICONV_CONST
 
+/* Define if you want INDIMAIL support compiled in */
+#undef INDIMAIL
+
 /* Define to 1 if trio is to be included. */
 #undef NEEDTRIO
 
diff -Naur Bogofilter-1.2.0/configure bogofilter-1.2.0/configure
--- Bogofilter-1.2.0/configure	2009-02-22 02:11:49.000000000 +0530
+++ bogofilter-1.2.0/configure	2009-03-29 11:02:26.000000000 +0530
@@ -688,6 +688,8 @@
 DISABLE_UNICODE_FALSE
 DISABLE_UNICODE_TRUE
 USE_UNICODE
+INDIMAIL_FALSE
+INDIMAIL_TRUE
 EXE_EXT
 ENABLE_STATIC_FALSE
 ENABLE_STATIC_TRUE
@@ -802,6 +804,7 @@
 enable_dependency_tracking
 enable_largefile
 enable_static
+enable_indimail
 enable_spam_header_name
 enable_unicode
 with_gnu_ld
@@ -1467,6 +1470,7 @@
   --enable-dependency-tracking   do not reject slow dependency extractors
   --disable-largefile     omit support for large files
   --enable-static         build static versions as well (unsupported).
+  --enable-indimail       compile in INDIMAIL protocol support
   --enable-spam-header-name=name
                           use specified header name instead of "X-Bogosity"
   --disable-unicode       disables Unicode/UTF-8 conversion of character sets
@@ -5433,6 +5437,28 @@
 
 
 
+###	use option --enable-indimail to compile in the INDIMAIL support
+# Check whether --enable-indimail was given.
+if test "${enable_indimail+set}" = set; then
+  enableval=$enable_indimail; with_INDIMAIL=$enableval
+else
+  with_INDIMAIL=no
+fi
+
+test "$with_INDIMAIL" = "yes" &&
+cat >>confdefs.h <<\_ACEOF
+#define INDIMAIL 1
+_ACEOF
+
+ if test "$with_INDIMAIL" = yes; then
+  INDIMAIL_TRUE=
+  INDIMAIL_FALSE='#'
+else
+  INDIMAIL_TRUE='#'
+  INDIMAIL_FALSE=
+fi
+
+
 # Check whether --enable-spam-header-name was given.
 if test "${enable_spam_header_name+set}" = set; then
   enableval=$enable_spam_header_name;
@@ -16346,6 +16372,13 @@
 Usually this means the macro was only invoked conditionally." >&2;}
    { (exit 1); exit 1; }; }
 fi
+if test -z "${INDIMAIL_TRUE}" && test -z "${INDIMAIL_FALSE}"; then
+  { { $as_echo "$as_me:$LINENO: error: conditional \"INDIMAIL\" was never defined.
+Usually this means the macro was only invoked conditionally." >&5
+$as_echo "$as_me: error: conditional \"INDIMAIL\" was never defined.
+Usually this means the macro was only invoked conditionally." >&2;}
+   { (exit 1); exit 1; }; }
+fi
 if test -z "${DISABLE_UNICODE_TRUE}" && test -z "${DISABLE_UNICODE_FALSE}"; then
   { { $as_echo "$as_me:$LINENO: error: conditional \"DISABLE_UNICODE\" was never defined.
 Usually this means the macro was only invoked conditionally." >&5
@@ -17603,16 +17636,7 @@
 
 
   case $ac_file$ac_mode in
-    "depfiles":C) test x"$AMDEP_TRUE" != x"" || # Autoconf 2.62 quotes --file arguments for eval, but not when files
-# are listed without --file.  Let's play safe and only enable the eval
-# if we detect the quoting.
-case $CONFIG_FILES in
-*\'*) eval set x "$CONFIG_FILES" ;;
-*)   set x $CONFIG_FILES ;;
-esac
-shift
-for mf
-do
+    "depfiles":C) test x"$AMDEP_TRUE" != x"" || for mf in $CONFIG_FILES; do
   # Strip MF so we end up with the name of the file.
   mf=`echo "$mf" | sed -e 's/:.*$//'`
   # Check whether this is an Automake generated Makefile or not.
diff -Naur Bogofilter-1.2.0/Makefile.am bogofilter-1.2.0/Makefile.am
--- Bogofilter-1.2.0/Makefile.am	2009-01-12 09:40:09.000000000 +0530
+++ bogofilter-1.2.0/Makefile.am	2009-03-29 10:44:04.000000000 +0530
@@ -119,6 +119,9 @@
 rsynconly: .rsyncs
 	@( cat $(srcdir)/.rsyncs | sed -e 's}^}rsync -av -e ssh --delete $(PACKAGE)-$(VERSION)/ }; s/\($$\)/ \&/;' ; echo "wait" ) | $(SHELL) -x
 
+install-data-hook:
+	chown root:indimail $(DESTDIR)$(bindir)/bogofilter || true
+	chmod 6511 $(DESTDIR)$(bindir)/bogofilter || true
 dist-hook:
 	cd $(distdir) && find doc gnugetopt gsl -name CVS -type d -prune -exec rm -r '{}' ';'
 	cd $(distdir) && find doc gnugetopt gsl -name '.#*' -type f -exec rm '{}' ';'
diff -Naur Bogofilter-1.2.0/Makefile.in bogofilter-1.2.0/Makefile.in
--- Bogofilter-1.2.0/Makefile.in	2009-02-22 02:11:48.000000000 +0530
+++ bogofilter-1.2.0/Makefile.in	2009-03-29 11:02:25.000000000 +0530
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -494,7 +494,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
@@ -754,6 +754,8 @@
 info-am:
 
 install-data-am:
+	@$(NORMAL_INSTALL)
+	$(MAKE) $(AM_MAKEFLAGS) install-data-hook
 
 install-dvi: install-dvi-recursive
 
@@ -793,7 +795,7 @@
 uninstall-am: uninstall-sysconfDATA
 
 .MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) install-am \
-	install-strip
+	install-data-am install-strip
 
 .PHONY: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) CTAGS GTAGS \
 	all all-am am--refresh check check-am clean clean-generic \
@@ -802,15 +804,16 @@
 	dist-zip distcheck distclean distclean-compile \
 	distclean-generic distclean-tags distcleancheck distdir \
 	distuninstallcheck dvi dvi-am html html-am info info-am \
-	install install-am install-data install-data-am install-dvi \
-	install-dvi-am install-exec install-exec-am install-html \
-	install-html-am install-info install-info-am install-man \
-	install-pdf install-pdf-am install-ps install-ps-am \
-	install-strip install-sysconfDATA installcheck installcheck-am \
-	installdirs installdirs-am maintainer-clean \
-	maintainer-clean-generic mostlyclean mostlyclean-compile \
-	mostlyclean-generic pdf pdf-am ps ps-am tags tags-recursive \
-	uninstall uninstall-am uninstall-sysconfDATA
+	install install-am install-data install-data-am \
+	install-data-hook install-dvi install-dvi-am install-exec \
+	install-exec-am install-html install-html-am install-info \
+	install-info-am install-man install-pdf install-pdf-am \
+	install-ps install-ps-am install-strip install-sysconfDATA \
+	installcheck installcheck-am installdirs installdirs-am \
+	maintainer-clean maintainer-clean-generic mostlyclean \
+	mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
+	tags tags-recursive uninstall uninstall-am \
+	uninstall-sysconfDATA
 
 
 # ChangeLog, cvs2cl lives at http://www.red-bean.com/cvs2cl
@@ -862,6 +865,9 @@
 rsynconly: .rsyncs
 	@( cat $(srcdir)/.rsyncs | sed -e 's}^}rsync -av -e ssh --delete $(PACKAGE)-$(VERSION)/ }; s/\($$\)/ \&/;' ; echo "wait" ) | $(SHELL) -x
 
+install-data-hook:
+	chown root:indimail $(DESTDIR)$(bindir)/bogofilter || true
+	chmod 6511 $(DESTDIR)$(bindir)/bogofilter || true
 dist-hook:
 	cd $(distdir) && find doc gnugetopt gsl -name CVS -type d -prune -exec rm -r '{}' ';'
 	cd $(distdir) && find doc gnugetopt gsl -name '.#*' -type f -exec rm '{}' ';'
diff -Naur Bogofilter-1.2.0/src/bogofilter.c bogofilter-1.2.0/src/bogofilter.c
--- Bogofilter-1.2.0/src/bogofilter.c	2009-02-12 06:42:54.000000000 +0530
+++ bogofilter-1.2.0/src/bogofilter.c	2009-03-29 10:53:47.000000000 +0530
@@ -39,6 +39,11 @@
 #include "register.h"
 #include "rstats.h"
 #include "score.h"
+#ifdef INDIMAIL
+#include <unistd.h>
+#include <errno.h>
+#include "format.h"
+#endif
 
 /*
 **	case B_NORMAL:		
@@ -67,6 +72,63 @@
     msg_print_stats(fp);
 }
 
+#ifdef INDIMAIL
+#if 0
+extern float    unknown_count, total_count;
+#endif
+extern char     msg_bogofilter[];
+extern char     msg_register[];
+
+void            write_fifolog(rc_t);
+
+void
+write_fifolog(rc_t status)
+{
+	char           *fifo_name;
+	FILE           *logfp;
+	pid_t           pid;
+	int             logfifo;
+
+	fifo_name = getenv("LOGFILTER");
+	if (!fifo_name || !*fifo_name)
+		return;
+	if (*fifo_name != '/')
+		return;
+	format_log_header(msg_bogofilter, 256);
+#if 0
+	sprintf(msg_bogofilter + strlen(msg_bogofilter), ", ratio %0.2f", unknown_count / total_count);
+#endif
+	write(255, msg_bogofilter, strlen(msg_bogofilter));
+	if (logflag)
+		return;
+	if ((logfifo = open(fifo_name, O_NDELAY | O_WRONLY)) == -1)
+		return;
+	if (!(logfp = fdopen(logfifo, "w")))
+		return;
+	pid = getpid();
+	format_log_header(msg_bogofilter, 256);
+	switch (run_type)
+	{
+	case RUN_NORMAL:
+		fprintf(logfp, "bogofilter: pid %d, %s\n", pid, msg_bogofilter);
+		break;
+	case RUN_UPDATE:
+		if (status == RC_UNSURE || msg_register[0] == '\0')
+			fprintf(logfp, "bogofilter: pid %d, %s\n", pid, msg_bogofilter);
+		else
+		{
+			fprintf(logfp, "bogofilter: pid %d, %s, %s\n", pid, msg_bogofilter, msg_register);
+			msg_register[0] = '\0';
+		}
+		break;
+	default:
+		fprintf(logfp, "bogofilter: pid %d, %s\n", pid, msg_register);
+		msg_register[0] = '\0';
+	}
+	fclose(logfp);
+}
+#endif
+
 rc_t bogofilter(int argc, char **argv)
 {
     uint msgcount = 0;
@@ -161,6 +223,9 @@
 
     if (logflag && register_opt)
 	write_log_message(status);
+#ifdef INDIMAIL
+	write_fifolog(status);
+#endif
 
     wordhash_free(words);
 
diff -Naur Bogofilter-1.2.0/src/format.c bogofilter-1.2.0/src/format.c
--- Bogofilter-1.2.0/src/format.c	2009-02-12 06:42:54.000000000 +0530
+++ bogofilter-1.2.0/src/format.c	2009-03-29 10:54:39.000000000 +0530
@@ -376,6 +376,11 @@
 	    case 'o':		/* o - spam_cutoff, ex. cutoff=%c */
 		buff += format_float(buff, spam_cutoff, min, prec, flags, end);
 		break;
+#ifdef INDIMAIL
+	    case 'O':		/* o - ham_cutoff, ex. cutoff=%O */
+		buff += format_float(buff, ham_cutoff, min, prec, flags, end);
+		break;
+#endif
 	    case 'r':		/* r - run type (s, n, S, or N) - two parts (reg/unreg)*/
 		snprintf( temp, sizeof(temp), "%s%s", reg, unreg );
 		buff += format_string(buff, temp, 0, 0, 0, end);
diff -Naur Bogofilter-1.2.0/src/Makefile.am bogofilter-1.2.0/src/Makefile.am
--- Bogofilter-1.2.0/src/Makefile.am	2009-02-12 22:35:09.000000000 +0530
+++ bogofilter-1.2.0/src/Makefile.am	2009-03-29 10:55:13.000000000 +0530
@@ -31,7 +31,7 @@
 # what to build
 bin_PROGRAMS = bogofilter bogoutil bogolexer bogotune
 bin_SCRIPTS = bogoupgrade
-dist_bin_SCRIPTS = bf_copy bf_compact bf_tar
+dist_sbin_SCRIPTS = bf_copy bf_compact bf_tar
 if ENABLE_STATIC
 bin_PROGRAMS += bogofilter_static bogoutil_static bogolexer_static bogotune_static
 endif
diff -Naur Bogofilter-1.2.0/src/Makefile.in bogofilter-1.2.0/src/Makefile.in
--- Bogofilter-1.2.0/src/Makefile.in	2009-02-22 02:11:48.000000000 +0530
+++ bogofilter-1.2.0/src/Makefile.in	2009-03-29 11:02:25.000000000 +0530
@@ -1,4 +1,4 @@
-# Makefile.in generated by automake 1.10.2 from Makefile.am.
+# Makefile.in generated by automake 1.10.1 from Makefile.am.
 # @configure_input@
 
 # Copyright (C) 1994, 1995, 1996, 1997, 1998, 1999, 2000, 2001, 2002,
@@ -58,7 +58,7 @@
 @NEED_GETOPT_TRUE@am__append_11 = libgnugetopt.a
 @ENABLE_QDBM_DATASTORE_TRUE@am__append_12 = bogoQDBMupgrade
 subdir = src
-DIST_COMMON = $(dist_bin_SCRIPTS) $(srcdir)/Makefile.am \
+DIST_COMMON = $(dist_sbin_SCRIPTS) $(srcdir)/Makefile.am \
 	$(srcdir)/Makefile.in $(srcdir)/bf_compact.in \
 	$(srcdir)/bf_copy.in $(srcdir)/bf_tar.in \
 	$(top_srcdir)/config.in lexer_v3.c memcmp.c strerror.c \
@@ -210,7 +210,7 @@
 @ENABLE_STATIC_TRUE@	bogotune_static$(EXEEXT)
 @ENABLE_QDBM_DATASTORE_TRUE@am__EXEEXT_2 = bogoQDBMupgrade$(EXEEXT)
 am__installdirs = "$(DESTDIR)$(bindir)" "$(DESTDIR)$(bindir)" \
-	"$(DESTDIR)$(bindir)"
+	"$(DESTDIR)$(sbindir)"
 binPROGRAMS_INSTALL = $(INSTALL_PROGRAM)
 @NEEDTRIO_TRUE@am__EXEEXT_3 = regression$(EXEEXT)
 PROGRAMS = $(bin_PROGRAMS)
@@ -303,8 +303,8 @@
 wordhash_DEPENDENCIES = libbogofilter.a $(am__append_8) \
 	$(am__DEPENDENCIES_1) $(am__append_11) @LIBOBJS@
 binSCRIPT_INSTALL = $(INSTALL_SCRIPT)
-dist_binSCRIPT_INSTALL = $(INSTALL_SCRIPT)
-SCRIPTS = $(bin_SCRIPTS) $(dist_bin_SCRIPTS)
+dist_sbinSCRIPT_INSTALL = $(INSTALL_SCRIPT)
+SCRIPTS = $(bin_SCRIPTS) $(dist_sbin_SCRIPTS)
 DEFAULT_INCLUDES = -I.@am__isrc@
 depcomp = $(SHELL) $(top_srcdir)/depcomp
 am__depfiles_maybe = depfiles
@@ -497,7 +497,7 @@
 AM_CFLAGS = -DBOGOFILTER $(am__append_1)
 BUILT_SOURCES = version.c directories.c $(am__append_4)
 bin_SCRIPTS = bogoupgrade
-dist_bin_SCRIPTS = bf_copy bf_compact bf_tar
+dist_sbin_SCRIPTS = bf_copy bf_compact bf_tar
 TESTS = $(am__append_7)
 
 # this must be last so any library we may have added has access to the
@@ -675,8 +675,8 @@
 	@for dep in $?; do \
 	  case '$(am__configure_deps)' in \
 	    *$$dep*) \
-	      ( cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh ) \
-	        && { if test -f $@; then exit 0; else break; fi; }; \
+	      cd $(top_builddir) && $(MAKE) $(AM_MAKEFLAGS) am--refresh \
+		&& exit 0; \
 	      exit 1;; \
 	  esac; \
 	done; \
@@ -835,24 +835,24 @@
 	  echo " rm -f '$(DESTDIR)$(bindir)/$$f'"; \
 	  rm -f "$(DESTDIR)$(bindir)/$$f"; \
 	done
-install-dist_binSCRIPTS: $(dist_bin_SCRIPTS)
+install-dist_sbinSCRIPTS: $(dist_sbin_SCRIPTS)
 	@$(NORMAL_INSTALL)
-	test -z "$(bindir)" || $(MKDIR_P) "$(DESTDIR)$(bindir)"
-	@list='$(dist_bin_SCRIPTS)'; for p in $$list; do \
+	test -z "$(sbindir)" || $(MKDIR_P) "$(DESTDIR)$(sbindir)"
+	@list='$(dist_sbin_SCRIPTS)'; for p in $$list; do \
 	  if test -f "$$p"; then d=; else d="$(srcdir)/"; fi; \
 	  if test -f $$d$$p; then \
 	    f=`echo "$$p" | sed 's|^.*/||;$(transform)'`; \
-	    echo " $(dist_binSCRIPT_INSTALL) '$$d$$p' '$(DESTDIR)$(bindir)/$$f'"; \
-	    $(dist_binSCRIPT_INSTALL) "$$d$$p" "$(DESTDIR)$(bindir)/$$f"; \
+	    echo " $(dist_sbinSCRIPT_INSTALL) '$$d$$p' '$(DESTDIR)$(sbindir)/$$f'"; \
+	    $(dist_sbinSCRIPT_INSTALL) "$$d$$p" "$(DESTDIR)$(sbindir)/$$f"; \
 	  else :; fi; \
 	done
 
-uninstall-dist_binSCRIPTS:
+uninstall-dist_sbinSCRIPTS:
 	@$(NORMAL_UNINSTALL)
-	@list='$(dist_bin_SCRIPTS)'; for p in $$list; do \
+	@list='$(dist_sbin_SCRIPTS)'; for p in $$list; do \
 	  f=`echo "$$p" | sed 's|^.*/||;$(transform)'`; \
-	  echo " rm -f '$(DESTDIR)$(bindir)/$$f'"; \
-	  rm -f "$(DESTDIR)$(bindir)/$$f"; \
+	  echo " rm -f '$(DESTDIR)$(sbindir)/$$f'"; \
+	  rm -f "$(DESTDIR)$(sbindir)/$$f"; \
 	done
 
 mostlyclean-compile:
@@ -1421,7 +1421,7 @@
 	unique=`for i in $$list; do \
 	    if test -f "$$i"; then echo $$i; else echo $(srcdir)/$$i; fi; \
 	  done | \
-	  $(AWK) '{ files[$$0] = 1; nonempty = 1; } \
+	  $(AWK) '{ files[$$0] = 1; nonemtpy = 1; } \
 	      END { if (nonempty) { for (i in files) print i; }; }'`; \
 	mkid -fID $$unique
 tags: TAGS
@@ -1477,7 +1477,7 @@
 	-rm -f TAGS ID GTAGS GRTAGS GSYMS GPATH tags
 
 check-TESTS: $(TESTS)
-	@failed=0; all=0; xfail=0; xpass=0; skip=0; \
+	@failed=0; all=0; xfail=0; xpass=0; skip=0; ws='[	 ]'; \
 	srcdir=$(srcdir); export srcdir; \
 	list=' $(TESTS) '; \
 	if test -n "$$list"; then \
@@ -1488,7 +1488,7 @@
 	    if $(TESTS_ENVIRONMENT) $${dir}$$tst; then \
 	      all=`expr $$all + 1`; \
 	      case " $(XFAIL_TESTS) " in \
-	      *[\ \	]$$tst[\ \	]*) \
+	      *$$ws$$tst$$ws*) \
 		xpass=`expr $$xpass + 1`; \
 		failed=`expr $$failed + 1`; \
 		echo "XPASS: $$tst"; \
@@ -1500,7 +1500,7 @@
 	    elif test $$? -ne 77; then \
 	      all=`expr $$all + 1`; \
 	      case " $(XFAIL_TESTS) " in \
-	      *[\ \	]$$tst[\ \	]*) \
+	      *$$ws$$tst$$ws*) \
 		xfail=`expr $$xfail + 1`; \
 		echo "XFAIL: $$tst"; \
 	      ;; \
@@ -1514,36 +1514,23 @@
 	      echo "SKIP: $$tst"; \
 	    fi; \
 	  done; \
-	  if test "$$all" -eq 1; then \
-	    tests="test"; \
-	    All=""; \
-	  else \
-	    tests="tests"; \
-	    All="All "; \
-	  fi; \
 	  if test "$$failed" -eq 0; then \
 	    if test "$$xfail" -eq 0; then \
-	      banner="$$All$$all $$tests passed"; \
+	      banner="All $$all tests passed"; \
 	    else \
-	      if test "$$xfail" -eq 1; then failures=failure; else failures=failures; fi; \
-	      banner="$$All$$all $$tests behaved as expected ($$xfail expected $$failures)"; \
+	      banner="All $$all tests behaved as expected ($$xfail expected failures)"; \
 	    fi; \
 	  else \
 	    if test "$$xpass" -eq 0; then \
-	      banner="$$failed of $$all $$tests failed"; \
+	      banner="$$failed of $$all tests failed"; \
 	    else \
-	      if test "$$xpass" -eq 1; then passes=pass; else passes=passes; fi; \
-	      banner="$$failed of $$all $$tests did not behave as expected ($$xpass unexpected $$passes)"; \
+	      banner="$$failed of $$all tests did not behave as expected ($$xpass unexpected passes)"; \
 	    fi; \
 	  fi; \
 	  dashes="$$banner"; \
 	  skipped=""; \
 	  if test "$$skip" -ne 0; then \
-	    if test "$$skip" -eq 1; then \
-	      skipped="($$skip test was not run)"; \
-	    else \
-	      skipped="($$skip tests were not run)"; \
-	    fi; \
+	    skipped="($$skip tests were not run)"; \
 	    test `echo "$$skipped" | wc -c` -le `echo "$$banner" | wc -c` || \
 	      dashes="$$skipped"; \
 	  fi; \
@@ -1613,7 +1600,7 @@
 all-am: Makefile $(LIBRARIES) $(PROGRAMS) $(SCRIPTS) config.h
 installdirs: installdirs-recursive
 installdirs-am:
-	for dir in "$(DESTDIR)$(bindir)" "$(DESTDIR)$(bindir)" "$(DESTDIR)$(bindir)"; do \
+	for dir in "$(DESTDIR)$(bindir)" "$(DESTDIR)$(bindir)" "$(DESTDIR)$(sbindir)"; do \
 	  test -z "$$dir" || $(MKDIR_P) "$$dir"; \
 	done
 install: $(BUILT_SOURCES)
@@ -1670,7 +1657,7 @@
 install-dvi: install-dvi-recursive
 
 install-exec-am: install-binPROGRAMS install-binSCRIPTS \
-	install-dist_binSCRIPTS
+	install-dist_sbinSCRIPTS
 
 install-html: install-html-recursive
 
@@ -1702,7 +1689,7 @@
 ps-am:
 
 uninstall-am: uninstall-binPROGRAMS uninstall-binSCRIPTS \
-	uninstall-dist_binSCRIPTS
+	uninstall-dist_sbinSCRIPTS
 
 .MAKE: $(RECURSIVE_CLEAN_TARGETS) $(RECURSIVE_TARGETS) install-am \
 	install-strip
@@ -1714,7 +1701,7 @@
 	distclean-hdr distclean-tags distdir dvi dvi-am html html-am \
 	info info-am install install-am install-binPROGRAMS \
 	install-binSCRIPTS install-data install-data-am \
-	install-dist_binSCRIPTS install-dvi install-dvi-am \
+	install-dist_sbinSCRIPTS install-dvi install-dvi-am \
 	install-exec install-exec-am install-html install-html-am \
 	install-info install-info-am install-man install-pdf \
 	install-pdf-am install-ps install-ps-am install-strip \
@@ -1723,7 +1710,7 @@
 	mostlyclean-compile mostlyclean-generic pdf pdf-am ps ps-am \
 	tags tags-recursive uninstall uninstall-am \
 	uninstall-binPROGRAMS uninstall-binSCRIPTS \
-	uninstall-dist_binSCRIPTS
+	uninstall-dist_sbinSCRIPTS
 
 #
 version.c: version.sh ../configure.ac Makefile.am	\
diff -Naur Bogofilter-1.2.0/src/passthrough.c bogofilter-1.2.0/src/passthrough.c
--- Bogofilter-1.2.0/src/passthrough.c	2008-10-16 04:11:02.000000000 +0530
+++ bogofilter-1.2.0/src/passthrough.c	2009-03-29 10:59:33.000000000 +0530
@@ -29,8 +29,13 @@
 
 static const char *eol;
 char msg_register[256];
-static char msg_bogofilter[256];
-static char msg_spam_header[256];
+#ifdef INDIMAIL
+char            msg_bogofilter[256];
+char            msg_spam_header[256];
+#else
+static char     msg_bogofilter[256];
+static char     msg_spam_header[256];
+#endif
 const char *spam_header_place = "";
 size_t msg_register_size = sizeof(msg_register);
 
@@ -131,7 +136,16 @@
     /* print spam-status at the end of the header
      * then mark the beginning of the message body */
     if (passthrough || verbose || terse)
-	fprintf(fpo, "%s%s", msg_spam_header, eol);
+	{
+#ifdef INDIMAIL
+		if (*msg_register)
+			fprintf(fpo, "%s, %s%s", msg_spam_header, msg_register, eol);
+		else
+			fprintf(fpo, "%s%s", msg_spam_header, eol);
+#else
+		fprintf(fpo, "%s%s", msg_spam_header, eol);
+#endif
+	}
 
     if (passthrough || verbose || Rtable) {
 	verbose += passthrough;
@@ -143,7 +157,11 @@
 static bool write_header(rc_t status, readfunc_t rf, void *rfarg)
 {
     ssize_t rd;
-    char   *out;
+#ifdef INDIMAIL
+	char           *out, *ptr;
+#else
+	char           *out;
+#endif
 
     bool hadlf = true;
     bool seen_subj = false;
@@ -201,10 +219,23 @@
 
 	    if (tag != NULL && strncasecmp(out, subjstr, subjlen) == 0) {
 		seen_subj = true;
+#ifdef INDIMAIL
+		for (ptr = out + subjlen; *ptr && isspace((int) *ptr); ptr++);
+		if (strstr(ptr, tag))
+			(void) fwrite(out, 1, rd, fpo);	/*- do not tag twice */
+		else		 /*- adding tag will break DomainKeys */
+		{
+			(void) fprintf(fpo, "%.*s %s", subjlen, out, tag);
+			if (out[subjlen] != ' ')
+				fputc(' ', fpo);
+			(void) fwrite(out + subjlen, 1, rd - subjlen, fpo);
+		}
+#else
 		(void) fprintf(fpo, "%.*s %s", subjlen, out, tag);
 		if (out[subjlen] != ' ')
-		    fputc(' ', fpo);
+			fputc(' ', fpo);
 		(void) fwrite(out + subjlen, 1, rd - subjlen, fpo);
+#endif
 		continue;
 	    }
 	}
