#!/bin/sh
# WARNING: This file was auto-generated. Do not edit!
# $Log: bootstrap.in,v $
# Revision 2.38  2009-02-08 01:27:03+05:30  Cprogrammer
# do not run chmod for non root users
#
# Revision 2.37  2009-02-08 00:29:15+05:30  Cprogrammer
# do not chmod when running with non-root privileges
#
# Revision 2.36  2009-02-04 13:43:47+05:30  Cprogrammer
# added INSTALL.rpm
#
# Revision 2.35  2009-01-31 20:01:04+05:30  Cprogrammer
# create /var/indimail/bin before copying crypt
# do not write inc_deps, lib_deps if qmail-1.03 not present
#
# Revision 2.34  2009-01-30 17:07:14+05:30  Cprogrammer
# added README.cluster
#
# Revision 2.33  2009-01-20 16:48:21+05:30  Cprogrammer
# added INSTALL.mysql
#
# Revision 2.32  2009-01-20 09:58:23+05:30  Cprogrammer
# use mysqlbindir for determining base
#
# Revision 2.31  2009-01-12 12:25:56+05:30  Cprogrammer
# fix installation abort due to missing files
#
# Revision 2.30  2009-01-11 19:51:13+05:30  Cprogrammer
# need crypt for inserting users in mgmtaccess table
#
# Revision 2.29  2008-11-13 19:28:02+05:30  Cprogrammer
# made vuserinfo setuid
#
# Revision 2.28  2008-09-17 19:28:45+05:30  Cprogrammer
# added vdominfo and printdir to the list of setuid programs
#
# Revision 2.27  2008-09-12 22:38:41+05:30  Cprogrammer
# added vadduser, vdeluser, vbulletin, vreorg
#
# Revision 2.26  2008-09-12 15:28:20+05:30  Cprogrammer
# BUG FIX. Fixed setting of setuid programs
#
# Revision 2.25  2008-08-14 14:08:30+05:30  Cprogrammer
# added CREDITS and IndiMail.pdf
#
# Revision 2.24  2008-07-27 20:56:50+05:30  Cprogrammer
# use libtool if DESTDIR is null
#
# Revision 2.23  2008-07-27 19:50:58+05:30  Cprogrammer
# added libtool --finish
#
# Revision 2.22  2008-07-25 16:47:13+05:30  Cprogrammer
# create users before setting permissions, else chown fails
#
# Revision 2.21  2008-07-20 18:09:24+05:30  Cprogrammer
# port for mac
#
# Revision 2.20  2008-07-18 19:12:46+05:30  Cprogrammer
# changes for running configure, make as non-root
#
# Revision 2.19  2008-07-17 22:57:18+05:30  Cprogrammer
# Darwin, LIBTOOL port
#
# Revision 2.18  2008-06-30 16:09:41+05:30  Cprogrammer
# set permission of /var/indimail
#
# Revision 2.17  2008-06-30 09:29:46+05:30  Cprogrammer
# moved commands to install stage
#
# Revision 2.16  2008-06-27 12:45:49+05:30  Cprogrammer
# display svctool execution
#
# Revision 2.15  2008-06-24 22:24:51+05:30  Cprogrammer
# added RCS id
#
# Revision 2.14  2008-06-22 20:08:55+05:30  Cprogrammer
# show creation of logdir
#
# Revision 2.13  2008-06-20 15:17:35+05:30  Cprogrammer
# added staged installation/configuration
#
# Revision 2.12  2008-06-17 23:08:07+05:30  Cprogrammer
# create users before copying crypt and setting permissions
#
# Revision 2.11  2008-06-17 15:37:05+05:30  Cprogrammer
# added creation of log directory
#
# Revision 2.10  2008-06-17 11:59:25+05:30  Cprogrammer
# corrected setting of perms for eps include files
# added creation of MySQL config file
#
# Revision 2.9  2008-06-16 11:16:22+05:30  Cprogrammer
# removed indimail.pdf
#
# Revision 2.8  2008-06-14 19:18:40+05:30  Cprogrammer
# use create_user from svctool
# added creation of mysql_db
#
# Revision 2.7  2008-06-13 19:35:38+05:30  Cprogrammer
# added README.mpack
#
# Revision 2.6  2008-06-13 08:35:20+05:30  Cprogrammer
# echo SUCCESS/FAILURE
#
# Revision 2.5  2008-06-12 21:57:36+05:30  Cprogrammer
# fixed more problems with chown, chmod
#
# Revision 2.4  2008-06-10 17:19:07+05:30  Cprogrammer
# added creation of users
#
# Revision 2.3  2008-06-10 14:25:56+05:30  Cprogrammer
# fixed chown, chmod problem with files in lib
#
# Revision 2.2  2008-06-10 13:21:54+05:30  Cprogrammer
# fixed chown problem
#
# Revision 2.1  2008-06-08 20:12:35+05:30  Cprogrammer
# installation bootstrap script
#
#
# $Id: bootstrap.in,v 2.38 2009-02-08 01:27:03+05:30 Cprogrammer Exp mbhangui $
indimaildir=@DESTDIR@@indimaildir@
shared_libpath=@DESTDIR@/usr/lib
export LD_LIBRARY_PATH=@DESTDIR@@indimaildir@/lib
LOGDIR=@DESTDIR@/var/log/indimail
DESTDIR=@DESTDIR@
host=@HOST@
databasedir=@indimaildir@/mysqldb

M_ch()
{
if test `$idcommand` = "0"
then
	echo "chown $*"
	chown $*
else
	echo "chown $*"
fi
}

create_all_users()
{
	# Create User
	echo "Creating default users"
	sh ./svctool --config=users --nolog
	if [ $? -ne 0 ] ; then
		exit 1
	fi
}

doAllDefaults()
{
echo "Creating default directories, setting default permissions, Copying default files"
# Directories
if [ ! -d $indimaildir ] ; then
	echo "mkdir $indimaildir"
	mkdir -p $indimaildir
fi
M_ch root:indimail $indimaildir
if test `$idcommand` = "0"
then
	echo "chmod 755 $indimaildir"
	chmod 755 $indimaildir
else
	echo "chmod 755 $indimaildir"
fi
for i in etc domains share include lib libexec libexec/authlib bin sbin modules doc
do
	if [ ! -d $indimaildir/$i ] ; then
		echo "mkdir -p $indimaildir/$i"
		mkdir -p $indimaildir/$i
	fi
	if test `$idcommand` = "0"
	then
		echo "chmod 755 $indimaildir/$i"
		chmod 755 $indimaildir/$i
	else
		echo "chmod 755 $indimaildir/$i"
	fi
done
# Libraries
for i in .libs/libindimail.la eps-1.2/.libs/libeps.la
do
	if [ -f $i ] ; then
		t_dir=`dirname $i`
		. $i
		if [ ! -d @DESTDIR@"$libdir" ] ; then
			mkdir -p @DESTDIR@"$libdir"
		fi
		if [ ! -f @DESTDIR@"$libdir/$dlname" ] ; then
			echo "cp -f $t_dir/$dlname @DESTDIR@$libdir"
			cp -f $t_dir/$dlname @DESTDIR@"$libdir"
		fi
		OLDPWD=$PWD
		echo "cd @DESTDIR@$libdir"
		cd @DESTDIR@"$libdir"
		for i in $library_names
		do
			echo "checking $i"
			if [ ! -f $i ] ; then
				echo "ln -s $dlname $i"
				ln -s $dlname $i
			fi
		done
		echo "cd $OLDPWD"
		cd $OLDPWD
		if ! cmp -s $t_dir/$dlname $indimaildir/lib/$dlname ; then
			echo "cp -f $t_dir/$dlname $indimaildir/lib"
			cp -f $t_dir/$dlname $indimaildir/lib
			M_ch root:indimail $indimaildir/lib/$dlname
			chmod 555 $indimaildir/lib/$dlname
		fi
	fi
done
if [ -f ./libtool ] ; then
	if [ " $DESTDIR" = " " ] ; then
		./libtool --finish $indimaildir/lib
	fi
fi
if [ ! -f $indimaildir/etc/inc_deps ] ; then
	echo "creating $indimaildir/etc/inc_deps"
	echo "@auth_inc@" > $indimaildir/etc/inc_deps
fi
if [ ! -f $indimaildir/etc/lib_deps ] ; then
	echo "creating $indimaildir/etc/lib_deps"
	echo "@auth_libs@" > $indimaildir/etc/lib_deps
fi

# Header Files
for i in indimail.h config.h
do
	if [ -f $indimaildir/include/$i ] ; then
		chmod 644 $indimaildir/include/$i
	fi
	if ! cmp -s $i $indimaildir/include/$i ; then echo "cp -f $i $indimaildir/include";cp -f $i $indimaildir/include;M_ch root:indimail $indimaildir/include/$i;chmod 444 $indimaildir/include/$i; fi
done
for i in eps_address.h eps_base64.h eps_boundary.h eps_buffer.h eps_content.h eps_email.h eps.h eps_header.h \
eps_int_buffer.h eps_interface.h eps_int_stream.h eps_line.h eps_mime.h eps_misc.h eps_roll.h eps_unroll.h \
rfc2822.h
do
	if [ -f $indimaildir/include/$i ] ; then
		chmod 644 $indimaildir/include/$i
	fi
	if ! cmp -s eps-1.2/$i $indimaildir/include/$i ; then echo "cp -f eps-1.2/$i $indimaildir/include";cp -f eps-1.2/$i $indimaildir/include;M_ch root:indimail $indimaildir/include/$i;chmod 444 $indimaildir/include/$i; fi
done
if [ -f $indimaildir/include/indimail_config.h ] ; then
	chmod 644 $indimaildir/include/indimail_config.h
fi
if ! cmp -s config.h $indimaildir/include/indimail_config.h ; then echo "cp -f config.h $indimaildir/include/indimail_config.h";cp -f config.h $indimaildir/include/indimail_config.h;M_ch root:indimail $indimaildir/include/indimail_config.h;chmod 444 $indimaildir/include/indimail_config.h; fi

# Config Files
for i in indimail.settings controlfiles headerlist osh.table cronlist
do
	if [ -f $indimaildir/etc/$i ] ; then
		chmod 644 $indimaildir/etc/$i
	fi
	if ! cmp -s $i $indimaildir/etc/$i ; then echo "cp -f $i $indimaildir/etc";cp -f $i $indimaildir/etc;M_ch indimail:indimail $indimaildir/etc/$i;chmod 444 $indimaildir/etc/$i; fi
done

# Docs
for i in 37rules.pdf ChangeLog COPYING CREDITS FAQ.pdf fhs-2.3.txt.gz HOWTO.bogofilter \
	HOWTO.sharedmaildir INSTALL.indimail IndiMail.pdf percenthack.shtml README.indimail \
	INSTALL.mysql INSTALL.rpm README.cluster README.vlimits ../../mpack-1.6/README.mpack
do
	j=`basename $i`
	if [ -f $indimaildir/doc/$j ] ; then
		chmod 644 $indimaildir/doc/$j
	fi
	if [ ! -f doc/$i ] ; then
		continue
	fi
	if ! cmp -s doc/$i $indimaildir/doc/$j ; then echo "cp -f doc/$i $indimaildir/doc";cp -f doc/$i $indimaildir/doc;M_ch root:indimail $indimaildir/doc/$j;chmod 444 $indimaildir/doc/$j; fi
done

if [ ! -f $indimaildir/bin/crypt ] ; then
	if [ -f ./crypt ] ; then
		echo "cp -f crypt $indimaildir/bin/crypt"
		cp -f crypt $indimaildir/bin/crypt
	else
		echo "crypt not found"
		exit 1
	fi
fi
# Binary Permissions
for i in ../sbin/systpass vdeldomain vadddomain vadduser vdeluser vaddaliasdomain vrenamedomain \
	vrenameuser vbulletin vdominfo printdir vuserinfo vreorg bogofilter ../libexec/authlib/authpam
do 
	if [ -f $indimaildir/bin/$i ] ; then
		echo "chmod 4555 $indimaildir/bin/$i"
		chmod 4555 $indimaildir/bin/$i
	fi
done

if [ ! -d $LOGDIR ] ; then
	echo "mkdir -p $LOGDIR"
	mkdir -p $LOGDIR
	if [ $? -ne 0 ] ; then
		exit 1
	fi
	M_ch -R qmaill:nofiles $LOGDIR
	if [ $? -ne 0 ] ; then
		exit 1
	fi
else
	if [ -h $LOGDIR ] ; then
		logdir=`ls -ld $LOGDIR |awk '{print $10}'`
	else
		logdir=$LOGDIR
	fi
	M_ch -R qmaill:nofiles $logdir
fi

# Permissions
echo "Setting Default Permissions"
if test `$idcommand` = "0"
then
	echo "chmod 555 $indimaildir"
	chmod 555 $indimaildir
else
	echo "chmod 555 $indimaildir"
fi
for i in etc domains share include lib libexec libexec/authlib bin sbin modules doc
do
	if [ " $i" = " domains"  -o " $i" = " etc" ] ; then
		if test `$idcommand` = "0"
		then
			echo "chmod 755 $indimaildir/$i"
			chmod 755 $indimaildir/$i
		else
			echo "chmod 755 $indimaildir/$i"
		fi
	else
		if test `$idcommand` = "0"
		then
			echo "chmod 555 $indimaildir/$i"
			chmod 555 $indimaildir/$i
		else
			echo "chmod 555 $indimaildir/$i"
		fi
	fi
	M_ch root:indimail $indimaildir/$i
done
M_ch -R root:indimail $indimaildir/modules
}

create_database()
{
# Create Database
MYSQL_BASE=`dirname @mysqlbindir@`

echo "Creating default directories, setting default permissions, Copying default files"
# Directories
if [ ! -d $indimaildir ] ; then
	echo "mkdir $indimaildir"
	mkdir -p $indimaildir
fi
M_ch root:indimail $indimaildir
if test `$idcommand` = "0"
then
	echo "chmod 755 $indimaildir"
	chmod 755 $indimaildir
else
	echo "chmod 755 $indimaildir"
fi
for i in etc domains share include lib libexec libexec/authlib bin sbin modules doc
do
	if [ ! -d $indimaildir/$i ] ; then
		echo "mkdir -p $indimaildir/$i"
		mkdir -p $indimaildir/$i
	fi
	if test `$idcommand` = "0"
	then
		echo "chmod 755 $indimaildir/$i"
		chmod 755 $indimaildir/$i
	else
		echo "chmod 755 $indimaildir/$i"
	fi
done
if [ ! -f $indimaildir/bin/crypt ] ; then
	if [ -f ./crypt ] ; then
		echo "cp -f crypt $indimaildir/bin/crypt"
		cp -f crypt $indimaildir/bin/crypt
	else
		echo "crypt not found"
		exit 1
	fi
fi
if [ ! -f @DESTDIR@/etc/my.cnf ] ; then
	if [ ! -d @DESTDIR@/etc ] ; then
		mkdir -p @DESTDIR@/etc
		if [ $? -ne 0 ] ; then
			exit 1
		fi
	fi
	if [ " $DESTDIR" = " " ] ; then
		echo "sh ./svctool --config=mysql   --mysqlPrefix=$MYSQL_BASE --model=medium --nolog"
		sh ./svctool --config=mysql   --mysqlPrefix=$MYSQL_BASE --model=medium --nolog
	else
		echo "sh ./svctool --config=mysql   --mysqlPrefix=$MYSQL_BASE --model=medium --nolog --destdir=$DESTDIR"
		sh ./svctool --config=mysql   --mysqlPrefix=$MYSQL_BASE --model=medium --nolog --destdir=$DESTDIR
	fi
	if [ $? -ne 0 ] ; then
		exit 1
	fi
fi
if [ " $DESTDIR" = " " ] ; then
	echo "sh ./svctool --config=mysqldb --mysqlPrefix=$MYSQL_BASE --databasedir=$databasedir --nolog"
	sh ./svctool --config=mysqldb --mysqlPrefix=$MYSQL_BASE --databasedir=$databasedir --nolog
else
	echo "sh ./svctool --config=mysqldb --mysqlPrefix=$MYSQL_BASE --databasedir=$databasedir --nolog --destdir=$DESTDIR"
	sh ./svctool --config=mysqldb --mysqlPrefix=$MYSQL_BASE --databasedir=$databasedir --nolog --destdir=$DESTDIR
fi
if [ $? -ne 0 ] ; then
	exit 1
fi
}

doDefault=1
doDb=0
doUser=0
while test $# -gt 0; do
    case "$1" in
    -*=*) optarg=`echo "$1" | sed 's/[-_a-zA-Z0-9]*=//'` ;;
    *) optarg= ;;
    esac
    case "$1" in
		--destdir=*)
		DESTDIR=$optarg
		;;
    	--database)
		doDb=1
		;;
    	--users)
		doUser=1
		;;
    	--nodefaults)
		doDefault=0
		;;
		*)
		echo "invalid option [$1]"
		exit 1
		;;
	esac
    shift
done

echo "Running bootstrap"
if [ -d ../qmail-1.03 ] ; then
	echo -I../indimail-@version@ -I../indimail-@version@/eps-1.2 @auth_inc@ > ../qmail-1.03/inc_deps
	echo -L../indimail-@version@/.libs -L../indimail-@version@/eps-1.2/.libs @auth_libs@ > ../qmail-1.03/lib_deps
fi

case "$host" in
*-*-sunos4.1.1*)
	idcommand="/usr/xpg4/bin/id -u"
	;;
*-*-darwin*)
	idcommand="/usr/bin/id -u"
	;;
*-*-solaris*)
	idcommand="/usr/xpg4/bin/id -u"
	;;
*)
	INSTALL="/usr/bin/install -c"
	idcommand="/usr/bin/id -u"
	;;
esac

(
if [ $doUser -eq 1 ] ; then
	create_all_users
fi
if [ $doDefault -eq 1 ] ; then
	doAllDefaults
fi
if [ $doDb -eq 1 ] ; then
	create_database
fi
) 2>/tmp/bootstrap.test.$$
/bin/cat /tmp/bootstrap.test.$$
if [ -s /tmp/bootstrap.test.$$ ] ; then
	echo "bootstrap FAILURE!!"
	/bin/rm -f /tmp/bootstrap.test.$$
	exit 1
else
	echo "bootstrap SUCCESS!!"
	/bin/rm -f /tmp/bootstrap.test.$$
	exit 0
fi
