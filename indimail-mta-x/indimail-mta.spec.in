#
#
# $Id: indimail-mta.spec.in,v 1.236 2020-06-15 15:35:19+05:30 Cprogrammer Exp mbhangui $
%undefine _missing_build_ids_terminate_build
%global _unpackaged_files_terminate_build 1
%global debug_package %{nil}

%if %{defined _project}
# define if building on openSUSE build service
%global build_on_obs       1
%global reconfigure_mode   0
%else
%define _project           local
%global build_on_obs       0
%global reconfigure_mode   0
%global _hardened_build    1
%endif

%global qmaildir           @qmaildir@
%global _prefix            @prefix@
%global libexecdir         @libexecdir@
%global shareddir          @shareddir@
%global mandir             @mandir@
%global qsysconfdir        @sysconfdir@
%global logdir             @logdir@
%global servicedir         @servicedir@
%global plugindir          %{_prefix}/lib/indimail/plugins
%global libdkim_version    1.5
%global libsrs2_version    1.0.18
%global ucspitcp_version   1.0
%global tcpserver_plugin   1
%if 0%{?suse_version}
%global noperms            1
%else
%global noperms            0
%endif
%global see_base           For a description of IndiMail visit https://github.com/mbhangui/indimail-mta
%global nolibdkim          0
%global nolibsrs2          0
%global nodksignatures     0
%global notlsarr           0

%global _verbose           0
%global qcount             5
%global qbase              %{qmaildir}/queue
%global dkimkeyfn          default

%if %build_on_obs == 1
%global packager Manvendra Bhangui <indimail-mta@indimail.org>
%endif

%if 0%{?suse_version}
%global dist suse
%global disttag suse
%endif

%if 0%{?fedora_version}
%global dist %{?dist}
%global disttag fedora
%endif

Summary: A Flexible SMTP server
Name: indimail-mta
Version: @version@
Provides: daemontools = %{version}, ucspi-tcp = %{version}
Release: @release@%{?dist}

## user/group management
# Note: it is not necessary to assign 555 for uid, gid. The package will use any id assigned to username, groupname
# at runtime
%global uid                555
%global gid                555
%global username           indimail
%global groupname          indimail
# Note: 999 indimail-mta does not require any specific values for uids/gids. 999 is just
# for rpmlint to shut up and stop complaining
Provides: user(%username)   = %uid
Provides: user(alias)       > 999
Provides: user(qmaild)      > 999
Provides: user(qmaill)      > 999
Provides: user(qmailp)      > 999
Provides: user(qmailq)      > 999
Provides: user(qmailr)      > 999
Provides: user(qmails)      > 999
Provides: user(qscand)      > 999
Provides: group(%groupname) = %gid
Provides: group(nofiles)    > 999
Provides: group(qmail)      > 999
Provides: group(qscand)     > 999
%if %build_on_obs == 0
Requires(pre): shadow-utils
Requires(postun): shadow-utils
%endif

%if %build_on_obs == 1
License: GPL-3.0+
%else
License: GPLv3
%endif
%if %{undefined suse_version} && %{undefined sles_version}
Group: System Environment/Base
%else
Group: Productivity/Networking/Email/Servers
%endif
Source1: http://downloads.sourceforge.net/indimail/%{name}-%{version}.tar.gz
Source2: http://downloads.sourceforge.net/indimail/ucspi-tcp-%{ucspitcp_version}.tar.gz
%if %nolibdkim == 0
Source3: http://downloads.sourceforge.net/indimail/libdkim-%{libdkim_version}.tar.gz
%endif
%if %nolibsrs2 == 0
Source4: http://downloads.sourceforge.net/indimail/libsrs2-%{libsrs2_version}.tar.gz
%endif
Source5: http://downloads.sourceforge.net/indimail/%{name}-rpmlintrc

%if %noperms == 0
%if 0%{?suse_version} >= 1120
Source6: http://downloads.sourceforge.net/indimail/%{name}-permissions.easy
Source7: http://downloads.sourceforge.net/indimail/%{name}-permissions.secure
Source8: http://downloads.sourceforge.net/indimail/%{name}-permissions.paranoid
%endif
%endif

URL: https://github.com/mbhangui/indimail-mta
#AutoReqProv: No
Conflicts: indimail-mini
Conflicts: daemontools
Conflicts: ucspi-tcp
Conflicts: indimail-mta < 2.0
Conflicts: indimail < 2.5
Obsoletes: indimail-mta < 2.0
BuildRequires: openssl-devel rpm gcc gcc-c++ make bison binutils coreutils grep
BuildRequires: glibc glibc-devel openssl procps readline-devel
BuildRequires: sed ncurses-devel gettext-devel
BuildRequires: flex findutils diffutils
BuildRequires: readline gzip autoconf automake libtool pkgconfig
BuildRequires: mysql-devel pam-devel libqmail-devel libqmail

##################################### OBS ####################################
%if %build_on_obs == 1
%if 0%{?suse_version}
BuildRequires: -post-build-checks
#!BuildIgnore: post-build-checks
%endif
%endif
##############################################################################

%if 0%{?suse_version}
BuildRequires: openldap2-devel
%else
BuildRequires: openldap-devel
%endif

%if %{undefined centos_version} && %{undefined rhel_version} && %{undefined centos_ver}
BuildRequires: chrpath
%endif
%if 0%{?suse_version} == 1220 || 0%{?suse_version} == 1210 || 0%{?suse_version} == 1140 || 0%{?suse_version} == 1100 || 0%{?suse_version} == 1030 || 0%{?suse_version} == 1020
BuildRequires: chrpath
%endif

%if %noperms == 0
%if 0%{?suse_version} >= 1120
PreReq: permissions
%endif
%endif

%if 0%{?suse_version}
BuildRequires: db-devel
%else
%if 0%{?fedora_version} > 17 || 0%{?centos_version} > 600 || 0%{?rhel_version} > 600 || 0%{?centos_ver} > 7
BuildRequires: libdb-devel
%else
BuildRequires: db4-devel
%endif
%endif

# rpm -qf /bin/ls
# rpm -qp --queryformat '%' {arch}\n some-file.rpm
# rpm --showrc for all macros
# rpm -qlp some-file.rpm
%if %build_on_obs == 1
BuildRoot: %(mktemp -ud %{_tmppath}/%{name}-%{version}-%{release}-XXXXXXX)
%endif
Requires: /usr/sbin/useradd /usr/sbin/userdel /usr/sbin/groupadd /usr/sbin/groupdel
Requires: /sbin/chkconfig procps /usr/bin/awk /usr/bin/which
Requires: coreutils grep /bin/sh glibc openssl libqmail
Requires: binutils diffutils sed findutils pkgconfig

%if 0%{?fedora_version} > 30 || 0%{?centos_version} > 700 || 0%{?rhel_version} > 700 || 0%{?centos_ver} > 7
Requires: policycoreutils
%else
%if %{defined centos_version} || %{defined rhel_version}
Requires: policycoreutils-python
%endif
%endif

%if 0%{?suse_version}
Requires: insserv-compat
%else
Requires: initscripts
%endif
#
# IndiMail is choosy and runs on reliable OS only
#
Excludeos: windows

%description
indimail-mta provides a standalone mta server that is part of the IndiMail
messaging platform. It comprises of the following packages

qmail,
serialmail,
qmailanalog,
dotforward,
fastforward,
mess822,
daemontools,
ucspi-tcp,

The package combines qmail with other packages like libdkim, libsrs2

qmail, daemontools, ucspi-tcp, serialmail, qmailanalog, fastforward, mess822

Original Author: Dan J. Bernstein <djb@cr.yp.to>

%{see_base}

%package -n daemontools
Summary: A collection of tools for managing UNIX services
Conflicts: indimail-mta
Provides: user(qmaill)      > 999
Provides: group(nofiles)    > 999
Provides: group(qmail)      > 999
%if %{undefined suse_version} && %{undefined sles_version}
Group: System Environment/Base
%else
Group: System/Base
%endif

%description -n daemontools
daemontools is a collection of tools for managing UNIX services.

supervise monitors a service. It starts the service and restarts the
service if it dies. Setting up a new service is easy: all supervise
needs is a directory with a run script that runs the service.

multilog saves error messages to one or more logs. It optionally
timestamps each line and, for each log, includes or excludes lines
matching specified patterns. It automatically rotates logs to limit the
amount of disk space used. If the disk fills up, it pauses and tries
again, without losing any data.

Original Author: Dan J. Bernstein <djb@cr.yp.to>

%package -n ucspi-tcp
Conflicts: indimail-mta
Summary: A collection of tools for building TCP client-server applications
%if %{undefined suse_version} && %{undefined sles_version}
Group: System Environment/Base
%else
Group: System/Base
%endif

%description -n ucspi-tcp
tcpserver and tcpclient are easy-to-use command-line tools for building
TCP client-server applications.

tcpserver waits for incoming connections and, for each connection, runs
a program of your choice. Your program receives environment variables
showing the local and remote host names, IP addresses, and port numbers.

tcpserver offers a concurrency limit to protect you from running out of
processes and memory. When you are handling 40 (by default) simultaneous
connections, tcpserver smoothly defers acceptance of new connections.

tcpserver also provides TCP access control features, similar to
tcp-wrappers/tcpd\'s hosts.allow but much faster. Its access control
rules are compiled into a hashed format with cdb, so it can easily deal
with thousands of different hosts.

This package includes a recordio tool that monitors all the input and
output of a server.

tcpclient makes a TCP connection and runs a program of your choice. It
sets up the same environment variables as tcpserver.

This package includes several sample clients built on top of tcpclient:
who@, date@, finger@, http@, tcpcat, and mconnect.

tcpserver and tcpclient conform to UCSPI, the UNIX Client-Server Program
Interface, using the TCP protocol. UCSPI tools are available for several
different networks.

Original Author: Dan J. Bernstein <djb@cr.yp.to>

%package -n indimail-mini
Summary: IndiMail - Mini Client Installation
Group: Productivity/Networking/Email/Clients
Conflicts: %{name}
Conflicts: indimail-mini < 2.0
Requires: coreutils /bin/sh glibc openssl
Requires: binutils

%description -n indimail-mini
This package contains sendmail, qmail-inject and qmail-qmqpc - Bare minimum
programs to have a mini-indimail installation.

A mini-indimail installation doesn't have a mail queue. It gives each
new message to a central server using QMQP.

%{see_base}

%prep
for i in %{name}-%{version} ucspi-tcp-%{ucspitcp_version} \
libdkim-%{libdkim_version} libsrs2-%{libsrs2_version}
do
(
  if [ -d $i ] ; then
    %{__rm} -rf $i
  fi
  if [ " $i" = " libdkim-%{libdkim_version}" -a %nolibdkim -ne 0 ] ; then
    continue
  fi
  if [ " $i" = " libsrs2-%{libsrs2_version}" -a %nolibsrs2 -ne 0 ] ; then
    continue
  fi
  if [ -f ../SOURCES/$i.tar.bz2 ] ; then
    %{__bzip2} -d -c ../SOURCES/$i.tar.bz2 |tar xf -
  elif [ -f ../SOURCES/$i.tar.gz ] ; then
    gunzip -c ../SOURCES/$i.tar.gz |tar xf -
  else
    echo "No Source Archive for $i"
    exit 1
  fi
%if %build_on_obs == 1
  if [ -d $i ] ; then
    #
    # Apply indimail-mta Patch
    #
    if [ " $i" = " %{name}-%{version}" ] ; then
      if [ -f ../SOURCES/%{name}-%{version}.patch ] ; then
        patch -p0 < ../SOURCES/%{name}-%{version}.patch
        continue
      elif [ -f ../SOURCES/%{name}-%{version}.patch.gz ] ; then
        gunzip -c ../SOURCES/%{name}-%{version}.patch.gz | patch -p0
        continue
      fi
    fi
  fi
%endif
)
done

%build
ID=$(id -u)
(
echo "---------------- INFORMATION ------------------------"
echo target        %_target
echo target_alias  %_target_alias
echo target_cpu    %_target_cpu
echo target_os     %_target_os
echo target_vendor %_target_vendor
echo Building %{name}-%{version}-%{release} Build %{_build} OS %{_os} Dist %dist disttag %disttag libs %{_lib} %{_libdir}
echo "------------------------------------------------------"
) > %{name}-rpm.info

(
echo "NAME=%{name}"
echo "Description=\"IndiMail MTA\""
echo "MTA_version="%{version}""
echo "ID=%{name}"
echo "HOME_URL=\"https://github.com/mbhangui/indimail-mta\""
echo "PACKAGE_BUGREPORT=\"Manvendra Bhangui indimail-mta@indimail.org\""
) > %{name}-release
#### LIBDKIM ######################
if [ -d libdkim-%{libdkim_version} ] ; then
  cd libdkim-%{libdkim_version}
  if [ %{reconfigure_mode} -eq 1 ] ; then
    echo "reconfiguring..."
    %{__mkdir_p} m4
    aclocal -I m4
    autoreconf -fiv
  fi
  %configure --prefix=%{_prefix} --libdir=%{_libdir} --mandir=%{mandir}
  cd ..
fi

#### LIBSRS2 ######################
if [ -d libsrs2-%{libsrs2_version} ] ; then
  cd libsrs2-%{libsrs2_version}
  if [ %{reconfigure_mode} -eq 1 ] ; then
    echo "reconfiguring..."
    %{__mkdir_p} m4
    aclocal -I m4
    autoreconf -fiv
  fi
  %configure --prefix=%{_prefix} --libdir=%{_libdir} --mandir=%{mandir}
  cd ..
fi

#### qmail ######################
if [ -d %{name}-%{version} ] ; then
  %{__sed} 's{QMAIL{%{qmaildir}{' %{name}-%{version}/conf-qmail.in > %{name}-%{version}/conf-qmail
  %{__sed} 's{SYSCONFDIR{%{qsysconfdir}{' %{name}-%{version}/conf-sysconfdir.in > %{name}-%{version}/conf-sysconfdir
  %{__sed} 's{SHAREDDIR{%{shareddir}{' %{name}-%{version}/conf-shared.in > %{name}-%{version}/conf-shared
  %{__sed} 's{PREFIX{%{_prefix}{' %{name}-%{version}/conf-prefix.in > %{name}-%{version}/conf-prefix
  %if %notlsarr == 0
    echo "-DHASTLSA" > %{name}-%{version}/conf-tlsa
  %else
    > %{name}-%{version}/conf-tlsa
  %endif
  %if %{tcpserver_plugin} == 1
    echo "-DLOAD_SHARED_OBJECTS" > %{name}-%{version}/conf-dlopen
  %else
    %{__rm} -f %{name}-%{version}/conf-dlopen
  %endif
  # create conf-users
  (
  echo "alias"
  echo "qmaild"
  echo "qmaill"
  echo "root"
  echo "qmailp"
  echo "qmailq"
  echo "qmailr"
  echo "qmails"
  echo %username
  echo "qscand"
  echo
  echo "The qmail system is heavily partitioned for security; it does almost"
  echo "nothing as root."
  echo
  echo "The first nine lines of this file are the alias user, the daemon user,"
  echo "the log user, the owner of miscellaneous files such as binaries, the"
  echo "passwd user, the queue user, the remote user, the send user, the"
  echo "indimail user and the virus scan user."
  ) > /tmp/conf-users
  diff /tmp/conf-users %{name}-%{version}/conf-users > /dev/null 2>&1
  if [ $? -ne 0 ] ; then
    %{__mv} /tmp/conf-users %{name}-%{version}/conf-users
  else
    %{__rm} -f /tmp/conf-users
  fi
  # create conf-groups
  (
  echo "qmail"
  echo "nofiles"
  echo %groupname
  echo "qscand"
  echo
  echo "These are the qmail groups. The second group should not have access to"
  echo "any files, but it must be usable for processes; this requirement"
  echo "excludes the \`\`nogroup'' and \`\`nobody'' groups on many systems."
  ) > /tmp/conf-groups
  diff /tmp/conf-groups %{name}-%{version}/conf-groups > /dev/null 2>&1
  if [ $? -ne 0 ] ; then
    %{__mv} /tmp/conf-groups %{name}-%{version}/conf-groups
  else
    %{__rm} -f /tmp/conf-groups
  fi
  %{name}-%{version}/catChangeLog %{name}-%{version}/doc/ChangeLog > ChangeLog-indimail-mta
  if [ -f %{name}-%{version}/qupgrade.sh ] ; then
    %{__cp} %{name}-%{version}/qupgrade.sh .
  fi
  if [ -f %{name}-%{version}/qlocal_upgrade.sh ] ; then
    %{__cp} %{name}-%{version}/qlocal_upgrade.sh .
  fi
  if [ -n "%{debug_package}" ] ; then
    echo %{__cc} -DINET6 -fPIC %{optflags} > %{name}-%{version}/conf-cc
    echo %{__cc} -rdynamic > %{name}-%{version}/conf-ld
  fi
fi
#### ucspi-tcp ######################
if [ -d ucspi-tcp-%{ucspitcp_version} ] ; then
  %{__sed} 's{HOME{%{_prefix}{' ucspi-tcp-%{ucspitcp_version}/conf-home.in > ucspi-tcp-%{ucspitcp_version}/conf-home
  %{__sed} 's{SHAREDDIR{%{shareddir}{' ucspi-tcp-%{ucspitcp_version}/conf-shared.in > ucspi-tcp-%{ucspitcp_version}/conf-shared
  %if %{tcpserver_plugin} == 1
    echo "-DLOAD_SHARED_OBJECTS" > ucspi-tcp-%{ucspitcp_version}/conf-dlopen
  %else
    %{__rm} -f ucspi-tcp-%{ucspitcp_version}/conf-dlopen
  %endif
  if [ -n "%{debug_package}" ] ; then
    echo %{__cc} -fPIC %{optflags} > ucspi-tcp-%{ucspitcp_version}/conf-cc
    echo %{__cc} -O2 > ucspi-tcp-%{ucspitcp_version}/conf-ld
  fi
fi

%install
ID=$(id -u)
%{__mkdir_p} %{buildroot}%{_prefix}
# This is needed for to figure out versions e.g.
# the following 3 lines in indimail-mta/Makefile
# libdkim_version=$(shell cat ../libdkim-x/conf-version)
# libsrs2_version=$(shell cat ../libsrs2-x/conf-version)
# ucspitcp_version=$(shell cat ../ucspi-tcp-x/conf-version)
if [ -d libdkim-%{libdkim_version} ] ; then
  ln -s libdkim-%{libdkim_version} libdkim-x
fi
if [ -d libsrs2-%{libsrs2_version} ] ; then
  ln -s libsrs2-%{libsrs2_version} libsrs2-x
fi
if [ -d ucspi-tcp-%{ucspitcp_version} ] ; then
  ln -s ucspi-tcp-%{ucspitcp_version} ucspi-tcp-x
fi
for i in libdkim-%{libdkim_version} libsrs2-%{libsrs2_version} \
%{name}-%{version} ucspi-tcp-%{ucspitcp_version}
do
  if [ " $i" = " libdkim-%{libdkim_version}" -a %nolibdkim -ne 0 ] ; then
    continue
  fi
  if [ " $i" = " libsrs2-%{libsrs2_version}" -a %nolibsrs2 -ne 0 ] ; then
    continue
  fi
  if [ -d $i ] ; then
    cd $i
    if [ %{_verbose} -eq 0 ] ; then
      %{__make} -s DESTDIR=%{buildroot}
      %{__make} -s DESTDIR=%{buildroot} install-strip
    else
      %{__make} DESTDIR=%{buildroot}
      %{__make} DESTDIR=%{buildroot} install-strip
    fi
    cd ..
  else
    echo "$i: No such file or directory" 1>&2
    exit 1
  fi
done

%{__mkdir_p} %{buildroot}%{shareddir}/doc
%{__mkdir_p} %{buildroot}%{libexecdir}
%{__mkdir_p} %{buildroot}%{qsysconfdir}
#copy files not copied by setup
install -m 0644 %{name}-release  %{buildroot}%{qsysconfdir}/%{name}-release
install -m 0644 %{name}-rpm.info %{buildroot}%{qsysconfdir}/%{name}-rpm.info
install -m 0644 ChangeLog-indimail-mta %{buildroot}%{shareddir}/doc/ChangeLog-indimail-mta
if [ -f qupgrade.sh ] ; then
install -m 0755 qupgrade.sh %{buildroot}%{libexecdir}/qupgrade.sh
fi
if [ -f qlocal_upgrade.sh ] ; then
install -m 0755 qlocal_upgrade.sh %{buildroot}%{libexecdir}/qlocal_upgrade.sh
fi
if [ -f %{name}-%{version}/indimail-mta.fc ] ; then
install -m 0644 %{name}-%{version}/indimail-mta.fc %{buildroot}%{qsysconfdir}/indimail-mta.fc
fi
if [ -f %{name}-%{version}/indimail-mta.te ] ; then
install -m 0644 %{name}-%{version}/indimail-mta.te %{buildroot}%{qsysconfdir}/indimail-mta.te
fi
/bin/rm -f ChangeLog qlocal_upgrade.sh qupgrade.sh %{name}-release %{name}-rpm.info

if [ %nolibdkim -eq 0 ] ; then
  %{__rm} -f %{buildroot}%{_libdir}/libdkim.la
  if [ -x /usr/bin/chrpath ] ; then
    /usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/dkim
  fi
fi
if [ %nolibsrs2 -eq 0 ] ; then
  %{__rm} -f %{buildroot}%{_libdir}/libsrs2.la
  if [ -x /usr/bin/chrpath ] ; then
    /usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/srsfilter
    /usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/srs
  fi
fi

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%{__mkdir_p} %{buildroot}%{_sysconfdir}/permissions.d/
install -m 644 %{S:6} %{buildroot}%{_sysconfdir}/permissions.d/%{name}-permissions
install -m 644 %{S:7} %{buildroot}%{_sysconfdir}/permissions.d/%{name}-permissions.secure
%endif
%endif

if [ -x /usr/bin/chrpath ] ; then
  for i in tcpserver ismaildup
  do
    if [ -f %{buildroot}%{_prefix}/bin/$i ] ; then
      /usr/bin/chrpath -d %{buildroot}%{_prefix}/bin/$i
    fi
  done
fi
# remove devel files as we are not building a devel package
%{__rm} -rf %{buildroot}%{mandir}/man3
%{__rm} -rf %{buildroot}%{_prefix}/include

if [ %nolibdkim -eq 0 ] ; then
if [ -x /usr/bin/chrpath ] ; then
  /usr/bin/chrpath -d %{buildroot}%{_libdir}/libdkim*.so
fi
%{__rm} -f  %{buildroot}%{_libdir}/libdkim.a
%{__rm} -f  %{buildroot}%{_libdir}/libdkim.so
fi
if [ %nolibsrs2 -eq 0 ] ; then
if [ -x /usr/bin/chrpath ] ; then
  /usr/bin/chrpath -d %{buildroot}%{_libdir}/libsrs2*.so
fi
%{__rm} -f  %{buildroot}%{_libdir}/libsrs2.a
%{__rm} -f  %{buildroot}%{_libdir}/libsrs2.so
fi

# Compress the man pages
find %{buildroot}%{mandir} -type f -exec gzip -q {} \;

if [ -x /bin/touch ] ; then
  TOUCH=/bin/touch
elif [ -x /usr/bin/touch ] ; then
  TOUCH=/usr/bin/touch
else
  TOUCH=/bin/touch
fi
# Create these files so that %%ghost does not complain
for i in tcp.smtp tcp.smtp.cdb tcp.qmtp tcp.qmtp.cdb tcp.qmqp \
tcp.qmqp.cdb
do
  if [ ! -f %{buildroot}%{qsysconfdir}/tcp/$i ] ; then
    $TOUCH %{buildroot}%{qsysconfdir}/tcp/$i
  fi
done
$TOUCH %{buildroot}%{qsysconfdir}/indimail-mta.pp
$TOUCH %{buildroot}%{qsysconfdir}/indimail-mta.mod
(
for i in `cat %{name}-%{version}/controlfiles.q`
do
  case "$i" in
  signatures)
  echo "%ghost %attr(0644,qscand,qscand) %config(noreplace,missingok) %{qsysconfdir}/control/$i"
  ;;
  spamignore)
  echo "%ghost %attr(0664,root,qmail) %config(noreplace,missingok) %{qsysconfdir}/control/$i"
  ;;
  *)
  echo "%ghost %config(noreplace,missingok) %{qsysconfdir}/control/$i"
  ;;
  esac
  echo $i 1>&3
  $TOUCH %{buildroot}%{qsysconfdir}/control/$i
done

for i in rsa2048.pem rsa1024.pem servercert.cnf servercert.pem dh1024.pem \
dh2048.pem dh512.pem rsa512.pem servercert.rand
do
  echo "%ghost %attr(0640,indimail,qmail) %config(noreplace,missingok) %{qsysconfdir}/certs/$i"
  echo ../certs/$i 1>&3
  $TOUCH %{buildroot}%{qsysconfdir}/certs/$i
done
echo "%ghost %attr(0644,root,root) %{qsysconfdir}/resolv.conf"
echo ../resolv.conf 1>&3
) > config_files.list 3>%{buildroot}%{qsysconfdir}/controlfiles.q

%if %{undefined suse_version} && %{undefined sles_version}
%{__mkdir_p} %{buildroot}%{logdir}
for i in deliver.25 greylist.1999 \
  qmqpd.628 qmtpd.209 qscanq smtpd.25 resolvconf \
  smtpd.366 smtpd.465 smtpd.587 qmail-daned.1998 \
  svscan udplogger.3000
do
  %{__mkdir_p} %{buildroot}%{logdir}/$i
  $TOUCH %{buildroot}%{logdir}/$i/current
done
%endif

%files -f config_files.list
%defattr(-, root, root,-)
#
# Directories
#
%dir %attr(555,root,qmail)                         %{qmaildir}
                                                   %{qmaildir}/bin
                                                   %{qmaildir}/sbin
                                                   %{qmaildir}/users
                                                   %{qmaildir}/control
                                                   %{qmaildir}/libexec
# opensuse requres ghost files to be present
%if %{undefined suse_version} && %{undefined sles_version}
%ghost %dir %attr(0755,qmaill,nofiles)             %{logdir}
%ghost %dir %attr(0755,qmaill,nofiles)             %{logdir}/*
%ghost      %attr(-,qmaill,nofiles)                %{logdir}/*/*
%endif
%dir %attr(555,root,root)                          %{libexecdir}
%dir %attr(555,root,root)                          %{libexecdir}/qfilters
%dir %attr(555,root,root)                          %{shareddir}
%dir %attr(555,root,root)                          %{shareddir}/boot
%dir %attr(555,root,root)                          %{shareddir}/doc
%dir %attr(755,root,qmail)                         %{qmaildir}/queue
%dir %attr(2775,alias,qmail)                       %{qmaildir}/alias
%dir %attr(750,qscand,qscand)                      %{qmaildir}/qscanq
%dir %attr(750,qscand,qscand)                      %{qmaildir}/qscanq/root
%dir %attr(750,qscand,qscand)                      %{qmaildir}/qscanq/root/scanq
%dir %attr(2755,root,qmail)                        %{qsysconfdir}
%dir %attr(2775,indimail,qmail)                    %{qsysconfdir}/users
%dir %attr(2775,indimail,qmail)                    %{qsysconfdir}/certs
%dir %attr(2775,indimail,qmail)                    %{qsysconfdir}/control
%dir %attr(2775,indimail,qmail)                    %{qsysconfdir}/tcp
%dir %attr(2775,indimail,qmail)                    %{qsysconfdir}/control/cache
%dir %attr(2775,qmailr,qmail)                      %{qsysconfdir}/control/ratelimit
%dir %attr(2755,indimail,qmail)                    %{qsysconfdir}/control/domainkeys
%dir %attr(755,indimail,qmail)                     %{qsysconfdir}/control/defaultqueue
%dir %attr(2775,indimail,qmail)                    %{qmaildir}/autoturn
%if "%{mandir}" != "/usr/share/man"
%dir %attr(755,root,root)                          %{mandir}
%dir %attr(755,root,root)                          %{mandir}/man1
%dir %attr(755,root,root)                          %{mandir}/man5
%dir %attr(755,root,root)                          %{mandir}/man7
%dir %attr(755,root,root)                          %{mandir}/man8
%endif
%if "%{_prefix}" != "/usr"
%dir %attr(555,root,root)                          %{_libdir}
%endif
%dir %attr(755,root,root)                          %{_prefix}/lib/indimail
%dir %attr(755,root,root)                          %{plugindir}

%attr(444,root,root) %config(noreplace)            %{qsysconfdir}/controlfiles.q
%attr(444,root,root) %config(noreplace)            %{qsysconfdir}/perm_list.mta

%ghost %config(noreplace,missingok)                %{qsysconfdir}/tcp/tcp.smtp
%ghost %config(noreplace,missingok)                %{qsysconfdir}/tcp/tcp.qmtp
%ghost %config(noreplace,missingok)                %{qsysconfdir}/tcp/tcp.qmqp
#
# These files will get removed during uninstallation
#
%ghost %attr(0644,indimail,indimail)               %{qsysconfdir}/tcp/tcp.smtp.cdb
%ghost %attr(0644,indimail,indimail)               %{qsysconfdir}/tcp/tcp.qmtp.cdb
%ghost %attr(0644,indimail,indimail)               %{qsysconfdir}/tcp/tcp.qmqp.cdb
%ghost %attr(0644,root,root)                       %{qsysconfdir}/indimail-mta.pp
%ghost %attr(0644,root,root)                       %{qsysconfdir}/indimail-mta.mod

%attr(644,root,root)  %config(noreplace)           %{qsysconfdir}/indimail-mta.te
%attr(644,root,root)  %config(noreplace)           %{qsysconfdir}/indimail-mta.fc
%attr(444,root,root)  %config(noreplace)           %{qsysconfdir}/cronlist.q
%attr(644,root,qmail) %config(noreplace)           %{qsysconfdir}/leapsecs.dat
%attr(644,root,qmail) %config(noreplace)           %{qsysconfdir}/leapsecs.txt
%attr(444,root,root)  %config(noreplace)           %{qsysconfdir}/%{name}-release
%attr(444,root,root)  %config(noreplace)           %{qsysconfdir}/%{name}-rpm.info
%attr(644,root,qmail) %config(noreplace,missingok) %{qsysconfdir}/control/nodnscheck
%attr(644,root,qmail) %config(noreplace,missingok) %{qsysconfdir}/control/level2-tlds
%attr(644,root,qmail) %config(noreplace,missingok) %{qsysconfdir}/control/level3-tlds
%attr(644,root,qmail) %config(noreplace,missingok) %{qsysconfdir}/foxhole_all.cdb

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%attr(644,root,root)                               %{_sysconfdir}/permissions.d/%{name}-permissions
%attr(644,root,root)                               %{_sysconfdir}/permissions.d/%{name}-permissions.secure
%endif
%endif

#
# Binaries
#
%attr(755,root,root)                    %{_prefix}/bin/queue-fix
%attr(755,root,root)                    %{_prefix}/bin/bouncesaying
%attr(755,root,root)                    %{_prefix}/bin/checkaddr
%attr(755,root,root)                    %{_prefix}/bin/autoresponder
%attr(755,root,root)                    %{_prefix}/bin/822headerfilter
%attr(755,root,root)                    %{_prefix}/bin/checkdomain
%attr(755,root,root)                    %{_prefix}/bin/qmailctl
%attr(755,root,root)                    %{_prefix}/bin/printmaillist
%attr(755,root,root)                    %{_prefix}/bin/newinclude
%attr(755,root,root)                    %{_prefix}/bin/recordio
%attr(755,root,root)                    %{_prefix}/bin/uacl
%attr(755,root,root)                    %{_prefix}/bin/822print
%attr(755,root,root)                    %{_prefix}/bin/sendmail
%attr(755,root,root)                    %{_prefix}/bin/irmail
%attr(755,root,root)                    %{_prefix}/bin/ifaddr
%attr(755,root,root)                    %{_prefix}/bin/setforward
%attr(755,root,root)                    %{_prefix}/bin/822date
%attr(755,root,root)                    %{_prefix}/bin/iftocc
%attr(755,root,root)                    %{_prefix}/bin/serialqmtp
%attr(755,root,root)                    %{_prefix}/bin/delcr
%attr(755,root,root)                    %{_prefix}/bin/setmaillist
%attr(755,root,root)                    %{_prefix}/bin/qmail-showctl
%attr(755,root,root)                    %{_prefix}/bin/822headerok
%attr(755,root,root)                    %{_prefix}/bin/printforward
%attr(755,root,root)                    %{_prefix}/bin/preline
%attr(755,root,root)                    %{_prefix}/bin/822addr
%attr(755,root,root)                    %{_prefix}/bin/822fields
%attr(755,root,root)                    %{_prefix}/bin/ofmipname
%attr(755,root,root)                    %{_prefix}/bin/822bodyfilter
%attr(755,root,root)                    %{_prefix}/bin/serialsmtp
%attr(755,root,root)                    %{_prefix}/bin/predate
%attr(755,root,root)                    %{_prefix}/bin/condredirect
%attr(755,root,root)                    %{_prefix}/bin/fastforward
%attr(755,root,root)                    %{_prefix}/bin/inewaliases
%attr(755,root,root)                    %{_prefix}/bin/qmail-rm
%attr(755,root,root)                    %{_prefix}/bin/dot-forward
%attr(755,root,root)                    %{_prefix}/bin/datemail
%attr(755,root,root)                    %{_prefix}/bin/qbase64
%attr(755,root,root)                    %{_prefix}/bin/swaks
%attr(755,root,root)                    %{_prefix}/bin/replier
%attr(755,root,root)                    %{_prefix}/bin/822header
%attr(755,root,root)                    %{_prefix}/bin/maildirwatch
%attr(755,root,root)                    %{_prefix}/bin/maildirqmtp
%attr(755,root,root)                    %{_prefix}/bin/maildirdeliver
%attr(755,root,root)                    %{_prefix}/bin/mbox2maildir
%attr(755,root,root)                    %{_prefix}/bin/qmaildirmake
%attr(755,root,root)                    %{_prefix}/bin/maildir2mbox
%attr(755,root,root)                    %{_prefix}/bin/condtomaildir
%attr(755,root,root)                    %{_prefix}/bin/maildirsmtp
%attr(755,root,root)                    %{_prefix}/bin/maildirserial
%attr(755,root,root)                    %{_prefix}/bin/maildircmd
%attr(755,root,root)                    %{_prefix}/bin/maildirsize
%attr(755,root,root)                    %{_prefix}/bin/qarf
%attr(755,root,root)                    %{_prefix}/bin/qaes
%attr(755,root,root)                    %{_prefix}/bin/qnotify
%attr(755,root,root)                    %{_prefix}/bin/rrt
%attr(755,root,root)                    %{_prefix}/bin/drate
%attr(755,root,root)                    %{_prefix}/bin/cidr
%attr(755,root,root)                    %{_prefix}/bin/tcp-env
%attr(755,root,root)                    %{_prefix}/bin/rrforward
%attr(755,root,root)                    %{_prefix}/bin/dk-filter
%attr(755,root,root)                    %{_prefix}/bin/mailsubj
%attr(755,root,root)                    %{_prefix}/bin/822field
%attr(755,root,root)                    %{_prefix}/bin/qmail-cat
%attr(755,root,root)                    %{_prefix}/bin/replier-config
%attr(755,root,root)                    %{_prefix}/bin/forward
%attr(755,root,root)                    %{_prefix}/bin/new-inject
%attr(755,root,root)                    %{_prefix}/bin/filterto
%attr(755,root,root)                    %{_prefix}/bin/fixcrio
%attr(755,root,root)                    %{_prefix}/bin/822body
%attr(755,root,root)                    %{_prefix}/bin/dktest
%attr(755,root,root)                    %{_prefix}/bin/iftoccfrom
%attr(755,root,root)                    %{_prefix}/bin/qreceipt
%attr(755,root,root)                    %{_prefix}/bin/except
%attr(755,root,root)                    %{_prefix}/bin/dknewkey
%attr(755,root,root)                    %{_prefix}/bin/argv0
%attr(755,root,root)                    %{_prefix}/bin/addcr
%attr(755,root,root)                    %{_prefix}/bin/qmail-inject
%attr(755,root,root)                    %{_prefix}/bin/serialcmd
%attr(755,root,root)                    %{_prefix}/bin/qmail-qread
%attr(755,root,root)                    %{_prefix}/bin/822received
%attr(755,root,root)                    %{_prefix}/bin/qmail-qfilter
%attr(755,root,root)                    %{_prefix}/bin/spfquery
%if %nolibsrs2 == 0
%attr(755,root,root)                    %{_prefix}/bin/srsfilter
%endif
%attr(755,root,root)                    %{_prefix}/bin/inotify

%attr(755,root,root)                    %{_prefix}/sbin/qmail-popbull
%attr(755,root,root)                    %{_prefix}/sbin/qmail-poppass
%attr(751,root,root)                    %{_prefix}/sbin/ofmipd
%attr(755,root,root)                    %{_prefix}/sbin/qmail-dkim
%attr(755,root,root)                    %{_prefix}/sbin/qmail-dk
%attr(755,root,root)                    %{_prefix}/sbin/spawn-filter
%attr(755,root,root)                    %{_prefix}/sbin/qmail-getpw
%attr(755,root,root)                    %{_prefix}/sbin/qmail-local
%attr(755,root,root)                    %{_prefix}/sbin/qmail-remote
%attr(755,root,root)                    %{_prefix}/sbin/qmail-pw2u
%attr(755,root,root)                    %{_prefix}/sbin/recipient-cdb
%attr(755,root,root)                    %{_prefix}/sbin/cdbtest
%attr(755,root,root)                    %{_prefix}/sbin/cdbstats
%attr(755,root,root)                    %{_prefix}/sbin/cdbdump
%attr(755,root,root)                    %{_prefix}/sbin/cdbget
%attr(755,root,root)                    %{_prefix}/sbin/cdbgetm
%attr(755,root,root)                    %{_prefix}/sbin/cdbmake
%attr(755,root,root)                    %{_prefix}/sbin/qmail-newmrh
%attr(6551,qscand,qmail)                %{_prefix}/sbin/qhpsi
%attr(6551,qmailq,qmail)                %{_prefix}/sbin/qmail-queue
%attr(4551,qscand,qscand)               %{_prefix}/sbin/qscanq
%attr(2551,root,qscand)                 %{_prefix}/sbin/run-cleanq
%attr(755,root,root)                    %{_prefix}/sbin/qscanq-stdin

%attr(755,root,root)                    %{_prefix}/sbin/plugtest
%attr(4551,root,root)                   %{_prefix}/sbin/sys-checkpwd
%attr(755,root,root)                    %{_prefix}/sbin/ldap-checkpwd
%attr(755,root,root)                    %{_prefix}/sbin/svctool
%attr(755,root,root)                    %{_prefix}/sbin/qmail-nullqueue
%attr(755,root,root)                    %{_prefix}/sbin/qmail-multi
%attr(755,root,root)                    %{_prefix}/sbin/cleanq
%attr(755,root,root)                    %{_prefix}/sbin/qmail-tcpok
%attr(755,root,root)                    %{_prefix}/sbin/qmail-tcpto
%attr(755,root,root)                    %{_prefix}/sbin/qmail-qmqpc
%attr(755,root,root)                    %{_prefix}/sbin/qmail-newu
%attr(755,root,root)                    %{_prefix}/sbin/cdb-database
%attr(755,root,root)                    %{_prefix}/sbin/sql-database
%attr(755,root,root)                    %{_prefix}/sbin/ctrlenv
%attr(755,root,root)                    %{_prefix}/sbin/qmail-cdb
%attr(755,root,root)                    %{_prefix}/sbin/qmail-sql

%attr(751,root,root)                    %{_prefix}/sbin/qmail-smtpd
%attr(751,root,root)                    %{_prefix}/sbin/qmail-qmqpd
%attr(751,root,root)                    %{_prefix}/sbin/qmail-qmtpd
%attr(751,root,root)                    %{_prefix}/sbin/qmail-daemon
%attr(751,root,root)                    %{_prefix}/sbin/qmail-start
%attr(751,root,root)                    %{_prefix}/sbin/qmail-lspawn
%attr(751,root,root)                    %{_prefix}/sbin/qmail-rspawn
%attr(751,root,root)                    %{_prefix}/sbin/qmail-clean
%attr(751,root,root)                    %{_prefix}/sbin/qmail-send
%attr(751,root,root)                    %{_prefix}/sbin/qmail-todo
%attr(755,root,root)                    %{_prefix}/sbin/surblfilter
%attr(755,root,root)                    %{_prefix}/sbin/surblqueue

%attr(755,root,root)                    %{_prefix}/sbin/relaytest
%attr(755,root,root)                    %{_prefix}/sbin/splogger

%attr(755,root,root)                    %{libexecdir}/columnt
%attr(755,root,root)                    %{libexecdir}/rpmattr
%attr(755,root,root)                    %{libexecdir}/leapsecs
%attr(755,root,root)                    %{libexecdir}/yearcal
%attr(755,root,root)                    %{libexecdir}/nowutc
%attr(755,root,root)                    %{libexecdir}/qmail-lagcheck
%attr(755,root,root)                    %{libexecdir}/batv
%attr(755,root,root)                    %{libexecdir}/zsuccesses
%attr(755,root,root)                    %{libexecdir}/deferrals
%attr(755,root,root)                    %{libexecdir}/rsmtprecipients
%attr(755,root,root)                    %{libexecdir}/zrecipients
%attr(755,root,root)                    %{libexecdir}/xsender
%attr(755,root,root)                    %{libexecdir}/rxdelay
%attr(755,root,root)                    %{libexecdir}/zspam
%attr(755,root,root)                    %{libexecdir}/recipients
%attr(755,root,root)                    %{libexecdir}/rsmtprdomains
%attr(755,root,root)                    %{libexecdir}/rsmtpfailures
%attr(755,root,root)                    %{libexecdir}/successes
%attr(755,root,root)                    %{libexecdir}/rspamrdomain
%attr(755,root,root)                    %{libexecdir}/matchup
%attr(755,root,root)                    %{libexecdir}/mlmatchup
%attr(755,root,root)                    %{libexecdir}/multilog-matchup
%attr(755,root,root)                    %{libexecdir}/smtp-matchup
%attr(755,root,root)                    %{libexecdir}/xqp
%attr(755,root,root)                    %{libexecdir}/zddist
%attr(755,root,root)                    %{libexecdir}/zsenders
%attr(755,root,root)                    %{libexecdir}/senders
%attr(755,root,root)                    %{libexecdir}/suids
%attr(755,root,root)                    %{libexecdir}/zsmtp
%attr(755,root,root)                    %{libexecdir}/zoverall
%attr(755,root,root)                    %{libexecdir}/rhosts
%attr(755,root,root)                    %{libexecdir}/zrhosts
%attr(755,root,root)                    %{libexecdir}/failures
%attr(755,root,root)                    %{libexecdir}/rsmtp
%attr(755,root,root)                    %{libexecdir}/rsmtpsenders
%attr(755,root,root)                    %{libexecdir}/zdeferrals
%attr(755,root,root)                    %{libexecdir}/rspamstat
%attr(755,root,root)                    %{libexecdir}/zsuids
%attr(755,root,root)                    %{libexecdir}/xrecipient
%attr(755,root,root)                    %{libexecdir}/rspamhist
%attr(755,root,root)                    %{libexecdir}/rsmtpsdomains
%attr(755,root,root)                    %{libexecdir}/zfailures
%attr(755,root,root)                    %{libexecdir}/zsendmail
%attr(755,root,root)                    %{libexecdir}/ddist
%attr(755,root,root)                    %{libexecdir}/rspamsdomain
%attr(755,root,root)                    %{libexecdir}/zrxdelay
%attr(755,root,root)                    %{libexecdir}/qupgrade.sh
%verify (not md5 size mtime mode)       %{libexecdir}/qlocal_upgrade.sh

%attr(755,root,root)                    %{libexecdir}/svscanboot
%attr(755,root,root)                    %{libexecdir}/atrn
%attr(755,root,root)                    %{libexecdir}/etrn
%attr(755,root,root)                    %{libexecdir}/cdbmake-12
%attr(755,root,root)                    %{libexecdir}/cdbmake-sv
%attr(755,root,root)                    %{libexecdir}/config-fast
%attr(755,root,root)                    %{libexecdir}/idedit
%attr(755,root,root)                    %{libexecdir}/hostname
%attr(755,root,root)                    %{libexecdir}/qmailconfig
%attr(755,root,root)                    %{libexecdir}/dnstxt
%attr(755,root,root)                    %{libexecdir}/dnsmxip
%attr(755,root,root)                    %{libexecdir}/dnsfq
%attr(755,root,root)                    %{libexecdir}/dnsptr
%attr(755,root,root)                    %{libexecdir}/dnsip
%attr(755,root,root)                    %{libexecdir}/dnscname
%if %notlsarr == 0
%attr(755,root,root)                    %{libexecdir}/dnstlsarr
%endif
%attr(755,root,root)                    %{libexecdir}/envmigrate
%attr(755,root,root)                    %{libexecdir}/qsmhook
%attr(755,root,root)                    %{libexecdir}/update_tmprsadh
%attr(755,root,root)                    %{libexecdir}/instcheck
%attr(755,root,root)                    %{libexecdir}/whois
%attr(755,root,root)                    %{libexecdir}/testzero
%attr(755,root,root)                    %{libexecdir}/qmail-lint
%attr(755,root,root)                    %{libexecdir}/ipmeprint
%attr(755,root,root)                    %{libexecdir}/elq
%attr(755,root,root)                    %{libexecdir}/pinq
%attr(755,root,root)                    %{libexecdir}/qail
%attr(755,root,root)                    %{libexecdir}/qpq
%attr(755,root,root)                    %{libexecdir}/qfrontend
%attr(755,root,root)                    %{libexecdir}/qfilters/qf-smtp-ratelimit

%docdir %{mandir}
%attr(0644,root,root)                   %{mandir}/man[1,4,5,7,8]/*

# daemontools
%attr(0755,root,root)                   %{_prefix}/bin/envdir
%attr(0755,root,root)                   %{_prefix}/bin/envuidgid
%attr(0755,root,root)                   %{_prefix}/bin/fghack
%attr(0755,root,root)                   %{_prefix}/bin/pgrphack
%attr(0755,root,root)                   %{_prefix}/bin/setlock
%attr(0755,root,root)                   %{_prefix}/bin/setuidgid
%attr(0755,root,root)                   %{_prefix}/bin/softlimit
%attr(0755,root,root)                   %{_prefix}/bin/supervise
%attr(0755,root,root)                   %{_prefix}/bin/svc
%attr(0755,root,root)                   %{_prefix}/bin/svok
%attr(0755,root,root)                   %{_prefix}/bin/svstat
%attr(0755,root,root)                   %{_prefix}/bin/tai64n
%attr(0755,root,root)                   %{_prefix}/bin/tai64nlocal
%attr(0755,root,root)                   %{_prefix}/bin/tai64nunix
%attr(0755,root,root)                   %{_prefix}/bin/tai2tai64n
%attr(0755,root,root)                   %{_prefix}/bin/tai64n2tai
%attr(0755,root,root)                   %{_prefix}/bin/spipe
%attr(0755,root,root)                   %{_prefix}/bin/qfilelog
%attr(0755,root,root)                   %{_prefix}/bin/multipipe
%attr(0755,root,root)                   %{_prefix}/bin/teepipe
%attr(0755,root,root)                   %{_prefix}/bin/logselect
%attr(0755,root,root)                   %{_prefix}/bin/qlogselect
%attr(0751,root,root)                   %{_prefix}/sbin/svscan
%attr(0755,root,root)                   %{_prefix}/sbin/readproctitle
%attr(0755,root,root)                   %{_prefix}/sbin/multilog
%attr(0755,root,root)                   %{_prefix}/sbin/docker-entrypoint

# ucspi-tcp
%attr(0755,root,root)                   %{_prefix}/bin/mconnect-io
%attr(0755,root,root)                   %{_prefix}/bin/rblsmtpd
%attr(0755,root,root)                   %{_prefix}/bin/tcprulescheck
%attr(0755,root,root)                   %{_prefix}/bin/tcpcat
%attr(0755,root,root)                   %{_prefix}/bin/date@
%attr(0755,root,root)                   %{_prefix}/bin/who@
%attr(0755,root,root)                   %{_prefix}/bin/tcpclient
%attr(0755,root,root)                   %{_prefix}/bin/tcpserver
%attr(0755,root,root)                   %{_prefix}/bin/mconnect
%attr(0755,root,root)                   %{_prefix}/bin/finger@
%attr(0755,root,root)                   %{_prefix}/bin/http@
%attr(0755,root,root)                   %{_prefix}/bin/tcprules
%attr(0755,root,root)                   %{_prefix}/bin/udpclient
%attr(0755,root,root)                   %{_prefix}/sbin/udplogger
%attr(0751,root,root)                   %{_prefix}/sbin/greydaemon
%attr(0751,root,root)                   %{_prefix}/sbin/qmail-greyd
%if %notlsarr == 0
%attr(0755,root,root)                   %{_prefix}/bin/qdane
%attr(0751,root,root)                   %{_prefix}/sbin/qmail-daned
%endif

%if %nolibdkim == 0
%attr(0755,root,root)                   %{_prefix}/bin/dkim
%endif

%if %nolibsrs2 == 0
%attr(0755,root,root)                   %{_prefix}/bin/srs
%endif
%attr(0755,root,root)                   %{shareddir}/boot/binm2
%attr(0755,root,root)                   %{shareddir}/boot/proc+df
%attr(0755,root,root)                   %{shareddir}/boot/binm1+df
%attr(0755,root,root)                   %{shareddir}/boot/binm3+df
%attr(0755,root,root)                   %{shareddir}/boot/home+df
%attr(0755,root,root)                   %{shareddir}/boot/binm3
%attr(0755,root,root)                   %{shareddir}/boot/binm1
%attr(0755,root,root)                   %{shareddir}/boot/proc
%attr(0755,root,root)                   %{shareddir}/boot/home
%attr(0755,root,root)                   %{shareddir}/boot/binm2+df
%attr(0644,root,root)                   %{shareddir}/boot/upstart
%attr(0644,root,root)                   %{shareddir}/boot/systemd

%attr(0755,root,root)                   %{plugindir}/generic.so
%attr(0755,root,root)                   %{plugindir}/smtpd-plugin.so
%attr(0755,root,root)                   %{plugindir}/smtpd-plugin0.so
%if %tcpserver_plugin != 0
%attr(0755,root,root)                   %{plugindir}/qmail_smtpd.so
%attr(0755,root,root)                   %{plugindir}/rblsmtpd.so
%endif

%if %build_on_obs == 0
%license %attr(0644,root,root)          %{shareddir}/doc/COPYING-indimail-mta
%license %attr(0644,root,root)          %{shareddir}/doc/README.licenses
%license %attr(0644,root,root)          %{shareddir}/doc/LICENSE.libdkim
%license %attr(0644,root,root)          %{shareddir}/doc/LICENSE.qhpsi
%license %attr(0644,root,root)          %{shareddir}/doc/LICENSE.GPL-2.libsrs2
%else
%attr(0644,root,root)                   %{shareddir}/doc/COPYING-indimail-mta
%attr(0644,root,root)                   %{shareddir}/doc/README.licenses
%attr(0644,root,root)                   %{shareddir}/doc/LICENSE.libdkim
%attr(0644,root,root)                   %{shareddir}/doc/LICENSE.qhpsi
%attr(0644,root,root)                   %{shareddir}/doc/LICENSE.GPL-2.libsrs2
%endif
%attr(0644,root,root)                   %{shareddir}/doc/softwarelicense1-1.html
%attr(0644,root,root)                   %{shareddir}/doc/INSTALL.alias
%attr(0644,root,root)                   %{shareddir}/doc/INSTALL.control
%attr(0644,root,root)                   %{shareddir}/doc/INSTALL.maildir
%attr(0644,root,root)                   %{shareddir}/doc/INSTALL.mbox
%attr(0644,root,root)                   %{shareddir}/doc/INSTALL-MINI
%attr(0644,root,root)                   %{shareddir}/doc/INSTALL.vsm
%attr(0644,root,root)                   %{shareddir}/doc/README.clamav
%attr(0644,root,root)                   %{shareddir}/doc/README.EXTTODO
%attr(0644,root,root)                   %{shareddir}/doc/README.filters
%attr(0644,root,root)                   %{shareddir}/doc/README.greylist
%attr(0644,root,root)                   %{shareddir}/doc/README.indimail-mta
%attr(0644,root,root)                   %{shareddir}/doc/README.qhpsi
%attr(0644,root,root)                   %{shareddir}/doc/README.qregex
%attr(0644,root,root)                   %{shareddir}/doc/README.queue-fix
%attr(0644,root,root)                   %{shareddir}/doc/README.status
%attr(0644,root,root)                   %{shareddir}/doc/README.recipients
%attr(0644,root,root)                   %{shareddir}/doc/README.libdkim
%attr(0644,root,root)                   %{shareddir}/doc/README.logselect
%attr(0644,root,root)                   %{shareddir}/doc/README.srs
%attr(0644,root,root)                   %{shareddir}/doc/README.surbl
%attr(0644,root,root)                   %{shareddir}/doc/README.ucspi-tcp
%attr(0644,root,root)                   %{shareddir}/doc/AUTHORS.libdkim
%attr(0644,root,root)                   %{shareddir}/doc/AUTHORS.libsrs2
%attr(0644,root,root)                   %{shareddir}/doc/CREDITS
%attr(0644,root,root)                   %{shareddir}/doc/ChangeLog-indimail-mta
%attr(0644,root,root)                   %{shareddir}/doc/INTERNALS
%attr(0644,root,root)                   %{shareddir}/doc/FROMISP
%attr(0644,root,root)                   %{shareddir}/doc/TOISP
%attr(0644,root,root)                   %{shareddir}/doc/AUTOTURN
%attr(0644,root,root)                   %{shareddir}/doc/PIC.local2alias
%attr(0644,root,root)                   %{shareddir}/doc/PIC.local2local
%attr(0644,root,root)                   %{shareddir}/doc/PIC.nullclient
%attr(0644,root,root)                   %{shareddir}/doc/PIC.rem2local
%attr(0644,root,root)                   %{shareddir}/doc/PIC.relaybad
%attr(0644,root,root)                   %{shareddir}/doc/PIC.local2ext
%attr(0644,root,root)                   %{shareddir}/doc/PIC.local2virt
%attr(0644,root,root)                   %{shareddir}/doc/PIC.relaygood
%attr(0644,root,root)                   %{shareddir}/doc/PIC.local2rem

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%verify (not user group mode) %attr(6551, qscand, qmail)   %{_prefix}/sbin/qhpsi
%verify (not user group mode) %attr(2551, root, qscand)    %{_prefix}/sbin/run-cleanq
%verify (not user group mode) %attr(6551, qmailq, qmail)   %{_prefix}/sbin/qmail-queue
%verify (not user group mode) %attr(4555, qscand, qscand)  %{_prefix}/sbin/qscanq
%verify (not user group mode) %attr(2775, alias, qmail)    %{qmaildir}/alias
%verify (not user group mode) %attr(2775, indimail, qmail) %{qmaildir}/autoturn
%verify (not user group mode) %attr(4551, root, root)      %{_prefix}/sbin/sys-checkpwd
%endif
%endif

# Shared libraries (omit for architectures that don't support them)
%if %nolibdkim == 0
%{_libdir}/libdkim-%{libdkim_version}.so.0
%{_libdir}/libdkim-%{libdkim_version}.so.0.0.0
%endif

%if %nolibsrs2 == 0
%{_libdir}/libsrs2.so.1
%{_libdir}/libsrs2.so.1.0.0
%endif

%files -n daemontools
%defattr(-, root, root,-)
#
# Directories
#
%if %{undefined suse_version} && %{undefined sles_version}
%ghost %dir %attr(0755,qmaill,nofiles)  %{logdir}
%ghost %dir %attr(0755,qmaill,nofiles)  %{logdir}/*
%ghost      %attr(-,qmaill,nofiles)     %{logdir}/*/*
%endif

%dir %attr(0555,root,root)              %{libexecdir}
%dir %attr(0555,root,root)              %{shareddir}
%dir %attr(0555,root,root)              %{shareddir}/boot
%dir %attr(0555,root,root)              %{shareddir}/doc
%if "%{mandir}" != "/usr/share/man"
%dir %attr(0755,root,root)              %{mandir}
%dir %attr(0755,root,root)              %{mandir}/man1
%dir %attr(0755,root,root)              %{mandir}/man8
%endif

%attr(0755,root,root)                   %{_prefix}/bin/envdir
%attr(0755,root,root)                   %{_prefix}/bin/envuidgid
%attr(0755,root,root)                   %{_prefix}/bin/fghack
%attr(0755,root,root)                   %{_prefix}/bin/pgrphack
%attr(0755,root,root)                   %{_prefix}/bin/setlock
%attr(0755,root,root)                   %{_prefix}/bin/setuidgid
%attr(0755,root,root)                   %{_prefix}/bin/softlimit
%attr(0755,root,root)                   %{_prefix}/bin/supervise
%attr(0755,root,root)                   %{_prefix}/bin/svc
%attr(0755,root,root)                   %{_prefix}/bin/svok
%attr(0755,root,root)                   %{_prefix}/bin/svstat
%attr(0755,root,root)                   %{_prefix}/bin/tai64n
%attr(0755,root,root)                   %{_prefix}/bin/tai64nlocal
%attr(0755,root,root)                   %{_prefix}/bin/tai64nunix
%attr(0755,root,root)                   %{_prefix}/bin/tai2tai64n
%attr(0755,root,root)                   %{_prefix}/bin/tai64n2tai
%attr(0755,root,root)                   %{_prefix}/bin/spipe
%attr(0755,root,root)                   %{_prefix}/bin/qfilelog
%attr(0755,root,root)                   %{_prefix}/bin/multipipe
%attr(0755,root,root)                   %{_prefix}/bin/teepipe
%attr(0755,root,root)                   %{_prefix}/bin/logselect
%attr(0755,root,root)                   %{_prefix}/bin/qlogselect
%attr(0755,root,root)                   %{_prefix}/bin/qmailctl
%attr(0751,root,root)                   %{_prefix}/sbin/svscan
%attr(0755,root,root)                   %{_prefix}/sbin/readproctitle
%attr(0755,root,root)                   %{_prefix}/sbin/multilog
%attr(0755,root,root)                   %{_prefix}/sbin/svctool

%attr(0755,root,root)                   %{libexecdir}/svscanboot

%attr(0644,root,root)                   %{shareddir}/boot/upstart
%attr(0644,root,root)                   %{shareddir}/boot/systemd

%docdir %{mandir}
%docdir %{shareddir}/doc
%attr(0644,root,root)                   %{shareddir}/doc/README.logselect
%attr(0644,root,root)                   %{mandir}/man1/spipe.1.gz
%attr(0644,root,root)                   %{mandir}/man1/qfilelog.1.gz
%attr(0644,root,root)                   %{mandir}/man1/multipipe.1.gz
%attr(0644,root,root)                   %{mandir}/man1/teepipe.1.gz
%attr(0644,root,root)                   %{mandir}/man1/qlogselect.1.gz
%attr(0644,root,root)                   %{mandir}/man1/tai2tai64n.1.gz
%attr(0644,root,root)                   %{mandir}/man1/tai64n2tai.1.gz
%attr(0644,root,root)                   %{mandir}/man8/envdir.8.gz
%attr(0644,root,root)                   %{mandir}/man8/envuidgid.8.gz
%attr(0644,root,root)                   %{mandir}/man8/fghack.8.gz
%attr(0644,root,root)                   %{mandir}/man8/multilog.8.gz
%attr(0644,root,root)                   %{mandir}/man8/pgrphack.8.gz
%attr(0644,root,root)                   %{mandir}/man8/readproctitle.8.gz
%attr(0644,root,root)                   %{mandir}/man8/setlock.8.gz
%attr(0644,root,root)                   %{mandir}/man8/setuidgid.8.gz
%attr(0644,root,root)                   %{mandir}/man8/softlimit.8.gz
%attr(0644,root,root)                   %{mandir}/man8/supervise.8.gz
%attr(0644,root,root)                   %{mandir}/man8/svc.8.gz
%attr(0644,root,root)                   %{mandir}/man8/svok.8.gz
%attr(0644,root,root)                   %{mandir}/man8/svscan.8.gz
%attr(0644,root,root)                   %{mandir}/man8/svstat.8.gz
%attr(0644,root,root)                   %{mandir}/man8/tai64n.8.gz
%attr(0644,root,root)                   %{mandir}/man8/tai64nlocal.8.gz
%attr(0644,root,root)                   %{mandir}/man8/tai64nunix.8.gz
%attr(0644,root,root)                   %{mandir}/man8/logselect.8.gz
%attr(0644,root,root)                   %{mandir}/man8/svscanboot.8.gz
%attr(0644,root,root)                   %{mandir}/man8/svctool.8.gz
%attr(0644,root,root)                   %{mandir}/man8/qmailctl.8.gz

%files -n ucspi-tcp
%attr(0755,root,root)                   %{_prefix}/bin/tcpserver
%attr(0755,root,root)                   %{_prefix}/bin/tcprules
%attr(0755,root,root)                   %{_prefix}/bin/tcprulescheck
%attr(0755,root,root)                   %{_prefix}/bin/tcpclient
%attr(0755,root,root)                   %{_prefix}/bin/who@
%attr(0755,root,root)                   %{_prefix}/bin/date@
%attr(0755,root,root)                   %{_prefix}/bin/finger@
%attr(0755,root,root)                   %{_prefix}/bin/http@
%attr(0755,root,root)                   %{_prefix}/bin/tcpcat
%attr(0755,root,root)                   %{_prefix}/bin/mconnect
%attr(0755,root,root)                   %{_prefix}/bin/mconnect-io
%attr(0755,root,root)                   %{_prefix}/bin/rblsmtpd
%attr(0755,root,root)                   %{_prefix}/bin/udpclient
%attr(0755,root,root)                   %{_prefix}/sbin/udplogger
%attr(0751,root,root)                   %{_prefix}/sbin/greydaemon
%attr(0751,root,root)                   %{_prefix}/sbin/qmail-greyd
%if %notlsarr == 0
%attr(0755,root,root)                   %{_prefix}/bin/qdane
%attr(0751,root,root)                   %{_prefix}/sbin/qmail-daned
%endif

%if "%{mandir}" != "/usr/share/man"
%dir %attr(0755,root,root)              %{mandir}
%dir %attr(0755,root,root)              %{mandir}/man1
%dir %attr(0755,root,root)              %{mandir}/man8
%endif

%docdir %{mandir}
%attr(0644,root,root)                   %{mandir}/man1/tcpserver.1.gz
%attr(0644,root,root)                   %{mandir}/man1/tcprules.1.gz
%attr(0644,root,root)                   %{mandir}/man1/tcprulescheck.1.gz
%attr(0644,root,root)                   %{mandir}/man1/tcpclient.1.gz
%attr(0644,root,root)                   %{mandir}/man1/who@.1.gz
%attr(0644,root,root)                   %{mandir}/man1/date@.1.gz
%attr(0644,root,root)                   %{mandir}/man1/finger@.1.gz
%attr(0644,root,root)                   %{mandir}/man1/http@.1.gz
%attr(0644,root,root)                   %{mandir}/man1/tcpcat.1.gz
%attr(0644,root,root)                   %{mandir}/man1/mconnect.1.gz
%attr(0644,root,root)                   %{mandir}/man1/mconnect-io.1.gz
%attr(0644,root,root)                   %{mandir}/man1/rblsmtpd.1.gz
%attr(0644,root,root)                   %{mandir}/man1/udpclient.1.gz
%attr(0644,root,root)                   %{mandir}/man8/udplogger.8.gz
%attr(0644,root,root)                   %{mandir}/man8/greydaemon.8.gz
%attr(0644,root,root)                   %{mandir}/man8/qmail-greyd.8.gz
%if %notlsarr == 0
%attr(0644,root,root)                   %{mandir}/man1/qdane.1.gz
%attr(0644,root,root)                   %{mandir}/man8/qmail-daned.8.gz
%endif

%attr(644,root,root)                    %{shareddir}/doc/README.ucspi-tcp

%files -n indimail-mini
%defattr(-, root, root, 0755)
#
# Directories
#
%dir %attr(0555,root,qmail)        %{qmaildir}
                                   %{qmaildir}/bin
                                   %{qmaildir}/sbin
                                   %{qmaildir}/users
                                   %{qmaildir}/control
%dir %attr(0755,indimail,indimail) %{qsysconfdir}/control
%if "%{mandir}" != "/usr/share/man"
%dir %attr(0755,root,root)         %{mandir}
%dir %attr(0755,root,root)         %{mandir}/man1
%dir %attr(0755,root,root)         %{mandir}/man8
%endif
#
%attr(0755,root,root)              %{_prefix}/bin/sendmail
%attr(0755,root,root)              %{_prefix}/bin/qmail-inject
%attr(0755,root,root)              %{_prefix}/bin/irmail
%attr(0755,root,root)              %{_prefix}/bin/forward
%attr(0755,root,root)              %{_prefix}/bin/predate
%attr(0755,root,root)              %{_prefix}/bin/datemail
%attr(0755,root,root)              %{_prefix}/bin/mailsubj
%attr(0755,root,root)              %{_prefix}/bin/qmail-showctl
%attr(0755,root,root)              %{_prefix}/bin/qmaildirmake
%attr(0755,root,root)              %{_prefix}/bin/maildir2mbox
%attr(0755,root,root)              %{_prefix}/bin/maildirwatch
%attr(0755,root,root)              %{_prefix}/sbin/qmail-qmqpc
#
%if %nolibsrs2 == 0
%{_libdir}/libsrs2.so.1
%{_libdir}/libsrs2.so.1.0.0
%endif
#
%attr(0644,root,root)              %{mandir}/man1/forward.1.gz
%attr(0644,root,root)              %{mandir}/man1/predate.1.gz
%attr(0644,root,root)              %{mandir}/man1/datemail.1.gz
%attr(0644,root,root)              %{mandir}/man1/mailsubj.1.gz
%attr(0644,root,root)              %{mandir}/man1/qmaildirmake.1.gz
%attr(0644,root,root)              %{mandir}/man1/maildir2mbox.1.gz
%attr(0644,root,root)              %{mandir}/man1/maildirwatch.1.gz
#
%if %nolibsrs2 == 0
%attr(0644,root,root)              %{mandir}/man5/qmail-srs.5.gz
%endif
#
%attr(0644,root,root)              %{mandir}/man8/qmail-showctl.8.gz
%attr(0644,root,root)              %{mandir}/man8/qmail-inject.8.gz
%attr(0644,root,root)              %{mandir}/man8/isendmail.8.gz
%attr(0644,root,root)              %{mandir}/man8/qmail-qmqpc.8.gz
%attr(0644,root,root)              %{mandir}/man8/irmail.8.gz

%attr(0644,root,root)              %{shareddir}/doc/INSTALL-MINI
%attr(0644,root,root)              %{shareddir}/doc/AUTHORS.libsrs2
%if %build_on_obs == 0
%license %attr(0644,root,root)     %{shareddir}/doc/LICENSE.GPL-2.libsrs2
%else
%attr(0644,root,root)              %{shareddir}/doc/LICENSE.GPL-2.libsrs2
%endif

# a copy of /var/qmail/control/me, /var/qmail/control/defaultdomain,
# and /var/qmail/control/plusdomain from your central server, so that
# qmail-inject uses appropriate host names in outgoing mail; and
# this host's name in /var/qmail/control/idhost, so that
# qmail-inject generates Message-ID without any risk of collision


%clean
[ "%{buildroot}" != "/" ] && %{__rm} -fr %{buildroot}

#            install   erase   upgrade  reinstall
# pretrans      0        -         0
# pre           1        -         2         2
# post          1        -         2         2
# preun         -        0         1         -
# postun        -        0         1         -
# posttrans     0        -         0
# The scriptlets in %%pre and %%post are respectively run before and after a package is installed.
# The scriptlets %%preun and %%postun are run before and after a package is uninstalled.
# The scriptlets %%pretrans and %%posttrans are run at start and end of a transaction.
# On upgrade, the scripts are run in the following order:
#
#   1. pretrans of new package
#   2. pre of new package
#   3. (package install)
#   4. post of new package
#   5. preun of old package
#   6. (removal of old package)
#   7. postun of old package
#   8. posttrans of new package

### SCRIPTLET ###############################################################################
%verifyscript
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
%{_prefix}/sbin/svctool --check-install --servicedir=%{servicedir} \
  --qbase=%{qbase} --qcount=%{qcount} --qstart=1

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%verify_permissions -e %{_prefix}/sbin/qhpsi
%verify_permissions -e %{_prefix}/sbin/run-cleanq
%verify_permissions -e %{_prefix}/sbin/qmail-queue
%verify_permissions -e %{_prefix}/sbin/qscanq
%verify_permissions -e %{_prefix}/alias
%verify_permissions -e %{_prefix}/autoturn
%endif
%endif

### SCRIPTLET ###############################################################################
%pretrans
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -f %{_prefix}/sbin/initsvc ] ; then
  %{_prefix}/sbin/initsvc -status
fi

if [ -f %{_prefix}/bin/svok ] ; then
  %{_prefix}/bin/svok %{servicedir}/.svscan/log 2>/dev/null
  if [ $? -eq 0 ] ; then
    echo "Giving %{name} exactly 5 seconds to exit nicely"
    if test -f %{_sysconfdir}/init/svscan.conf
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/event.d/svscan
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/systemd/system/multi-user.target.wants/svscan.service
    then
      /bin/systemctl stop svscan > /dev/null 2>&1
    elif test -x %{_prefix}/sbin/initsvc
    then
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_prefix}/sbin/initsvc -status || %{_sysconfdir}/init.d/svscan stop || true
      else
        %{_prefix}/sbin/initsvc -status || true
      fi
      %{_prefix}/sbin/initsvc -off || true
    else
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_sysconfdir}/init.d/svscan stop
      fi
      /bin/grep "^SV:" %{_sysconfdir}/inittab |/bin/grep svscan |/bin/grep respawn >/dev/null
      if [ $? -eq 0 ] ; then
        %{__sed} -i 's{^SV:{#SV:{' %{_sysconfdir}/inittab
        if [ $? -eq 0 ] ; then
          /sbin/init q
        fi
      fi
    fi
    sleep 5
  fi
fi
if [ -f %{libexecdir}/qupgrade.sh ] ; then
(
  echo "Running Custom Upgrade Script for pretrans"
  /bin/sh %{libexecdir}/qupgrade.sh pretrans noargs %{version} $*
) > /var/log/%{name}-setup.log 2>&1
fi

### SCRIPTLET ###############################################################################
%pre
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -z "$argv1" ] ; then
  argv1=0
fi
# we are doing upgrade
if [ $argv1 -eq 2 ] ; then
  if [ -f %{libexecdir}/qupgrade.sh ] ; then
  (
    echo "Running Custom Upgrade Script for pre upgrade"
    /bin/sh %{libexecdir}/qupgrade.sh pre upgrade %{version} $*
  ) >> /var/log/%{name}-setup.log 2>&1
  fi
  exit 0
fi
#
# Create a users and groups. Do not report any problems if they already
# exists.
#
(
nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd stop
  fi
fi
echo "Adding indimail-mta users/groups"
/usr/bin/getent group %groupname  > /dev/null || /usr/sbin/groupadd -r -g %gid %groupname || true
if [ $? = 4 ] ; then
  /usr/sbin/groupadd %groupname
fi
/usr/bin/getent group nofiles   > /dev/null || /usr/sbin/groupadd nofiles  || true
/usr/bin/getent group qmail     > /dev/null || /usr/sbin/groupadd qmail    || true
/usr/bin/getent group qscand    > /dev/null || /usr/sbin/groupadd qscand   || true

/usr/bin/getent passwd %username > /dev/null || /usr/sbin/useradd -r -g %groupname -u %uid -d %{qmaildir} %username || true
if [ $? = 4 ] ; then
  /usr/sbin/useradd -r -g %groupname -d %{qmaildir} %username
fi
/usr/bin/getent passwd alias    > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{qmaildir}/alias  -s /sbin/nologin alias  || true
/usr/bin/getent passwd qmaild   > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{qmaildir}        -s /sbin/nologin qmaild || true
/usr/bin/getent passwd qmaill   > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{logdir}          -s /sbin/nologin qmaill || true
/usr/bin/getent passwd qmailp   > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{qmaildir}        -s /sbin/nologin qmailp || true
/usr/bin/getent passwd qmailq   > /dev/null || /usr/sbin/useradd -M -g qmail    -d %{qmaildir}        -s /sbin/nologin qmailq || true
/usr/bin/getent passwd qmailr   > /dev/null || /usr/sbin/useradd -M -g qmail    -d %{qmaildir}        -s /sbin/nologin qmailr || true
/usr/bin/getent passwd qmails   > /dev/null || /usr/sbin/useradd -M -g qmail    -d %{qmaildir}        -s /sbin/nologin qmails || true
/usr/bin/getent passwd qscand   > /dev/null || /usr/sbin/useradd -M -g qscand   -d %{qmaildir}/qscanq -G qmail,qscand -s /sbin/nologin qscand || true

for i in %username alias qmaild qmaill qmailp qmailq qmailr qmails qscand
do
  %{__rm} -f /var/spool/mail/$i
done
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd start
  fi
fi
) >> /var/log/%{name}-setup.log 2>&1

### SCRIPTLET ###############################################################################
%post
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -z "$argv1" ] ; then
  argv1=0
fi
if [ $argv1 -eq 2 ] ; then # upgrade
  (
  echo "doing post upgrade activities"
  if [ -f %{libexecdir}/qupgrade.sh ] ; then
    if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
      /sbin/ldconfig
    fi
    echo "Running Custom Upgrade Script for post upgrade"
    /bin/sh %{libexecdir}/qupgrade.sh post upgrade %{version} $*
  fi
  if [ -f %{_sysconfdir}/init.d/svscan ] ; then
    cmp -s %{_prefix}/bin/qmailctl %{_sysconfdir}/init.d/svscan >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{_prefix}/bin/qmailctl %{_sysconfdir}/init.d/svscan
    fi
  fi
  if [ -x /bin/systemctl -a -d /lib/systemd/system ] ; then
    cmp -s %{shareddir}/boot/systemd /lib/systemd/system/svscan.service >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/systemd /lib/systemd/system/svscan.service
      /bin/systemctl daemon-reload
    fi
  elif [ -x /bin/systemctl -a -d /usr/lib/systemd/system ] ; then
    cmp -s %{shareddir}/boot/systemd /usr/lib/systemd/system/svscan.service >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/systemd /usr/lib/systemd/system/svscan.service
      /bin/systemctl daemon-reload
    fi
  elif [ -f /sbin/initctl -a -d %{_sysconfdir}/init ] ; then
    cmp -s %{shareddir}/boot/upstart %{_sysconfdir}/init/svscan.conf >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/upstart %{_sysconfdir}/init/svscan.conf
    fi
  elif [ -d %{_sysconfdir}/event.d ] ; then
    cmp -s %{shareddir}/boot/upstart %{_sysconfdir}/event.d/upstart >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/upstart %{_sysconfdir}/event.d
    fi
  elif [ -d /System/Library/LaunchDaemons ] ; then
    cmp -s %{shareddir}/boot/indimail.plist /System/Library/LaunchDaemons >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/indimail.plist /System/Library/LaunchDaemons
    fi
  fi
  # selinux
  %{_prefix}/sbin/svctool --servicedir=%{servicedir} --config=qselinux
  if [ -f %{_sysconfdir}/inittab ] ; then # one of these days, this will disappear
    /bin/grep "^#SV:" %{_sysconfdir}/inittab |/bin/grep svscan |/bin/grep respawn >/dev/null 2>&1
    if [ $? -eq 0 ] ; then
      %{__sed} -i 's{^#SV:{SV:{' %{_sysconfdir}/inittab
    fi
  fi

  # refresh indimail-mta services
  svc_list=""
  for i in clamd greylist.1999 qmail-qmqpd.628 \
    qmail-qmtpd.209 qmail-smtpd.25 qmail-smtpd.366 .svscan \
    qmail-smtpd.465 qmail-smtpd.587 qscanq udplogger.3000 \
    qmail-daned.1998 libwatch
  do
    if [ -d %{servicedir}/$i ] ; then
      if [ -z "$svc_list" ] ; then
        svc_list="%{servicedir}/$i"
      else
        svc_list="$svc_list %{servicedir}/$i"
      fi
    fi
  done
  svc_list="$svc_list %{qsysconfdir}/control/defaultqueue"
  %{_prefix}/sbin/svctool --servicedir=%{servicedir} --refreshsvc="$svc_list"
  ) >> /var/log//%{name}-setup.log 2>&1
  exit 0
fi
if [ -x /bin/touch ] ; then
  TOUCH=/bin/touch
elif [ -x /usr/bin/touch ] ; then
  TOUCH=/usr/bin/touch
else
  TOUCH=/bin/touch
fi

echo "Doing Post Install"
echo ""
echo " 1. Configure %{logdir} for multilog"
echo " 2. Configure %{servicedir}"
echo " 3. Configure svscanlog service"
echo " 4. Configure standard catch-all accounts, default qmail configuration"
echo " 5. Configure DKIM, Domainkeys signature"
echo " 6. Configure QHPSI for inline virus scanning"
echo " 7. Configure SMTP services on port in 465 25 587"
echo " 8. Configure default queue configuration for sendmail, qmail-inject"
echo " 9. Configure ODMR service"
echo "10. Configure greylisting service"
echo "11. Configure QMTP service"
echo "12. Configure QMQP service"
echo "13. Configure udplogger service"
echo "14. Configure qscanq/clamd/freshclam service"
echo "15. Configure %{qsysconfdir}/control/signatures"
echo "16. Configure tcprules database for SMTP, QMTP, QMQP"
echo "17. Configure %{name} startup"
echo ""

if [ ! -d %{logdir} ] ; then
  echo "Creating %{logdir}"
  %{__mkdir_p} %{logdir}
fi
%{__chown} -R qmaill:nofiles %{logdir}

(
# svscanlog service
%{_prefix}/sbin/svctool --svscanlog --servicedir=%{servicedir} --scanint=60

%{_prefix}/sbin/svctool --config=qmail --postmaster=%{qmaildir}/alias/Maildir/

if [ %nodksignatures -eq 0 ] ; then
  if [ -x %{_prefix}/bin/dknewkey ] ; then
    ver_opt="dkim"
    sign_opt="dkim"
    key_bit=$KEYBIT # set KEYBIT in environment variable
    if [ " $key_bit" = " " ] ; then
      key_bit=1024
    fi
    %{_prefix}/bin/dknewkey %{qsysconfdir}/control/domainkeys/%{dkimkeyfn} $key_bit
    %{__chown} indimail:qmail %{qsysconfdir}/control/domainkeys/%{dkimkeyfn}
    /bin/chmod 640 %{qsysconfdir}/control/domainkeys/%{dkimkeyfn}
  else
    ver_opt="none"
    sign_opt="none"
  fi
else
  ver_opt="none"
  sign_opt="none"
fi

%if %noperms == 0
%if 0%{?suse_version} >= 1120
%if 0%{?set_permissions:1} > 0
  if [ ! -f /tmp/no_permissions ] ; then
    %set_permissions %{name}
  fi
%else
  if [ ! -f /tmp/no_permissions ] ; then
    %run_permissions
  fi
%endif
%endif
%endif

# SMTP
%ifarch x86_64
%global smtp_soft_mem 52428800
%global qmtp_soft_mem 52428800
%global qmqp_soft_mem 52428800
%global send_soft_mem 83886080
%else
%global smtp_soft_mem 26214400
%global qmtp_soft_mem 26214400
%global qmqp_soft_mem 26214400
%global send_soft_mem 83886080
%endif

# Define QHPSI for inline virus scanning by qmail-queue
if [ -f /usr/sbin/clamd -a -f /usr/bin/clamdscan ] ; then
  have_clamav=1
  clamdPrefix="/usr"
  if [ -d %{_sysconfdir}/clamav ] ; then
    mysysconfdir=%{_sysconfdir}/clamav
  elif [ -d %{_sysconfdir}/clamd.d ] ; then
    mysysconfdir=%{_sysconfdir}/clamd.d
  elif [ -d %{qsysconfdir} ] ; then
    mysysconfdir=%{qsysconfdir}
  else
    mysysconfdir=%{_sysconfdir}
  fi
  qhpsi="/usr/bin/clamdscan %s --config=${mysysconfdir}/scan.conf --fdpass --quiet --no-summary"
  # let qscand get qmail group for socket permission
  /usr/sbin/usermod -aG qmail qscand || true
else
  have_clamav=0
fi
# SMTP ports
for port in 465 25 587
do
  extra_opt=""
  if [ $port -eq 465 ] ; then
    extra_opt="--skipsend --authsmtp --ssl"
    extra_opt="$extra_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
  elif [ $port -eq 587 ] ; then
    extra_opt="--skipsend --forceauthsmtp --antispoof --forcetls"
  else
    if [ $port -eq 25 ] ; then
      extra_opt="--remote-authsmtp=plain --localfilter --remotefilter"
      extra_opt="--dmemory=%{send_soft_mem}"
    else
      extra_opt="--authsmtp"
    fi
    extra_opt="$extra_opt --deliverylimit-count=-1 --deliverylimit-size=-1"
    extra_opt="$extra_opt --rbl=-rzen.spamhaus.org --rbl=-rdnsbl-1.uceprotect.net"
  fi
%if %{tcpserver_plugin} == 1
    extra_opt="$extra_opt --shared-objects=1 --use-dlmopen=1"
%endif
  if [ $have_clamav -eq 1 ] ; then
    extra_opt="$extra_opt --qhpsi=\"$qhpsi\""
  fi
  eval %{_prefix}/sbin/svctool --smtp=$port --servicedir=%{servicedir} \
    --qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
    --query-cache --dnscheck --password-cache \
    --cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 --persistdb \
    --starttls --fsync --syncdir --memory=%{smtp_soft_mem} \
	--chkrecipient --chkrelay --masquerade \
    --min-free=52428800 --content-filter --virus-filter \
    --dmasquerade --infifo=infifo \
    --dkverify=${ver_opt} \
    --dksign=${sign_opt} --private_key="%{qsysconfdir}/control/domainkeys/%/%{dkimkeyfn}" \
    $extra_opt
done

# queue parameters in control/defaultqueue for qmail-inject, sendmail
extra_opt=""
if [ $have_clamav -eq 1 ] ; then
  extra_opt="--qhpsi=\"$qhpsi\""
fi
eval %{_prefix}/sbin/svctool --queueParam=defaultqueue \
  --qbase=%{qbase} --qcount=%{qcount} --qstart=1 \
  --min-free=52428800 --fsync --syncdir --virus-filter \
  --dkverify="none" --dksign=$sign_opt \
  --private_key=%{qsysconfdir}/control/domainkeys/%/%{dkimkeyfn} \
  $extra_opt

# ODMR service
%{_prefix}/sbin/svctool --smtp=366 --odmr --servicedir=%{servicedir} \
  --infifo="" --query-cache --password-cache --memory=%{smtp_soft_mem}

# Greylist daemon
%{_prefix}/sbin/svctool --greylist=1999 --servicedir=%{servicedir} --min-resend-min=2 \
    --resend-win-hr=24 --timeout-days=30 --context-file=greylist.context \
    --hash-size=65535 --save-interval=5 --whitelist=greylist.white
if [ %{notlsarr} -eq 0 ] ; then
  # qmail-daned tlsa daemon
  %{_prefix}/sbin/qmail-daned > /dev/null 2>&1 || \
  (test $? -ne 100 && %{_prefix}/sbin/svctool \
    --tlsa=1998 --servicedir=%{servicedir} \
    --timeout-days=30 --context-file=tlsa.context \
    --hash-size=65535 --save-interval=5 --whitelist=tlsa.white ) || \
    echo "Not enabling qmail-daned service" 1>&2
fi
# qmail-qmtpd service
eval %{_prefix}/sbin/svctool --qmtp=209 --servicedir=%{servicedir} --qbase=%{qbase} \
  --qcount=%{qcount} --qstart=1 --cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 \
  --fsync --syncdir --memory=%{qmtp_soft_mem} --min-free=52428800 $extra_opt
# qmail-qmqpd service
eval %{_prefix}/sbin/svctool --qmqp=628 --servicedir=%{servicedir} --qbase=%{qbase} \
  --qcount=%{qcount} --qstart=1 --cntrldir=control --localip=0 --maxdaemons=75 --maxperip=25 \
  --fsync --syncdir --memory=%{qmqp_soft_mem} --min-free=52428800 $extra_opt
$TOUCH %{servicedir}/qmail-qmqpd.628/down

# virus/spam filtering
%{_prefix}/sbin/svctool --qscanq --servicedir=%{servicedir} --scanint=200
if [ $have_clamav -eq 1 ] ; then
  %{_prefix}/sbin/svctool --config=clamd
  %{_prefix}/sbin/svctool --config=foxhole
  # create clamd, freshclam service
 eval %{_prefix}/sbin/svctool --clamd --servicedir=%{servicedir} --clamdPrefix=$clamdPrefix \
    --sysconfdir=${mysysconfdir}
  if [ $have_clamav -eq 1 ] ; then
    echo "Checking if clamd/freshclam is running"
    count=`ps -e|grep clamd|wc -l`
    if [ $count -gt 0 ] ; then
      echo "Disabling clamd service"
      $TOUCH %{servicedir}/clamd/down
    fi
    count=`ps -e|grep freshclam|wc -l`
    if [ $count -gt 0 ] ; then
      echo "Disabling freshclam service"
      $TOUCH %{servicedir}/freshclam/down
    fi
  fi
fi

# udplogger service
%{_prefix}/sbin/svctool --udplogger=3000 --localip=0 --timeout=10 --servicedir=%{servicedir}

%{__cat} <<EOF > %{qsysconfdir}/control/signatures
# Windows executables seen in active virii
TVqQAAMAA:
TVpQAAIAA
# Additional windows executable signatures not yet seen in virii
TVpAALQAc
TVpyAXkAX
TVrmAU4AA
TVrhARwAk
TVoFAQUAA
TVoAAAQAA
TVoIARMAA
TVouARsAA
TVrQAT8AA
# .ZIPfile signature seen in SoBig.E and mydoom:
#UEsDBBQAA:SoBig.e Virus
#UEsDBAoAAA:mydoom Virus
# .GIF file found in a previous Microsoft virus making the rounds.
R0lGODlhaAA7APcAAP///+rp6puSp6GZrDUjUUc6Zn53mFJMdbGvvVtXh2xre8bF1x8cU4yLprOy:Virus in .gif files
# http://www.gossamer-threads.com/lists/qmail/users/114447
UEsDBAoAAQAAAEBHYzCf4kJRDDAAAAAwAAAKAAAAc3ZtaXhlLmV4ZcuI1rOkjfn48VwCkMYHRTfM
EOF
%{__chown} qscand:qscand %{qsysconfdir}/control/signatures

# Recreate ld.so links and cache
if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
  if [ -d %{_sysconfdir}/ld.so.conf.d ] ; then
    echo %{_libdir} > %{_sysconfdir}/ld.so.conf.d/indimail-%{_arch}.conf
  fi
  /sbin/ldconfig
fi

# rebuild cdb
for i in smtp qmtp qmqp
do
  for j in `/bin/ls %{qsysconfdir}/tcp/tcp*.$i 2>/dev/null`
  do
    t1=`date +'%s' -r $j`
    if [ -f $j.cdb ] ; then
      t2=`date +'%s' -r $j.cdb`
    else
      t2=0
    fi
    if [ $t1 -gt $t2 ] ; then
      echo "Creating CDB $j.cdb"
      %{_prefix}/bin/tcprules $j.cdb $j.tmp < $j && /bin/chmod 664 $j.cdb \
        && chown indimail:indimail $j.cdb
    fi
  done
done

# turn off automatic refresh for services during first time installation
svc_list=""
for i in clamd greylist.1999 qmail-qmqpd.628 \
  qmail-qmtpd.209 qmail-smtpd.25 qmail-smtpd.366 .svscan \
  qmail-smtpd.465 qmail-smtpd.587 qscanq udplogger.3000 \
  qmail-daned.1998
do
  if [ -d %{servicedir}/$i ] ; then
    svc_list="$svc_list %{servicedir}/$i"
  fi
done
svc_list="$svc_list %{qsysconfdir}/control/defaultqueue"
%{_prefix}/sbin/svctool --servicedir=%{servicedir} --norefreshsvc="0 $svc_list"

# libindimail/mysql_lib control file updater
%{_prefix}/sbin/svctool --libwatch --servicedir=%{servicedir}

# selinux
%{_prefix}/sbin/svctool --servicedir=%{servicedir} --config=qselinux

#
# Install IndiMail to be started on system boot
# The add-boot command installs svscan to be started by init, systemd, upstart or launchctl
#
echo "adding indimail startup"
%{_prefix}/sbin/svctool --config=add-boot
%{_prefix}/sbin/svctool --config=add-alt

if [ -f %{qsysconfdir}/cronlist.q -a -d %{_sysconfdir}/cron.d ] ; then
  echo "adding cron entries"
  %{__cp} %{qsysconfdir}/cronlist.q %{_sysconfdir}/cron.d
fi

if [ -f %{libexecdir}/qupgrade.sh ] ; then
  echo "Running Custom Installation Script for post install"
  /bin/sh %{libexecdir}/qupgrade.sh post install %{version} $*
fi
if [ -x /bin/systemctl ] ; then
  /bin/systemctl enable svscan
fi
) >> /var/log/%{name}-setup.log 2>&1
if [ -f %{_sysconfdir}/init/svscan.conf -o -f %{_sysconfdir}/event.d/svscan ] ; then
  echo "1. Execute /sbin/initctl emit qmailstart to start services"
  count=1
elif [ -f %{_sysconfdir}/systemd/system/multi-user.target.wants/svscan.service ] ; then
  echo "1. Execute /bin/systemctl start svscan to start services"
  count=1
else
  if [ -f %{_prefix}/sbin/initsvc ] ; then
  echo "1. Execute %{_prefix}/sbin/initsvc -on"
  else
  echo "1. Execute %{_sysconfdir}/init.d/svscan start"
  fi
  echo "2. Execute /sbin/init q to start services"
  count=2
fi
default_domain=$([ -n "$HOSTNAME" ] && echo "$HOSTNAME" || `uname -n`)
count=`expr $count + 1`
echo "$count. Change your default domain in %{qsysconfdir}/control/defaultdomain"
count=`expr $count + 1`
echo "$count. You can optionally run the following command to verify installation"
echo "   sudo rpm -V indimail"
if [ ! -f %{qsysconfdir}/certs/servercert.pem ] ; then
count=`expr $count + 1`
echo "$count. You need to create CERTS for SSL/TLS/STARTTLS"
echo "   Execute the following command to create the certificate"
echo "   %{_prefix}/sbin/svctool --config=cert --postmaster=postmaster@$default_domain --common_name=$default_domain"
fi
echo
echo "Look at /var/log/%{name}-setup.log for the installation log"

### SCRIPTLET ###############################################################################
%preun
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
(
if [ -z "$argv1" ] ; then
  argv1=0
fi
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
  (
  if [ -f %{libexecdir}/qupgrade.sh ] ; then
    echo "Running Custom Un-Installation Script for preun upgrade"
    /bin/sh %{libexecdir}/qupgrade.sh preun upgrade %{version} "$argv1"
  fi
  ) >> /var/log/%{name}-setup.log 2>&1
  exit 0
fi
if [ -f %{_prefix}/bin/svok ] ; then
  %{_prefix}/bin/svok %{servicedir}/.svscan/log 2>/dev/null
  if [ $? -eq 0 ] ; then
    echo "Giving %{name} exactly 5 seconds to exit nicely"
    if test -f %{_sysconfdir}/init/svscan.conf
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/event.d/svscan
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/systemd/system/multi-user.target.wants/svscan.service
    then
      /bin/systemctl stop svscan > /dev/null 2>&1
    elif test -x %{_prefix}/sbin/initsvc
    then
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_prefix}/sbin/initsvc -status || %{_sysconfdir}/init.d/svscan stop || true
      else
        %{_prefix}/sbin/initsvc -status || true
      fi
      %{_prefix}/sbin/initsvc -off || true
    else
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_sysconfdir}/init.d/svscan stop
      fi
      /bin/grep "^SV:" %{_sysconfdir}/inittab |/bin/grep svscan |/bin/grep respawn >/dev/null
      if [ $? -eq 0 ] ; then
        %{__sed} -i 's{^SV:{#SV:{' %{_sysconfdir}/inittab
        if [ $? -eq 0 ] ; then
          /sbin/init q
        fi
      fi
    fi
    sleep 5
  fi
fi

if [ -f %{libexecdir}/qupgrade.sh ] ; then
  echo "Running Custom Un-Installation Script for preun pre-uninstall"
  /bin/sh %{libexecdir}/qupgrade.sh preun uninstall %{version} "$argv1"
fi

if [ -f %{_sysconfdir}/init.d/svscan ] ; then
  if [ -f /sbin/chkconfig ] ; then
    /sbin/chkconfig --add sendmail
  fi
fi
# Remove IndiMail being started on system boot
echo "removing indimail startup"
%{_prefix}/sbin/svctool --config=rm-boot
%{_prefix}/sbin/svctool --config=remove-alt
) >> /var/log/%{name}-setup.log 2>&1

### SCRIPTLET ###############################################################################
%postun
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -z "$argv1" ] ; then
  argv1=0
fi
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
  if [ -f %{libexecdir}/qupgrade.sh ] ; then
    (
    echo "Running Custom Un-Installation Script for postun upgrade"
    /bin/sh %{libexecdir}/qupgrade.sh postun upgrade %{version} $*
    ) >> /var/log/%{name}-setup.log
  fi
  if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
    echo "recreating ld.so cache"
    /sbin/ldconfig
  fi
  exit 0
fi
(
# remove users / groups
nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd stop
  fi
fi
for i in alias qmaild qmaill qmailp qmailq qmailr qmails qscand indimail
do
  echo "Removing user $i"
  /usr/bin/getent passwd $i > /dev/null && /usr/sbin/userdel $i >/dev/null || true
done
for i in nofiles qmail qscand indimail
do
  echo "Removing group $i"
  /usr/bin/getent group $i > /dev/null && /usr/sbin/groupdel $i  >/dev/null || true
done
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd start
  fi
fi

for i in postmaster mailer-daemon root ham spam register-ham register-spam
do
  %{__rm} -f %{qmaildir}/alias/.qmail-"$i"
done
%{__rm} -rf %{qmaildir}/alias/Maildir

echo "removing startup services"
if [ -f /usr/sbin/clamd -a -f /usr/bin/clamdscan ] ; then
  for i in clamd freshclam
  do
    if [ -d %{servicedir}/$i ] ; then
      %{__rm} -rf %{servicedir}/$i || true
    elif [ -L %{servicedir}/$i ] ; then
      %{__rm} -rf %{servicedir}/$i || true
    fi
  done
fi
for i in qmail-send.25 qmail-smtpd.25 qmail-smtpd.366 \
  qscanq qmail-smtpd.465 qmail-smtpd.587 \
  qmail-qmtpd.209 qmail-qmqpd.628 greylist.1999 \
  qmail-daned.1998 resolvconf udplogger.3000 .svscan
do
  if [ -d %{servicedir}/$i ] ; then
    %{__rm} -rf %{servicedir}/$i || true
  elif [ -L %{servicedir}/$i ] ; then
    %{__rm} -rf %{servicedir}/$i || true
  fi
done

count=`/bin/ls %{servicedir} 2>/dev/null| /usr/bin/wc -l`
if [ $count -eq 0 ] ; then # ignore disabled services
  %{__rm} -rf %{servicedir} || true
fi

if [ -d %{_sysconfdir}/cron.d ] ; then
  echo "removing cron entries"
  %{__rm} -f %{_sysconfdir}/cron.d/cronlist.q
fi

echo "removing logs"
if [ -h %{logdir} ] ; then
  log_dir=`/bin/ls -ld %{logdir} | /usr/bin/awk '{print $10}'`
else
  log_dir=%{logdir}
fi
[ "$log_dir" != "/" ] && %{__rm} -fr $log_dir

if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
  echo "recreating ld.so cache"
  /sbin/ldconfig
fi

#selinux
if [ -x /usr/sbin/selinuxenabled ] ; then
  /usr/sbin/selinuxenabled
  if [ $? -eq 0 -a -x /usr/sbin/semodule ] ; then
    echo "disabling selinux module"
    /usr/sbin/semodule -r indimail-mta
  fi
fi

if [ -f %{libexecdir}/qupgrade.sh ] ; then
  echo "Running Custom Un-Installation Script for postun uninstall"
  /bin/sh %{libexecdir}/qupgrade.sh postun uninstall %{version} $*
fi
) >> /var/log/%{name}-setup.log 2>&1

### SCRIPTLET ###############################################################################
%posttrans
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -f %{libexecdir}/qupgrade.sh ] ; then
(
  echo "Running Custom Installation Script for posttrans"
  /bin/sh %{libexecdir}/qupgrade.sh posttrans noargs %{version} $*
) >> /var/log/%{name}-setup.log 2>&1
fi

### SCRIPTLET ###############################################################################
%pretrans -n daemontools
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -f %{_prefix}/sbin/initsvc ] ; then
  %{_prefix}/sbin/initsvc -status
fi

if [ -f %{_prefix}/bin/svok ] ; then
  %{_prefix}/bin/svok %{servicedir}/.svscan/log 2>/dev/null
  if [ $? -eq 0 ] ; then
    echo "Giving svscan exactly 5 seconds to exit nicely"
    if test -f %{_sysconfdir}/init/svscan.conf
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/event.d/svscan
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/systemd/system/multi-user.target.wants/svscan.service
    then
      /bin/systemctl stop svscan > /dev/null 2>&1
    elif test -x %{_prefix}/sbin/initsvc
    then
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_prefix}/sbin/initsvc -status || %{_sysconfdir}/init.d/svscan stop || true
      else
        %{_prefix}/sbin/initsvc -status || true
      fi
      %{_prefix}/sbin/initsvc -off || true
    else
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_sysconfdir}/init.d/svscan stop
      fi
      /bin/grep "^SV:" %{_sysconfdir}/inittab |/bin/grep svscan |/bin/grep respawn >/dev/null
      if [ $? -eq 0 ] ; then
        %{__sed} -i 's{^SV:{#SV:{' %{_sysconfdir}/inittab
        if [ $? -eq 0 ] ; then
          /sbin/init q
        fi
      fi
    fi
    sleep 5
  fi
fi
if [ -f %{libexecdir}/qupgrade.sh ] ; then
(
  echo "Running Custom Upgrade Script for pretrans"
  /bin/sh %{libexecdir}/qupgrade.sh pretrans noargs %{version} $*
) > /var/log/%{name}-setup.log 2>&1
fi

### SCRIPTLET ###############################################################################
%pre -n daemontools
/usr/bin/getent group  nofiles  > /dev/null || /usr/sbin/groupadd nofiles  || true
/usr/bin/getent group  qmail    > /dev/null || /usr/sbin/groupadd qmail    || true
/usr/bin/getent passwd qmaill   > /dev/null || /usr/sbin/useradd -M -g nofiles  -d %{qmaildir} -s /sbin/nologin qmaill || true

### SCRIPTLET ###############################################################################
%post -n daemontools
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -z "$argv1" ] ; then
  argv1=0
fi
if [ ! -d %{logdir} ] ; then
  echo "Creating %{logdir}"
  %{__mkdir_p} %{logdir}
fi
if [ $argv1 -eq 2 ] ; then # upgrade
  (
  echo "doing post upgrade activities"
  if [ -x /bin/systemctl -a -d /lib/systemd/system ] ; then
    cmp -s %{shareddir}/boot/systemd /lib/systemd/system/svscan.service >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/systemd /lib/systemd/system/svscan.service
      /bin/systemctl daemon-reload
    fi
  elif [ -x /bin/systemctl -a -d /usr/lib/systemd/system ] ; then
    cmp -s %{shareddir}/boot/systemd /usr/lib/systemd/system/svscan.service >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/systemd /usr/lib/systemd/system/svscan.service
      /bin/systemctl daemon-reload
    fi
  elif [ -f /sbin/initctl -a -d %{_sysconfdir}/init ] ; then
    cmp -s %{shareddir}/boot/upstart %{_sysconfdir}/init/svscan.conf >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/upstart %{_sysconfdir}/init/svscan.conf
    fi
  elif [ -d %{_sysconfdir}/event.d ] ; then
    cmp -s %{shareddir}/boot/upstart %{_sysconfdir}/event.d/upstart >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/upstart %{_sysconfdir}/event.d
    fi
  elif [ -d /System/Library/LaunchDaemons ] ; then
    cmp -s %{shareddir}/boot/indimail.plist /System/Library/LaunchDaemons >/dev/null 2>&1
    if [ $? -ne 0 ] ; then
      %{__cp} %{shareddir}/boot/indimail.plist /System/Library/LaunchDaemons
    fi
  fi
  if [ -f %{_sysconfdir}/inittab ] ; then # one of these days, this will disappear
    /bin/grep "^#SV:" %{_sysconfdir}/inittab |/bin/grep svscan |/bin/grep respawn >/dev/null 2>&1
    if [ $? -eq 0 ] ; then
      %{__sed} -i 's{^#SV:{SV:{' %{_sysconfdir}/inittab
    fi
  fi
  ) >> /var/log/%{name}-setup.log 2>&1
  exit 0
fi
echo "adding indimail startup"
%{_prefix}/sbin/svctool --config=add-boot
# svscanlog service
%{_prefix}/sbin/svctool --svscanlog --servicedir=%{servicedir} --scanint=60

### SCRIPTLET ###############################################################################
%preun -n daemontools
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
(
if [ -z "$argv1" ] ; then
  argv1=0
fi
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
  (
  if [ -f %{libexecdir}/qupgrade.sh ] ; then
    echo "Running Custom Un-Installation Script for preun upgrade"
    /bin/sh %{libexecdir}/qupgrade.sh preun upgrade %{version} "$argv1"
  fi
  ) >> /var/log/daemontools-setup.log 2>&1
  exit 0
fi
if [ -f %{_prefix}/bin/svok ] ; then
  %{_prefix}/bin/svok %{servicedir}/.svscan/log 2>/dev/null
  if [ $? -eq 0 ] ; then
    echo "Giving svscan exactly 5 seconds to exit nicely"
    if test -f %{_sysconfdir}/init/svscan.conf
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/event.d/svscan
    then
      /sbin/initctl emit qmailstop > /dev/null 2>&1
    elif test -f %{_sysconfdir}/systemd/system/multi-user.target.wants/svscan.service
    then
      /bin/systemctl stop svscan > /dev/null 2>&1
    elif test -x %{_prefix}/sbin/initsvc
    then
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_prefix}/sbin/initsvc -status || %{_sysconfdir}/init.d/svscan stop || true
      else
        %{_prefix}/sbin/initsvc -status || true
      fi
      %{_prefix}/sbin/initsvc -off || true
    else
      if [ -x %{_sysconfdir}/init.d/svscan ] ; then
        %{_sysconfdir}/init.d/svscan stop
      fi
      /bin/grep "^SV:" %{_sysconfdir}/inittab |/bin/grep svscan |/bin/grep respawn >/dev/null
      if [ $? -eq 0 ] ; then
        %{__sed} -i 's{^SV:{#SV:{' %{_sysconfdir}/inittab
        if [ $? -eq 0 ] ; then
          /sbin/init q
        fi
      fi
    fi
    sleep 5
  fi
fi

if [ -f %{libexecdir}/qupgrade.sh ] ; then
  echo "Running Custom Un-Installation Script for preun pre-uninstall"
  /bin/sh %{libexecdir}/qupgrade.sh preun uninstall %{version} "$argv1"
fi

# Remove IndiMail being started on system boot
echo "removing indimail startup"
%{_prefix}/sbin/svctool --config=rm-boot
) >> /var/log/daemontools-setup.log 2>&1

### SCRIPTLET ###############################################################################
%postun -n daemontools
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -z "$argv1" ] ; then
  argv1=0
fi
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
  (
  if [ -f %{libexecdir}/qupgrade.sh ] ; then
    echo "Running Custom Un-Installation Script for postun upgrade"
    /bin/sh %{libexecdir}/qupgrade.sh postun upgrade %{version} $*
  fi
  ) >> /var/log/daemontools-setup.log
  exit 0
fi
(
# remove users / groups
nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd stop
  fi
fi
echo "Removing user qmaill"
/usr/bin/getent passwd qmaill > /dev/null && /usr/sbin/userdel qmaill >/dev/null || true

for i in qmail nofiles
do
  echo "Removing group $i"
  /usr/bin/getent group $i > /dev/null && /usr/sbin/groupdel $i  >/dev/null || true
done
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd start
  fi
fi
echo "removing logs"
if [ -h %{logdir} ] ; then
  log_dir=`/bin/ls -ld %{logdir} | /usr/bin/awk '{print $10}'`
else
  log_dir=%{logdir}
fi
[ "$log_dir" != "/" ] && %{__rm} -fr $log_dir
) >> /var/log/%{name}-setup.log

%post -n indimail-mini
argv1=$1
ID=$(id -u)
if [ $ID -ne 0 ] ; then
  echo "You are not root" 1>&2
  exit 1
fi
if [ -z "$argv1" ] ; then
  argv1=0
fi
# we are doing upgrade
if [ $argv1 -eq 2 ] ; then
  if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
    echo "recreating ld.so cache"
    /sbin/ldconfig
  fi
  exit 0
fi
(
#
# Create user/groups indimail. Do not report any problems if it already
# exists.
#
nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd stop
  elif [ -f %{_sysconfdir}/lib/systemd/system/multi-user.target/nscd.service ] ; then
    /bin/systemctl start nscd.service
  fi
fi
echo "Adding IndiMail users/groups"
/usr/bin/getent group indimail  > /dev/null || /usr/sbin/groupadd -r -g 555 indimail || true
if [ $? = 4 ] ; then
  /usr/sbin/groupadd indimail
fi
/usr/bin/getent group nofiles   > /dev/null || /usr/sbin/groupadd nofiles  || true
/usr/bin/getent group qmail     > /dev/null || /usr/sbin/groupadd qmail    || true

%{__rm} -f /var/spool/mail/indimail

/usr/bin/getent passwd indimail > /dev/null || /usr/sbin/useradd -r -g indimail -u 555 -d %{qmaildir} indimail || true
if [ $? = 4 ] ; then
  /usr/sbin/useradd -r -g indimail -d %{qmaildir} indimail
fi
if [ $nscd_up -ge 1 ] ; then
  if [ -x %{_sysconfdir}/init.d/nscd ] ; then
    %{_sysconfdir}/init.d/nscd start
  elif [ -f %{_sysconfdir}/lib/systemd/system/multi-user.target/nscd.service ] ; then
    /bin/systemctl start nscd.service
  fi
fi

if [ -f %{_prefix}/sbin/qmail-qmqpc ] ; then
  %{__mv} %{_prefix}/sbin/qmail-queue %{_prefix}/sbin/qmail-queue.orig
fi
cd %{_prefix}/sbin
/bin/ln -sf qmail-qmqpc qmail-queue
if [ -f %{_sysconfdir}/init.d/sendmail ] ; then
  %{_sysconfdir}/init.d/sendmail stop
  if [ -f /sbin/chkconfig ] ; then
    /sbin/chkconfig --del sendmail
  fi
fi
if [ -x /usr/sbin/alternatives ] ; then
  alternatives_cmd=/usr/sbin/alternatives
elif [ -x /usr/sbin/update-alternatives ] ; then
  alternatives_cmd=/usr/sbin/update-alternatives
else
  alternatives_cmd=""
fi
if [ -n $alternatives_cmd ] ; then
  for i in /usr/lib/sendmail /usr/sbin/sendmail; do
    if [ -f $i -a ! -L $i ]; then
      echo "! $i is a file, should be a link" 1>&2
      %{__mv} $i $i.old
    fi
  done
  for i in mailq newaliases; do
    if [ -f /usr/share/man/man1/$i.1.gz -a ! -L /usr/share/man/man1/$i.1.gz ] ; then
      echo "! /usr/share/man/man1/$i.1.gz is a file, should be a link" 1>&2
      %{__mv} /usr/share/man/man1/$i.1.gz /usr/share/man/man1/$i.old.1.gz
    fi
  done
  if [ -f %{_sysconfdir}/pam.d/smtp -a ! -L %{_sysconfdir}/pam.d/smtp ] ; then
    echo "! %{_sysconfdir}/pam.d/smtp is a file, should be a link" 1>&2
    %{__mv} %{_sysconfdir}/pam.d/smtp %{_sysconfdir}/pam.d/smtp.old
  fi
  $alternatives_cmd --install \
    /usr/sbin/sendmail mta %{_prefix}/bin/sendmail 120 \
    --slave /usr/share/man/man8/sendmail.8.gz mta-sendmailman \
      %{mandir}/man8/isendmail.8.gz \
    --slave /usr/lib/sendmail mta-sendmail %{_prefix}/bin/sendmail \
    --slave /usr/bin/rmail mta-rmail %{_prefix}/bin/irmail
  $alternatives_cmd --set mta %{_prefix}/bin/sendmail
else
  for i in /usr/lib/sendmail /usr/sbin/sendmail; do
    if [ -f $i -a ! -L $i ]; then
      echo "! $i is a file, should be a link" 1>&2
      %{__mv} $i $i.old
      /bin/ln -s %{_prefix}/bin/sendmail $i
    elif [ -L $i ];then
      %{__mv} $i $i.old
      /bin/ln -s %{_prefix}/bin/sendmail $i
    elif [ ! -f $i ];then
      echo "! $i is missing"
      /bin/ln -s %{_prefix}/bin/sendmail $i
    fi
  done
  if [ -f %{_sysconfdir}/pam.d/smtp -a ! -L %{_sysconfdir}/pam.d/smtp ] ; then
    echo "! %{_sysconfdir}/pam.d/smtp is a file, should be a link" 1>&2
    %{__mv} %{_sysconfdir}/pam.d/smtp %{_sysconfdir}/pam.d/smtp.old
    /bin/ln -s %{_sysconfdir}/pam.d/pam.multi %{_sysconfdir}/pam.d/smtp
  fi
  for i in mailq newaliases; do
    if [ -f /usr/share/man/man1/$i.1.gz -a ! -L /usr/share/man/man1/$i.1.gz ] ; then
      echo "! /usr/share/man/man1/$i.1.gz is a file, should be a link" 1>&2
      %{__mv} /usr/share/man/man1/$i.1.gz /usr/share/man/man1/$i.old.1.gz
    fi
  done
fi

# a copy of following control files from your central server
# /var/indimail/control/me
# /var/indimail/control/defaultdomain,
# /var/indimail/control/plusdomain
# so that qmail-inject uses appropriate host names in outgoing mail; and
# this host's name in /var/indimail/control/idhost, so that qmail-inject
# generates Message-ID without any risk of collision
if [ ! -f %{qsysconfdir}/control/idhost ] ; then
  default_domain=$([ -n "$HOSTNAME" ] && echo "$HOSTNAME" || `uname -n`)
  echo $default_domain > %{qsysconfdir}/control/idhost
fi
if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
  echo "recreating ld.so cache"
  /sbin/ldconfig
fi
) >> /var/log/%{name}-setup.log

%postun -n indimail-mini
argv1=$1
if [ -z "$argv1" ] ; then
  argv1=0
fi
# we are doing upgrade
if [ $argv1 -eq 1 ] ; then
  (
  if [ -f %{libexecdir}/qupgrade.sh ] ; then
    echo "Running Custom Un-Installation Script for postun upgrade"
    /bin/sh %{libexecdir}/qupgrade.sh postun upgrade %{version} $*
  fi
  ) >> /var/log/%{name}-setup.log
  if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
    echo "recreating ld.so cache"
    /sbin/ldconfig
  fi
  exit 0
fi
(
if [ -x /usr/sbin/alternatives ] ; then
  alternatives_cmd=/usr/sbin/alternatives
elif [ -x /usr/sbin/update-alternatives ] ; then
  alternatives_cmd=/usr/sbin/update-alternatives
else
  alternatives_cmd=""
fi
if [ -n $alternatives_cmd ] ; then
  $alternatives_cmd --remove mta %{_prefix}/bin/sendmail
  $alternatives_cmd --auto mta
  for i in /usr/lib/sendmail /usr/sbin/sendmail %{_sysconfdir}/pam.d/smtp; do
    if [ -f $i.old -o -L $i.old ]; then
      echo "restoring $i"
      %{__mv} $i.old $i
    fi
  done
else
  if [ -f %{_sysconfdir}/init.d/sendmail ] ; then
    if [ -f /sbin/chkconfig ] ; then
      /sbin/chkconfig --add sendmail
      echo "to start sendmail, issue"
      echo "%{_sysconfdir}/init.d/sendmail start"
    fi
  fi
fi
for i in /usr/lib/sendmail /usr/sbin/sendmail %{_sysconfdir}/pam.d/smtp; do
  if [ -f $i.old -o -L $i.old ]; then
    echo "restoring $i"
    %{__mv} $i.old $i
  fi
done
for i in mailq newaliases; do
  if [ -f /usr/share/man/man1/$i.old.1.gz ] ; then
    echo "restoring /usr/share/man/man1/$i.1.gz"
    %{__mv} /usr/share/man/man1/$i.old.1.gz /usr/share/man/man1/$i.1.gz
  fi
done
if [ "%{_libdir}" != "/usr/lib64" -a "%{_libdir}" != "/usr/lib" ] ; then
  echo "recreating ld.so cache"
  /sbin/ldconfig
fi
) >> /var/log/%{name}-setup.log

# fix changelog for openSUSE buildservice
%changelog
