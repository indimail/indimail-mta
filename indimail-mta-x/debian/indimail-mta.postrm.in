#!/bin/sh
# postrm script for indimail
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postrm> `remove'
#        * <postrm> `purge'
#        * <old-postrm> `upgrade' <new-version>
#        * <new-postrm> `failed-upgrade' <old-version>
#        * <new-postrm> `abort-install'
#        * <new-postrm> `abort-install' <old-version>
#        * <new-postrm> `abort-upgrade' <old-version>
#        * <disappearer's-postrm> `disappear' <overwriter>
#          <overwriter-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


prefix=@prefix@
qmaildir=@qmaildir@
qsysconfdir=@qsysconfdir@
shareddir=@shareddir@
libexecdir=@libexecdir@
mandir=@mandir@
servicedir=@servicedir@
logdir=@logdir@
rm=/bin/rm
rmdir=/bin/rmdir
####################################
default_domain=indimail.org

ID=`id -u`
if [ $ID -ne 0 ] ; then
	echo "You are not root" >&2
	exit 1
fi

case "$1" in
    purge|remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
	if [ -f ${libexecdir}/qupgrade.sh ] ; then
	(
		echo "Running Custom Upgrade Script for pre $1"
		/bin/sh ${libexecdir}/qupgrade.sh postrm $1 @version@ $* || true
	) >> /var/log/indimail-mta-setup.log 2>&1
	fi
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

# we are doing upgrade or removal
if [ " $1" = " upgrade" ] ; then
	if [ ! "${prefix}" = "/usr" ] ; then
		echo "recreating ld.so cache"
		/sbin/ldconfig
	fi
	exit 0
fi

case "$1" in
    failed-upgrade|abort-install|abort-upgrade|disappear)
	exit 0
    ;;
esac
#
# Debian silliness
#
if [ " $1" = " purge" ] ; then
	nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd stop
		elif [ -f /etc/systemd/system/multi-user.target/nscd.service ] ; then
			/bin/systemctl stop nscd.service >/dev/null 2>&1 || true
		fi
	fi
	(
	for i in alias qmaild qmailp qmailq qmailr qmails qscand indimail
	do
		echo "removing user $i"
		/usr/bin/getent passwd $i > /dev/null && /usr/sbin/userdel $i >/dev/null || true
	done
	for i in qmail qscand indimail qcerts
	do
		echo "removing group $i"
		/usr/bin/getent group $i > /dev/null && /usr/sbin/groupdel $i  >/dev/null || true
	done
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd start
		elif [ -f /etc/systemd/system/multi-user.target/nscd.service ] ; then
			/bin/systemctl start nscd.service >/dev/null 2>&1 || true
		fi
	fi

	echo "removing configuration"
	for i in .qmail-nonspam .qmail-register-nonspam .qmail-register-spam .qmail-spam .qmail-default
	do
		${rm} -f ${qmaildir}/domains/${default_domain}/$i
	done
	if [ -d ${qmaildir}/domains/${default_domain} ] ; then
		${rmdir} --ignore-fail-on-non-empty ${qmaildir}/domains/${default_domain} 2>/dev/null || true
	fi
	${rmdir} --ignore-fail-on-non-empty ${qmaildir}/domains 2>/dev/null || true

	echo "removing aliases postmaster, mailer-daemon, root"
	for i in postmaster mailer-daemon root
	do
		${rm} -f ${qmaildir}/alias/.qmail-"$i"
	done
	${rm} -rf ${qmaildir}/Maildir ${qmaildir}/alias/Maildir
	if [ -d ${qmaildir}/alias ] ; then
		${rmdir} --ignore-fail-on-non-empty ${qmaildir}/alias 2>/dev/null || true
	fi

	echo "removing tcp configuration"
	${rm} -f ${qsysconfdir}/resolv.conf
	for i in smtp qmtp qmqp
	do
		${rm} -f ${qsysconfdir}/tcp/tcp.$i.cdb ${qsysconfdir}/tcp/tcp.$i
	done
	${rm} -f ${qsysocnfdir}/control/controlfiles.q
	for i in chkrcptdomains defaulthost greylist.white me signatures tlsclientmethod \
		databytes dnsbllist hostip plusdomain smtpgreeting tlsserverciphers \
		defaultdelivery envnoathost localiphost queue_base timeoutremote tlsservermethod \
		defaultdomain filterargs locals rcpthosts timeoutsmtpd
	do
		${rm} -f ${qsysconfdir}/control/$i
	done
	for i in indimail.cnf indimail-mta-stat.override backup.conf \
		cronlist.q headerlist inc_deps indimail.mrtg.cfg \
		procmailrc indimail.settings lib_deps osh.table \
		quotawarnmsg.example services.log
	do
		${rm} -f ${qsysconfdir}/$i
	done
	for i in rsa2048.pem rsa1024.pem servercert.cnf servercert.pem dh1024.pem \
		dh2048.pem dh512.pem rsa512.pem servercert.rand clientcert.pem dhparams.pem
	do
		${rm} -f ${qsysconfdir}/certs/$i
	done

	echo "removing binaries, libraries, queues"
	if [ ${prefix} = "/var/indimail" -o ${prefix} = "/var/qmail" ] ; then
		for i in bin sbin queue
		do
			${rm} -rf ${prefix}/$i || true
		done
		echo "removing man pages"
		for i in ${prefix}/bin ${prefix}/sbin ${prefix}/lib ${prefix}/queue \
			${mandir}/man1 ${mandir}/cat1 ${mandir}/man5 \
			${mandir}/cat5 ${mandir}/man7 ${mandir}/cat7 \
			${mandir}/man8 ${mandir}/cat8 ${mandir}/man3
		do
			${rm} -rf $i || true
		done
		for i in `/bin/ls ${shareddir} 2>/dev/null`
		do
			if [ " $i" = " clamd" ] ; then # leave the signatures
				continue;
			fi
			${rm} -rf ${shareddir}/$i || true
		done
	else
		for i in bin sbin control users
		do
			${rm} -f ${qmaildir}/$i || true
		done
		# queue
		${rm} -rf ${qmaildir}/queue || true
		# modules
		${rm} -rf ${prefix}/lib/indimail || true
		# shareddir
		if [ ! " ${shareddir}" = " /usr/share" ] ; then
			for i in `/bin/ls ${shareddir} 2>/dev/null`
			do
				${rm} -rf ${shareddir}/$i || true
			done
		fi
		# libexecdir
		if [ ! " ${libexecdir}" = " /usr/libexec" ] ; then
			${rm} -rf ${libexecdir} || true
		fi
	fi
	for i in assign cdb
	do
    	${rm} -f ${qsysconfdir}/users/$i
	done
	if [ -d ${qsysconfdir}/users ] ; then
	${rmdir} --ignore-fail-on-non-empty ${qsysconfdir}/users || true
	fi
	${rm} -f ${qsysconfdir}/control/domainkeys/default.pub ${qsysconfdir}/control/domainkeys/default
	if [ -d ${qsysconfdir}/control/domainkeys ] ; then
		${rmdir} --ignore-fail-on-non-empty ${qsysconfdir}/control/domainkeys 2>/dev/null || true
	fi
	if [ -d ${qsysconfdir}/control/defaultqueue ] ; then
	${rm} -rf ${qsysconfdir}/control/defaultqueue 2>/dev/null || true
	fi
	if [ -d ${qsysconfdir}/control ] ; then
	${rmdir} --ignore-fail-on-non-empty ${qsysconfdir}/control || true
	fi
	if [ -d ${qsysconfdir}/certs ] ; then
	${rmdir} --ignore-fail-on-non-empty ${qsysconfdir}/certs || true
	fi
	echo "removing man pages"
	${rmdir} --ignore-fail-on-non-empty ${qmaildir} 2>/dev/null || true

	echo "removing startup services"
    for i in clamd greylist.1999 qmail-send.25 qmail-qmqpd.628 \
      qmail-qmtpd.209 qmail-smtpd.25 qmail-smtpd.366 \
      qmail-smtpd.465 qmail-smtpd.587 qmail-daned.1998 \
      slowq-send qscanq udplogger.3000 .svscan
	do
		if [ -d ${servicedir}/$i -o -L ${servicedir}/$i ] ; then
			touch ${servicedir}/$i/down
			svc -dx ${servicedir}/$i >/dev/null 2<&1 || true
		fi
		if [ -d ${servicedir}/$i/log -o -L ${servicedir}/$i/log ] ; then
			touch ${servicedir}/$i/log/down
			svc -dx ${servicedir}/$i/log >/dev/null 2<&1 || true
		fi
		if [ -d ${servicedir}/$i -o -L ${servicedir}/$i ] ; then
			${rm} -rf ${servicedir}/$i >/dev/null 2>&1 || true
		fi
	done

	count=`/bin/ls ${servicedir} 2>/dev/null| /usr/bin/wc -l`
	if [ $count -eq 0 ] ; then
		${rmdir} --ignore-fail-on-non-empty ${servicedir} || true
	fi
	echo "removing logs"
	for i in deliver.25 smtpd.25 smtpd.366 smtpd.465 \
		smtpd.587 qmtpd.209 qmqpd.628 greylist.1999 \
		daned.1998 resolvconf udplogger.3000 slowq-send \
		logfifo
	do
		if [ -d ${logdir}/$i ] ; then
			rm -fr ${logdir}/$i
		fi
	done
	) >> /var/log/indimail-mta-setup.log 2>&1
fi
if [ ! "${prefix}" = "/usr" ] ; then
	echo "recreating ld.so cache"
	/sbin/ldconfig
fi
exit 0
