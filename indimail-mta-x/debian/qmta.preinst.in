#!/bin/sh
set -e
prefix=@prefix@
qmaildir=@qmaildir@
rm=/bin/rm

ID=`id -u`
if [ $ID -ne 0 ] ; then
	echo "You are not root" >&2
	exit 1
fi
#
# Create user/groups indimail. Do not report any problems if it already
# exists.
#

case "$1" in
	upgrade)
	set +e
	if [ -d /run ] ; then
		rundir=/run/qmta
	else
		rundir=/var/run/qmta
	fi
	count=$(ps -ef|grep qmta-send|grep -v grep|wc -l)
	if [ $count -gt 0 ] ; then
  		mkdir -p $rundir
		touch $rundir/.qmta-send.down
	else
		${rm} -f $rundir/.qmta-send.down
	fi
	if test -f /etc/systemd/system/multi-user.target.wants/qmta-send.service
	then
		systemctl stop qmta-send >/dev/null 2>&1 || true
	fi
	set -e
	sleep 5
	;;
    install)
	nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd stop
		elif [ -f /etc/systemd/system/multi-user.target/nscd.service ] ; then
			/bin/systemctl stop nscd.service >/dev/null 2>&1 || true
		fi
	fi
	mkdir -p ${qmaildir}
	echo "Adding IndiMail users/groups"
	/usr/bin/getent group indimail  > /dev/null || /usr/sbin/groupadd -r -g 555 indimail || true
	if [ $? = 4 ] ; then
		/usr/sbin/groupadd indimail
	fi
	/usr/bin/getent group nofiles   > /dev/null || /usr/sbin/groupadd nofiles  || true
	/usr/bin/getent group qmail     > /dev/null || /usr/sbin/groupadd qmail    || true
	/usr/bin/getent group qscand    > /dev/null || /usr/sbin/groupadd qscand   || true
	/usr/bin/getent passwd indimail > /dev/null || /usr/sbin/useradd -r -g indimail -u 555 -d ${qmaildir} indimail || true
	if [ $? = 4 ] ; then
		/usr/sbin/useradd -r -g indimail -d ${prefix} indimail
	fi
	/usr/bin/getent passwd alias    > /dev/null || /usr/sbin/useradd -M -g nofiles  -d ${qmaildir}/alias  -s /sbin/nologin alias  || true
    /usr/bin/getent passwd qmailq   > /dev/null || /usr/sbin/useradd -M -g qmail    -d ${qmaildir}        -s /sbin/nologin qmailq || true
    /usr/bin/getent passwd qmailr   > /dev/null || /usr/sbin/useradd -M -g qmail    -d ${qmaildir}        -s /sbin/nologin qmailr || true
    /usr/bin/getent passwd qmails   > /dev/null || /usr/sbin/useradd -M -g qmail    -d ${qmaildir}        -s /sbin/nologin qmails || true
	/usr/bin/getent passwd qscand   > /dev/null || /usr/sbin/useradd -M -g qscand   -d ${qmaildir}/qscanq -G qmail,qscand -s /sbin/nologin qscand || true
	${rm} -f /var/spool/mail/indimail
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd start
		elif [ -f /etc/systemd/system/multi-user.target/nscd.service ] ; then
			/bin/systemctl start nscd.service >/dev/null 2>&1 || true
		fi
	fi
	;;

    abort-upgrade)
    ;;

    *)
        echo "preinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
