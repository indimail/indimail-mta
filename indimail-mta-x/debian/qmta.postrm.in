#!/bin/sh
set -e
prefix=@prefix@
qsysconfdir=@qsysconfdir@
rm=/bin/rm
mv=/bin/mv
rmdir=/bin/rmdir
####################################
ID=`id -u`
if [ $ID -ne 0 ] ; then
	echo "You are not root" >&2
	exit 1
fi

case "$1" in
    purge|remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

# we are doing upgrade or removal
if [ " $1" = " upgrade" ] ; then
	if [ ! "${prefix}" = "/usr" ] ; then
		echo "recreating ld.so cache"
		/sbin/ldconfig
	fi
	exit 0
fi

case "$1" in
    failed-upgrade|abort-install|abort-upgrade|disappear)
	exit 0
    ;;
esac
#
# Debian silliness
#
if [ " $1" = " remove" ] ; then
	if [ ! "@prefix@" = "/usr" ] ; then
		for i in bin sbin share/indimail
		do
			${rmdir} --ignore-fail-on-non-empty ${prefix}/$i 2>/dev/null || true
		done
	fi
	${rmdir} --ignore-fail-on-non-empty ${prefix} 2>/dev/null || true
	for i in idhost defaulthost defaultdomain plusdomain
	do
		${rm} -f ${qsysconfdir}/control/$i || true
	done
	${rmdir} --ignore-fail-on-non-empty ${qsysconfdir} 2>/dev/null || true
fi
if [ " $1" = " purge" ] ; then
	nscd_up=`ps -ef |grep nscd |grep -v grep|wc -l`
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd stop
		elif [ -f /etc/systemd/system/multi-user.target/nscd.service ] ; then
			/bin/systemctl stop nscd.service
		fi
	fi
	for i in indimail alias qmailq qmailr qmails qscand; do
		echo "removing user $i"
		/usr/bin/getent passwd $i > /dev/null && /usr/sbin/userdel $i >/dev/null || true
	done
	for i in indimail nofiles qmail qscand; do
		echo "removing group $i"
		/usr/bin/getent group $i  > /dev/null && /usr/sbin/groupdel $i >/dev/null || true
	done
	if [ $nscd_up -ge 1 ] ; then
		if [ -x /etc/init.d/nscd ] ; then
			/etc/init.d/nscd start
		elif [ -f /etc/systemd/system/multi-user.target/nscd.service ] ; then
			/bin/systemctl start nscd.service
		fi
	fi
	for i in idhost defaulthost defaultdomain plusdomain
	do
		${rm} -f ${qsysconfdir}/control/$i || true
	done
	${rmdir} --ignore-fail-on-non-empty ${qsysconfdir} 2>/dev/null || true
	if [ ! "@prefix@" = "/usr" ] ; then
		for i in bin sbin share/indimail
		do
			${rmdir} --ignore-fail-on-non-empty ${prefix}/$i 2>/dev/null || true
		done
		${rmdir} --ignore-fail-on-non-empty ${prefix} 2>/dev/null || true
	fi
fi
if [ ! "${prefix}" = "/usr" ] ; then
	echo "recreating ld.so cache"
	/sbin/ldconfig
fi
exit 0
