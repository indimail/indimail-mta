#!/bin/sh
# postrm script for indimail
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postrm> `remove'
#        * <postrm> `purge'
#        * <old-postrm> `upgrade' <new-version>
#        * <new-postrm> `failed-upgrade' <old-version>
#        * <new-postrm> `abort-install'
#        * <new-postrm> `abort-install' <old-version>
#        * <new-postrm> `abort-upgrade' <old-version>
#        * <disappearer's-postrm> `disappear' <overwriter>
#          <overwriter-version>
# for details, see http://www.debian.org/doc/debian-policy/ or
# the debian-policy package


prefix=@prefix@
mandir=@mandir@
indimaildir=@indimaildir@
shareddir=@shareddir@
sysconfdir=@sysconfdir@
servicedir=/service
logdir=@logdir@
rm=/bin/rm
rmdir=/bin/rmdir
####################################
noproxy=0
nocourierimap=0
noclamav=1
nofetchmail=0
nobogofilter=0
nonssd=0

ID=`id -u`
if [ $ID -ne 0 ] ; then
	echo "You are not root" >&2
	exit 1
fi

case "$1" in
    purge|remove|upgrade|failed-upgrade|abort-install|abort-upgrade|disappear)
	if [ -f ${libexecdir}/iupgrade.sh ] ; then
	(
		echo "Running Custom Upgrade Script for pre $1"
		/bin/sh ${libexecdir}/iupgrade.sh postrm $1 @version@ $* || true
	) >> /tmp/indimail-setup.log 2>&1
	fi
    ;;

    *)
        echo "postrm called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

# we are doing upgrade or removal
if [ " $1" = " upgrade" ] ; then
	echo "recreating ld.so cache"
	/sbin/ldconfig
	exit 0
fi

case "$1" in
    failed-upgrade|abort-install|abort-upgrade|disappear)
	exit 0
    ;;
esac
default_domain=`uname -n`
#
# Debian silliness
#
(
if [ " $1" = " purge" ] ; then
	echo "removing database and configuration"
	for i in mysqldb domains alias
	do
		${rm} -rf ${indimaildir}/$i || true
	done
	if [ -f /etc/mysql/indimail.cnf ] ; then
		${rm} -f /etc/mysql/indimail.cnf
	fi
	for port in 465 25
	do
  	if [ $nobogofilter -eq 0 ] ; then
    	> ${servicedir}/qmail-smtpd.$port/variables/SPAMFILTER
    	> ${servicedir}/qmail-smtpd.$port/variables/SPAMEXITCODE
    	> ${servicedir}/qmail-smtpd.$port/variables/LOGFILTER
  	fi
	done
	${rm} -f ${sysconfdir}/indimail.mrtg.ok ${sysconfdir}/system.mrtg.ok
	echo "removing startup services"
	for i in fetchmail indisrvr.4000 inlookup.infifo mysql.3306 \
	pwdlookup qmail-imapd.143 qmail-imapd-ssl.993 qmail-pop3d.110 qmail-pop3d-ssl.995 \
	qmail-imapd.4143 qmail-pop3d.4110 qmail-poppass.106 mrtg 
	do
  		if [ -d ${servicedir}/$i ] ; then
    		${rm} -rf ${servicedir}/$i || true
  		elif [ -L ${servicedir}/$i ] ; then
    		${rm} -f ${servicedir}/$i || true
  		fi
	done
	if [ $noproxy -eq 0 ] ; then
		for i in proxy-imapd.4143 proxy-imapd-ssl.9143 proxy-pop3d.4110 proxy-pop3d-ssl.9110
		do
  			if [ -d ${servicedir}/$i ] ; then
    			${rm} -rf ${servicedir}/$i || true
  			fi
		done
	fi
	count=`/bin/ls ${servicedir} 2>/dev/null| /usr/bin/wc -l`
	if [ $count -eq 0 ] ; then # ignore disabled services
  	${rm} -rf ${servicedir} || true
	fi

	if [ -d /etc/cron.d ] ; then
  	echo "removing cron entries"
  	${rm} -f /etc/cron.d/cronlist.i
	fi

	echo "removing configuration"
	for i in imap pop3 poppass
	do
		${rm} -f ${sysconfdir}/tcp.$i.cdb ${sysconfdir}/tcp.$i
	done
	${rm} -f ${sysconfdir}/control/controlfiles
	for i in indimail.cnf stat.override backup.conf cronlist.i headerlist \
		imapd.cnf imapd.dist imapd-ssl.dist indimail.mrtg.cfg \
		procmailrc indimail.settings osh.table perm_list.i pop3d.cnf \
		pop3d.dist pop3d-ssl.dist qmailprog.list quotawarnmsg.example \
		services.log system.flashlogin system.menu system.module system.rc
	do
		${rm} -f ${sysconfdir}/$i
	done

	if [ $nobogofilter -eq 0 ] ; then
		${rm} -f ${sysconfdir}/bogofilter.cf ${sysconfdir}/bogofilter.cf.example
	fi

	if [ $noclamav -eq 0 ] ; then
		${rm} -f ${sysconfdir}/clamd.conf ${sysconfdir}/freshclam.conf
		${rm} -f ${sysconfdir}/clamd.conf.disabled ${sysconfdir}/freshclam.conf.disabled
		${rm} -f ${sysconfdir}/clamd.conf.sample ${sysconfdir}/freshclam.conf.sample
	fi
	if [ $nonssd -eq 0 ] ; then
		${rm} -f ${sysconfdir}/nssd.conf
	fi
	if [ $nofetchmail -eq 0 ] ; then
		${rm} -f ${sysconfdir}/fetchmailrc
	fi

	for i in assign cdb
	do
    	${rm} -f ${sysconfdir}/users/$i
	done
	if [ -d ${sysconfdir}/users ] ; then
	${rmdir} --ignore-fail-on-non-empty ${sysconfdir}/users || true
	fi

	for i in .qmail-nonspam .qmail-register-nonspam .qmail-register-spam .qmail-spam
	do
		${rm} -f ${indimaildir}/domains/${default_domain}/$i
	done
	${rm} -f ${sysconfdir}/imapd.pem ${sysconfdir}/pop3d.pem
	${rm} -f ${sysconfdir}/imapd.cnf.* ${sysconfdir}/pop3d.cnf.*

	echo "removing logs"
	${rm} -f ${indimaildir}/mysqldb/logs/logisam.log
	${rm} -f ${indimaildir}/mysqldb/logs/logquery
	${rm} -f ${indimaildir}/mysqldb/logs/logslow
	if [ -h ${logdir} ] ; then
		log_dir=`/bin/ls -ld ${logdir} | /usr/bin/awk '{print $10}'`
	else
		log_dir=${logdir}
	fi
	for i in fetchmail imapd.143 imapd-ssl.993 indisrvr.4000 inlookup.infifo \
	mrtg mysql.3306 pop3d.110 pop3d-ssl.995 poppass.106 proxyIMAP.4143 \
	proxyIMAP.9143 proxyPOP3.4110 proxyPOP3.9110 pwdlookup
	do
		${rm} -rf $log_dir/$i
	done

	echo "recreating ld.so cache"
	/sbin/ldconfig

else
	echo "recreating ld.so cache"
	/sbin/ldconfig
fi
) >> /tmp/indimail-setup.log
exit 0
